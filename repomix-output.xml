This file is a merged representation of a subset of the codebase, containing specifically included files, combined into a single document by Repomix.

<file_summary>
This section contains a summary of this file.

<purpose>
This file contains a packed representation of a subset of the repository's contents that is considered the most important context.
It is designed to be easily consumable by AI systems for analysis, code review,
or other automated processes.
</purpose>

<file_format>
The content is organized as follows:
1. This summary section
2. Repository information
3. Directory structure
4. Repository files (if enabled)
5. Multiple file entries, each consisting of:
  - File path as an attribute
  - Full contents of the file
</file_format>

<usage_guidelines>
- This file should be treated as read-only. Any changes should be made to the
  original repository files, not this packed version.
- When processing this file, use the file path to distinguish
  between different files in the repository.
- Be aware that this file may contain sensitive information. Handle it with
  the same level of security as you would the original repository.
</usage_guidelines>

<notes>
- Some files may have been excluded based on .gitignore rules and Repomix's configuration
- Binary files are not included in this packed representation. Please refer to the Repository Structure section for a complete list of file paths, including binary files
- Only files matching these patterns are included: src/components/**, src/app/**/page.tsx, src/app/**/layout.tsx, src/styles/**, *.css, tailwind.config.*, package.json
- Files matching patterns in .gitignore are excluded
- Files matching default ignore patterns are excluded
- Files are sorted by Git change count (files with more changes are at the bottom)
</notes>

</file_summary>

<directory_structure>
package.json
src/app/layout.tsx
src/app/login/page.tsx
src/app/page.tsx
src/app/signup/page.tsx
src/components/AIBuilder.tsx
src/components/AppConceptWizard.tsx
src/components/AuthGuard.tsx
src/components/build/index.ts
src/components/build/PhaseControlPanel.tsx
src/components/build/PhaseDetailView.tsx
src/components/build/PhaseProgressIndicator.tsx
src/components/build/ValidationDashboard.tsx
src/components/BuilderHeader.tsx
src/components/ChatPanel.tsx
src/components/CodePreview.tsx
src/components/CodeQualityReport.tsx
src/components/ComponentPreview.tsx
src/components/DesignControlPanel.tsx
src/components/dev/DebugPanel.tsx
src/components/dev/DevTools.tsx
src/components/dev/ElementInspector/ElementInspector.tsx
src/components/dev/ElementInspector/index.ts
src/components/dev/ElementInspector/InspectorButton.tsx
src/components/dev/ElementInspector/InspectorOverlay.tsx
src/components/dev/ElementInspector/InspectorPanel.tsx
src/components/dev/ElementInspector/PromptGeneratorModal.tsx
src/components/dev/ElementInspector/SelectedElementCard.tsx
src/components/dev/index.ts
src/components/dev/MockAIBanner.tsx
src/components/DiffPreview.tsx
src/components/ErrorBoundary.tsx
src/components/ExamplePrompts.tsx
src/components/FeatureLibrary.tsx
src/components/FullAppPreview.tsx
src/components/header/BuildDropdown.tsx
src/components/header/index.ts
src/components/header/ProjectDropdown.tsx
src/components/header/ProjectInfo.tsx
src/components/header/SettingsDropdown.tsx
src/components/header/ViewModeToggle.tsx
src/components/layout/DragDropCanvas.tsx
src/components/LayoutBuilderWizard.tsx
src/components/LayoutPreview.tsx
src/components/modals/ApprovalModal.tsx
src/components/modals/CompareVersionsModal.tsx
src/components/modals/DeploymentModal.tsx
src/components/modals/DiffPreviewModal.tsx
src/components/modals/index.ts
src/components/modals/LibraryModal.tsx
src/components/modals/PhasedBuildPanel.tsx
src/components/modals/StagingConsentModal.tsx
src/components/modals/VersionHistoryModal.tsx
src/components/NaturalConversationWizard.tsx
src/components/PerformanceReport.tsx
src/components/PowerfulPreview.tsx
src/components/PreviewPanel.tsx
src/components/review/CommentThread.tsx
src/components/review/EnhancedDiffViewer.tsx
src/components/review/HunkApprovalCard.tsx
src/components/review/ImpactAnalysisPanel.tsx
src/components/review/index.ts
src/components/review/ReviewSidebar.tsx
src/components/review/ReviewSummary.tsx
src/components/review/RollbackHistory.tsx
src/components/SettingsPage.tsx
src/components/storage/FileActions.tsx
src/components/storage/FileCard.tsx
src/components/storage/FileFilters.tsx
src/components/storage/FileGrid.tsx
src/components/storage/FileUploader.tsx
src/components/storage/index.ts
src/components/storage/StorageStats.tsx
src/components/StreamingProgress.tsx
src/components/TabNavigation.tsx
src/components/TemplatePreview.tsx
src/components/TemplateSelector.tsx
src/components/ThemeToggle.tsx
src/components/Toast.tsx
src/components/ui/HeaderDropdown.tsx
src/components/ui/Icons.tsx
src/components/ui/index.ts
src/components/ui/ResizableHandle.tsx
src/components/ui/ResizablePanel.tsx
src/components/ui/ResizablePanelGroup.tsx
src/components/ui/Toast.tsx
src/components/ValidationMessage.tsx
src/components/VersionHistoryPanel.tsx
tailwind.config.js
</directory_structure>

<files>
This section contains the contents of the repository's files.

<file path="src/components/build/index.ts">
/**
 * Build Components Index
 * Export all phase-driven build system components
 */

export { PhaseProgressIndicator } from './PhaseProgressIndicator';
export { PhaseControlPanel } from './PhaseControlPanel';
export { ValidationDashboard } from './ValidationDashboard';
export { PhaseDetailView } from './PhaseDetailView';
</file>

<file path="src/app/page.tsx">
'use client';

import AIBuilder from '@/components/AIBuilder';

export default function HomePage() {
  return <AIBuilder />;
}
</file>

<file path="src/components/AuthGuard.tsx">
'use client';

import { useEffect, useState } from 'react';
import { useRouter, usePathname } from 'next/navigation';
import { useAuth } from '@/contexts/AuthContext';

export default function AuthGuard({ children }: { children: React.ReactNode }) {
  const router = useRouter();
  const pathname = usePathname();
  const { user, loading } = useAuth();
  const [isChecking, setIsChecking] = useState(true);

  useEffect(() => {
    // Skip auth check for public pages
    if (
      pathname === '/login' ||
      pathname === '/signup' ||
      pathname.startsWith('/api/auth/callback')
    ) {
      setIsChecking(false);
      return;
    }

    // Wait for auth context to finish loading
    if (!loading) {
      if (!user) {
        router.push('/login');
      }
      setIsChecking(false);
    }
  }, [pathname, router, user, loading]);

  // Show loading state while checking auth
  if (isChecking || loading) {
    return (
      <div className="min-h-screen bg-gradient-to-br from-slate-900 via-purple-900 to-slate-900 dark:from-slate-900 dark:via-purple-900 dark:to-slate-900 flex items-center justify-center transition-colors duration-300">
        <div className="text-center">
          <div className="text-6xl mb-4 animate-bounce">üîí</div>
          <div className="text-white dark:text-white text-xl">Checking authentication...</div>
        </div>
      </div>
    );
  }

  // Allow access to login/signup pages without auth
  if (
    pathname === '/login' ||
    pathname === '/signup' ||
    pathname.startsWith('/api/auth/callback')
  ) {
    return <>{children}</>;
  }

  // Require authentication for all other pages
  if (!user) {
    return null;
  }

  return <>{children}</>;
}
</file>

<file path="src/components/build/PhaseControlPanel.tsx">
'use client';

import React from 'react';
import type { BuildPhase, PhaseId, BuildProgress } from '../../types/buildPhases';

interface PhaseControlPanelProps {
  phases: BuildPhase[];
  progress: BuildProgress;
  isBuilding: boolean;
  isPaused: boolean;
  onStartBuild: () => void;
  onPauseBuild: () => void;
  onResumeBuild: () => void;
  onSkipPhase: (phaseId: PhaseId) => void;
  onRetryPhase: (phaseId: PhaseId) => void;
  onViewPhaseDetails: (phaseId: PhaseId) => void;
  className?: string;
}

/**
 * Control panel for managing build phases
 */
export function PhaseControlPanel({
  phases,
  progress,
  isBuilding,
  isPaused,
  onStartBuild,
  onPauseBuild,
  onResumeBuild,
  onSkipPhase,
  onRetryPhase,
  onViewPhaseDetails,
  className = '',
}: PhaseControlPanelProps) {
  const currentPhase = phases.find((p) => p.id === progress.currentPhaseId);
  const hasFailedTasks = currentPhase?.tasks.some((t) => t.status === 'failed');
  const canSkip = currentPhase && currentPhase.status === 'in-progress';
  const canRetry = hasFailedTasks;

  return (
    <div
      className={`bg-gradient-to-br from-slate-800/80 to-slate-900/80 rounded-xl border border-white/10 p-4 ${className}`}
    >
      {/* Header */}
      <div className="flex items-center justify-between mb-4">
        <h3 className="text-white font-semibold flex items-center gap-2">
          <span>üéõÔ∏è</span>
          <span>Build Controls</span>
        </h3>
        {isBuilding && (
          <div
            className={`px-2 py-1 rounded-full text-xs font-medium ${
              isPaused ? 'bg-yellow-500/20 text-yellow-400' : 'bg-green-500/20 text-green-400'
            }`}
          >
            {isPaused ? 'Paused' : 'Building...'}
          </div>
        )}
      </div>

      {/* Main Controls */}
      <div className="flex gap-2 mb-4">
        {!isBuilding ? (
          <button
            onClick={onStartBuild}
            className="flex-1 px-4 py-2.5 rounded-lg bg-gradient-to-r from-blue-600 to-purple-600 hover:from-blue-500 hover:to-purple-500 text-white font-medium transition-all hover:shadow-lg hover:shadow-blue-500/20 flex items-center justify-center gap-2"
          >
            <span>üöÄ</span>
            <span>Start Build</span>
          </button>
        ) : (
          <>
            {isPaused ? (
              <button
                onClick={onResumeBuild}
                className="flex-1 px-4 py-2.5 rounded-lg bg-green-600 hover:bg-green-500 text-white font-medium transition-all flex items-center justify-center gap-2"
              >
                <span>‚ñ∂Ô∏è</span>
                <span>Resume</span>
              </button>
            ) : (
              <button
                onClick={onPauseBuild}
                className="flex-1 px-4 py-2.5 rounded-lg bg-yellow-600 hover:bg-yellow-500 text-white font-medium transition-all flex items-center justify-center gap-2"
              >
                <span>‚è∏Ô∏è</span>
                <span>Pause</span>
              </button>
            )}
          </>
        )}
      </div>

      {/* Current Phase Info */}
      {currentPhase && (
        <div className="bg-white/5 rounded-lg p-3 mb-4">
          <div className="flex items-center justify-between mb-2">
            <div className="text-sm font-medium text-white">
              Current: Phase {currentPhase.order} - {currentPhase.name}
            </div>
            <button
              onClick={() => onViewPhaseDetails(currentPhase.id)}
              className="text-xs text-blue-400 hover:text-blue-300 transition-colors"
            >
              View Details ‚Üí
            </button>
          </div>
          <div className="text-xs text-slate-400 mb-2">{currentPhase.description}</div>

          {/* Task Progress */}
          <div className="flex items-center gap-2">
            <div className="flex-1 h-1.5 bg-slate-700 rounded-full overflow-hidden">
              <div
                className="h-full bg-blue-500 rounded-full transition-all duration-300"
                style={{
                  width: `${(currentPhase.tasks.filter((t) => t.status === 'completed').length / currentPhase.tasks.length) * 100}%`,
                }}
              />
            </div>
            <div className="text-xs text-slate-500">
              {currentPhase.tasks.filter((t) => t.status === 'completed').length}/
              {currentPhase.tasks.length}
            </div>
          </div>
        </div>
      )}

      {/* Phase Actions */}
      {currentPhase && (
        <div className="flex gap-2">
          <button
            onClick={() => canSkip && onSkipPhase(currentPhase.id)}
            disabled={!canSkip}
            className="flex-1 px-3 py-2 rounded-lg bg-white/5 border border-white/10 text-slate-300 hover:bg-white/10 hover:text-white transition-all disabled:opacity-50 disabled:cursor-not-allowed text-sm flex items-center justify-center gap-1.5"
          >
            <span>‚è≠Ô∏è</span>
            <span>Skip Phase</span>
          </button>
          <button
            onClick={() => canRetry && onRetryPhase(currentPhase.id)}
            disabled={!canRetry}
            className="flex-1 px-3 py-2 rounded-lg bg-white/5 border border-white/10 text-slate-300 hover:bg-white/10 hover:text-white transition-all disabled:opacity-50 disabled:cursor-not-allowed text-sm flex items-center justify-center gap-1.5"
          >
            <span>üîÑ</span>
            <span>Retry</span>
          </button>
        </div>
      )}

      {/* Phase List */}
      <div className="mt-4 pt-4 border-t border-white/10">
        <div className="text-xs font-medium text-slate-400 mb-2">All Phases</div>
        <div className="space-y-1">
          {phases.map((phase) => {
            const isCurrentPhase = phase.id === progress.currentPhaseId;
            const statusColors = {
              completed: 'text-green-400',
              'in-progress': 'text-blue-400',
              skipped: 'text-slate-500',
              pending: 'text-slate-400',
            };
            const statusIcons = {
              completed: '‚úÖ',
              'in-progress': '‚è≥',
              skipped: '‚è≠Ô∏è',
              pending: '‚óã',
            };

            return (
              <button
                key={phase.id}
                onClick={() => onViewPhaseDetails(phase.id)}
                className={`w-full flex items-center gap-2 px-2 py-1.5 rounded text-left text-sm transition-all ${
                  isCurrentPhase ? 'bg-blue-500/20 text-white' : 'hover:bg-white/5 text-slate-300'
                }`}
              >
                <span className={statusColors[phase.status]}>{statusIcons[phase.status]}</span>
                <span className="flex-1 truncate">{phase.name}</span>
                <span className="text-xs text-slate-500">{phase.estimatedTime}</span>
              </button>
            );
          })}
        </div>
      </div>
    </div>
  );
}

export default PhaseControlPanel;
</file>

<file path="src/components/build/ValidationDashboard.tsx">
'use client';

import React from 'react';
import type { BuildPhase, ValidationCheck, ValidationResult } from '../../types/buildPhases';

interface ValidationDashboardProps {
  phase: BuildPhase;
  validationResult?: ValidationResult;
  onRunValidation: () => void;
  onProceedAnyway: () => void;
  onRetryPhase: () => void;
  isValidating?: boolean;
  className?: string;
}

/**
 * Dashboard showing validation checks for current phase
 */
export function ValidationDashboard({
  phase,
  validationResult,
  onRunValidation,
  onProceedAnyway,
  onRetryPhase,
  isValidating = false,
  className = '',
}: ValidationDashboardProps) {
  const checks = validationResult?.checks || phase.validationChecks;
  const hasFailures = checks.some((c) => !c.passed);
  const allPassed = checks.every((c) => c.passed);
  const canProceed = validationResult?.canProceed ?? false;

  const getCheckIcon = (check: ValidationCheck) => {
    if (check.passed) return '‚úÖ';
    switch (check.type) {
      case 'render':
        return '‚ùå';
      case 'console':
        return '‚ö†Ô∏è';
      case 'functionality':
        return '‚ùå';
      case 'performance':
        return '‚ö†Ô∏è';
      default:
        return '‚óã';
    }
  };

  const getCheckColor = (check: ValidationCheck) => {
    if (check.passed) return 'bg-green-500/10 border-green-500/30 text-green-400';
    switch (check.type) {
      case 'render':
      case 'functionality':
        return 'bg-red-500/10 border-red-500/30 text-red-400';
      case 'console':
      case 'performance':
        return 'bg-yellow-500/10 border-yellow-500/30 text-yellow-400';
      default:
        return 'bg-slate-500/10 border-slate-500/30 text-slate-400';
    }
  };

  const getTypeLabel = (type: ValidationCheck['type']) => {
    switch (type) {
      case 'render':
        return 'üñºÔ∏è Render';
      case 'console':
        return 'üñ•Ô∏è Console';
      case 'functionality':
        return '‚öôÔ∏è Function';
      case 'performance':
        return '‚ö° Perf';
      default:
        return type;
    }
  };

  return (
    <div
      className={`bg-gradient-to-br from-slate-800/80 to-slate-900/80 rounded-xl border border-white/10 p-4 ${className}`}
    >
      {/* Header */}
      <div className="flex items-center justify-between mb-4">
        <h3 className="text-white font-semibold flex items-center gap-2">
          <span>üîç</span>
          <span>Validation</span>
        </h3>
        {validationResult && (
          <div
            className={`px-2 py-1 rounded-full text-xs font-medium ${
              allPassed
                ? 'bg-green-500/20 text-green-400'
                : hasFailures
                  ? 'bg-red-500/20 text-red-400'
                  : 'bg-yellow-500/20 text-yellow-400'
            }`}
          >
            {allPassed ? 'All Passed' : hasFailures ? 'Issues Found' : 'Warnings'}
          </div>
        )}
      </div>

      {/* Phase Info */}
      <div className="bg-white/5 rounded-lg p-3 mb-4">
        <div className="text-sm font-medium text-white mb-1">
          Phase {phase.order}: {phase.name}
        </div>
        <div className="text-xs text-slate-400">{phase.description}</div>
      </div>

      {/* Validation Checks */}
      <div className="space-y-2 mb-4">
        {checks.map((check) => (
          <div
            key={check.id}
            className={`flex items-start gap-3 p-3 rounded-lg border ${getCheckColor(check)}`}
          >
            <span className="text-lg mt-0.5">{getCheckIcon(check)}</span>
            <div className="flex-1 min-w-0">
              <div className="flex items-center gap-2 mb-1">
                <span className="text-sm font-medium">{check.name}</span>
                <span className="text-xs opacity-70">{getTypeLabel(check.type)}</span>
              </div>
              {check.message && <div className="text-xs opacity-80">{check.message}</div>}
            </div>
          </div>
        ))}
      </div>

      {/* Summary */}
      {validationResult && hasFailures && (
        <div className="bg-yellow-500/10 border border-yellow-500/30 rounded-lg p-3 mb-4">
          <div className="flex items-start gap-2">
            <span className="text-lg">üí°</span>
            <div className="text-sm text-yellow-200">
              {canProceed ? (
                <>
                  <strong>Warnings detected</strong> - You can proceed, but consider addressing
                  these issues for better quality.
                </>
              ) : (
                <>
                  <strong>Critical issues found</strong> - These must be fixed before proceeding to
                  the next phase.
                </>
              )}
            </div>
          </div>
        </div>
      )}

      {/* Actions */}
      <div className="flex gap-2">
        <button
          onClick={onRunValidation}
          disabled={isValidating}
          className="flex-1 px-4 py-2.5 rounded-lg bg-blue-600 hover:bg-blue-500 text-white font-medium transition-all disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center gap-2"
        >
          {isValidating ? (
            <>
              <span className="animate-spin">‚è≥</span>
              <span>Validating...</span>
            </>
          ) : (
            <>
              <span>üîç</span>
              <span>Run Validation</span>
            </>
          )}
        </button>

        {validationResult && (
          <>
            {allPassed || canProceed ? (
              <button
                onClick={onProceedAnyway}
                className="flex-1 px-4 py-2.5 rounded-lg bg-green-600 hover:bg-green-500 text-white font-medium transition-all flex items-center justify-center gap-2"
              >
                <span>‚úÖ</span>
                <span>Proceed</span>
              </button>
            ) : (
              <button
                onClick={onRetryPhase}
                className="flex-1 px-4 py-2.5 rounded-lg bg-orange-600 hover:bg-orange-500 text-white font-medium transition-all flex items-center justify-center gap-2"
              >
                <span>üîÑ</span>
                <span>Retry Phase</span>
              </button>
            )}
          </>
        )}
      </div>

      {/* Suggestions */}
      {validationResult?.warnings && validationResult.warnings.length > 0 && (
        <div className="mt-4 pt-4 border-t border-white/10">
          <div className="text-xs font-medium text-slate-400 mb-2">Suggestions</div>
          <ul className="space-y-1">
            {validationResult.warnings.map((warning, idx) => (
              <li key={idx} className="flex items-start gap-2 text-xs text-slate-300">
                <span className="text-yellow-400">‚Ä¢</span>
                <span>{warning}</span>
              </li>
            ))}
          </ul>
        </div>
      )}
    </div>
  );
}

export default ValidationDashboard;
</file>

<file path="src/components/CodePreview.tsx">
'use client';

import { useState } from 'react';

interface CodePreviewProps {
  code: string;
}

export default function CodePreview({ code }: CodePreviewProps) {
  const [copied, setCopied] = useState(false);

  const copyToClipboard = async () => {
    try {
      await navigator.clipboard.writeText(code);
      setCopied(true);
      setTimeout(() => setCopied(false), 2000);
    } catch (err) {
      console.error('Failed to copy code:', err);
    }
  };

  return (
    <div className="relative">
      <div className="absolute top-3 right-3 z-10">
        <button
          onClick={copyToClipboard}
          className="px-3 py-1.5 text-sm border border-white/20 bg-black/50 backdrop-blur-sm text-white hover:bg-white/10 rounded-md transition-colors"
        >
          {copied ? 'Copied!' : 'Copy'}
        </button>
      </div>

      <div className="bg-slate-900 rounded-lg border border-white/10 overflow-hidden">
        <div className="flex items-center justify-between px-4 py-2 bg-slate-800 border-b border-white/10">
          <div className="flex items-center space-x-2">
            <div className="w-3 h-3 rounded-full bg-red-500"></div>
            <div className="w-3 h-3 rounded-full bg-yellow-500"></div>
            <div className="w-3 h-3 rounded-full bg-green-500"></div>
          </div>
          <span className="text-sm text-slate-400">GeneratedComponent.tsx</span>
        </div>

        <pre className="p-4 text-sm overflow-x-auto max-h-96 overflow-y-auto">
          <code className="text-slate-100 whitespace-pre-wrap">{code}</code>
        </pre>
      </div>
    </div>
  );
}
</file>

<file path="src/components/ComponentPreview.tsx">
'use client';

import { useState, useEffect, useMemo, useCallback } from 'react';
import { sanitizeHtml } from '../utils/sanitizeHtml';

interface ComponentPreviewProps {
  code: string;
  theme?: 'light' | 'dark';
  mode?: 'desktop' | 'tablet' | 'mobile';
  props?: Record<string, any>;
  livePreview?: boolean;
}

interface PreviewError {
  message: string;
  details?: string;
}

export default function ComponentPreview({
  code,
  theme = 'light',
  mode = 'desktop',
  props = {},
  livePreview = false,
}: ComponentPreviewProps) {
  const [previewContent, setPreviewContent] = useState<string>('');
  const [error, setError] = useState<string | null>(null);

  // Responsive dimensions
  const dimensions = useMemo(() => {
    switch (mode) {
      case 'mobile':
        return { width: '375px', height: '667px', label: 'iPhone SE' };
      case 'tablet':
        return { width: '768px', height: '1024px', label: 'iPad' };
      case 'desktop':
      default:
        return { width: '100%', height: '100%', label: 'Desktop' };
    }
  }, [mode]);

  // Theme colors
  const themeColors = useMemo(() => {
    if (theme === 'dark') {
      return {
        bg: '#0f172a',
        text: '#e2e8f0',
        border: '#334155',
        accent: '#3b82f6',
      };
    }
    return {
      bg: '#ffffff',
      text: '#1e293b',
      border: '#e2e8f0',
      accent: '#3b82f6',
    };
  }, [theme]);

  // Helper function to extract JSX from code using multiple patterns
  const extractJSX = useCallback((code: string): string => {
    // Try patterns in order of specificity
    const patterns = [
      // Pattern 1: Demo function's return
      /function\s+Demo\s*\([^)]*\)\s*\{[\s\S]*?return\s*\(\s*([\s\S]*?)\s*\);?\s*\}/,
      // Pattern 2: Default export function's return
      /export\s+default\s+function[^{]*\{[\s\S]*?return\s*\(\s*([\s\S]*?)\s*\);?\s*\}/,
      // Pattern 3: return <...>
      /return\s+(<[\s\S]*?>[\s\S]*?<\/\w+>)/,
    ];

    for (const pattern of patterns) {
      const match = code.match(pattern);
      if (match) return match[1].trim();
    }

    // Pattern 4: Last return statement in the code
    const allReturns = code.match(/return\s*\(\s*([\s\S]*?)\s*\);/g);
    if (allReturns && allReturns.length > 0) {
      const lastReturn = allReturns[allReturns.length - 1];
      const match = lastReturn.match(/return\s*\(\s*([\s\S]*?)\s*\);/);
      if (match) return match[1].trim();
    }

    return '';
  }, []);

  // Memoized function to handle JSX to HTML conversion
  const convertJsxToHtml = useCallback(
    (jsxCode: string, props: Record<string, any>): string => {
      try {
        let html = extractJSX(jsxCode);
        if (!html) return '';

        // Convert JSX className to class
        html = html.replace(/className=/g, 'class=');
        html = html.replace(/className:/g, 'class:');

        // Replace prop values
        Object.entries(props).forEach(([key, value]) => {
          html = html.replace(
            new RegExp(`\\{${key}\\}`, 'g'),
            typeof value === 'string' ? value : JSON.stringify(value)
          );
        });

        // Convert JSX style objects to CSS strings
        html = html.replace(/style=\{\{([^}]+)\}\}/g, (match, styleObj) => {
          try {
            const cleanedStyle = styleObj.replace(/,\s*$/, '');
            const styleEntries = cleanedStyle.split(',').map((pair: string) => {
              const [key, value] = pair.split(':').map((s: string) => s.trim());
              const cssKey = key.replace(/[A-Z]/g, (m: string) => `-${m.toLowerCase()}`);
              const cssValue = value.replace(/['"]/g, '');
              return `${cssKey}: ${cssValue}`;
            });
            return `style="${styleEntries.join('; ')}"`;
          } catch (err) {
            console.error('Style conversion error:', err);
            return '';
          }
        });

        // Remove remaining React-specific syntax (surgically)
        // Remove standalone variable references
        html = html.replace(/\{([a-zA-Z_$][a-zA-Z0-9_$]*)\}/g, '');
        // Remove simple property access
        html = html.replace(/\{([a-zA-Z_$][a-zA-Z0-9_$]*\.[a-zA-Z_$][a-zA-Z0-9_$]*)\}/g, '');
        // Remove function calls without JSX
        html = html.replace(/\{([a-zA-Z_$][a-zA-Z0-9_$]*\([^)]*\))\}/g, '');

        // Remove event handlers
        html = html.replace(/\s+on[A-Z]\w+={[^}]+}/g, '');

        // Clean up self-closing tags
        html = html.replace(/<(\w+)([^>]*?)\s*\/>/g, '<$1$2></$1>');

        return html;
      } catch (err) {
        console.error('JSX to HTML conversion error:', err);
        return '';
      }
    },
    [extractJSX]
  );

  // Function to render preview content
  useEffect(() => {
    try {
      if (!code || code.trim() === '') {
        // Show empty state
        const emptyState = `
          <div style="
            width: 100%;
            height: 100%;
            background: ${themeColors.bg};
            color: ${themeColors.text};
            padding: 32px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            border: 2px dashed ${themeColors.border};
            border-radius: 12px;
            box-sizing: border-box;
          ">
            <div style="font-size: 48px; margin-bottom: 20px;">üìã</div>
            <div style="font-size: 20px; font-weight: 600; margin-bottom: 12px;">
              No Component Generated Yet
            </div>
            <div style="font-size: 14px; opacity: 0.7; text-align: center;">
              Enter a prompt and click Generate to see your component here
            </div>
          </div>
        `;
        setPreviewContent(sanitizeHtml(emptyState));
        return;
      }

      // Extract JSX/HTML from the code for preview
      let htmlContent = '';

      // Try to render with improved JSX to HTML conversion
      if (livePreview) {
        try {
          let jsx = extractJSX(code);

          if (jsx) {
            // Convert className to class (multiple patterns)
            jsx = jsx.replace(/className=/g, 'class=');
            jsx = jsx.replace(/className\s*=\s*"/g, 'class="');
            jsx = jsx.replace(/className\s*=\s*'/g, "class='");
            jsx = jsx.replace(/className\s*=\s*\{/g, 'class={');

            // Handle icon components (Lucide React icons) - convert to emoji or SVG placeholders
            const iconMap: { [key: string]: string } = {
              Sparkles: '‚ú®',
              Star: '‚≠ê',
              Heart: '‚ù§Ô∏è',
              Check: '‚úì',
              X: '‚úï',
              Plus: '+',
              Minus: '-',
              Search: 'üîç',
              Menu: '‚ò∞',
              User: 'üë§',
              Settings: '‚öôÔ∏è',
              Home: 'üè†',
              Mail: '‚úâÔ∏è',
              Phone: 'üìû',
              Calendar: 'üìÖ',
              Clock: 'üïê',
              Lock: 'üîí',
              Unlock: 'üîì',
              Eye: 'üëÅÔ∏è',
              EyeOff: 'üôà',
              ChevronRight: '‚Ä∫',
              ChevronLeft: '‚Äπ',
              ChevronUp: '‚åÉ',
              ChevronDown: '‚åÑ',
              ArrowRight: '‚Üí',
              ArrowLeft: '‚Üê',
              ArrowUp: '‚Üë',
              ArrowDown: '‚Üì',
              Download: '‚¨á',
              Upload: '‚¨Ü',
              Trash: 'üóëÔ∏è',
              Edit: '‚úèÔ∏è',
              Save: 'üíæ',
              Share: 'üîó',
              Copy: 'üìã',
              Info: '‚ÑπÔ∏è',
              Alert: '‚ö†Ô∏è',
              Bell: 'üîî',
              Sun: '‚òÄÔ∏è',
              Moon: 'üåô',
              Cloud: '‚òÅÔ∏è',
              Zap: '‚ö°',
              Gift: 'üéÅ',
              Flag: 'üö©',
              Database: 'üóÑÔ∏è',
              Server: 'üñ•Ô∏è',
              Code: 'üíª',
              Terminal: '‚å®Ô∏è',
              Folder: 'üìÅ',
              File: 'üìÑ',
              Image: 'üñºÔ∏è',
              Video: 'üìπ',
              Music: 'üéµ',
              Book: 'üìñ',
              Bookmark: 'üîñ',
              Tag: 'üè∑Ô∏è',
              Package: 'üì¶',
              Inbox: 'üì•',
              Send: 'üì§',
              Paperclip: 'üìé',
              Link: 'üîó',
              ExternalLink: '‚ÜóÔ∏è',
              Maximize: '‚õ∂',
              Minimize: '‚àí',
              MoreVertical: '‚ãÆ',
              MoreHorizontal: '‚ãØ',
              Filter: '‚öóÔ∏è',
              Sort: '‚áÖ',
              Refresh: '‚Üª',
              Play: '‚ñ∂',
              Pause: '‚è∏',
              Stop: '‚èπ',
              Volume: 'üîä',
              Camera: 'üì∑',
              Printer: 'üñ®Ô∏è',
              Wifi: 'üì∂',
              Bluetooth: 'üîµ',
              Battery: 'üîã',
              Power: '‚ö°',
              Shield: 'üõ°Ô∏è',
              Award: 'üèÜ',
              Trophy: 'üèÜ',
              Target: 'üéØ',
              Compass: 'üß≠',
              Map: 'üó∫Ô∏è',
            };

            // Replace icon components with emoji/symbols
            jsx = jsx.replace(
              /<([A-Z][a-z]*(?:[A-Z][a-z]*)*)([^>]*?)\/>/g,
              (match, compName, attrs) => {
                const emoji = iconMap[compName];

                if (emoji) {
                  // Extract className if present
                  const classMatch = attrs.match(/class(?:Name)?\s*=\s*"([^"]*)"/);
                  const className = classMatch ? classMatch[1] : '';
                  return `<span class="${className}">${emoji}</span>`;
                }

                // Fallback for unmapped icons
                const classMatch = attrs.match(/class(?:Name)?\s*=\s*"([^"]*)"/);
                const className = classMatch ? classMatch[1] : 'inline-block w-4 h-4 text-gray-400';
                return `<span class="${className}" title="${compName} icon">‚¨ú</span>`;
              }
            );

            // Handle component instances - convert to divs with their class
            // Example: <Button label="Click" onClick={...} /> becomes the button HTML
            jsx = jsx.replace(/<([A-Z]\w+)([^>]*?)\/>/g, (match, compName, attrs) => {
              // Extract label/children prop if present
              const labelMatch = attrs.match(/label\s*=\s*"([^"]*)"/);
              const label = labelMatch ? labelMatch[1] : compName;

              // Extract className if present
              const classMatch = attrs.match(/class(?:Name)?\s*=\s*"([^"]*)"/);
              const className = classMatch ? classMatch[1] : 'p-4 bg-gray-100 rounded';

              return `<div class="${className}">${label}</div>`;
            });

            // Handle component instances with children
            jsx = jsx.replace(
              /<([A-Z]\w+)([^>]*?)>([\s\S]*?)<\/\1>/g,
              (match, compName, attrs, children) => {
                const classMatch = attrs.match(/class(?:Name)?\s*=\s*"([^"]*)"/);
                const className = classMatch ? classMatch[1] : 'p-4 bg-gray-100 rounded';
                return `<div class="${className}">${children}</div>`;
              }
            );

            // Handle template literals with specific patterns
            jsx = jsx.replace(/\{price\}/gi, '29.99');
            jsx = jsx.replace(/\{price\.toFixed\(2\)\}/gi, '29.99');
            jsx = jsx.replace(/\{\$\{price\}\}/g, '$29.99');
            jsx = jsx.replace(/\{\$\{price\.toFixed\(2\)\}\}/g, '$29.99');
            jsx = jsx.replace(/\$\{price\}/g, '29.99');
            jsx = jsx.replace(/\$\{price\.toFixed\(2\)\}/g, '29.99');

            // Surgically remove simple variable references (preserves React patterns)
            // Remove standalone variable references
            jsx = jsx.replace(/\{([a-zA-Z_$][a-zA-Z0-9_$]*)\}/g, '');
            // Remove simple property access
            jsx = jsx.replace(/\{([a-zA-Z_$][a-zA-Z0-9_$]*\.[a-zA-Z_$][a-zA-Z0-9_$]*)\}/g, '');
            // Remove function calls without JSX
            jsx = jsx.replace(/\{([a-zA-Z_$][a-zA-Z0-9_$]*\([^)]*\))\}/g, '');

            // Handle self-closing tags
            jsx = jsx.replace(/<(\w+)([^>]*?)\s*\/>/g, '<$1$2></$1>');

            // Remove ALL event handlers (onClick, onChange, etc.)
            jsx = jsx.replace(/\s+on[A-Z]\w+\s*=\s*\{[^}]*\}/g, '');
            jsx = jsx.replace(/\s+on[A-Z]\w+\s*=\s*"[^"]*"/g, '');
            jsx = jsx.replace(/\s+on[A-Z]\w+\s*=\s*'[^']*'/g, '');

            // Handle inline styles - convert object notation to CSS
            jsx = jsx.replace(/style\s*=\s*\{\{([^}]+)\}\}/g, (match, styleContent) => {
              try {
                const cssProps = styleContent
                  .split(',')
                  .map((prop: string) => {
                    const [key, value] = prop.split(':').map((s: string) => s.trim());
                    if (!key || !value) return '';
                    const cssKey = key.replace(/[A-Z]/g, (m: string) => `-${m.toLowerCase()}`);
                    const cssValue = value.replace(/['"]/g, '');
                    return `${cssKey}: ${cssValue}`;
                  })
                  .filter(Boolean)
                  .join('; ');
                return `style="${cssProps}"`;
              } catch (err) {
                console.error('Style conversion error:', err);
                return '';
              }
            });

            htmlContent = jsx;
          }
        } catch (err) {
          console.error('JSX conversion error:', err);
        }
      }

      // If live preview failed or is disabled, use static preview
      if (!htmlContent) {
        htmlContent = convertJsxToHtml(code, props);
      }

      // If we still don't have content, show the fallback message
      if (!htmlContent.trim()) {
        htmlContent = `
          <div style="
            padding: 32px;
            background: ${themeColors.bg};
            color: ${themeColors.text};
            border-radius: 12px;
          ">
            <h2 style="margin-bottom: 16px;">Generated Component</h2>
            <p style="opacity: 0.8;">Component code has been generated successfully!</p>
            <p style="margin-top: 12px; font-size: 14px; opacity: 0.6;">
              Switch to the Code tab to view the full implementation.
            </p>
          </div>
        `;
      }

      const sanitized = sanitizeHtml(htmlContent);

      // Wrap the content in a container div
      const containerHtml = `
        <div style="
          width: 100%;
          height: 100%;
          background: ${themeColors.bg};
          color: ${themeColors.text};
          padding: 24px;
          box-sizing: border-box;
          overflow: auto;
          display: flex;
          align-items: center;
          justify-content: center;
        ">
          <div style="
            width: 100%;
            max-width: ${mode === 'desktop' ? '100%' : dimensions.width};
          ">
            ${sanitized}
          </div>
        </div>
      `;

      setPreviewContent(containerHtml);
      setError(null);
    } catch (err) {
      console.error('Preview error:', err);
      const errorMessage = err instanceof Error ? err.message : 'Failed to render preview';
      setError(errorMessage);

      const errorHtml = `
        <div style="
          width: 100%;
          height: 100%;
          background: ${themeColors.bg};
          color: #ef4444;
          padding: 32px;
          display: flex;
          flex-direction: column;
          align-items: center;
          justify-content: center;
          border: 2px solid #ef4444;
          border-radius: 12px;
          box-sizing: border-box;
        ">
          <div style="font-size: 48px; margin-bottom: 20px;">‚ö†Ô∏è</div>
          <div style="font-size: 20px; font-weight: 600; margin-bottom: 12px;">
            Preview Error
          </div>
          <div style="font-size: 14px; opacity: 0.8; text-align: center; max-width: 500px;">
            ${sanitizeHtml(errorMessage)}
          </div>
        </div>
      `;

      setPreviewContent(errorHtml);
    }
  }, [code, theme, mode, props, livePreview, themeColors, extractJSX, convertJsxToHtml]);

  return (
    <div className="h-full flex flex-col bg-white/5 rounded-lg border border-white/10">
      {/* Preview Info Bar */}
      <div className="px-4 py-2 border-b border-white/10 flex items-center justify-between bg-black/20">
        <div className="flex items-center gap-3 text-xs text-slate-400">
          <span className="flex items-center gap-1">
            <span
              className={`w-2 h-2 rounded-full ${livePreview ? 'bg-green-400 animate-pulse' : 'bg-slate-500'}`}
            ></span>
            {livePreview ? 'Live' : 'Static'}
          </span>
          <span>|</span>
          <span>{dimensions.label}</span>
          <span>|</span>
          <span className="capitalize">{theme} Theme</span>
        </div>
        {error && <span className="text-xs text-red-400">‚ö†Ô∏è {error}</span>}
      </div>

      {/* Preview Container */}
      <div className="flex-1 flex items-center justify-center p-6 overflow-auto">
        <div
          style={{
            width: dimensions.width,
            height: mode !== 'desktop' ? dimensions.height : '100%',
            minHeight: mode === 'desktop' ? '400px' : dimensions.height,
            maxWidth: '100%',
            transition: 'all 0.3s ease',
            boxShadow: mode !== 'desktop' ? '0 20px 60px rgba(0,0,0,0.3)' : 'none',
            background: themeColors.bg,
          }}
          className={`rounded-lg overflow-hidden relative ${error ? 'border-2 border-red-500' : ''}`}
        >
          {/* Preview Frame */}
          <div className="w-full h-full" dangerouslySetInnerHTML={{ __html: previewContent }} />

          {/* Responsive Overlay */}
          {mode !== 'desktop' && (
            <div className="absolute top-0 left-0 right-0 bg-black/20 backdrop-blur-sm px-4 py-2 flex items-center justify-between text-xs text-slate-300">
              <span>{dimensions.label}</span>
              <span>
                {dimensions.width} √ó {dimensions.height}
              </span>
            </div>
          )}
        </div>
      </div>
    </div>
  );
}
</file>

<file path="src/components/dev/ElementInspector/index.ts">
/**
 * Element Inspector Components
 * Barrel export for the Visual Element Inspector dev tool.
 */

export { ElementInspector, default as default } from './ElementInspector';
export { InspectorButton } from './InspectorButton';
export { InspectorOverlay } from './InspectorOverlay';
export { InspectorPanel } from './InspectorPanel';
export { SelectedElementCard } from './SelectedElementCard';
export { PromptGeneratorModal } from './PromptGeneratorModal';
</file>

<file path="src/components/DiffPreview.tsx">
'use client';

import React, { useState } from 'react';

interface DiffChange {
  type: 'ADD_IMPORT' | 'INSERT_AFTER' | 'INSERT_BEFORE' | 'REPLACE' | 'DELETE' | 'APPEND';
  searchFor?: string;
  content?: string;
  replaceWith?: string;
}

interface FileDiff {
  path: string;
  action: 'MODIFY' | 'CREATE' | 'DELETE';
  changes: DiffChange[];
}

interface DiffPreviewProps {
  summary: string;
  files: FileDiff[];
  onApprove: () => void;
  onReject: () => void;
}

export default function DiffPreview({ summary, files, onApprove, onReject }: DiffPreviewProps) {
  const [expandedFiles, setExpandedFiles] = useState<Set<string>>(
    new Set(files.map((f) => f.path))
  );

  const toggleFile = (path: string) => {
    const newExpanded = new Set(expandedFiles);
    if (newExpanded.has(path)) {
      newExpanded.delete(path);
    } else {
      newExpanded.add(path);
    }
    setExpandedFiles(newExpanded);
  };

  const getChangeTypeIcon = (type: DiffChange['type']) => {
    const icons = {
      ADD_IMPORT: '‚ûï',
      INSERT_AFTER: 'üìù',
      INSERT_BEFORE: 'üìù',
      REPLACE: 'üîÑ',
      DELETE: '‚ùå',
      APPEND: '‚ûï',
    };
    return icons[type];
  };

  const getChangeTypeColor = (type: DiffChange['type']) => {
    const colors = {
      ADD_IMPORT: 'text-green-400',
      INSERT_AFTER: 'text-blue-400',
      INSERT_BEFORE: 'text-blue-400',
      REPLACE: 'text-yellow-400',
      DELETE: 'text-red-400',
      APPEND: 'text-green-400',
    };
    return colors[type];
  };

  const getActionIcon = (action: FileDiff['action']) => {
    const icons = {
      MODIFY: 'üìù',
      CREATE: '‚ûï',
      DELETE: 'üóëÔ∏è',
    };
    return icons[action];
  };

  const getActionColor = (action: FileDiff['action']) => {
    const colors = {
      MODIFY: 'border-blue-500/30 bg-blue-500/10',
      CREATE: 'border-green-500/30 bg-green-500/10',
      DELETE: 'border-red-500/30 bg-red-500/10',
    };
    return colors[action];
  };

  const formatChangeDescription = (change: DiffChange): string => {
    switch (change.type) {
      case 'ADD_IMPORT':
        return `Add import statement`;
      case 'INSERT_AFTER':
        return `Insert code after: "${change.searchFor?.substring(0, 40)}..."`;
      case 'INSERT_BEFORE':
        return `Insert code before: "${change.searchFor?.substring(0, 40)}..."`;
      case 'REPLACE':
        return `Replace: "${change.searchFor?.substring(0, 30)}..." ‚Üí "${change.replaceWith?.substring(0, 30)}..."`;
      case 'DELETE':
        return `Delete: "${change.searchFor?.substring(0, 40)}..."`;
      case 'APPEND':
        return `Append code to end of file`;
      default:
        return 'Unknown change';
    }
  };

  // Calculate total changes
  const totalChanges = files.reduce((sum, file) => sum + file.changes.length, 0);

  return (
    <div className="space-y-4">
      {/* Summary Header */}
      <div className="bg-gradient-to-r from-blue-500/20 to-purple-500/20 border border-blue-500/30 rounded-xl p-4">
        <div className="flex items-start gap-3">
          <div className="w-10 h-10 rounded-lg bg-blue-500/20 flex items-center justify-center flex-shrink-0">
            <span className="text-2xl">‚ú®</span>
          </div>
          <div className="flex-1">
            <h3 className="text-white font-semibold mb-1">Proposed Changes</h3>
            <p className="text-sm text-blue-200 leading-relaxed">{summary}</p>
            <div className="flex items-center gap-4 mt-3 text-xs text-blue-200/80">
              <span>
                üìÅ {files.length} {files.length === 1 ? 'file' : 'files'}
              </span>
              <span>
                üîß {totalChanges} {totalChanges === 1 ? 'change' : 'changes'}
              </span>
            </div>
          </div>
        </div>
      </div>

      {/* Info Banner */}
      <div className="bg-yellow-500/10 border border-yellow-500/30 rounded-lg p-3">
        <div className="flex items-start gap-2">
          <span className="text-lg">üí°</span>
          <div className="text-sm text-yellow-200/90">
            <span className="font-medium">Smart modifications:</span> Only the specific code you
            requested will be changed. Everything else stays exactly the same.
          </div>
        </div>
      </div>

      {/* Files List */}
      <div className="space-y-3">
        {files.map((file, fileIdx) => (
          <div
            key={fileIdx}
            className={`border rounded-xl overflow-hidden ${getActionColor(file.action)}`}
          >
            {/* File Header */}
            <button
              onClick={() => toggleFile(file.path)}
              className="w-full px-4 py-3 flex items-center justify-between hover:bg-white/5 transition-all"
            >
              <div className="flex items-center gap-3">
                <span className="text-xl">{getActionIcon(file.action)}</span>
                <div className="text-left">
                  <div className="text-white font-medium text-sm">{file.path}</div>
                  <div className="text-xs text-slate-400 mt-0.5">
                    {file.action} ‚Ä¢ {file.changes.length}{' '}
                    {file.changes.length === 1 ? 'change' : 'changes'}
                  </div>
                </div>
              </div>
              <svg
                className={`w-5 h-5 text-slate-400 transition-transform ${
                  expandedFiles.has(file.path) ? 'rotate-180' : ''
                }`}
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
              >
                <path
                  strokeLinecap="round"
                  strokeLinejoin="round"
                  strokeWidth={2}
                  d="M19 9l-7 7-7-7"
                />
              </svg>
            </button>

            {/* File Changes */}
            {expandedFiles.has(file.path) && (
              <div className="px-4 pb-4 space-y-2">
                {file.changes.map((change, changeIdx) => (
                  <div
                    key={changeIdx}
                    className="bg-black/20 rounded-lg p-3 border border-white/10"
                  >
                    <div className="flex items-start gap-3">
                      <span className={`text-lg ${getChangeTypeColor(change.type)}`}>
                        {getChangeTypeIcon(change.type)}
                      </span>
                      <div className="flex-1 min-w-0">
                        <div className="text-xs font-medium text-slate-300 mb-2">
                          {change.type.replace('_', ' ')}
                        </div>
                        <div className="text-xs text-slate-400 mb-2">
                          {formatChangeDescription(change)}
                        </div>

                        {/* Show code preview for certain change types */}
                        {(change.type === 'ADD_IMPORT' || change.type === 'APPEND') &&
                          change.content && (
                            <div className="mt-2">
                              <div className="text-xs text-green-400 mb-1">+ Adding:</div>
                              <pre className="text-xs bg-black/40 rounded p-2 overflow-x-auto text-green-300">
                                <code>
                                  {change.content.substring(0, 200)}
                                  {change.content.length > 200 ? '...' : ''}
                                </code>
                              </pre>
                            </div>
                          )}

                        {change.type === 'REPLACE' && (
                          <div className="mt-2 space-y-2">
                            {change.searchFor && (
                              <div>
                                <div className="text-xs text-red-400 mb-1">- Removing:</div>
                                <pre className="text-xs bg-black/40 rounded p-2 overflow-x-auto text-red-300 line-through">
                                  <code>
                                    {change.searchFor.substring(0, 100)}
                                    {change.searchFor.length > 100 ? '...' : ''}
                                  </code>
                                </pre>
                              </div>
                            )}
                            {change.replaceWith && (
                              <div>
                                <div className="text-xs text-green-400 mb-1">+ Adding:</div>
                                <pre className="text-xs bg-black/40 rounded p-2 overflow-x-auto text-green-300">
                                  <code>
                                    {change.replaceWith.substring(0, 100)}
                                    {change.replaceWith.length > 100 ? '...' : ''}
                                  </code>
                                </pre>
                              </div>
                            )}
                          </div>
                        )}
                      </div>
                    </div>
                  </div>
                ))}
              </div>
            )}
          </div>
        ))}
      </div>

      {/* Action Buttons */}
      <div className="flex gap-3 pt-2">
        <button
          onClick={onReject}
          className="flex-1 px-6 py-3 rounded-xl bg-slate-700 hover:bg-slate-600 text-white font-medium transition-all flex items-center justify-center gap-2"
        >
          <span>‚ùå</span>
          <span>Reject Changes</span>
        </button>
        <button
          onClick={onApprove}
          className="flex-1 px-6 py-3 rounded-xl bg-gradient-to-r from-green-500 to-emerald-600 hover:from-green-600 hover:to-emerald-700 text-white font-medium transition-all shadow-lg hover:shadow-green-500/20 flex items-center justify-center gap-2"
        >
          <span>‚úÖ</span>
          <span>Apply Changes</span>
        </button>
      </div>

      {/* Safety Info */}
      <div className="bg-white/5 border border-white/10 rounded-lg p-3">
        <div className="flex items-start gap-2 text-xs text-slate-400">
          <span>üõ°Ô∏è</span>
          <p>
            Your current version will be saved in history before applying these changes. You can
            always undo or revert if needed.
          </p>
        </div>
      </div>
    </div>
  );
}
</file>

<file path="src/components/ExamplePrompts.tsx">
'use client';

import React from 'react';

export interface ExamplePrompt {
  id: string;
  text: string;
  category: 'saas' | 'ecommerce' | 'content' | 'social' | 'productivity' | 'other';
  icon?: string;
}

export const EXAMPLE_PROMPTS: ExamplePrompt[] = [
  // SaaS & Business
  {
    id: 'saas-crm',
    text: 'Build a CRM for small businesses to manage leads and contacts',
    category: 'saas',
    icon: 'üíº',
  },
  {
    id: 'saas-project',
    text: 'Create a project management tool like Trello for remote teams',
    category: 'saas',
    icon: 'üìä',
  },
  {
    id: 'saas-analytics',
    text: 'Build an analytics dashboard to track website visitors and conversion rates',
    category: 'saas',
    icon: 'üìà',
  },

  // E-commerce
  {
    id: 'ecom-store',
    text: 'Create an online store to sell handmade crafts with Stripe payments',
    category: 'ecommerce',
    icon: 'üõí',
  },
  {
    id: 'ecom-marketplace',
    text: 'Build a marketplace where users can list and sell items',
    category: 'ecommerce',
    icon: 'üè™',
  },

  // Content & Media
  {
    id: 'content-blog',
    text: 'Build a blog platform with markdown support and dark mode',
    category: 'content',
    icon: 'üìù',
  },
  {
    id: 'content-portfolio',
    text: 'Create a portfolio website to showcase my design work',
    category: 'content',
    icon: 'üé®',
  },
  {
    id: 'content-docs',
    text: 'Build a documentation site with search and navigation',
    category: 'content',
    icon: 'üìö',
  },

  // Social & Community
  {
    id: 'social-forum',
    text: 'Create a discussion forum like Reddit with upvoting and comments',
    category: 'social',
    icon: 'üí¨',
  },
  {
    id: 'social-network',
    text: 'Build a social network where users can follow friends and share posts',
    category: 'social',
    icon: 'üë•',
  },

  // Productivity & Tools
  {
    id: 'prod-tasks',
    text: 'Build a task manager for freelancers with priorities and due dates',
    category: 'productivity',
    icon: '‚úÖ',
  },
  {
    id: 'prod-notes',
    text: 'Create a note-taking app like Notion with rich text editing',
    category: 'productivity',
    icon: 'üìã',
  },
  {
    id: 'prod-calendar',
    text: 'Build a booking system for appointments and scheduling',
    category: 'productivity',
    icon: 'üìÖ',
  },

  // Other
  {
    id: 'other-fitness',
    text: 'Create a fitness tracker to log workouts and track progress',
    category: 'other',
    icon: 'üí™',
  },
  {
    id: 'other-recipe',
    text: 'Build a recipe app where users can save and share recipes',
    category: 'other',
    icon: 'üç≥',
  },
];

interface ExamplePromptsProps {
  onSelect: (prompt: string) => void;
  variant?: 'grid' | 'chips' | 'list';
  maxDisplay?: number;
  showCategories?: boolean;
}

export const ExamplePrompts: React.FC<ExamplePromptsProps> = ({
  onSelect,
  variant = 'chips',
  maxDisplay = 5,
}) => {
  const displayPrompts = EXAMPLE_PROMPTS.slice(0, maxDisplay);

  if (variant === 'grid') {
    return (
      <div className="space-y-4">
        <div className="flex items-center gap-2">
          <span className="text-yellow-400">üí°</span>
          <h3 className="text-sm font-medium text-slate-300">Try these ideas:</h3>
        </div>
        <div className="grid grid-cols-1 md:grid-cols-2 gap-3">
          {displayPrompts.map((prompt) => (
            <button
              key={prompt.id}
              onClick={() => onSelect(prompt.text)}
              className="bg-white/5 rounded-xl p-4 text-left hover:bg-white/10 transition-all border border-transparent hover:border-blue-500/30 group"
            >
              <div className="flex items-start gap-3">
                {prompt.icon && <span className="text-2xl flex-shrink-0">{prompt.icon}</span>}
                <p className="text-sm text-slate-300 group-hover:text-white transition-colors">
                  {prompt.text}
                </p>
              </div>
            </button>
          ))}
        </div>
      </div>
    );
  }

  if (variant === 'list') {
    return (
      <div className="space-y-2">
        <div className="flex items-center gap-2 mb-3">
          <span className="text-blue-400">‚ú®</span>
          <p className="text-xs font-medium text-slate-400 uppercase tracking-wider">
            Example Ideas
          </p>
        </div>
        {displayPrompts.map((prompt) => (
          <button
            key={prompt.id}
            onClick={() => onSelect(prompt.text)}
            className="w-full text-left px-4 py-3 bg-white/5 rounded-lg hover:bg-white/10 transition-all flex items-center gap-3 group border border-transparent hover:border-blue-500/20"
          >
            {prompt.icon && <span className="text-xl flex-shrink-0">{prompt.icon}</span>}
            <span className="text-sm text-slate-300 group-hover:text-white transition-colors">
              {prompt.text}
            </span>
          </button>
        ))}
      </div>
    );
  }

  // Chips variant (default)
  return (
    <div className="space-y-3">
      <div className="flex items-center gap-2">
        <span className="text-blue-400">‚ú®</span>
        <p className="text-xs text-slate-400">Not sure what to build? Try one of these:</p>
      </div>
      <div className="flex flex-wrap gap-2">
        {displayPrompts.map((prompt) => (
          <button
            key={prompt.id}
            onClick={() => onSelect(prompt.text)}
            className="px-3 py-2 rounded-lg bg-white/5 hover:bg-blue-500/10 hover:border-blue-500/30 border border-transparent text-xs text-slate-300 hover:text-blue-400 transition-all flex items-center gap-2"
          >
            {prompt.icon && <span>{prompt.icon}</span>}
            <span>{prompt.text}</span>
          </button>
        ))}
      </div>
    </div>
  );
};

// Categorized version
interface CategorizedPromptsProps {
  onSelect: (prompt: string) => void;
}

export const CategorizedPrompts: React.FC<CategorizedPromptsProps> = ({ onSelect }) => {
  const categories = [
    { id: 'saas', label: 'SaaS & Business', icon: 'üíº' },
    { id: 'ecommerce', label: 'E-commerce', icon: 'üõí' },
    { id: 'content', label: 'Content & Media', icon: 'üìù' },
    { id: 'social', label: 'Social', icon: 'üë•' },
    { id: 'productivity', label: 'Productivity', icon: '‚úÖ' },
    { id: 'other', label: 'Other', icon: 'üåü' },
  ];

  return (
    <div className="space-y-6">
      <div className="flex items-center gap-2">
        <span className="text-yellow-400">üí°</span>
        <h3 className="text-lg font-semibold text-white">Example Ideas</h3>
      </div>

      {categories.map((category) => {
        const prompts = EXAMPLE_PROMPTS.filter((p) => p.category === category.id);
        if (prompts.length === 0) return null;

        return (
          <div key={category.id} className="space-y-3">
            <h4 className="text-sm font-medium text-slate-400 flex items-center gap-2">
              <span>{category.icon}</span>
              {category.label}
            </h4>
            <div className="space-y-2">
              {prompts.map((prompt) => (
                <button
                  key={prompt.id}
                  onClick={() => onSelect(prompt.text)}
                  className="w-full text-left px-4 py-3 bg-white/5 rounded-lg hover:bg-white/10 transition-all flex items-center gap-3 group border border-transparent hover:border-blue-500/20"
                >
                  {prompt.icon && <span className="text-xl flex-shrink-0">{prompt.icon}</span>}
                  <span className="text-sm text-slate-300 group-hover:text-white transition-colors">
                    {prompt.text}
                  </span>
                </button>
              ))}
            </div>
          </div>
        );
      })}
    </div>
  );
};

// Placeholder text for input
export function getRandomPlaceholder(): string {
  const placeholders = [
    'Describe your app idea... (e.g., "A task manager for freelancers")',
    'What do you want to build? (e.g., "An e-commerce store for handmade goods")',
    'Tell me about your app... (e.g., "A blog platform with dark mode")',
    'What problem does your app solve? (e.g., "Help teams track projects")',
    'Describe your vision... (e.g., "A social network for developers")',
  ];

  return placeholders[Math.floor(Math.random() * placeholders.length)];
}
</file>

<file path="src/components/FeatureLibrary.tsx">
'use client';

import React, { useState, useMemo } from 'react';
import type { Feature } from '../types/appConcept';

/**
 * Feature template structure
 */
interface FeatureTemplate {
  id: string;
  name: string;
  description: string;
  priority: 'high' | 'medium' | 'low';
  category: string;
  icon: string;
}

/**
 * Feature library organized by category
 */
const featureTemplates: FeatureTemplate[] = [
  // Authentication
  {
    id: 'auth-login',
    name: 'User Login',
    description: 'Secure email/password login with session management',
    priority: 'high',
    category: 'Authentication',
    icon: 'üîê',
  },
  {
    id: 'auth-signup',
    name: 'User Registration',
    description: 'New user signup with email verification',
    priority: 'high',
    category: 'Authentication',
    icon: 'üìù',
  },
  {
    id: 'auth-oauth',
    name: 'Social Login',
    description: 'Login with Google, GitHub, or other providers',
    priority: 'medium',
    category: 'Authentication',
    icon: 'üîó',
  },
  {
    id: 'auth-password-reset',
    name: 'Password Reset',
    description: 'Forgot password flow with email recovery',
    priority: 'high',
    category: 'Authentication',
    icon: 'üîÑ',
  },
  {
    id: 'auth-2fa',
    name: 'Two-Factor Auth',
    description: 'Additional security with 2FA verification',
    priority: 'low',
    category: 'Authentication',
    icon: 'üõ°Ô∏è',
  },

  // Data Management
  {
    id: 'data-crud',
    name: 'CRUD Operations',
    description: 'Create, read, update, and delete data records',
    priority: 'high',
    category: 'Data Management',
    icon: 'üìä',
  },
  {
    id: 'data-search',
    name: 'Search & Filter',
    description: 'Search functionality with advanced filters',
    priority: 'high',
    category: 'Data Management',
    icon: 'üîç',
  },
  {
    id: 'data-sort',
    name: 'Sort & Pagination',
    description: 'Data sorting with paginated results',
    priority: 'medium',
    category: 'Data Management',
    icon: 'üìë',
  },
  {
    id: 'data-export',
    name: 'Data Export',
    description: 'Export data to CSV, Excel, or PDF',
    priority: 'low',
    category: 'Data Management',
    icon: 'üì§',
  },
  {
    id: 'data-import',
    name: 'Data Import',
    description: 'Bulk import data from files',
    priority: 'low',
    category: 'Data Management',
    icon: 'üì•',
  },

  // User Experience
  {
    id: 'ux-dark-mode',
    name: 'Dark Mode',
    description: 'Toggle between light and dark themes',
    priority: 'medium',
    category: 'User Experience',
    icon: 'üåô',
  },
  {
    id: 'ux-responsive',
    name: 'Responsive Design',
    description: 'Mobile-first responsive layout',
    priority: 'high',
    category: 'User Experience',
    icon: 'üì±',
  },
  {
    id: 'ux-loading',
    name: 'Loading States',
    description: 'Skeleton loaders and progress indicators',
    priority: 'medium',
    category: 'User Experience',
    icon: '‚è≥',
  },
  {
    id: 'ux-keyboard',
    name: 'Keyboard Shortcuts',
    description: 'Power user keyboard navigation',
    priority: 'low',
    category: 'User Experience',
    icon: '‚å®Ô∏è',
  },
  {
    id: 'ux-accessibility',
    name: 'Accessibility',
    description: 'WCAG compliant accessible design',
    priority: 'medium',
    category: 'User Experience',
    icon: '‚ôø',
  },

  // Communication
  {
    id: 'comm-notifications',
    name: 'In-App Notifications',
    description: 'Real-time notification system',
    priority: 'medium',
    category: 'Communication',
    icon: 'üîî',
  },
  {
    id: 'comm-email',
    name: 'Email Notifications',
    description: 'Transactional and marketing emails',
    priority: 'medium',
    category: 'Communication',
    icon: 'üìß',
  },
  {
    id: 'comm-chat',
    name: 'Real-time Chat',
    description: 'Live messaging between users',
    priority: 'medium',
    category: 'Communication',
    icon: 'üí¨',
  },
  {
    id: 'comm-comments',
    name: 'Comments',
    description: 'Threaded commenting system',
    priority: 'medium',
    category: 'Communication',
    icon: 'üí≠',
  },

  // E-commerce
  {
    id: 'ecom-cart',
    name: 'Shopping Cart',
    description: 'Add to cart with quantity management',
    priority: 'high',
    category: 'E-commerce',
    icon: 'üõí',
  },
  {
    id: 'ecom-checkout',
    name: 'Checkout Flow',
    description: 'Multi-step checkout process',
    priority: 'high',
    category: 'E-commerce',
    icon: 'üí≥',
  },
  {
    id: 'ecom-inventory',
    name: 'Inventory Management',
    description: 'Track stock levels and availability',
    priority: 'medium',
    category: 'E-commerce',
    icon: 'üì¶',
  },
  {
    id: 'ecom-wishlist',
    name: 'Wishlist',
    description: 'Save items for later purchase',
    priority: 'low',
    category: 'E-commerce',
    icon: '‚ù§Ô∏è',
  },

  // Analytics
  {
    id: 'analytics-dashboard',
    name: 'Analytics Dashboard',
    description: 'Visual metrics and KPI tracking',
    priority: 'medium',
    category: 'Analytics',
    icon: 'üìà',
  },
  {
    id: 'analytics-charts',
    name: 'Charts & Graphs',
    description: 'Interactive data visualizations',
    priority: 'medium',
    category: 'Analytics',
    icon: 'üìä',
  },
  {
    id: 'analytics-reports',
    name: 'Report Generation',
    description: 'Automated report creation',
    priority: 'low',
    category: 'Analytics',
    icon: 'üìã',
  },

  // Social
  {
    id: 'social-profiles',
    name: 'User Profiles',
    description: 'Customizable user profile pages',
    priority: 'high',
    category: 'Social',
    icon: 'üë§',
  },
  {
    id: 'social-follow',
    name: 'Follow/Unfollow',
    description: 'Social following system',
    priority: 'medium',
    category: 'Social',
    icon: 'üë•',
  },
  {
    id: 'social-feed',
    name: 'Activity Feed',
    description: 'Timeline of user activities',
    priority: 'medium',
    category: 'Social',
    icon: 'üì∞',
  },
  {
    id: 'social-share',
    name: 'Social Sharing',
    description: 'Share content to social platforms',
    priority: 'low',
    category: 'Social',
    icon: 'üîó',
  },

  // Content
  {
    id: 'content-editor',
    name: 'Rich Text Editor',
    description: 'WYSIWYG content editor',
    priority: 'medium',
    category: 'Content',
    icon: '‚úèÔ∏è',
  },
  {
    id: 'content-media',
    name: 'Media Gallery',
    description: 'Image and video gallery',
    priority: 'medium',
    category: 'Content',
    icon: 'üñºÔ∏è',
  },
  {
    id: 'content-upload',
    name: 'File Upload',
    description: 'Drag-and-drop file uploads',
    priority: 'medium',
    category: 'Content',
    icon: 'üìÅ',
  },
  {
    id: 'content-markdown',
    name: 'Markdown Support',
    description: 'Markdown content rendering',
    priority: 'low',
    category: 'Content',
    icon: 'üìù',
  },
];

/**
 * Get unique categories from templates
 */
const categories = Array.from(new Set(featureTemplates.map((t) => t.category)));

/**
 * FeatureLibrary component
 */
interface FeatureLibraryProps {
  isOpen: boolean;
  onClose: () => void;
  onSelectFeature: (feature: Omit<Feature, 'id'>) => void;
  existingFeatureNames?: string[];
}

export function FeatureLibrary({
  isOpen,
  onClose,
  onSelectFeature,
  existingFeatureNames = [],
}: FeatureLibraryProps) {
  const [searchQuery, setSearchQuery] = useState('');
  const [selectedCategory, setSelectedCategory] = useState<string | null>(null);

  const filteredTemplates = useMemo(() => {
    return featureTemplates.filter((template) => {
      // Filter by search
      const matchesSearch =
        searchQuery === '' ||
        template.name.toLowerCase().includes(searchQuery.toLowerCase()) ||
        template.description.toLowerCase().includes(searchQuery.toLowerCase());

      // Filter by category
      const matchesCategory = selectedCategory === null || template.category === selectedCategory;

      // Exclude already added features
      const notAdded = !existingFeatureNames.some(
        (name) => name.toLowerCase() === template.name.toLowerCase()
      );

      return matchesSearch && matchesCategory && notAdded;
    });
  }, [searchQuery, selectedCategory, existingFeatureNames]);

  const handleSelectTemplate = (template: FeatureTemplate) => {
    onSelectFeature({
      name: template.name,
      description: template.description,
      priority: template.priority,
    });
  };

  if (!isOpen) return null;

  return (
    <div
      className="fixed inset-0 bg-black/70 backdrop-blur-sm z-[60] flex items-center justify-center p-4"
      onClick={onClose}
    >
      <div
        className="bg-slate-900 rounded-2xl border border-white/10 max-w-4xl w-full max-h-[85vh] overflow-hidden shadow-2xl"
        onClick={(e) => e.stopPropagation()}
      >
        {/* Header */}
        <div className="px-6 py-5 border-b border-white/10 bg-gradient-to-r from-purple-500/20 to-blue-500/20">
          <div className="flex items-center justify-between">
            <div className="flex items-center gap-3">
              <div className="w-12 h-12 rounded-xl bg-purple-500/20 flex items-center justify-center">
                <span className="text-3xl">üìö</span>
              </div>
              <div>
                <h3 className="text-xl font-bold text-white">Feature Library</h3>
                <p className="text-sm text-slate-300">
                  Pre-built feature templates to speed up your app
                </p>
              </div>
            </div>
            <button onClick={onClose} className="p-2 rounded-lg hover:bg-white/10 transition-all">
              <span className="text-slate-400 text-xl">‚úï</span>
            </button>
          </div>
        </div>

        {/* Search and Filters */}
        <div className="px-6 py-4 border-b border-white/10 bg-black/20">
          <div className="flex flex-col sm:flex-row gap-4">
            {/* Search */}
            <div className="flex-1">
              <input
                type="text"
                value={searchQuery}
                onChange={(e) => setSearchQuery(e.target.value)}
                placeholder="Search features..."
                className="w-full px-4 py-2.5 rounded-lg bg-slate-800 border border-white/10 text-white placeholder-slate-500 focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent"
              />
            </div>

            {/* Category Filter */}
            <div className="flex flex-wrap gap-2">
              <button
                onClick={() => setSelectedCategory(null)}
                className={`px-3 py-1.5 rounded-lg text-sm font-medium transition-all ${
                  selectedCategory === null
                    ? 'bg-purple-600 text-white'
                    : 'bg-slate-800 text-slate-400 hover:text-white hover:bg-slate-700'
                }`}
              >
                All
              </button>
              {categories.map((category) => (
                <button
                  key={category}
                  onClick={() => setSelectedCategory(category)}
                  className={`px-3 py-1.5 rounded-lg text-sm font-medium transition-all ${
                    selectedCategory === category
                      ? 'bg-purple-600 text-white'
                      : 'bg-slate-800 text-slate-400 hover:text-white hover:bg-slate-700'
                  }`}
                >
                  {category}
                </button>
              ))}
            </div>
          </div>
        </div>

        {/* Feature Grid */}
        <div className="p-6 overflow-y-auto max-h-[calc(85vh-200px)]">
          {filteredTemplates.length === 0 ? (
            <div className="text-center py-12">
              <div className="text-4xl mb-4">üîç</div>
              <p className="text-slate-400">
                {searchQuery || selectedCategory
                  ? 'No features found matching your criteria'
                  : 'All features have been added!'}
              </p>
            </div>
          ) : (
            <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">
              {filteredTemplates.map((template) => (
                <button
                  key={template.id}
                  onClick={() => handleSelectTemplate(template)}
                  className="text-left p-4 rounded-xl bg-slate-800/50 border border-white/5 hover:bg-slate-800 hover:border-purple-500/30 transition-all group"
                >
                  <div className="flex items-start gap-3">
                    <span className="text-2xl">{template.icon}</span>
                    <div className="flex-1 min-w-0">
                      <div className="flex items-center gap-2 mb-1">
                        <h4 className="text-white font-medium truncate group-hover:text-purple-300 transition-colors">
                          {template.name}
                        </h4>
                        <span
                          className={`px-1.5 py-0.5 rounded text-xs font-medium ${
                            template.priority === 'high'
                              ? 'bg-red-500/20 text-red-300'
                              : template.priority === 'medium'
                                ? 'bg-yellow-500/20 text-yellow-300'
                                : 'bg-green-500/20 text-green-300'
                          }`}
                        >
                          {template.priority}
                        </span>
                      </div>
                      <p className="text-xs text-slate-400 line-clamp-2">{template.description}</p>
                      <p className="text-xs text-purple-400 mt-2 opacity-0 group-hover:opacity-100 transition-opacity">
                        Click to add ‚Üí
                      </p>
                    </div>
                  </div>
                </button>
              ))}
            </div>
          )}
        </div>

        {/* Footer */}
        <div className="px-6 py-4 border-t border-white/10 bg-black/20">
          <div className="flex items-center justify-between">
            <p className="text-sm text-slate-500">
              {filteredTemplates.length} feature
              {filteredTemplates.length === 1 ? '' : 's'} available
            </p>
            <button
              onClick={onClose}
              className="px-4 py-2 rounded-lg bg-slate-700 hover:bg-slate-600 text-white text-sm font-medium transition-all"
            >
              Done
            </button>
          </div>
        </div>
      </div>
    </div>
  );
}

export default FeatureLibrary;
</file>

<file path="src/components/header/index.ts">
// Header Components
export { ProjectDropdown } from './ProjectDropdown';
export { BuildDropdown } from './BuildDropdown';
export { SettingsDropdown } from './SettingsDropdown';
export { ProjectInfo } from './ProjectInfo';
export { ViewModeToggle } from './ViewModeToggle';
</file>

<file path="src/components/header/ProjectDropdown.tsx">
'use client';

import React from 'react';
import { HeaderDropdown, DropdownItem } from '../ui/HeaderDropdown';
import {
  FolderIcon,
  PlusIcon,
  AppsIcon,
  DownloadIcon,
  ShareIcon,
  FileIcon,
  CodeIcon,
  ArchiveIcon,
  ClipboardIcon,
} from '../ui/Icons';

interface ProjectDropdownProps {
  onNewProject?: () => void;
  onMyApps?: () => void;
  onExportHTML?: () => void;
  onExportReact?: () => void;
  onExportZip?: () => void;
  onCopyToClipboard?: () => void;
  onShare?: () => void;
  appCount?: number;
  showShare?: boolean;
}

export const ProjectDropdown: React.FC<ProjectDropdownProps> = ({
  onNewProject,
  onMyApps,
  onExportHTML,
  onExportReact,
  onExportZip,
  onCopyToClipboard,
  onShare,
  appCount = 0,
  showShare = true,
}) => {
  const items: DropdownItem[] = [
    {
      id: 'new-app',
      label: 'New App',
      icon: <PlusIcon size={16} />,
      shortcut: 'Ctrl+N',
      onClick: onNewProject,
    },
    {
      id: 'my-apps',
      label: 'My Apps',
      icon: <AppsIcon size={16} />,
      onClick: onMyApps,
      badge: appCount > 0 ? appCount : undefined,
      dividerAfter: true,
    },
    {
      id: 'export',
      label: 'Export',
      icon: <DownloadIcon size={16} />,
      subItems: [
        {
          id: 'export-html',
          label: 'Export as HTML',
          icon: <FileIcon size={16} />,
          onClick: onExportHTML,
        },
        {
          id: 'export-react',
          label: 'Export as React',
          icon: <CodeIcon size={16} />,
          onClick: onExportReact,
        },
        {
          id: 'export-zip',
          label: 'Export as ZIP',
          icon: <ArchiveIcon size={16} />,
          onClick: onExportZip,
        },
        {
          id: 'copy-clipboard',
          label: 'Copy to Clipboard',
          icon: <ClipboardIcon size={16} />,
          onClick: onCopyToClipboard,
        },
      ],
    },
  ];

  // Conditionally add Share
  if (showShare && onShare) {
    items.push({
      id: 'share',
      label: 'Share',
      icon: <ShareIcon size={16} />,
      onClick: onShare,
    });
  }

  return (
    <HeaderDropdown
      trigger={
        <span className="flex items-center gap-2">
          <FolderIcon size={16} />
          <span className="hidden sm:inline">Project</span>
        </span>
      }
      label="Project menu"
      items={items}
      align="left"
    />
  );
};

export default ProjectDropdown;
</file>

<file path="src/components/modals/ApprovalModal.tsx">
'use client';

import React from 'react';
import type { PendingChange } from '@/types/aiBuilderTypes';

export interface ApprovalModalProps {
  isOpen: boolean;
  pendingChange: PendingChange | null;
  onApprove: () => void;
  onReject: () => void;
}

export function ApprovalModal({ isOpen, pendingChange, onApprove, onReject }: ApprovalModalProps) {
  if (!isOpen || !pendingChange) return null;

  return (
    <div
      className="fixed inset-0 bg-black/80 backdrop-blur-sm z-[60] flex items-center justify-center p-4"
      onClick={() => {}}
    >
      <div
        className="bg-slate-900 rounded-2xl border border-yellow-500/30 max-w-2xl w-full shadow-2xl"
        onClick={(e) => e.stopPropagation()}
      >
        {/* Modal Header */}
        <div className="px-6 py-5 border-b border-yellow-500/30 bg-yellow-500/10">
          <div className="flex items-center gap-3">
            <div className="w-12 h-12 rounded-xl bg-yellow-500/20 flex items-center justify-center">
              <span className="text-3xl">‚ö†Ô∏è</span>
            </div>
            <div>
              <h3 className="text-xl font-bold text-white">Approve Changes?</h3>
              <p className="text-sm text-yellow-200/80">
                Review the proposed modifications to your app
              </p>
            </div>
          </div>
        </div>

        {/* Modal Content */}
        <div className="px-6 py-5">
          <div className="mb-6">
            <label className="text-sm font-medium text-slate-300 mb-2 block">
              What&apos;s changing:
            </label>
            <div className="bg-slate-800/50 rounded-lg p-4 border border-white/10">
              <p className="text-white text-sm leading-relaxed">
                {pendingChange.changeDescription}
              </p>
            </div>
          </div>

          <div className="bg-blue-500/10 border border-blue-500/30 rounded-lg p-4 mb-6">
            <div className="flex items-start gap-3">
              <span className="text-2xl">üí°</span>
              <div>
                <p className="text-sm font-medium text-blue-200 mb-1">Why approval is needed</p>
                <p className="text-xs text-blue-200/70 leading-relaxed">
                  This change will modify your existing app. Approving ensures you won&apos;t
                  accidentally lose features you like. You can reject this change and request
                  something different instead.
                </p>
              </div>
            </div>
          </div>

          {/* Preview of files being changed */}
          <div className="mb-6">
            <label className="text-sm font-medium text-slate-300 mb-2 block">Files affected:</label>
            <div className="bg-slate-800/50 rounded-lg p-3 border border-white/10 max-h-32 overflow-y-auto">
              {(() => {
                try {
                  const parsedData = JSON.parse(pendingChange.newCode);
                  return (
                    <div className="space-y-1">
                      {parsedData.files?.map((file: { path: string }, idx: number) => (
                        <div key={idx} className="flex items-center gap-2 text-xs text-slate-300">
                          <span className="text-blue-400">üìÑ</span>
                          <span>{file.path}</span>
                        </div>
                      ))}
                    </div>
                  );
                } catch {
                  return <p className="text-xs text-slate-400">Unable to parse file list</p>;
                }
              })()}
            </div>
          </div>
        </div>

        {/* Modal Actions */}
        <div className="px-6 py-4 border-t border-white/10 bg-black/20 flex gap-3">
          <button
            onClick={onReject}
            className="flex-1 px-4 py-3 rounded-lg bg-slate-700 hover:bg-slate-600 text-white font-medium transition-all"
          >
            ‚ùå Reject Changes
          </button>
          <button
            onClick={onApprove}
            className="flex-1 px-4 py-3 rounded-lg bg-gradient-to-r from-green-500 to-emerald-600 hover:from-green-600 hover:to-emerald-700 text-white font-medium transition-all shadow-lg"
          >
            ‚úÖ Approve &amp; Apply
          </button>
        </div>
      </div>
    </div>
  );
}

export default ApprovalModal;
</file>

<file path="src/components/modals/CompareVersionsModal.tsx">
'use client';

import React from 'react';
import type { AppVersion, GeneratedComponent } from '@/types/aiBuilderTypes';

export interface CompareVersionsModalProps {
  isOpen: boolean;
  onClose: () => void;
  version1: AppVersion | null;
  version2: AppVersion | null;
  onRevertToVersion: (version: AppVersion) => void;
  onForkVersion: (version: AppVersion) => void;
  currentComponent?: GeneratedComponent | null;
}

export function CompareVersionsModal({
  isOpen,
  onClose,
  version1,
  version2,
  onRevertToVersion,
  onForkVersion,
}: CompareVersionsModalProps) {
  if (!isOpen || !version1 || !version2) return null;

  const handleClose = () => {
    onClose();
  };

  return (
    <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/80 backdrop-blur-sm p-4">
      <div className="bg-gradient-to-br from-slate-900 to-slate-800 rounded-2xl border border-white/10 shadow-2xl max-w-6xl w-full max-h-[85vh] overflow-hidden">
        {/* Modal Header */}
        <div className="px-6 py-4 border-b border-white/10 bg-gradient-to-r from-purple-500/20 to-blue-500/20">
          <div className="flex items-center justify-between">
            <div className="flex items-center gap-3">
              <span className="text-3xl">üîç</span>
              <div>
                <h2 className="text-2xl font-bold text-white">Compare Versions</h2>
                <p className="text-sm text-slate-300 mt-1">
                  Version {version1.versionNumber} vs Version {version2.versionNumber}
                </p>
              </div>
            </div>
            <button
              onClick={handleClose}
              className="text-slate-400 hover:text-white transition-colors"
            >
              <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path
                  strokeLinecap="round"
                  strokeLinejoin="round"
                  strokeWidth={2}
                  d="M6 18L18 6M6 6l12 12"
                />
              </svg>
            </button>
          </div>
        </div>

        {/* Modal Body */}
        <div className="px-6 py-6 overflow-y-auto max-h-[70vh]">
          <div className="grid grid-cols-2 gap-6">
            {/* Version 1 */}
            <div className="space-y-3">
              <div className="bg-purple-500/10 border border-purple-500/30 rounded-xl p-4">
                <div className="flex items-center gap-2 mb-2">
                  <span className="text-2xl">üìå</span>
                  <div>
                    <h3 className="text-white font-semibold">Version {version1.versionNumber}</h3>
                    <p className="text-xs text-slate-400">
                      {new Date(version1.timestamp).toLocaleString()}
                    </p>
                  </div>
                </div>
                <p className="text-sm text-slate-300">{version1.description}</p>
              </div>

              <div className="bg-black/20 rounded-xl border border-white/10 p-4">
                <div className="flex items-center justify-between mb-2">
                  <h4 className="text-white font-semibold text-sm">Code Preview</h4>
                  <button
                    onClick={() => {
                      navigator.clipboard.writeText(version1.code);
                      alert('Code copied to clipboard!');
                    }}
                    className="text-xs text-blue-400 hover:text-blue-300"
                  >
                    Copy
                  </button>
                </div>
                <pre className="text-xs text-slate-300 overflow-auto max-h-[400px] p-3 bg-black/40 rounded-lg">
                  <code>{version1.code.substring(0, 1000)}...</code>
                </pre>
              </div>
            </div>

            {/* Version 2 */}
            <div className="space-y-3">
              <div className="bg-blue-500/10 border border-blue-500/30 rounded-xl p-4">
                <div className="flex items-center gap-2 mb-2">
                  <span className="text-2xl">üìç</span>
                  <div>
                    <h3 className="text-white font-semibold">Version {version2.versionNumber}</h3>
                    <p className="text-xs text-slate-400">
                      {new Date(version2.timestamp).toLocaleString()}
                    </p>
                  </div>
                </div>
                <p className="text-sm text-slate-300">{version2.description}</p>
              </div>

              <div className="bg-black/20 rounded-xl border border-white/10 p-4">
                <div className="flex items-center justify-between mb-2">
                  <h4 className="text-white font-semibold text-sm">Code Preview</h4>
                  <button
                    onClick={() => {
                      navigator.clipboard.writeText(version2.code);
                      alert('Code copied to clipboard!');
                    }}
                    className="text-xs text-blue-400 hover:text-blue-300"
                  >
                    Copy
                  </button>
                </div>
                <pre className="text-xs text-slate-300 overflow-auto max-h-[400px] p-3 bg-black/40 rounded-lg">
                  <code>{version2.code.substring(0, 1000)}...</code>
                </pre>
              </div>
            </div>
          </div>

          {/* Quick Actions */}
          <div className="mt-6 p-4 bg-white/5 border border-white/10 rounded-xl">
            <h4 className="text-white font-semibold mb-3 flex items-center gap-2">
              <span>‚ö°</span> Quick Actions
            </h4>
            <div className="flex gap-3">
              <button
                onClick={() => {
                  if (window.confirm(`Revert to Version ${version1.versionNumber}?`)) {
                    onRevertToVersion(version1);
                    handleClose();
                  }
                }}
                className="flex-1 px-4 py-2 rounded-lg bg-purple-600 hover:bg-purple-700 text-white text-sm font-medium transition-all"
              >
                üîÑ Revert to Version {version1.versionNumber}
              </button>
              <button
                onClick={() => {
                  onForkVersion(version1);
                  handleClose();
                }}
                className="flex-1 px-4 py-2 rounded-lg bg-white/5 border border-white/10 hover:bg-white/10 text-white text-sm font-medium transition-all"
              >
                üç¥ Fork Version {version1.versionNumber}
              </button>
            </div>
          </div>
        </div>

        {/* Modal Footer */}
        <div className="px-6 py-4 border-t border-white/10 bg-black/20 flex justify-between items-center">
          <div className="flex items-center gap-2 text-xs text-slate-400">
            <span>üí°</span>
            <span>Compare code changes between versions</span>
          </div>
          <button
            onClick={handleClose}
            className="px-4 py-2 rounded-lg bg-blue-600 hover:bg-blue-700 text-white text-sm font-medium transition-all"
          >
            Close
          </button>
        </div>
      </div>
    </div>
  );
}

export default CompareVersionsModal;
</file>

<file path="src/components/modals/DeploymentModal.tsx">
'use client';

import React from 'react';
import { getDeploymentInstructions, type DeploymentInstructions } from '@/utils/exportApp';

export interface DeploymentModalProps {
  isOpen: boolean;
  onClose: () => void;
  deploymentInstructions: DeploymentInstructions | null;
  onPlatformChange: (platform: 'vercel' | 'netlify' | 'github') => void;
  appName?: string;
}

export function DeploymentModal({
  isOpen,
  onClose,
  deploymentInstructions,
  onPlatformChange,
  appName = 'app',
}: DeploymentModalProps) {
  if (!isOpen || !deploymentInstructions) return null;

  const handleClose = () => {
    onClose();
  };

  return (
    <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/80 backdrop-blur-sm p-4">
      <div className="bg-gradient-to-br from-slate-900 to-slate-800 rounded-2xl border border-white/10 shadow-2xl max-w-2xl w-full max-h-[80vh] overflow-hidden">
        {/* Modal Header */}
        <div className="px-6 py-4 border-b border-white/10 bg-gradient-to-r from-green-500/20 to-blue-500/20">
          <div className="flex items-center justify-between">
            <div className="flex items-center gap-3">
              <span className="text-3xl">üì¶</span>
              <div>
                <h2 className="text-2xl font-bold text-white">App Exported Successfully!</h2>
                <p className="text-sm text-slate-300 mt-1">Ready to deploy to production</p>
              </div>
            </div>
            <button
              onClick={handleClose}
              className="text-slate-400 hover:text-white transition-colors"
            >
              <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path
                  strokeLinecap="round"
                  strokeLinejoin="round"
                  strokeWidth={2}
                  d="M6 18L18 6M6 6l12 12"
                />
              </svg>
            </button>
          </div>
        </div>

        {/* Modal Body */}
        <div className="px-6 py-6 overflow-y-auto max-h-[60vh]">
          <div className="space-y-6">
            {/* Success Message */}
            <div className="bg-green-500/10 border border-green-500/30 rounded-xl p-4">
              <div className="flex items-start gap-3">
                <span className="text-2xl">‚úÖ</span>
                <div>
                  <h3 className="text-white font-semibold mb-1">Download Started</h3>
                  <p className="text-sm text-slate-300">
                    Your app has been packaged as a ZIP file with all necessary files, including
                    package.json, configuration files, and a README with deployment instructions.
                  </p>
                </div>
              </div>
            </div>

            {/* Deployment Options */}
            <div>
              <h3 className="text-white font-semibold mb-4 flex items-center gap-2">
                <span>üöÄ</span> Deployment Options
              </h3>
              <div className="grid grid-cols-1 md:grid-cols-3 gap-3">
                <button
                  onClick={() => onPlatformChange('vercel')}
                  className={`p-4 rounded-xl border transition-all ${
                    deploymentInstructions.platform === 'vercel'
                      ? 'bg-black/40 border-blue-500/50'
                      : 'bg-white/5 border-white/10 hover:bg-white/10'
                  }`}
                >
                  <div className="text-2xl mb-2">‚ñ≤</div>
                  <div className="text-white font-medium">Vercel</div>
                  <div className="text-xs text-slate-400 mt-1">Recommended</div>
                </button>
                <button
                  onClick={() => onPlatformChange('netlify')}
                  className={`p-4 rounded-xl border transition-all ${
                    deploymentInstructions.platform === 'netlify'
                      ? 'bg-black/40 border-blue-500/50'
                      : 'bg-white/5 border-white/10 hover:bg-white/10'
                  }`}
                >
                  <div className="text-2xl mb-2">‚óÜ</div>
                  <div className="text-white font-medium">Netlify</div>
                  <div className="text-xs text-slate-400 mt-1">Easy Deploy</div>
                </button>
                <button
                  onClick={() => onPlatformChange('github')}
                  className={`p-4 rounded-xl border transition-all ${
                    deploymentInstructions.platform === 'github'
                      ? 'bg-black/40 border-blue-500/50'
                      : 'bg-white/5 border-white/10 hover:bg-white/10'
                  }`}
                >
                  <div className="text-2xl mb-2">üêô</div>
                  <div className="text-white font-medium">GitHub</div>
                  <div className="text-xs text-slate-400 mt-1">Version Control</div>
                </button>
              </div>
            </div>

            {/* Instructions */}
            <div>
              <h3 className="text-white font-semibold mb-3 flex items-center gap-2">
                <span>üìã</span> Deployment Steps
              </h3>
              <div className="bg-black/20 rounded-xl border border-white/10 p-4">
                <ol className="space-y-3">
                  {deploymentInstructions.steps.map((step, index) => (
                    <li key={index} className="flex items-start gap-3">
                      <span className="flex-shrink-0 w-6 h-6 rounded-full bg-blue-500/20 border border-blue-500/40 flex items-center justify-center text-xs text-blue-400 font-medium">
                        {index + 1}
                      </span>
                      <span className="text-sm text-slate-300 leading-relaxed pt-0.5">{step}</span>
                    </li>
                  ))}
                </ol>

                {deploymentInstructions.cliCommand && (
                  <div className="mt-4 pt-4 border-t border-white/10">
                    <div className="flex items-center justify-between mb-2">
                      <span className="text-xs text-slate-400">Quick Deploy Command:</span>
                      <button
                        onClick={() => {
                          navigator.clipboard.writeText(deploymentInstructions.cliCommand || '');
                          alert('Command copied to clipboard!');
                        }}
                        className="text-xs text-blue-400 hover:text-blue-300"
                      >
                        Copy
                      </button>
                    </div>
                    <code className="block px-3 py-2 rounded-lg bg-black/40 text-green-400 text-sm font-mono">
                      {deploymentInstructions.cliCommand}
                    </code>
                  </div>
                )}
              </div>
            </div>

            {/* Additional Resources */}
            <div className="bg-blue-500/10 border border-blue-500/30 rounded-xl p-4">
              <div className="flex items-start gap-3">
                <span className="text-xl">üí°</span>
                <div className="text-sm text-slate-300">
                  <p className="font-semibold text-white mb-1">Tip:</p>
                  <p>
                    For the best experience, we recommend deploying to Vercel. It&apos;s optimized
                    for Next.js apps and provides automatic deployments, preview URLs, and
                    zero-config setup.
                  </p>
                </div>
              </div>
            </div>
          </div>
        </div>

        {/* Modal Footer */}
        <div className="px-6 py-4 border-t border-white/10 bg-black/20 flex justify-between items-center">
          <div className="flex items-center gap-2 text-xs text-slate-400">
            <span>üì¶</span>
            <span>Check your downloads folder for the ZIP file</span>
          </div>
          <button
            onClick={handleClose}
            className="px-4 py-2 rounded-lg bg-blue-600 hover:bg-blue-700 text-white text-sm font-medium transition-all"
          >
            Got it!
          </button>
        </div>
      </div>
    </div>
  );
}

export default DeploymentModal;
</file>

<file path="src/components/modals/DiffPreviewModal.tsx">
'use client';

import React from 'react';
import DiffPreview from '../DiffPreview';
import type { PendingDiff } from '@/types/aiBuilderTypes';

export interface DiffPreviewModalProps {
  isOpen: boolean;
  onClose: () => void;
  pendingDiff: PendingDiff | null;
  onApprove: () => void;
  onReject: () => void;
}

export function DiffPreviewModal({
  isOpen,
  onClose,
  pendingDiff,
  onApprove,
  onReject,
}: DiffPreviewModalProps) {
  if (!isOpen || !pendingDiff) return null;

  return (
    <div
      className="fixed inset-0 bg-black/80 backdrop-blur-sm z-[70] flex items-center justify-center p-4"
      onClick={() => {}}
    >
      <div
        className="bg-slate-900 rounded-2xl border border-blue-500/30 max-w-4xl w-full max-h-[85vh] overflow-hidden shadow-2xl"
        onClick={(e) => e.stopPropagation()}
      >
        <div className="px-6 py-5 border-b border-blue-500/30 bg-blue-500/10">
          <div className="flex items-center justify-between">
            <div className="flex items-center gap-3">
              <div className="w-12 h-12 rounded-xl bg-blue-500/20 flex items-center justify-center">
                <span className="text-3xl">üîç</span>
              </div>
              <div>
                <h3 className="text-xl font-bold text-white">Review Changes</h3>
                <p className="text-sm text-blue-200/80">Smart targeted modifications</p>
              </div>
            </div>
            <button onClick={onClose} className="p-2 rounded-lg hover:bg-white/10 transition-all">
              <span className="text-slate-400 text-xl">‚úï</span>
            </button>
          </div>
        </div>

        <div className="p-6 overflow-y-auto max-h-[70vh]">
          <DiffPreview
            summary={pendingDiff.summary}
            files={pendingDiff.files}
            onApprove={onApprove}
            onReject={onReject}
          />
        </div>
      </div>
    </div>
  );
}

export default DiffPreviewModal;
</file>

<file path="src/components/modals/index.ts">
/**
 * Modal Components Module
 *
 * Extracted modal and overlay components from AIBuilder.tsx
 * for better code organization and reusability.
 */

export { LibraryModal } from './LibraryModal';
export { ApprovalModal } from './ApprovalModal';
export { VersionHistoryModal } from './VersionHistoryModal';
export { DeploymentModal } from './DeploymentModal';
export { DiffPreviewModal } from './DiffPreviewModal';
export { StagingConsentModal } from './StagingConsentModal';
export { CompareVersionsModal } from './CompareVersionsModal';
export { PhasedBuildPanel } from './PhasedBuildPanel';

// Re-export types
export type { LibraryModalProps } from './LibraryModal';
export type { ApprovalModalProps } from './ApprovalModal';
export type { VersionHistoryModalProps } from './VersionHistoryModal';
export type { DeploymentModalProps } from './DeploymentModal';
export type { DiffPreviewModalProps } from './DiffPreviewModal';
export type { StagingConsentModalProps } from './StagingConsentModal';
export type { CompareVersionsModalProps } from './CompareVersionsModal';
export type { PhasedBuildPanelProps } from './PhasedBuildPanel';
</file>

<file path="src/components/modals/StagingConsentModal.tsx">
'use client';

import React from 'react';
import type { ChatMessage, StagePlan } from '@/types/aiBuilderTypes';

export interface StagingConsentModalProps {
  isOpen: boolean;
  pendingRequest: string;
  onBuildAllAtOnce: () => void;
  onBuildInPhases: () => void;
  chatMessages?: ChatMessage[];
  setIsGenerating?: (value: boolean) => void;
  setNewAppStagePlan?: (plan: StagePlan) => void;
  setChatMessages?: (setter: (prev: ChatMessage[]) => ChatMessage[]) => void;
  setPendingNewAppRequest?: (value: string) => void;
}

export function StagingConsentModal({
  isOpen,
  pendingRequest,
  onBuildAllAtOnce,
  onBuildInPhases,
}: StagingConsentModalProps) {
  if (!isOpen || !pendingRequest) return null;

  return (
    <div
      className="fixed inset-0 bg-black/80 backdrop-blur-sm z-[60] flex items-center justify-center p-4"
      onClick={() => {}}
    >
      <div
        className="bg-slate-900 rounded-2xl border border-purple-500/30 max-w-2xl w-full shadow-2xl"
        onClick={(e) => e.stopPropagation()}
      >
        {/* Modal Header */}
        <div className="px-6 py-5 border-b border-purple-500/30 bg-purple-500/10">
          <div className="flex items-center gap-3">
            <div className="w-12 h-12 rounded-xl bg-purple-500/20 flex items-center justify-center">
              <span className="text-3xl">üèóÔ∏è</span>
            </div>
            <div>
              <h3 className="text-xl font-bold text-white">Build in Phases?</h3>
              <p className="text-sm text-purple-200/80">
                Large app detected - suggested phased approach
              </p>
            </div>
          </div>
        </div>

        {/* Modal Content */}
        <div className="px-6 py-5">
          <div className="mb-6">
            <label className="text-sm font-medium text-slate-300 mb-2 block">Your request:</label>
            <div className="bg-slate-800/50 rounded-lg p-4 border border-white/10">
              <p className="text-white text-sm leading-relaxed">&quot;{pendingRequest}&quot;</p>
            </div>
          </div>

          <div className="bg-blue-500/10 border border-blue-500/30 rounded-lg p-4 mb-6">
            <div className="flex items-start gap-3">
              <span className="text-2xl">üí°</span>
              <div>
                <p className="text-sm font-medium text-blue-200 mb-2">Why Build in Phases?</p>
                <ul className="text-xs text-blue-200/70 leading-relaxed space-y-1.5">
                  <li>‚úÖ Each phase gets fully working code you can test</li>
                  <li>‚úÖ See progress step-by-step with live previews</li>
                  <li>‚úÖ Guide the direction after each phase</li>
                  <li>‚úÖ Avoids overwhelming single-build approach</li>
                  <li>‚úÖ Better quality - each piece is refined before moving on</li>
                </ul>
              </div>
            </div>
          </div>

          <div className="bg-purple-500/10 border border-purple-500/30 rounded-lg p-4 mb-6">
            <div className="flex items-start gap-3">
              <span className="text-2xl">üéØ</span>
              <div>
                <p className="text-sm font-medium text-purple-200 mb-2">How It Works</p>
                <ol className="text-xs text-purple-200/70 leading-relaxed space-y-1.5">
                  <li>1. I&apos;ll analyze and break your request into 2-4 logical phases</li>
                  <li>2. Build Phase 1 (foundation + core features)</li>
                  <li>3. You review, test, and approve before Phase 2</li>
                  <li>4. Repeat until your complete app is ready</li>
                </ol>
              </div>
            </div>
          </div>

          <div className="bg-green-500/10 border border-green-500/30 rounded-lg p-4">
            <div className="flex items-start gap-3">
              <span className="text-2xl">‚ö°</span>
              <div>
                <p className="text-sm font-medium text-green-200 mb-1">Or Build All at Once?</p>
                <p className="text-xs text-green-200/70 leading-relaxed">
                  I can also generate everything in one go. This is faster but gives you less
                  control over the direction, and the result might need more refinement.
                </p>
              </div>
            </div>
          </div>
        </div>

        {/* Modal Actions */}
        <div className="px-6 py-4 border-t border-white/10 bg-black/20 flex gap-3">
          <button
            onClick={onBuildAllAtOnce}
            className="flex-1 px-4 py-3 rounded-lg bg-slate-700 hover:bg-slate-600 text-white font-medium transition-all"
          >
            ‚ö° Build All at Once
          </button>
          <button
            onClick={onBuildInPhases}
            className="flex-1 px-4 py-3 rounded-lg bg-gradient-to-r from-purple-500 to-blue-600 hover:from-purple-600 hover:to-blue-700 text-white font-medium transition-all shadow-lg"
          >
            üèóÔ∏è Build in Phases (Recommended)
          </button>
        </div>
      </div>
    </div>
  );
}

export default StagingConsentModal;
</file>

<file path="src/components/review/CommentThread.tsx">
'use client';

import React, { useState } from 'react';
import type { CommentThreadProps } from '@/types/review';

/**
 * CommentThread - Inline commenting system for code review
 *
 * Features:
 * - Display comments on a specific line
 * - Add new comments
 * - Resolve/unresolve comments
 * - Mark as needs attention
 * - Delete comments
 */
export default function CommentThread({
  comments,
  lineNumber,
  onAddComment,
  onResolveComment,
  onDeleteComment,
  onMarkNeedsAttention,
}: CommentThreadProps) {
  const [isAdding, setIsAdding] = useState(false);
  const [newComment, setNewComment] = useState('');

  const handleSubmit = () => {
    if (newComment.trim()) {
      onAddComment(newComment.trim());
      setNewComment('');
      setIsAdding(false);
    }
  };

  const handleKeyDown = (e: React.KeyboardEvent) => {
    if (e.key === 'Enter' && (e.ctrlKey || e.metaKey)) {
      handleSubmit();
    }
    if (e.key === 'Escape') {
      setIsAdding(false);
      setNewComment('');
    }
  };

  const formatTimestamp = (timestamp: string) => {
    const date = new Date(timestamp);
    return date.toLocaleString(undefined, {
      month: 'short',
      day: 'numeric',
      hour: '2-digit',
      minute: '2-digit',
    });
  };

  const unresolvedCount = comments.filter((c) => !c.resolved).length;
  const needsAttentionCount = comments.filter((c) => c.needsAttention).length;

  return (
    <div className="rounded-lg border border-blue-500/30 bg-blue-500/10 overflow-hidden">
      {/* Header */}
      <div className="px-3 py-2 border-b border-blue-500/20 bg-blue-500/5 flex items-center justify-between">
        <div className="flex items-center gap-2 text-xs">
          <span className="text-blue-400">üí¨</span>
          <span className="text-blue-300 font-medium">Line {lineNumber}</span>
          <span className="text-blue-400/60">
            ‚Ä¢ {comments.length} {comments.length === 1 ? 'comment' : 'comments'}
          </span>
          {unresolvedCount > 0 && (
            <span className="px-1.5 py-0.5 rounded bg-yellow-500/20 text-yellow-400 text-xs">
              {unresolvedCount} unresolved
            </span>
          )}
          {needsAttentionCount > 0 && (
            <span className="px-1.5 py-0.5 rounded bg-red-500/20 text-red-400 text-xs">
              {needsAttentionCount} needs attention
            </span>
          )}
        </div>
        <button
          onClick={() => setIsAdding(true)}
          className="text-xs text-blue-400 hover:text-blue-300 transition-colors"
        >
          + Add Comment
        </button>
      </div>

      {/* Comments List */}
      <div className="divide-y divide-blue-500/10">
        {comments.map((comment) => (
          <div
            key={comment.id}
            className={`px-3 py-2 ${
              comment.resolved
                ? 'opacity-60'
                : comment.needsAttention
                  ? 'bg-red-500/10 border-l-2 border-red-500'
                  : ''
            }`}
          >
            <div className="flex items-start justify-between gap-2">
              <div className="flex-1 min-w-0">
                {/* Author & Time */}
                <div className="flex items-center gap-2 mb-1">
                  <span className="text-xs font-medium text-white">{comment.author}</span>
                  <span className="text-xs text-slate-500">
                    {formatTimestamp(comment.timestamp)}
                  </span>
                  {comment.resolved && <span className="text-xs text-green-400">‚úì Resolved</span>}
                  {comment.needsAttention && (
                    <span className="text-xs text-red-400">‚ö†Ô∏è Needs Attention</span>
                  )}
                </div>

                {/* Content */}
                <p className="text-sm text-slate-300 whitespace-pre-wrap break-words">
                  {comment.content}
                </p>
              </div>

              {/* Actions */}
              <div className="flex items-center gap-1 flex-shrink-0">
                <button
                  onClick={() => onResolveComment(comment.id)}
                  className={`p-1 rounded text-xs transition-colors ${
                    comment.resolved
                      ? 'text-yellow-400 hover:text-yellow-300'
                      : 'text-green-400 hover:text-green-300'
                  }`}
                  title={comment.resolved ? 'Unresolve' : 'Resolve'}
                >
                  {comment.resolved ? '‚Ü©Ô∏è' : '‚úì'}
                </button>
                <button
                  onClick={() => onMarkNeedsAttention(comment.id, !comment.needsAttention)}
                  className={`p-1 rounded text-xs transition-colors ${
                    comment.needsAttention
                      ? 'text-red-400 hover:text-red-300'
                      : 'text-slate-400 hover:text-slate-300'
                  }`}
                  title={comment.needsAttention ? 'Remove attention flag' : 'Mark needs attention'}
                >
                  ‚ö†Ô∏è
                </button>
                <button
                  onClick={() => {
                    if (window.confirm('Delete this comment?')) {
                      onDeleteComment(comment.id);
                    }
                  }}
                  className="p-1 rounded text-xs text-slate-400 hover:text-red-400 transition-colors"
                  title="Delete comment"
                >
                  üóëÔ∏è
                </button>
              </div>
            </div>
          </div>
        ))}
      </div>

      {/* Add Comment Form */}
      {isAdding && (
        <div className="px-3 py-3 border-t border-blue-500/20 bg-blue-500/5">
          <textarea
            autoFocus
            value={newComment}
            onChange={(e) => setNewComment(e.target.value)}
            onKeyDown={handleKeyDown}
            placeholder="Add a comment... (Ctrl+Enter to submit)"
            className="w-full px-3 py-2 rounded-lg bg-slate-800 border border-white/10 text-white text-sm placeholder-slate-500 focus:outline-none focus:ring-2 focus:ring-blue-500 resize-none"
            rows={2}
          />
          <div className="flex items-center justify-between mt-2">
            <span className="text-xs text-slate-500">
              Press Ctrl+Enter to submit, Escape to cancel
            </span>
            <div className="flex gap-2">
              <button
                onClick={() => {
                  setIsAdding(false);
                  setNewComment('');
                }}
                className="px-3 py-1 rounded text-xs text-slate-400 hover:text-white hover:bg-white/10 transition-all"
              >
                Cancel
              </button>
              <button
                onClick={handleSubmit}
                disabled={!newComment.trim()}
                className="px-3 py-1 rounded text-xs bg-blue-600 hover:bg-blue-700 text-white transition-all disabled:opacity-50 disabled:cursor-not-allowed"
              >
                Add Comment
              </button>
            </div>
          </div>
        </div>
      )}

      {/* Empty State */}
      {comments.length === 0 && !isAdding && (
        <div className="px-3 py-4 text-center">
          <p className="text-sm text-slate-400">No comments yet</p>
          <button
            onClick={() => setIsAdding(true)}
            className="mt-2 text-xs text-blue-400 hover:text-blue-300 transition-colors"
          >
            Add the first comment
          </button>
        </div>
      )}
    </div>
  );
}
</file>

<file path="src/components/review/EnhancedDiffViewer.tsx">
'use client';

import React, { useState, useCallback, useRef } from 'react';
import type { EnhancedDiffViewerProps, DiffHunk, DiffLine } from '@/types/review';
import { getStatusBgColor } from '@/types/review';
import HunkApprovalCard from './HunkApprovalCard';
import CommentThread from './CommentThread';

/**
 * EnhancedDiffViewer - Side-by-side diff comparison component
 *
 * Features:
 * - Side-by-side view of original and modified code
 * - Syntax highlighting indication through line coloring
 * - Line numbers
 * - Change indicators (added, removed, modified)
 * - Expandable context around changes
 * - Hunk-level approval/rejection
 * - Inline commenting
 */
export default function EnhancedDiffViewer({
  original,
  modified,
  fileName,
  language,
  hunks,
  onHunkApprove,
  onHunkReject,
  onAddComment,
  showLineNumbers = true,
  contextLines = 3,
}: EnhancedDiffViewerProps) {
  const [expandedHunks, setExpandedHunks] = useState<Set<string>>(new Set(hunks.map((h) => h.id)));
  const [commentingLine, setCommentingLine] = useState<{
    hunkId: string;
    lineNumber: number;
  } | null>(null);
  const [commentText, setCommentText] = useState('');
  const commentInputRef = useRef<HTMLTextAreaElement>(null);

  const toggleHunk = useCallback((hunkId: string) => {
    setExpandedHunks((prev) => {
      const next = new Set(prev);
      if (next.has(hunkId)) {
        next.delete(hunkId);
      } else {
        next.add(hunkId);
      }
      return next;
    });
  }, []);

  const handleLineClick = useCallback((hunkId: string, lineNumber: number) => {
    setCommentingLine({ hunkId, lineNumber });
    setCommentText('');
  }, []);

  const handleAddComment = useCallback(
    (content: string) => {
      if (commentingLine && content.trim()) {
        onAddComment(commentingLine.lineNumber, content.trim());
        setCommentingLine(null);
        setCommentText('');
      }
    },
    [commentingLine, onAddComment]
  );

  const handleSubmitComment = useCallback(() => {
    handleAddComment(commentText);
  }, [handleAddComment, commentText]);

  const getLineTypeClass = (type: DiffLine['type']): string => {
    switch (type) {
      case 'added':
        return 'bg-green-500/20 border-l-2 border-green-500';
      case 'removed':
        return 'bg-red-500/20 border-l-2 border-red-500';
      default:
        return 'bg-transparent';
    }
  };

  const getLineNumberClass = (type: DiffLine['type']): string => {
    switch (type) {
      case 'added':
        return 'text-green-400';
      case 'removed':
        return 'text-red-400';
      default:
        return 'text-slate-500';
    }
  };

  const getLanguageExtension = (): string => {
    const ext = fileName.split('.').pop() || '';
    const langMap: Record<string, string> = {
      ts: 'typescript',
      tsx: 'typescript',
      js: 'javascript',
      jsx: 'javascript',
      css: 'css',
      scss: 'scss',
      json: 'json',
      md: 'markdown',
      html: 'html',
    };
    return langMap[ext] || language || 'plaintext';
  };

  // If no hunks provided, create a simple diff view
  if (hunks.length === 0) {
    return (
      <div className="rounded-xl overflow-hidden border border-white/10 bg-slate-900">
        <div className="px-4 py-3 border-b border-white/10 bg-black/20">
          <div className="flex items-center gap-2">
            <span className="text-lg">üìÑ</span>
            <span className="text-white font-medium">{fileName}</span>
            <span className="text-xs text-slate-500 bg-slate-800 px-2 py-0.5 rounded">
              {getLanguageExtension()}
            </span>
          </div>
        </div>
        <div className="p-4 text-slate-400 text-sm">No changes to display</div>
      </div>
    );
  }

  return (
    <div className="rounded-xl overflow-hidden border border-white/10 bg-slate-900">
      {/* File Header */}
      <div className="px-4 py-3 border-b border-white/10 bg-black/20">
        <div className="flex items-center justify-between">
          <div className="flex items-center gap-2">
            <span className="text-lg">üìÑ</span>
            <span className="text-white font-medium">{fileName}</span>
            <span className="text-xs text-slate-500 bg-slate-800 px-2 py-0.5 rounded">
              {getLanguageExtension()}
            </span>
          </div>
          <div className="flex items-center gap-2 text-xs">
            <span className="flex items-center gap-1 text-green-400">
              <span className="w-2 h-2 bg-green-500 rounded-full"></span>
              {hunks.reduce(
                (sum, h) => sum + h.lines.filter((l) => l.type === 'added').length,
                0
              )}{' '}
              added
            </span>
            <span className="flex items-center gap-1 text-red-400">
              <span className="w-2 h-2 bg-red-500 rounded-full"></span>
              {hunks.reduce(
                (sum, h) => sum + h.lines.filter((l) => l.type === 'removed').length,
                0
              )}{' '}
              removed
            </span>
          </div>
        </div>
      </div>

      {/* Hunks */}
      <div className="divide-y divide-white/5">
        {hunks.map((hunk) => (
          <div key={hunk.id} className={`border-l-4 ${getStatusBgColor(hunk.status)}`}>
            {/* Hunk Header */}
            <HunkApprovalCard
              hunk={hunk}
              onApprove={() => onHunkApprove(hunk.id)}
              onReject={() => onHunkReject(hunk.id)}
              onReset={() => {}}
              expanded={expandedHunks.has(hunk.id)}
              onToggleExpand={() => toggleHunk(hunk.id)}
            />

            {/* Hunk Content */}
            {expandedHunks.has(hunk.id) && (
              <div className="overflow-x-auto">
                {/* Side-by-side view */}
                <div className="grid grid-cols-2 divide-x divide-white/10">
                  {/* Original (Left) */}
                  <div className="min-w-0">
                    <div className="px-3 py-1.5 bg-red-500/10 border-b border-white/5">
                      <span className="text-xs text-red-400 font-medium">Original</span>
                    </div>
                    <div className="font-mono text-xs">
                      {hunk.lines.map((line, idx) => (
                        <div
                          key={`orig-${idx}`}
                          className={`flex ${
                            line.type === 'removed'
                              ? 'bg-red-500/20'
                              : line.type === 'added'
                                ? 'opacity-0 h-0 overflow-hidden'
                                : 'bg-transparent'
                          }`}
                        >
                          {showLineNumbers && line.type !== 'added' && (
                            <span
                              className={`w-12 px-2 py-0.5 text-right select-none border-r border-white/5 ${getLineNumberClass(
                                line.type
                              )}`}
                            >
                              {line.originalNumber || line.number}
                            </span>
                          )}
                          {line.type !== 'added' && (
                            <span
                              className={`flex-1 px-3 py-0.5 whitespace-pre ${
                                line.type === 'removed' ? 'text-red-300' : 'text-slate-300'
                              }`}
                            >
                              {line.type === 'removed' && (
                                <span className="text-red-500 mr-1">-</span>
                              )}
                              {line.content}
                            </span>
                          )}
                        </div>
                      ))}
                    </div>
                  </div>

                  {/* Modified (Right) */}
                  <div className="min-w-0">
                    <div className="px-3 py-1.5 bg-green-500/10 border-b border-white/5">
                      <span className="text-xs text-green-400 font-medium">Modified</span>
                    </div>
                    <div className="font-mono text-xs">
                      {hunk.lines.map((line, idx) => (
                        <div
                          key={`mod-${idx}`}
                          className={`flex group ${
                            line.type === 'added'
                              ? 'bg-green-500/20'
                              : line.type === 'removed'
                                ? 'opacity-0 h-0 overflow-hidden'
                                : 'bg-transparent'
                          }`}
                        >
                          {showLineNumbers && line.type !== 'removed' && (
                            <span
                              className={`w-12 px-2 py-0.5 text-right select-none border-r border-white/5 ${getLineNumberClass(
                                line.type
                              )}`}
                            >
                              {line.modifiedNumber || line.number}
                            </span>
                          )}
                          {line.type !== 'removed' && (
                            <>
                              <span
                                className={`flex-1 px-3 py-0.5 whitespace-pre cursor-pointer hover:bg-white/5 ${
                                  line.type === 'added' ? 'text-green-300' : 'text-slate-300'
                                }`}
                                onClick={() => handleLineClick(hunk.id, line.number)}
                              >
                                {line.type === 'added' && (
                                  <span className="text-green-500 mr-1">+</span>
                                )}
                                {line.content}
                              </span>
                              <button
                                onClick={() => handleLineClick(hunk.id, line.number)}
                                className="opacity-0 group-hover:opacity-100 px-2 py-0.5 text-blue-400 hover:text-blue-300 transition-opacity"
                                title="Add comment"
                              >
                                üí¨
                              </button>
                            </>
                          )}
                        </div>
                      ))}
                    </div>
                  </div>
                </div>

                {/* Comment input */}
                {commentingLine?.hunkId === hunk.id && (
                  <div className="p-3 bg-blue-500/10 border-t border-blue-500/30">
                    <div className="flex items-start gap-2">
                      <span className="text-sm">üí¨</span>
                      <div className="flex-1">
                        <textarea
                          ref={commentInputRef}
                          autoFocus
                          value={commentText}
                          onChange={(e) => setCommentText(e.target.value)}
                          placeholder="Add a comment..."
                          className="w-full px-3 py-2 rounded-lg bg-slate-800 border border-white/10 text-white text-sm placeholder-slate-500 focus:outline-none focus:ring-2 focus:ring-blue-500 resize-none"
                          rows={2}
                          onKeyDown={(e) => {
                            if (e.key === 'Enter' && (e.ctrlKey || e.metaKey)) {
                              handleSubmitComment();
                            }
                            if (e.key === 'Escape') {
                              setCommentingLine(null);
                              setCommentText('');
                            }
                          }}
                        />
                        <div className="flex items-center justify-between mt-2">
                          <span className="text-xs text-slate-500">
                            Line {commentingLine.lineNumber}
                          </span>
                          <div className="flex gap-2">
                            <button
                              onClick={() => {
                                setCommentingLine(null);
                                setCommentText('');
                              }}
                              className="px-3 py-1 rounded text-xs text-slate-400 hover:text-white hover:bg-white/10 transition-all"
                            >
                              Cancel
                            </button>
                            <button
                              onClick={handleSubmitComment}
                              disabled={!commentText.trim()}
                              className="px-3 py-1 rounded text-xs bg-blue-600 hover:bg-blue-700 text-white transition-all disabled:opacity-50 disabled:cursor-not-allowed"
                            >
                              Add Comment
                            </button>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                )}

                {/* Existing comments */}
                {hunk.lines.some((l) => l.comments.length > 0) && (
                  <div className="p-3 bg-slate-800/50 border-t border-white/5">
                    {hunk.lines
                      .filter((l) => l.comments.length > 0)
                      .map((line) => (
                        <div key={line.number} className="mb-2 last:mb-0">
                          <CommentThread
                            comments={line.comments}
                            lineNumber={line.number}
                            onAddComment={(content) => onAddComment(line.number, content)}
                            onResolveComment={() => {}}
                            onDeleteComment={() => {}}
                            onMarkNeedsAttention={() => {}}
                          />
                        </div>
                      ))}
                  </div>
                )}
              </div>
            )}
          </div>
        ))}
      </div>
    </div>
  );
}
</file>

<file path="src/components/review/HunkApprovalCard.tsx">
'use client';

import React from 'react';
import type { HunkApprovalCardProps } from '@/types/review';
import {
  getCategoryDisplayName,
  getCategoryIcon,
  getStatusColor,
  getStatusBgColor,
} from '@/types/review';

/**
 * HunkApprovalCard - Individual hunk approval/rejection UI
 *
 * Features:
 * - Shows hunk summary and category
 * - Approve/Reject/Reset buttons
 * - Visual status indicators
 * - Expandable details
 */
export default function HunkApprovalCard({
  hunk,
  onApprove,
  onReject,
  onReset,
  expanded = true,
  onToggleExpand,
}: HunkApprovalCardProps) {
  const addedLines = hunk.lines.filter((l) => l.type === 'added').length;
  const removedLines = hunk.lines.filter((l) => l.type === 'removed').length;
  const unchangedLines = hunk.lines.filter((l) => l.type === 'unchanged').length;

  const getStatusIcon = () => {
    switch (hunk.status) {
      case 'approved':
        return '‚úÖ';
      case 'rejected':
        return '‚ùå';
      default:
        return '‚è≥';
    }
  };

  const getStatusLabel = () => {
    switch (hunk.status) {
      case 'approved':
        return 'Approved';
      case 'rejected':
        return 'Rejected';
      default:
        return 'Pending';
    }
  };

  const getTypeLabel = () => {
    switch (hunk.type) {
      case 'addition':
        return '‚ûï Addition';
      case 'deletion':
        return '‚ûñ Deletion';
      default:
        return 'üîÑ Modification';
    }
  };

  const getTypeColor = () => {
    switch (hunk.type) {
      case 'addition':
        return 'text-green-400';
      case 'deletion':
        return 'text-red-400';
      default:
        return 'text-yellow-400';
    }
  };

  return (
    <div className={`border ${getStatusBgColor(hunk.status)}`}>
      {/* Header */}
      <div className="px-4 py-3 flex items-center justify-between">
        <div className="flex items-center gap-3">
          {/* Expand/Collapse Button */}
          {onToggleExpand && (
            <button
              onClick={onToggleExpand}
              className="p-1 rounded hover:bg-white/10 transition-all"
              title={expanded ? 'Collapse' : 'Expand'}
            >
              <svg
                className={`w-4 h-4 text-slate-400 transition-transform ${
                  expanded ? 'rotate-90' : ''
                }`}
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
              >
                <path
                  strokeLinecap="round"
                  strokeLinejoin="round"
                  strokeWidth={2}
                  d="M9 5l7 7-7 7"
                />
              </svg>
            </button>
          )}

          {/* Status Icon */}
          <span className="text-xl">{getStatusIcon()}</span>

          {/* Hunk Info */}
          <div className="flex flex-col gap-0.5">
            <div className="flex items-center gap-2">
              <span className="text-white font-medium text-sm">
                {hunk.summary || `Lines ${hunk.startLine}-${hunk.endLine}`}
              </span>
              <span className={`text-xs ${getStatusColor(hunk.status)}`}>{getStatusLabel()}</span>
            </div>
            <div className="flex items-center gap-2 text-xs text-slate-400">
              <span className={getTypeColor()}>{getTypeLabel()}</span>
              <span>‚Ä¢</span>
              <span className="flex items-center gap-1">
                {getCategoryIcon(hunk.category)}
                {getCategoryDisplayName(hunk.category)}
              </span>
            </div>
          </div>
        </div>

        {/* Stats & Actions */}
        <div className="flex items-center gap-4">
          {/* Line Stats */}
          <div className="flex items-center gap-3 text-xs">
            {addedLines > 0 && <span className="text-green-400">+{addedLines}</span>}
            {removedLines > 0 && <span className="text-red-400">-{removedLines}</span>}
            {unchangedLines > 0 && (
              <span className="text-slate-500">{unchangedLines} unchanged</span>
            )}
          </div>

          {/* Action Buttons */}
          <div className="flex items-center gap-2">
            {hunk.status === 'pending' ? (
              <>
                <button
                  onClick={onReject}
                  className="px-3 py-1.5 rounded-lg bg-red-500/20 hover:bg-red-500/30 border border-red-500/30 text-red-400 text-xs font-medium transition-all hover:scale-105"
                  title="Reject this change"
                >
                  ‚ùå Reject
                </button>
                <button
                  onClick={onApprove}
                  className="px-3 py-1.5 rounded-lg bg-green-500/20 hover:bg-green-500/30 border border-green-500/30 text-green-400 text-xs font-medium transition-all hover:scale-105"
                  title="Approve this change"
                >
                  ‚úÖ Approve
                </button>
              </>
            ) : (
              <button
                onClick={onReset}
                className="px-3 py-1.5 rounded-lg bg-slate-500/20 hover:bg-slate-500/30 border border-slate-500/30 text-slate-400 text-xs font-medium transition-all hover:scale-105"
                title="Reset to pending"
              >
                üîÑ Reset
              </button>
            )}
          </div>
        </div>
      </div>

      {/* Optional Detailed Stats */}
      {expanded && (
        <div className="px-4 py-2 border-t border-white/5 bg-black/20 flex items-center gap-4 text-xs text-slate-500">
          <span>
            üìç Lines {hunk.startLine}‚Äì{hunk.endLine}
          </span>
          {hunk.lines.some((l) => l.comments.length > 0) && (
            <span className="flex items-center gap-1 text-blue-400">
              üí¨ {hunk.lines.reduce((sum, l) => sum + l.comments.length, 0)} comments
            </span>
          )}
        </div>
      )}
    </div>
  );
}
</file>

<file path="src/components/review/ImpactAnalysisPanel.tsx">
'use client';

import React, { useState } from 'react';
import type { ImpactAnalysisPanelProps } from '@/types/review';
import { getRiskLevelColor, getRiskLevelBgColor } from '@/types/review';

/**
 * ImpactAnalysisPanel - Displays change impact assessment
 *
 * Features:
 * - Files affected overview
 * - Components that may be impacted
 * - Potential breaking changes
 * - Risk level indicator
 * - Suggested testing areas
 */
export default function ImpactAnalysisPanel({
  analysis,
  expanded: initialExpanded = true,
  onToggleExpand,
}: ImpactAnalysisPanelProps) {
  const [expanded, setExpanded] = useState(initialExpanded);
  const [activeTab, setActiveTab] = useState<'files' | 'components' | 'breaking' | 'tests'>(
    'files'
  );

  const handleToggle = () => {
    setExpanded(!expanded);
    onToggleExpand?.();
  };

  const tabs = [
    { id: 'files', label: 'Files', icon: 'üìÅ', count: analysis.filesAffected.length },
    {
      id: 'components',
      label: 'Components',
      icon: '‚öõÔ∏è',
      count: analysis.componentsAffected.length,
    },
    { id: 'breaking', label: 'Breaking', icon: '‚ö†Ô∏è', count: analysis.breakingChanges.length },
    { id: 'tests', label: 'Tests', icon: 'üß™', count: analysis.suggestedTests.length },
  ] as const;

  return (
    <div
      className={`rounded-xl border overflow-hidden ${getRiskLevelBgColor(analysis.overallRisk)}`}
    >
      {/* Header */}
      <button
        onClick={handleToggle}
        className="w-full px-4 py-3 flex items-center justify-between hover:bg-white/5 transition-all"
      >
        <div className="flex items-center gap-3">
          <span className="text-xl">üìä</span>
          <div className="text-left">
            <h3 className="text-white font-semibold">Impact Analysis</h3>
            <p className="text-xs text-slate-400">
              {analysis.filesAffected.length} files ‚Ä¢ {analysis.componentsAffected.length}{' '}
              components
            </p>
          </div>
        </div>
        <div className="flex items-center gap-3">
          {/* Risk Badge */}
          <span
            className={`px-2 py-1 rounded-lg text-xs font-medium border ${getRiskLevelBgColor(
              analysis.overallRisk
            )} ${getRiskLevelColor(analysis.overallRisk)}`}
          >
            {analysis.overallRisk.toUpperCase()} RISK
          </span>
          {/* Expand Icon */}
          <svg
            className={`w-5 h-5 text-slate-400 transition-transform ${
              expanded ? 'rotate-180' : ''
            }`}
            fill="none"
            stroke="currentColor"
            viewBox="0 0 24 24"
          >
            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 9l-7 7-7-7" />
          </svg>
        </div>
      </button>

      {/* Content */}
      {expanded && (
        <div className="border-t border-white/10">
          {/* Tabs */}
          <div className="flex border-b border-white/10">
            {tabs.map((tab) => (
              <button
                key={tab.id}
                onClick={() => setActiveTab(tab.id)}
                className={`flex-1 px-3 py-2 text-xs font-medium transition-all ${
                  activeTab === tab.id
                    ? 'bg-white/10 text-white border-b-2 border-blue-500'
                    : 'text-slate-400 hover:text-white hover:bg-white/5'
                }`}
              >
                <span className="mr-1">{tab.icon}</span>
                {tab.label}
                {tab.count > 0 && (
                  <span
                    className={`ml-1 px-1.5 py-0.5 rounded-full text-xs ${
                      tab.id === 'breaking' && tab.count > 0
                        ? 'bg-red-500/20 text-red-400'
                        : 'bg-slate-700 text-slate-400'
                    }`}
                  >
                    {tab.count}
                  </span>
                )}
              </button>
            ))}
          </div>

          {/* Tab Content */}
          <div className="p-4 max-h-64 overflow-y-auto">
            {activeTab === 'files' && (
              <div className="space-y-2">
                {analysis.filesAffected.length === 0 ? (
                  <p className="text-sm text-slate-400 text-center py-4">No files affected</p>
                ) : (
                  analysis.filesAffected.map((file, idx) => (
                    <div
                      key={idx}
                      className="flex items-center gap-2 px-3 py-2 rounded-lg bg-black/20 border border-white/5"
                    >
                      <span className="text-blue-400">üìÑ</span>
                      <span className="text-sm text-slate-300 truncate">{file}</span>
                    </div>
                  ))
                )}
              </div>
            )}

            {activeTab === 'components' && (
              <div className="space-y-2">
                {analysis.componentsAffected.length === 0 ? (
                  <p className="text-sm text-slate-400 text-center py-4">No components affected</p>
                ) : (
                  analysis.componentsAffected.map((component, idx) => (
                    <div
                      key={idx}
                      className="flex items-center gap-2 px-3 py-2 rounded-lg bg-black/20 border border-white/5"
                    >
                      <span className="text-purple-400">‚öõÔ∏è</span>
                      <span className="text-sm text-slate-300">{component}</span>
                    </div>
                  ))
                )}
              </div>
            )}

            {activeTab === 'breaking' && (
              <div className="space-y-2">
                {analysis.breakingChanges.length === 0 ? (
                  <div className="text-center py-4">
                    <span className="text-3xl block mb-2">‚úÖ</span>
                    <p className="text-sm text-green-400">No breaking changes detected</p>
                  </div>
                ) : (
                  analysis.breakingChanges.map((change, idx) => (
                    <div
                      key={idx}
                      className="flex items-start gap-2 px-3 py-2 rounded-lg bg-red-500/10 border border-red-500/20"
                    >
                      <span className="text-red-400 flex-shrink-0">‚ö†Ô∏è</span>
                      <span className="text-sm text-red-300">{change}</span>
                    </div>
                  ))
                )}
              </div>
            )}

            {activeTab === 'tests' && (
              <div className="space-y-2">
                {analysis.suggestedTests.length === 0 ? (
                  <p className="text-sm text-slate-400 text-center py-4">No test suggestions</p>
                ) : (
                  analysis.suggestedTests.map((test, idx) => (
                    <div
                      key={idx}
                      className="flex items-start gap-2 px-3 py-2 rounded-lg bg-black/20 border border-white/5"
                    >
                      <span className="text-green-400 flex-shrink-0">üß™</span>
                      <span className="text-sm text-slate-300">{test}</span>
                    </div>
                  ))
                )}
              </div>
            )}
          </div>

          {/* Dependencies Footer */}
          {analysis.dependencies.length > 0 && (
            <div className="px-4 py-3 border-t border-white/10 bg-black/20">
              <div className="flex items-center gap-2 text-xs text-slate-400">
                <span>üì¶</span>
                <span>Dependencies:</span>
                <div className="flex flex-wrap gap-1">
                  {analysis.dependencies.slice(0, 5).map((dep, idx) => (
                    <span key={idx} className="px-1.5 py-0.5 rounded bg-slate-700 text-slate-300">
                      {dep}
                    </span>
                  ))}
                  {analysis.dependencies.length > 5 && (
                    <span className="text-slate-500">+{analysis.dependencies.length - 5} more</span>
                  )}
                </div>
              </div>
            </div>
          )}
        </div>
      )}
    </div>
  );
}
</file>

<file path="src/components/review/index.ts">
/**
 * Review Components - Export barrel
 *
 * Enhanced Review System components for code review and approval workflows.
 */

export { default as EnhancedDiffViewer } from './EnhancedDiffViewer';
export { default as HunkApprovalCard } from './HunkApprovalCard';
export { default as ReviewSidebar } from './ReviewSidebar';
export { default as ImpactAnalysisPanel } from './ImpactAnalysisPanel';
export { default as CommentThread } from './CommentThread';
export { default as RollbackHistory } from './RollbackHistory';
export { default as ReviewSummary } from './ReviewSummary';

// Re-export types for convenience
export type {
  EnhancedDiffViewerProps,
  HunkApprovalCardProps,
  ReviewSidebarProps,
  ReviewPanelProps,
  ImpactAnalysisPanelProps,
  CommentThreadProps,
  RollbackHistoryProps,
  ReviewSummaryProps,
} from '@/types/review';
</file>

<file path="src/components/review/ReviewSummary.tsx">
'use client';

import React from 'react';
import type { ReviewSummaryProps } from '@/types/review';
import {
  getCategoryDisplayName,
  getCategoryIcon,
  getRiskLevelColor,
  getRiskLevelBgColor,
} from '@/types/review';

/**
 * ReviewSummary - Overview of approved/rejected changes
 *
 * Features:
 * - Summary statistics
 * - Progress visualization
 * - Category breakdown
 * - Apply approved changes button
 * - Impact warning for high-risk changes
 */
export default function ReviewSummary({
  changes,
  totalHunks,
  approvedHunks,
  rejectedHunks,
  pendingHunks,
  impactAnalysis,
  onApplyApproved,
}: ReviewSummaryProps) {
  const approvalPercentage = totalHunks > 0 ? Math.round((approvedHunks / totalHunks) * 100) : 0;
  const rejectionPercentage = totalHunks > 0 ? Math.round((rejectedHunks / totalHunks) * 100) : 0;
  const pendingPercentage = totalHunks > 0 ? Math.round((pendingHunks / totalHunks) * 100) : 0;

  // Group changes by category
  const byCategory = changes.reduce(
    (acc, change) => {
      const cat = change.category;
      if (!acc[cat]) acc[cat] = { count: 0, hunks: 0, approved: 0 };
      acc[cat].count++;
      acc[cat].hunks += change.hunks.length;
      acc[cat].approved += change.hunks.filter((h) => h.status === 'approved').length;
      return acc;
    },
    {} as Record<string, { count: number; hunks: number; approved: number }>
  );

  const canApply = approvedHunks > 0;
  const hasHighRisk = impactAnalysis.overallRisk === 'high';
  const hasBreakingChanges = impactAnalysis.breakingChanges.length > 0;

  return (
    <div className="rounded-xl border border-white/10 bg-slate-900 overflow-hidden">
      {/* Header */}
      <div className="px-4 py-3 border-b border-white/10 bg-gradient-to-r from-blue-500/20 to-purple-500/20">
        <div className="flex items-center justify-between">
          <div className="flex items-center gap-2">
            <span className="text-xl">üìã</span>
            <h3 className="text-white font-semibold">Review Summary</h3>
          </div>
          <span
            className={`px-2 py-1 rounded-lg text-xs font-medium border ${getRiskLevelBgColor(
              impactAnalysis.overallRisk
            )} ${getRiskLevelColor(impactAnalysis.overallRisk)}`}
          >
            {impactAnalysis.overallRisk.toUpperCase()} RISK
          </span>
        </div>
      </div>

      {/* Progress Overview */}
      <div className="p-4 border-b border-white/10">
        <div className="flex items-center justify-between mb-3">
          <span className="text-sm text-slate-400">Review Progress</span>
          <span className="text-sm text-white font-medium">
            {approvedHunks + rejectedHunks} / {totalHunks} reviewed
          </span>
        </div>

        {/* Progress Bar */}
        <div className="h-3 bg-slate-700 rounded-full overflow-hidden flex">
          {approvedHunks > 0 && (
            <div
              className="h-full bg-green-500 transition-all"
              style={{ width: `${approvalPercentage}%` }}
            />
          )}
          {rejectedHunks > 0 && (
            <div
              className="h-full bg-red-500 transition-all"
              style={{ width: `${rejectionPercentage}%` }}
            />
          )}
          {pendingHunks > 0 && (
            <div
              className="h-full bg-slate-500 transition-all"
              style={{ width: `${pendingPercentage}%` }}
            />
          )}
        </div>

        {/* Stats */}
        <div className="flex items-center justify-between mt-3 text-xs">
          <div className="flex items-center gap-1 text-green-400">
            <span className="w-2 h-2 bg-green-500 rounded-full"></span>
            <span>
              {approvedHunks} Approved ({approvalPercentage}%)
            </span>
          </div>
          <div className="flex items-center gap-1 text-red-400">
            <span className="w-2 h-2 bg-red-500 rounded-full"></span>
            <span>
              {rejectedHunks} Rejected ({rejectionPercentage}%)
            </span>
          </div>
          <div className="flex items-center gap-1 text-slate-400">
            <span className="w-2 h-2 bg-slate-500 rounded-full"></span>
            <span>
              {pendingHunks} Pending ({pendingPercentage}%)
            </span>
          </div>
        </div>
      </div>

      {/* Category Breakdown */}
      <div className="p-4 border-b border-white/10">
        <h4 className="text-sm text-slate-400 mb-3">By Category</h4>
        <div className="grid grid-cols-2 gap-2">
          {Object.entries(byCategory).map(([category, data]) => (
            <div key={category} className="px-3 py-2 rounded-lg bg-black/20 border border-white/5">
              <div className="flex items-center justify-between">
                <span className="text-xs text-slate-300">
                  {getCategoryIcon(category as any)} {getCategoryDisplayName(category as any)}
                </span>
                <span className="text-xs text-slate-500">{data.count} files</span>
              </div>
              <div className="flex items-center gap-2 mt-1">
                <div className="flex-1 h-1 bg-slate-700 rounded-full overflow-hidden">
                  <div
                    className="h-full bg-green-500"
                    style={{
                      width: `${data.hunks > 0 ? (data.approved / data.hunks) * 100 : 0}%`,
                    }}
                  />
                </div>
                <span className="text-xs text-green-400">
                  {data.approved}/{data.hunks}
                </span>
              </div>
            </div>
          ))}
        </div>
      </div>

      {/* Warnings */}
      {(hasHighRisk || hasBreakingChanges) && (
        <div className="p-4 border-b border-white/10 bg-yellow-500/10">
          <div className="flex items-start gap-2">
            <span className="text-xl">‚ö†Ô∏è</span>
            <div className="flex-1">
              <h4 className="text-yellow-400 font-medium text-sm mb-1">Review Carefully</h4>
              <ul className="text-xs text-yellow-300/80 space-y-1">
                {hasHighRisk && (
                  <li>‚Ä¢ This includes high-risk changes that may affect critical functionality</li>
                )}
                {hasBreakingChanges && (
                  <li>
                    ‚Ä¢ {impactAnalysis.breakingChanges.length} potential breaking change
                    {impactAnalysis.breakingChanges.length > 1 ? 's' : ''} detected
                  </li>
                )}
              </ul>
            </div>
          </div>
        </div>
      )}

      {/* Files Summary */}
      <div className="p-4 border-b border-white/10">
        <h4 className="text-sm text-slate-400 mb-2">Files</h4>
        <div className="flex items-center gap-3 text-xs">
          <span className="text-white">üìÅ {impactAnalysis.filesAffected.length} affected</span>
          <span className="text-purple-400">
            ‚öõÔ∏è {impactAnalysis.componentsAffected.length} components
          </span>
          {impactAnalysis.suggestedTests.length > 0 && (
            <span className="text-green-400">
              üß™ {impactAnalysis.suggestedTests.length} suggested tests
            </span>
          )}
        </div>
      </div>

      {/* Apply Button */}
      <div className="p-4 bg-black/20">
        <button
          onClick={onApplyApproved}
          disabled={!canApply}
          className={`w-full px-4 py-3 rounded-xl font-medium transition-all flex items-center justify-center gap-2 ${
            canApply
              ? 'bg-gradient-to-r from-green-500 to-emerald-600 hover:from-green-600 hover:to-emerald-700 text-white shadow-lg hover:shadow-green-500/20'
              : 'bg-slate-700 text-slate-500 cursor-not-allowed'
          }`}
        >
          <span>‚úÖ</span>
          <span>
            {canApply
              ? `Apply ${approvedHunks} Approved Change${approvedHunks > 1 ? 's' : ''}`
              : 'No Changes to Apply'}
          </span>
        </button>

        {pendingHunks > 0 && (
          <p className="text-xs text-center text-slate-500 mt-2">
            {pendingHunks} hunk{pendingHunks > 1 ? 's' : ''} still pending review
          </p>
        )}
      </div>
    </div>
  );
}
</file>

<file path="src/components/review/RollbackHistory.tsx">
'use client';

import React, { useState } from 'react';
import type { RollbackHistoryProps } from '@/types/review';

/**
 * RollbackHistory - Restore points UI
 *
 * Features:
 * - List of restore points with timestamps
 * - One-click rollback to any point
 * - Rollback individual files
 * - Delete restore points
 * - Storage management info
 */
export default function RollbackHistory({
  restorePoints,
  onRollbackTo,
  onRollbackFile,
  onDeletePoint,
  maxRestorePoints = 10,
}: RollbackHistoryProps) {
  const [expandedPoint, setExpandedPoint] = useState<string | null>(null);
  const [confirmingRollback, setConfirmingRollback] = useState<string | null>(null);

  const formatTimestamp = (date: Date): string => {
    return new Date(date).toLocaleString(undefined, {
      month: 'short',
      day: 'numeric',
      hour: '2-digit',
      minute: '2-digit',
    });
  };

  const formatRelativeTime = (date: Date): string => {
    const now = new Date();
    const diff = now.getTime() - new Date(date).getTime();
    const minutes = Math.floor(diff / 60000);
    const hours = Math.floor(minutes / 60);
    const days = Math.floor(hours / 24);

    if (days > 0) return `${days} day${days > 1 ? 's' : ''} ago`;
    if (hours > 0) return `${hours} hour${hours > 1 ? 's' : ''} ago`;
    if (minutes > 0) return `${minutes} minute${minutes > 1 ? 's' : ''} ago`;
    return 'Just now';
  };

  const handleRollback = (pointId: string) => {
    if (confirmingRollback === pointId) {
      onRollbackTo(pointId);
      setConfirmingRollback(null);
    } else {
      setConfirmingRollback(pointId);
      // Auto-cancel confirmation after 3 seconds
      setTimeout(() => setConfirmingRollback(null), 3000);
    }
  };

  const toggleExpand = (pointId: string) => {
    setExpandedPoint(expandedPoint === pointId ? null : pointId);
  };

  return (
    <div className="rounded-xl border border-white/10 bg-slate-900 overflow-hidden">
      {/* Header */}
      <div className="px-4 py-3 border-b border-white/10 bg-black/20">
        <div className="flex items-center justify-between">
          <div className="flex items-center gap-2">
            <span className="text-xl">üïí</span>
            <h3 className="text-white font-semibold">Rollback History</h3>
            <span className="text-xs bg-slate-700 text-slate-400 px-2 py-0.5 rounded-full">
              {restorePoints.length} / {maxRestorePoints}
            </span>
          </div>
          {restorePoints.length > 0 && (
            <span className="text-xs text-slate-500">
              Oldest points auto-removed when limit reached
            </span>
          )}
        </div>
      </div>

      {/* Restore Points List */}
      <div className="max-h-96 overflow-y-auto">
        {restorePoints.length === 0 ? (
          <div className="p-6 text-center">
            <span className="text-4xl block mb-2">üì≠</span>
            <p className="text-sm text-slate-400">No restore points yet</p>
            <p className="text-xs text-slate-500 mt-1">
              Restore points are created automatically before applying changes
            </p>
          </div>
        ) : (
          <div className="divide-y divide-white/5">
            {restorePoints.map((point, idx) => (
              <div key={point.id} className="p-3 hover:bg-white/5 transition-all">
                {/* Point Header */}
                <div className="flex items-start justify-between">
                  <button
                    onClick={() => toggleExpand(point.id)}
                    className="flex items-start gap-3 text-left flex-1"
                  >
                    {/* Index Badge */}
                    <span
                      className={`w-6 h-6 rounded-full flex items-center justify-center text-xs font-medium ${
                        idx === 0
                          ? 'bg-green-500/20 text-green-400 border border-green-500/30'
                          : 'bg-slate-700 text-slate-400'
                      }`}
                    >
                      {idx === 0 ? '‚úì' : idx + 1}
                    </span>

                    {/* Point Info */}
                    <div className="flex-1 min-w-0">
                      <div className="flex items-center gap-2">
                        <span className="text-white font-medium text-sm truncate">
                          {point.label}
                        </span>
                        {idx === 0 && (
                          <span className="text-xs bg-green-500/20 text-green-400 px-1.5 py-0.5 rounded">
                            Latest
                          </span>
                        )}
                      </div>
                      <div className="flex items-center gap-2 mt-1 text-xs text-slate-400">
                        <span>{formatTimestamp(point.timestamp)}</span>
                        <span>‚Ä¢</span>
                        <span>{formatRelativeTime(point.timestamp)}</span>
                      </div>
                      <div className="flex items-center gap-2 mt-1 text-xs text-slate-500">
                        <span>üìÅ {point.metadata.filesChanged} files</span>
                        {point.metadata.approvedHunks !== undefined && (
                          <>
                            <span>‚Ä¢</span>
                            <span className="text-green-400">‚úì {point.metadata.approvedHunks}</span>
                          </>
                        )}
                        {point.metadata.rejectedHunks !== undefined && (
                          <>
                            <span>‚Ä¢</span>
                            <span className="text-red-400">‚úó {point.metadata.rejectedHunks}</span>
                          </>
                        )}
                      </div>
                    </div>

                    {/* Expand Arrow */}
                    <svg
                      className={`w-4 h-4 text-slate-400 transition-transform ${
                        expandedPoint === point.id ? 'rotate-180' : ''
                      }`}
                      fill="none"
                      stroke="currentColor"
                      viewBox="0 0 24 24"
                    >
                      <path
                        strokeLinecap="round"
                        strokeLinejoin="round"
                        strokeWidth={2}
                        d="M19 9l-7 7-7-7"
                      />
                    </svg>
                  </button>

                  {/* Actions */}
                  <div className="flex items-center gap-2 ml-2">
                    <button
                      onClick={() => handleRollback(point.id)}
                      className={`px-3 py-1.5 rounded-lg text-xs font-medium transition-all ${
                        confirmingRollback === point.id
                          ? 'bg-yellow-500 text-black animate-pulse'
                          : 'bg-blue-500/20 text-blue-400 hover:bg-blue-500/30 border border-blue-500/30'
                      }`}
                    >
                      {confirmingRollback === point.id ? 'Confirm?' : 'üîÑ Rollback'}
                    </button>
                    <button
                      onClick={() => {
                        if (window.confirm(`Delete restore point "${point.label}"?`)) {
                          onDeletePoint(point.id);
                        }
                      }}
                      className="p-1.5 rounded-lg text-slate-400 hover:text-red-400 hover:bg-red-500/10 transition-all"
                      title="Delete restore point"
                    >
                      üóëÔ∏è
                    </button>
                  </div>
                </div>

                {/* Expanded Files List */}
                {expandedPoint === point.id && (
                  <div className="mt-3 ml-9 space-y-1">
                    <p className="text-xs text-slate-400 mb-2">Files in this restore point:</p>
                    {point.files.slice(0, 10).map((file, fileIdx) => (
                      <div
                        key={fileIdx}
                        className="flex items-center justify-between px-3 py-2 rounded-lg bg-black/20 border border-white/5"
                      >
                        <div className="flex items-center gap-2 min-w-0">
                          <span className="text-slate-400">üìÑ</span>
                          <span className="text-sm text-slate-300 truncate">{file.path}</span>
                        </div>
                        <button
                          onClick={() => onRollbackFile(point.id, file.path)}
                          className="text-xs text-blue-400 hover:text-blue-300 px-2 py-1 rounded hover:bg-blue-500/10 transition-all flex-shrink-0"
                        >
                          Restore
                        </button>
                      </div>
                    ))}
                    {point.files.length > 10 && (
                      <p className="text-xs text-slate-500 px-3 py-1">
                        +{point.files.length - 10} more files
                      </p>
                    )}
                  </div>
                )}
              </div>
            ))}
          </div>
        )}
      </div>

      {/* Footer */}
      {restorePoints.length > 0 && (
        <div className="px-4 py-3 border-t border-white/10 bg-black/20">
          <div className="flex items-center justify-between text-xs text-slate-500">
            <span className="flex items-center gap-1">
              <span>üí°</span>
              Click a restore point to see files, then rollback all or individual files
            </span>
          </div>
        </div>
      )}
    </div>
  );
}
</file>

<file path="src/components/storage/FileActions.tsx">
'use client';

import React from 'react';

interface FileActionsProps {
  selectedCount: number;
  onBulkDownload?: () => void;
  onBulkDelete?: () => void;
  onSelectAll?: () => void;
  onDeselectAll?: () => void;
  disabled?: boolean;
}

/**
 * FileActions Component
 *
 * Provides bulk action controls for selected files.
 * Includes download, delete, and selection management.
 */
export function FileActions({
  selectedCount,
  onBulkDownload,
  onBulkDelete,
  onSelectAll,
  onDeselectAll,
  disabled = false,
}: FileActionsProps) {
  if (selectedCount === 0) {
    return null;
  }

  return (
    <div className="sticky top-0 z-10 bg-gradient-to-r from-blue-600/20 to-purple-600/20 backdrop-blur-sm border border-blue-500/30 rounded-xl p-4 shadow-lg">
      <div className="flex flex-wrap items-center justify-between gap-3">
        {/* Selection Info */}
        <div className="flex items-center gap-3">
          <span className="text-blue-200 font-semibold">
            {selectedCount} {selectedCount === 1 ? 'file' : 'files'} selected
          </span>
          {onDeselectAll && (
            <button
              onClick={onDeselectAll}
              className="px-2 py-1 rounded text-xs text-blue-300 hover:text-white hover:bg-white/10 transition-all"
              disabled={disabled}
            >
              Clear Selection
            </button>
          )}
        </div>

        {/* Bulk Actions */}
        <div className="flex gap-2">
          {onSelectAll && (
            <button
              onClick={onSelectAll}
              className="px-3 py-1.5 rounded-lg bg-white/10 hover:bg-white/20 text-white text-sm font-medium transition-all flex items-center gap-2 disabled:opacity-50 disabled:cursor-not-allowed"
              disabled={disabled}
            >
              <span>‚òëÔ∏è</span>
              <span>Select All</span>
            </button>
          )}

          {onBulkDownload && (
            <button
              onClick={onBulkDownload}
              className="px-3 py-1.5 rounded-lg bg-blue-600 hover:bg-blue-700 text-white text-sm font-medium transition-all flex items-center gap-2 disabled:opacity-50 disabled:cursor-not-allowed"
              disabled={disabled}
            >
              <span>üì•</span>
              <span>Download</span>
            </button>
          )}

          {onBulkDelete && (
            <button
              onClick={() => {
                if (
                  window.confirm(
                    `Delete ${selectedCount} ${selectedCount === 1 ? 'file' : 'files'}?`
                  )
                ) {
                  onBulkDelete();
                }
              }}
              className="px-3 py-1.5 rounded-lg bg-red-600 hover:bg-red-700 text-white text-sm font-medium transition-all flex items-center gap-2 disabled:opacity-50 disabled:cursor-not-allowed"
              disabled={disabled}
            >
              <span>üóëÔ∏è</span>
              <span>Delete</span>
            </button>
          )}
        </div>
      </div>
    </div>
  );
}
</file>

<file path="src/components/storage/FileCard.tsx">
'use client';

import React from 'react';
import type { FileMetadata } from '@/types/storage';

interface FileCardProps {
  file: FileMetadata;
  isSelected?: boolean;
  onSelect?: (file: FileMetadata) => void;
  onDownload?: (file: FileMetadata) => void;
  onDelete?: (file: FileMetadata) => void;
  onCopyLink?: (file: FileMetadata) => void;
  isLoading?: boolean;
}

/**
 * FileCard Component
 *
 * Displays individual file information with preview, metadata, and actions.
 * Supports keyboard navigation and accessibility.
 */
export function FileCard({
  file,
  isSelected = false,
  onSelect,
  onDownload,
  onDelete,
  onCopyLink,
  isLoading = false,
}: FileCardProps) {
  // Determine if file is an image based on MIME type
  const isImage = file.mimeType.startsWith('image/');

  // Format file size for display
  const formatSize = (bytes: number): string => {
    const units = ['B', 'KB', 'MB', 'GB'];
    let size = bytes;
    let unitIndex = 0;

    while (size >= 1024 && unitIndex < units.length - 1) {
      size /= 1024;
      unitIndex++;
    }

    return `${size.toFixed(1)} ${units[unitIndex]}`;
  };

  // Format date for display
  const formatDate = (dateString: string): string => {
    const date = new Date(dateString);
    const now = new Date();
    const diffMs = now.getTime() - date.getTime();
    const diffDays = Math.floor(diffMs / (1000 * 60 * 60 * 24));

    if (diffDays === 0) return 'Today';
    if (diffDays === 1) return 'Yesterday';
    if (diffDays < 7) return `${diffDays} days ago`;

    return date.toLocaleDateString();
  };

  // Get file icon based on MIME type
  const getFileIcon = (): string => {
    if (file.mimeType.startsWith('image/')) return 'üñºÔ∏è';
    if (file.mimeType.startsWith('video/')) return 'üé•';
    if (file.mimeType.startsWith('audio/')) return 'üéµ';
    if (file.mimeType === 'application/pdf') return 'üìÑ';
    if (file.mimeType.includes('text/')) return 'üìù';
    if (file.mimeType.includes('json')) return '{}';
    if (file.mimeType.includes('html')) return 'üåê';
    if (file.mimeType.includes('javascript')) return '‚ö°';
    return 'üìé';
  };

  return (
    <div
      className={`
        relative group rounded-xl border transition-all duration-300
        ${
          isSelected
            ? 'bg-blue-500/20 border-blue-500/60 shadow-lg shadow-blue-500/20'
            : 'bg-white/5 border-white/10 hover:bg-white/10 hover:border-white/20'
        }
        ${isLoading ? 'opacity-50 pointer-events-none' : ''}
        ${onSelect ? 'cursor-pointer' : ''}
      `}
      onClick={() => onSelect?.(file)}
      role="article"
      aria-label={`File: ${file.name}`}
      tabIndex={0}
      onKeyDown={(e) => {
        if (e.key === 'Enter' || e.key === ' ') {
          e.preventDefault();
          onSelect?.(file);
        }
      }}
    >
      {/* Loading Overlay */}
      {isLoading && (
        <div className="absolute inset-0 bg-black/40 rounded-xl flex items-center justify-center z-10">
          <div className="flex gap-1">
            <div
              className="w-2 h-2 bg-blue-500 rounded-full animate-bounce"
              style={{ animationDelay: '0ms' }}
            ></div>
            <div
              className="w-2 h-2 bg-blue-500 rounded-full animate-bounce"
              style={{ animationDelay: '150ms' }}
            ></div>
            <div
              className="w-2 h-2 bg-blue-500 rounded-full animate-bounce"
              style={{ animationDelay: '300ms' }}
            ></div>
          </div>
        </div>
      )}

      {/* File Preview */}
      <div className="aspect-square rounded-t-xl bg-slate-800/50 flex items-center justify-center overflow-hidden">
        {isImage && file.publicUrl ? (
          <img
            src={file.publicUrl}
            alt={file.name}
            className="w-full h-full object-cover"
            loading="lazy"
          />
        ) : (
          <div className="text-6xl">{getFileIcon()}</div>
        )}
      </div>

      {/* File Info */}
      <div className="p-4">
        {/* File Name */}
        <h3
          className="text-white font-medium text-sm truncate mb-1 group-hover:text-blue-400 transition-colors"
          title={file.name}
        >
          {file.name}
        </h3>

        {/* File Metadata */}
        <div className="flex items-center gap-2 text-xs text-slate-400 mb-3">
          <span>{formatSize(file.size)}</span>
          <span>‚Ä¢</span>
          <span>{formatDate(file.createdAt)}</span>
        </div>

        {/* Action Buttons */}
        <div className="flex gap-2">
          {onDownload && (
            <button
              onClick={(e) => {
                e.stopPropagation();
                onDownload(file);
              }}
              className="flex-1 px-3 py-2 rounded-lg bg-blue-600 hover:bg-blue-700 text-white text-xs font-medium transition-all flex items-center justify-center gap-1"
              title="Download file"
              aria-label={`Download ${file.name}`}
            >
              <span>üì•</span>
              <span>Download</span>
            </button>
          )}

          {onCopyLink && (
            <button
              onClick={(e) => {
                e.stopPropagation();
                onCopyLink(file);
              }}
              className="px-3 py-2 rounded-lg bg-white/5 hover:bg-white/10 border border-white/10 hover:border-white/20 text-slate-300 hover:text-white text-xs transition-all"
              title="Copy link"
              aria-label={`Copy link for ${file.name}`}
            >
              <span>üîó</span>
            </button>
          )}

          {onDelete && (
            <button
              onClick={(e) => {
                e.stopPropagation();
                onDelete(file);
              }}
              className="px-3 py-2 rounded-lg bg-white/5 hover:bg-red-500/20 border border-white/10 hover:border-red-500/40 text-slate-300 hover:text-red-400 text-xs transition-all"
              title="Delete file"
              aria-label={`Delete ${file.name}`}
            >
              <span>üóëÔ∏è</span>
            </button>
          )}
        </div>
      </div>

      {/* Selection Indicator */}
      {isSelected && (
        <div className="absolute top-3 right-3 w-6 h-6 bg-blue-500 rounded-full flex items-center justify-center shadow-lg">
          <span className="text-white text-xs">‚úì</span>
        </div>
      )}
    </div>
  );
}
</file>

<file path="src/components/storage/FileFilters.tsx">
'use client';

import React from 'react';

interface FileFiltersProps {
  searchQuery: string;
  onSearchChange: (query: string) => void;
  selectedType: string;
  onTypeChange: (type: string) => void;
  sortBy: 'name' | 'size' | 'created_at' | 'updated_at';
  sortOrder: 'asc' | 'desc';
  onSortChange: (
    sortBy: 'name' | 'size' | 'created_at' | 'updated_at',
    order: 'asc' | 'desc'
  ) => void;
  onClearFilters: () => void;
  fileTypes?: string[];
}

/**
 * FileFilters Component
 *
 * Provides search, filtering, and sorting controls for files.
 * Includes type filtering and sort options.
 */
export function FileFilters({
  searchQuery,
  onSearchChange,
  selectedType,
  onTypeChange,
  sortBy,
  sortOrder,
  onSortChange,
  onClearFilters,
  fileTypes = ['all', 'image', 'video', 'document', 'other'],
}: FileFiltersProps) {
  const hasActiveFilters =
    searchQuery !== '' || selectedType !== 'all' || sortBy !== 'created_at' || sortOrder !== 'desc';

  const typeIcons: Record<string, string> = {
    all: 'üìÅ',
    image: 'üñºÔ∏è',
    video: 'üé•',
    audio: 'üéµ',
    document: 'üìÑ',
    other: 'üìé',
  };

  const sortOptions: Array<{
    value: 'name' | 'size' | 'created_at' | 'updated_at';
    label: string;
  }> = [
    { value: 'name', label: 'Name' },
    { value: 'size', label: 'Size' },
    { value: 'created_at', label: 'Upload Date' },
    { value: 'updated_at', label: 'Modified Date' },
  ];

  return (
    <div className="space-y-3">
      {/* Search Bar */}
      <div className="relative">
        <input
          type="text"
          value={searchQuery}
          onChange={(e) => onSearchChange(e.target.value)}
          placeholder="Search files..."
          className="w-full px-4 py-2.5 pl-10 rounded-lg glass-panel border border-white/20 text-white placeholder-slate-500 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500/60 transition-all duration-300"
          aria-label="Search files"
        />
        <span className="absolute left-3 top-1/2 -translate-y-1/2 text-slate-400">üîç</span>
        {searchQuery && (
          <button
            onClick={() => onSearchChange('')}
            className="absolute right-3 top-1/2 -translate-y-1/2 text-slate-400 hover:text-white transition-colors"
            aria-label="Clear search"
          >
            ‚úï
          </button>
        )}
      </div>

      <div className="flex flex-wrap gap-3">
        {/* File Type Filter */}
        <div className="flex gap-2">
          {fileTypes.map((type) => (
            <button
              key={type}
              onClick={() => onTypeChange(type)}
              className={`
                px-3 py-1.5 rounded-lg text-sm font-medium transition-all duration-200
                ${
                  selectedType === type
                    ? 'bg-blue-600 text-white shadow-lg shadow-blue-500/20'
                    : 'bg-white/5 text-slate-300 hover:bg-white/10 hover:text-white border border-white/10'
                }
              `}
              aria-label={`Filter by ${type}`}
              aria-pressed={selectedType === type}
            >
              <span className="mr-1">{typeIcons[type] || 'üìé'}</span>
              <span className="capitalize">{type}</span>
            </button>
          ))}
        </div>

        {/* Sort Controls */}
        <div className="flex gap-2 ml-auto">
          <select
            value={sortBy}
            onChange={(e) => onSortChange(e.target.value as any, sortOrder)}
            className="px-3 py-1.5 rounded-lg bg-white/5 border border-white/10 text-white text-sm focus:outline-none focus:ring-2 focus:ring-blue-500"
            aria-label="Sort by"
          >
            {sortOptions.map((option) => (
              <option key={option.value} value={option.value} className="bg-slate-800">
                {option.label}
              </option>
            ))}
          </select>

          <button
            onClick={() => onSortChange(sortBy, sortOrder === 'asc' ? 'desc' : 'asc')}
            className="px-3 py-1.5 rounded-lg bg-white/5 border border-white/10 text-white hover:bg-white/10 transition-all"
            aria-label={`Sort ${sortOrder === 'asc' ? 'descending' : 'ascending'}`}
            title={`Sort ${sortOrder === 'asc' ? 'descending' : 'ascending'}`}
          >
            {sortOrder === 'asc' ? '‚Üë' : '‚Üì'}
          </button>

          {hasActiveFilters && (
            <button
              onClick={onClearFilters}
              className="px-3 py-1.5 rounded-lg bg-red-500/20 border border-red-500/40 text-red-300 hover:bg-red-500/30 hover:text-red-200 text-sm font-medium transition-all"
              aria-label="Clear all filters"
            >
              Clear Filters
            </button>
          )}
        </div>
      </div>
    </div>
  );
}
</file>

<file path="src/components/storage/FileGrid.tsx">
'use client';

import React from 'react';
import { FileCard } from './FileCard';
import type { FileMetadata } from '@/types/storage';

interface FileGridProps {
  files: FileMetadata[];
  selectedFiles?: Set<string>;
  onSelectFile?: (file: FileMetadata) => void;
  onDownload?: (file: FileMetadata) => void;
  onDelete?: (file: FileMetadata) => void;
  onCopyLink?: (file: FileMetadata) => void;
  loadingFileIds?: Set<string>;
  isLoading?: boolean;
  emptyMessage?: string;
}

/**
 * FileGrid Component
 *
 * Displays files in a responsive grid layout.
 * Supports selection, actions, and loading states.
 */
export function FileGrid({
  files,
  selectedFiles = new Set(),
  onSelectFile,
  onDownload,
  onDelete,
  onCopyLink,
  loadingFileIds = new Set(),
  isLoading = false,
  emptyMessage = 'No files yet. Upload your first file to get started!',
}: FileGridProps) {
  // Show loading skeleton
  if (isLoading) {
    return (
      <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4">
        {[...Array(8)].map((_, i) => (
          <div
            key={i}
            className="rounded-xl border border-white/10 bg-white/5 overflow-hidden animate-pulse"
          >
            <div className="aspect-square bg-slate-800/50" />
            <div className="p-4 space-y-3">
              <div className="h-4 bg-slate-700/50 rounded w-3/4" />
              <div className="h-3 bg-slate-700/50 rounded w-1/2" />
              <div className="flex gap-2">
                <div className="flex-1 h-8 bg-slate-700/50 rounded" />
                <div className="w-8 h-8 bg-slate-700/50 rounded" />
              </div>
            </div>
          </div>
        ))}
      </div>
    );
  }

  // Show empty state
  if (files.length === 0) {
    return (
      <div className="flex flex-col items-center justify-center py-16 px-4">
        <div className="text-6xl mb-4">üìÅ</div>
        <h3 className="text-xl font-semibold text-white mb-2">No Files Found</h3>
        <p className="text-slate-400 text-center max-w-md">{emptyMessage}</p>
      </div>
    );
  }

  return (
    <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4">
      {files.map((file) => (
        <FileCard
          key={file.id}
          file={file}
          isSelected={selectedFiles.has(file.id)}
          onSelect={onSelectFile}
          onDownload={onDownload}
          onDelete={onDelete}
          onCopyLink={onCopyLink}
          isLoading={loadingFileIds.has(file.id)}
        />
      ))}
    </div>
  );
}
</file>

<file path="src/components/storage/FileUploader.tsx">
'use client';

import React, { useState, useRef } from 'react';

interface UploadProgress {
  file: File;
  progress: number;
  status: 'pending' | 'uploading' | 'success' | 'error';
  error?: string;
}

interface FileUploaderProps {
  onUpload: (files: File[]) => Promise<void>;
  maxFileSize?: number; // in bytes
  allowedTypes?: string[];
  allowedExtensions?: string[];
  maxFiles?: number;
  disabled?: boolean;
}

/**
 * FileUploader Component
 *
 * Drag & drop file uploader with validation and progress tracking.
 * Supports multiple file upload with preview and cancellation.
 */
export function FileUploader({
  onUpload,
  maxFileSize = 10 * 1024 * 1024, // 10MB default
  allowedTypes = [],
  allowedExtensions = [],
  maxFiles = 10,
  disabled = false,
}: FileUploaderProps) {
  const [isDragging, setIsDragging] = useState(false);
  const [selectedFiles, setSelectedFiles] = useState<File[]>([]);
  const [uploadProgress, setUploadProgress] = useState<Map<string, UploadProgress>>(new Map());
  const [isUploading, setIsUploading] = useState(false);
  const fileInputRef = useRef<HTMLInputElement>(null);

  // Format file size
  const formatSize = (bytes: number): string => {
    const units = ['B', 'KB', 'MB', 'GB'];
    let size = bytes;
    let unitIndex = 0;

    while (size >= 1024 && unitIndex < units.length - 1) {
      size /= 1024;
      unitIndex++;
    }

    return `${size.toFixed(1)} ${units[unitIndex]}`;
  };

  // Validate file
  const validateFile = (file: File): { valid: boolean; error?: string } => {
    // Check file size
    if (file.size > maxFileSize) {
      return {
        valid: false,
        error: `File exceeds ${formatSize(maxFileSize)} limit`,
      };
    }

    // Check file type
    if (allowedTypes.length > 0 && !allowedTypes.includes(file.type)) {
      return {
        valid: false,
        error: 'File type not allowed',
      };
    }

    // Check file extension
    if (allowedExtensions.length > 0) {
      const extension = file.name.split('.').pop()?.toLowerCase();
      if (!extension || !allowedExtensions.includes(extension)) {
        return {
          valid: false,
          error: 'File extension not allowed',
        };
      }
    }

    return { valid: true };
  };

  // Handle file selection
  const handleFiles = (files: FileList | null) => {
    if (!files || disabled) return;

    const filesArray = Array.from(files);
    const validFiles: File[] = [];
    const errors: string[] = [];

    for (const file of filesArray) {
      const validation = validateFile(file);
      if (validation.valid) {
        validFiles.push(file);
      } else {
        errors.push(`${file.name}: ${validation.error}`);
      }
    }

    if (errors.length > 0) {
      alert(`Some files were rejected:\n${errors.join('\n')}`);
    }

    if (validFiles.length > 0) {
      setSelectedFiles((prev) => [...prev, ...validFiles].slice(0, maxFiles));
    }
  };

  // Handle drag events
  const handleDragEnter = (e: React.DragEvent) => {
    e.preventDefault();
    e.stopPropagation();
    if (!disabled) setIsDragging(true);
  };

  const handleDragLeave = (e: React.DragEvent) => {
    e.preventDefault();
    e.stopPropagation();
    setIsDragging(false);
  };

  const handleDragOver = (e: React.DragEvent) => {
    e.preventDefault();
    e.stopPropagation();
  };

  const handleDrop = (e: React.DragEvent) => {
    e.preventDefault();
    e.stopPropagation();
    setIsDragging(false);

    if (!disabled) {
      handleFiles(e.dataTransfer.files);
    }
  };

  // Remove file from selection
  const removeFile = (index: number) => {
    setSelectedFiles((prev) => prev.filter((_, i) => i !== index));
  };

  // Upload files
  const handleUpload = async () => {
    if (selectedFiles.length === 0 || isUploading) return;

    setIsUploading(true);

    try {
      await onUpload(selectedFiles);
      setSelectedFiles([]);
    } catch (error) {
      console.error('Upload error:', error);
      alert('Upload failed. Please try again.');
    } finally {
      setIsUploading(false);
    }
  };

  return (
    <div className="space-y-4">
      {/* Drag & Drop Zone */}
      <div
        className={`
          relative rounded-xl border-2 border-dashed transition-all duration-300
          ${
            isDragging
              ? 'border-blue-500 bg-blue-500/10'
              : 'border-white/20 bg-white/5 hover:border-white/40 hover:bg-white/10'
          }
          ${disabled ? 'opacity-50 cursor-not-allowed' : 'cursor-pointer'}
        `}
        onDragEnter={handleDragEnter}
        onDragLeave={handleDragLeave}
        onDragOver={handleDragOver}
        onDrop={handleDrop}
        onClick={() => !disabled && fileInputRef.current?.click()}
      >
        <div className="p-8 text-center">
          <div className="text-6xl mb-4">{isDragging ? 'üì•' : 'üì§'}</div>
          <h3 className="text-white font-semibold text-lg mb-2">
            {isDragging ? 'Drop files here' : 'Upload Files'}
          </h3>
          <p className="text-slate-400 text-sm mb-4">Drag & drop files here, or click to browse</p>
          <div className="text-xs text-slate-500 space-y-1">
            <p>Maximum file size: {formatSize(maxFileSize)}</p>
            {allowedTypes.length > 0 && <p>Allowed types: {allowedTypes.join(', ')}</p>}
            {allowedExtensions.length > 0 && (
              <p>Allowed extensions: {allowedExtensions.join(', ')}</p>
            )}
          </div>
        </div>

        <input
          ref={fileInputRef}
          type="file"
          multiple
          onChange={(e) => handleFiles(e.target.files)}
          className="hidden"
          disabled={disabled}
          accept={allowedTypes.join(',')}
        />
      </div>

      {/* Selected Files */}
      {selectedFiles.length > 0 && (
        <div className="space-y-3">
          <div className="flex items-center justify-between">
            <h4 className="text-white font-semibold text-sm">
              Selected Files ({selectedFiles.length})
            </h4>
            <button
              onClick={() => setSelectedFiles([])}
              className="text-xs text-red-400 hover:text-red-300 transition-colors"
            >
              Clear All
            </button>
          </div>

          <div className="space-y-2">
            {selectedFiles.map((file, index) => (
              <div
                key={`${file.name}-${index}`}
                className="flex items-center gap-3 p-3 rounded-lg bg-white/5 border border-white/10"
              >
                <div className="text-2xl">üìÑ</div>
                <div className="flex-1 min-w-0">
                  <p className="text-white text-sm font-medium truncate">{file.name}</p>
                  <p className="text-slate-400 text-xs">{formatSize(file.size)}</p>
                </div>
                <button
                  onClick={() => removeFile(index)}
                  className="px-2 py-1 rounded text-slate-400 hover:text-red-400 hover:bg-red-500/10 transition-all"
                  aria-label={`Remove ${file.name}`}
                >
                  ‚úï
                </button>
              </div>
            ))}
          </div>

          {/* Upload Button */}
          <button
            onClick={handleUpload}
            disabled={isUploading || disabled}
            className="w-full px-4 py-3 rounded-lg bg-gradient-to-r from-blue-600 to-purple-600 hover:from-blue-700 hover:to-purple-700 text-white font-medium transition-all disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center gap-2"
          >
            {isUploading ? (
              <>
                <div className="flex gap-1">
                  <div
                    className="w-2 h-2 bg-white rounded-full animate-bounce"
                    style={{ animationDelay: '0ms' }}
                  ></div>
                  <div
                    className="w-2 h-2 bg-white rounded-full animate-bounce"
                    style={{ animationDelay: '150ms' }}
                  ></div>
                  <div
                    className="w-2 h-2 bg-white rounded-full animate-bounce"
                    style={{ animationDelay: '300ms' }}
                  ></div>
                </div>
                <span>Uploading...</span>
              </>
            ) : (
              <>
                <span>üì§</span>
                <span>
                  Upload {selectedFiles.length} {selectedFiles.length === 1 ? 'File' : 'Files'}
                </span>
              </>
            )}
          </button>
        </div>
      )}
    </div>
  );
}
</file>

<file path="src/components/storage/index.ts">
/**
 * Storage Components Module
 *
 * Modular, reusable components for file storage management.
 * Built for Phase 3 of the Supabase Storage Strategic Implementation Plan.
 */

export { FileCard } from './FileCard';
export { FileGrid } from './FileGrid';
export { FileFilters } from './FileFilters';
export { FileUploader } from './FileUploader';
export { FileActions } from './FileActions';
export { StorageStats } from './StorageStats';
</file>

<file path="src/components/TemplatePreview.tsx">
'use client';

import React from 'react';
import type { FullTemplate } from '../types/architectureTemplates';
import { getCategoryDisplayName } from '../data/templates';

interface TemplatePreviewProps {
  template: FullTemplate;
  onClose: () => void;
  onSelect: () => void;
}

/**
 * TemplatePreview Component
 * Shows detailed preview of a template with all its features and components
 */
export function TemplatePreview({ template, onClose, onSelect }: TemplatePreviewProps) {
  const getComplexityColor = (complexity: string) => {
    switch (complexity) {
      case 'simple':
        return 'bg-green-500/20 text-green-300 border-green-500/30';
      case 'moderate':
        return 'bg-yellow-500/20 text-yellow-300 border-yellow-500/30';
      case 'complex':
        return 'bg-red-500/20 text-red-300 border-red-500/30';
      default:
        return 'bg-slate-500/20 text-slate-300 border-slate-500/30';
    }
  };

  const getLayoutIcon = (type: string) => {
    switch (type) {
      case 'sidebar':
        return 'üìä';
      case 'topnav':
        return 'üìë';
      case 'minimal':
        return 'üìÑ';
      case 'split':
        return 'üìê';
      default:
        return 'üì±';
    }
  };

  return (
    <div className="fixed inset-0 bg-black/80 backdrop-blur-sm z-50 flex items-center justify-center p-4">
      <div className="bg-slate-900 rounded-2xl border border-white/10 max-w-4xl w-full max-h-[90vh] overflow-hidden shadow-2xl">
        {/* Header */}
        <div className="px-6 py-5 border-b border-white/10 bg-gradient-to-r from-blue-500/10 to-purple-500/10">
          <div className="flex items-center justify-between">
            <div className="flex items-center gap-4">
              <div className="w-14 h-14 rounded-xl bg-slate-800/50 flex items-center justify-center text-3xl">
                {template.icon}
              </div>
              <div>
                <h2 className="text-xl font-bold text-white">{template.name}</h2>
                <div className="flex items-center gap-2 mt-1">
                  <span className="text-sm text-slate-400">
                    {getCategoryDisplayName(template.category)}
                  </span>
                  <span className="text-slate-600">‚Ä¢</span>
                  <span
                    className={`text-xs px-2 py-0.5 rounded-full border ${getComplexityColor(template.complexity)}`}
                  >
                    {template.complexity}
                  </span>
                  <span className="text-slate-600">‚Ä¢</span>
                  <span className="text-xs text-slate-400">
                    ~{template.estimatedComponents} components
                  </span>
                </div>
              </div>
            </div>
            <button onClick={onClose} className="p-2 rounded-lg hover:bg-white/10 transition-all">
              <span className="text-slate-400 text-xl">‚úï</span>
            </button>
          </div>
        </div>

        {/* Content */}
        <div className="p-6 overflow-y-auto max-h-[calc(90vh-180px)]">
          {/* Description */}
          <div className="mb-6">
            <p className="text-slate-300">{template.description}</p>
          </div>

          <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
            {/* Left Column */}
            <div className="space-y-6">
              {/* Layout Structure */}
              <div className="p-4 rounded-xl bg-slate-800/50 border border-white/10">
                <h3 className="font-semibold text-white mb-3 flex items-center gap-2">
                  <span>{getLayoutIcon(template.layoutStructure.type)}</span>
                  Layout Structure
                </h3>
                <div className="space-y-2">
                  <div className="flex items-center gap-2">
                    <span className="text-xs text-slate-400">Type:</span>
                    <span className="text-sm text-white capitalize">
                      {template.layoutStructure.type}
                    </span>
                  </div>
                  <div className="flex flex-wrap gap-1.5">
                    {template.layoutStructure.regions.map((region, index) => (
                      <span
                        key={index}
                        className="text-xs px-2 py-1 rounded bg-slate-700 text-slate-300"
                      >
                        {region}
                      </span>
                    ))}
                  </div>
                </div>
              </div>

              {/* Technical Requirements */}
              <div className="p-4 rounded-xl bg-slate-800/50 border border-white/10">
                <h3 className="font-semibold text-white mb-3 flex items-center gap-2">
                  <span>‚öôÔ∏è</span>
                  Technical Requirements
                </h3>
                <div className="grid grid-cols-2 gap-3">
                  <div
                    className={`flex items-center gap-2 p-2 rounded-lg ${template.technicalRequirements.needsAuth ? 'bg-blue-500/10' : 'bg-slate-700/30'}`}
                  >
                    <span
                      className={
                        template.technicalRequirements.needsAuth
                          ? 'text-blue-400'
                          : 'text-slate-500'
                      }
                    >
                      {template.technicalRequirements.needsAuth ? '‚úì' : '‚óã'}
                    </span>
                    <span
                      className={`text-sm ${template.technicalRequirements.needsAuth ? 'text-blue-200' : 'text-slate-500'}`}
                    >
                      Authentication
                    </span>
                  </div>
                  <div
                    className={`flex items-center gap-2 p-2 rounded-lg ${template.technicalRequirements.needsDatabase ? 'bg-purple-500/10' : 'bg-slate-700/30'}`}
                  >
                    <span
                      className={
                        template.technicalRequirements.needsDatabase
                          ? 'text-purple-400'
                          : 'text-slate-500'
                      }
                    >
                      {template.technicalRequirements.needsDatabase ? '‚úì' : '‚óã'}
                    </span>
                    <span
                      className={`text-sm ${template.technicalRequirements.needsDatabase ? 'text-purple-200' : 'text-slate-500'}`}
                    >
                      Database
                    </span>
                  </div>
                  <div
                    className={`flex items-center gap-2 p-2 rounded-lg ${template.technicalRequirements.needsAPI ? 'bg-green-500/10' : 'bg-slate-700/30'}`}
                  >
                    <span
                      className={
                        template.technicalRequirements.needsAPI
                          ? 'text-green-400'
                          : 'text-slate-500'
                      }
                    >
                      {template.technicalRequirements.needsAPI ? '‚úì' : '‚óã'}
                    </span>
                    <span
                      className={`text-sm ${template.technicalRequirements.needsAPI ? 'text-green-200' : 'text-slate-500'}`}
                    >
                      API
                    </span>
                  </div>
                  <div
                    className={`flex items-center gap-2 p-2 rounded-lg ${template.technicalRequirements.needsFileUpload ? 'bg-orange-500/10' : 'bg-slate-700/30'}`}
                  >
                    <span
                      className={
                        template.technicalRequirements.needsFileUpload
                          ? 'text-orange-400'
                          : 'text-slate-500'
                      }
                    >
                      {template.technicalRequirements.needsFileUpload ? '‚úì' : '‚óã'}
                    </span>
                    <span
                      className={`text-sm ${template.technicalRequirements.needsFileUpload ? 'text-orange-200' : 'text-slate-500'}`}
                    >
                      File Upload
                    </span>
                  </div>
                </div>
              </div>

              {/* Features */}
              <div className="p-4 rounded-xl bg-slate-800/50 border border-white/10">
                <h3 className="font-semibold text-white mb-3 flex items-center gap-2">
                  <span>‚ú®</span>
                  Features
                </h3>
                <div className="space-y-3">
                  <div>
                    <span className="text-xs text-slate-400 block mb-2">Required Features</span>
                    <div className="flex flex-wrap gap-1.5">
                      {template.requiredFeatures.map((feature, index) => (
                        <span
                          key={index}
                          className="text-xs px-2 py-1 rounded-full bg-blue-500/20 text-blue-200 border border-blue-500/30"
                        >
                          {feature}
                        </span>
                      ))}
                    </div>
                  </div>
                  <div>
                    <span className="text-xs text-slate-400 block mb-2">Suggested Features</span>
                    <div className="flex flex-wrap gap-1.5">
                      {template.suggestedFeatures.map((feature, index) => (
                        <span
                          key={index}
                          className="text-xs px-2 py-1 rounded-full bg-white/5 text-slate-400 border border-white/10"
                        >
                          {feature}
                        </span>
                      ))}
                    </div>
                  </div>
                </div>
              </div>
            </div>

            {/* Right Column */}
            <div className="space-y-6">
              {/* Components List */}
              <div className="p-4 rounded-xl bg-slate-800/50 border border-white/10">
                <h3 className="font-semibold text-white mb-3 flex items-center gap-2">
                  <span>üß©</span>
                  Components ({template.components.length})
                </h3>
                <div className="space-y-2 max-h-[400px] overflow-y-auto">
                  {template.components.map((component, index) => (
                    <div
                      key={index}
                      className="p-3 rounded-lg bg-slate-700/30 border border-white/5"
                    >
                      <div className="flex items-center justify-between mb-1">
                        <span className="font-medium text-white text-sm">{component.name}</span>
                        <span
                          className={`text-xs px-2 py-0.5 rounded-full ${
                            component.priority === 'core'
                              ? 'bg-green-500/20 text-green-300'
                              : 'bg-slate-600/30 text-slate-400'
                          }`}
                        >
                          {component.priority}
                        </span>
                      </div>
                      <p className="text-xs text-slate-400">{component.description}</p>
                    </div>
                  ))}
                </div>
              </div>

              {/* Base Prompt Preview */}
              <div className="p-4 rounded-xl bg-slate-800/50 border border-white/10">
                <h3 className="font-semibold text-white mb-3 flex items-center gap-2">
                  <span>üìù</span>
                  AI Prompt Preview
                </h3>
                <div className="p-3 rounded-lg bg-slate-900/50 border border-white/5 max-h-[200px] overflow-y-auto">
                  <pre className="text-sm text-slate-300 whitespace-pre-wrap font-mono leading-relaxed">
                    {template.basePrompt}
                  </pre>
                </div>
              </div>
            </div>
          </div>
        </div>

        {/* Footer */}
        <div className="px-6 py-4 border-t border-white/10 bg-slate-900/50 flex items-center justify-between">
          <button
            onClick={onClose}
            className="px-4 py-2.5 rounded-lg bg-slate-700 hover:bg-slate-600 text-white font-medium transition-all"
          >
            Cancel
          </button>
          <button
            onClick={onSelect}
            className="px-6 py-2.5 rounded-lg bg-gradient-to-r from-blue-600 to-purple-600 hover:from-blue-700 hover:to-purple-700 text-white font-medium transition-all shadow-lg"
          >
            Use This Template
          </button>
        </div>
      </div>
    </div>
  );
}

export default TemplatePreview;
</file>

<file path="src/components/TemplateSelector.tsx">
'use client';

import React, { useState, useMemo } from 'react';
import type {
  FullTemplate,
  TemplateCategory,
  TemplateComplexity,
} from '../types/architectureTemplates';
import {
  architectureTemplates,
  filterTemplates,
  getAllCategories,
  getCategoryDisplayName,
  getRecommendedTemplates,
} from '../data/templates';
import TemplatePreview from './TemplatePreview';

interface TemplateSelectorProps {
  onSelect: (template: FullTemplate) => void;
  onSkip?: () => void;
  userDescription?: string;
}

/**
 * TemplateSelector Component
 * Displays available architecture templates for user selection
 */
export function TemplateSelector({ onSelect, onSkip, userDescription }: TemplateSelectorProps) {
  const [selectedCategory, setSelectedCategory] = useState<TemplateCategory | 'all'>('all');
  const [selectedComplexity, setSelectedComplexity] = useState<TemplateComplexity | 'all'>('all');
  const [searchQuery, setSearchQuery] = useState('');
  const [previewTemplate, setPreviewTemplate] = useState<FullTemplate | null>(null);

  // Get recommended templates if user description is provided
  const recommendedTemplates = useMemo(() => {
    if (userDescription) {
      return getRecommendedTemplates(userDescription);
    }
    return [];
  }, [userDescription]);

  // Filter templates based on current filters
  const filteredTemplates = useMemo(() => {
    return filterTemplates({
      category: selectedCategory === 'all' ? undefined : selectedCategory,
      complexity: selectedComplexity === 'all' ? undefined : selectedComplexity,
      searchQuery: searchQuery || undefined,
    });
  }, [selectedCategory, selectedComplexity, searchQuery]);

  const categories = getAllCategories();

  const getComplexityColor = (complexity: TemplateComplexity) => {
    switch (complexity) {
      case 'simple':
        return 'bg-green-500/20 text-green-300 border-green-500/30';
      case 'moderate':
        return 'bg-yellow-500/20 text-yellow-300 border-yellow-500/30';
      case 'complex':
        return 'bg-red-500/20 text-red-300 border-red-500/30';
    }
  };

  const getCategoryColor = (category: TemplateCategory) => {
    switch (category) {
      case 'admin':
        return 'bg-blue-500/20 text-blue-300';
      case 'commerce':
        return 'bg-purple-500/20 text-purple-300';
      case 'content':
        return 'bg-orange-500/20 text-orange-300';
      case 'marketing':
        return 'bg-pink-500/20 text-pink-300';
      case 'saas':
        return 'bg-cyan-500/20 text-cyan-300';
    }
  };

  return (
    <div className="space-y-6">
      {/* Header */}
      <div className="text-center mb-8">
        <h2 className="text-2xl font-bold text-white mb-2">Choose a Template</h2>
        <p className="text-slate-400">
          Select a pre-built architecture pattern to accelerate your development
        </p>
      </div>

      {/* Recommended Templates */}
      {recommendedTemplates.length > 0 && (
        <div className="mb-8">
          <h3 className="text-sm font-medium text-slate-300 mb-3 flex items-center gap-2">
            <span>‚ú®</span>
            <span>Recommended for you</span>
          </h3>
          <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
            {recommendedTemplates.slice(0, 3).map((template) => (
              <button
                key={template.id}
                onClick={() => onSelect(template)}
                className="p-4 rounded-xl bg-gradient-to-br from-blue-600/20 to-purple-600/20 border border-blue-500/30 hover:border-blue-500/50 text-left transition-all group"
              >
                <div className="flex items-center gap-3 mb-2">
                  <span className="text-2xl">{template.icon}</span>
                  <span className="font-semibold text-white group-hover:text-blue-200 transition-colors">
                    {template.name}
                  </span>
                  <span className="ml-auto text-xs bg-blue-500/30 text-blue-200 px-2 py-0.5 rounded-full">
                    Recommended
                  </span>
                </div>
                <p className="text-sm text-slate-400 line-clamp-2">{template.description}</p>
              </button>
            ))}
          </div>
        </div>
      )}

      {/* Filters */}
      <div className="flex flex-wrap items-center gap-4 pb-4 border-b border-white/10">
        {/* Search */}
        <div className="flex-1 min-w-[200px]">
          <input
            type="text"
            value={searchQuery}
            onChange={(e) => setSearchQuery(e.target.value)}
            placeholder="Search templates..."
            className="w-full px-4 py-2 rounded-lg bg-slate-800 border border-white/10 text-white placeholder-slate-500 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent text-sm"
          />
        </div>

        {/* Category Filter */}
        <select
          value={selectedCategory}
          onChange={(e) => setSelectedCategory(e.target.value as TemplateCategory | 'all')}
          className="px-4 py-2 rounded-lg bg-slate-800 border border-white/10 text-white focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm"
        >
          <option value="all">All Categories</option>
          {categories.map((cat) => (
            <option key={cat} value={cat}>
              {getCategoryDisplayName(cat)}
            </option>
          ))}
        </select>

        {/* Complexity Filter */}
        <select
          value={selectedComplexity}
          onChange={(e) => setSelectedComplexity(e.target.value as TemplateComplexity | 'all')}
          className="px-4 py-2 rounded-lg bg-slate-800 border border-white/10 text-white focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm"
        >
          <option value="all">All Complexities</option>
          <option value="simple">Simple</option>
          <option value="moderate">Moderate</option>
          <option value="complex">Complex</option>
        </select>
      </div>

      {/* Template Grid */}
      <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
        {filteredTemplates.map((template) => (
          <div
            key={template.id}
            className="p-5 rounded-xl bg-slate-800/50 border border-white/10 hover:border-white/20 transition-all group relative"
          >
            {/* Header */}
            <div className="flex items-start gap-3 mb-3">
              <div className="w-12 h-12 rounded-xl bg-slate-700/50 flex items-center justify-center text-2xl">
                {template.icon}
              </div>
              <div className="flex-1">
                <h3 className="font-semibold text-white group-hover:text-blue-200 transition-colors">
                  {template.name}
                </h3>
                <div className="flex items-center gap-2 mt-1">
                  <span
                    className={`text-xs px-2 py-0.5 rounded-full ${getCategoryColor(template.category)}`}
                  >
                    {getCategoryDisplayName(template.category)}
                  </span>
                </div>
              </div>
            </div>

            {/* Description */}
            <p className="text-sm text-slate-400 mb-4 line-clamp-2" title={template.description}>
              {template.description}
            </p>

            {/* Features */}
            <div className="flex flex-wrap gap-1.5 mb-4">
              {template.features.slice(0, 4).map((feature, index) => (
                <span
                  key={index}
                  className="text-xs px-2 py-0.5 rounded-full bg-white/5 text-slate-400 border border-white/5"
                >
                  {feature}
                </span>
              ))}
              {template.features.length > 4 && (
                <span className="text-xs px-2 py-0.5 text-slate-500">
                  +{template.features.length - 4} more
                </span>
              )}
            </div>

            {/* Footer */}
            <div className="flex items-center justify-between pt-3 border-t border-white/5">
              <div className="flex items-center gap-3">
                <span
                  className={`text-xs px-2 py-0.5 rounded-full border ${getComplexityColor(template.complexity)}`}
                >
                  {template.complexity}
                </span>
                <span className="text-xs text-slate-500">
                  ~{template.estimatedComponents} components
                </span>
              </div>
              <div className="flex gap-2">
                <button
                  onClick={() => setPreviewTemplate(template)}
                  className="text-xs px-3 py-1.5 rounded-lg bg-white/5 hover:bg-white/10 text-slate-300 transition-colors"
                >
                  Preview
                </button>
                <button
                  onClick={() => onSelect(template)}
                  className="text-xs px-3 py-1.5 rounded-lg bg-blue-600 hover:bg-blue-700 text-white font-medium transition-colors"
                >
                  Select
                </button>
              </div>
            </div>
          </div>
        ))}
      </div>

      {/* Empty State */}
      {filteredTemplates.length === 0 && (
        <div className="text-center py-12">
          <div className="text-4xl mb-4">üîç</div>
          <h3 className="text-lg font-medium text-white mb-2">No templates found</h3>
          <p className="text-slate-400">Try adjusting your filters or search query</p>
        </div>
      )}

      {/* Skip Option */}
      {onSkip && (
        <div className="text-center pt-6 border-t border-white/10">
          <button
            onClick={onSkip}
            className="text-sm text-slate-400 hover:text-slate-300 transition-colors"
          >
            Skip template selection and start from scratch ‚Üí
          </button>
        </div>
      )}

      {/* Preview Modal */}
      {previewTemplate && (
        <TemplatePreview
          template={previewTemplate}
          onClose={() => setPreviewTemplate(null)}
          onSelect={() => {
            onSelect(previewTemplate);
            setPreviewTemplate(null);
          }}
        />
      )}
    </div>
  );
}

export default TemplateSelector;
</file>

<file path="src/components/ThemeToggle.tsx">
'use client';

import React, { useState, useRef, useEffect } from 'react';
import { useTheme, type UseTheme } from '@/hooks/useTheme';
import type { Theme } from '@/contexts/ThemeContext';

interface ThemeToggleProps {
  /** Size variant of the toggle */
  size?: 'sm' | 'md' | 'lg';
  /** Whether to show text label */
  showLabel?: boolean;
  /** Whether to show dropdown for system option */
  showDropdown?: boolean;
}

const sizeClasses = {
  sm: 'w-8 h-8 text-sm',
  md: 'w-10 h-10 text-base',
  lg: 'w-12 h-12 text-lg',
};

const iconSizeClasses = {
  sm: 'text-base',
  md: 'text-xl',
  lg: 'text-2xl',
};

export function ThemeToggle({
  size = 'md',
  showLabel = false,
  showDropdown = true,
}: ThemeToggleProps) {
  const { theme, resolvedTheme, setTheme, toggleTheme } = useTheme();
  const [isOpen, setIsOpen] = useState(false);
  const dropdownRef = useRef<HTMLDivElement>(null);

  // Close dropdown when clicking outside
  useEffect(() => {
    function handleClickOutside(event: MouseEvent) {
      if (dropdownRef.current && !dropdownRef.current.contains(event.target as Node)) {
        setIsOpen(false);
      }
    }
    document.addEventListener('mousedown', handleClickOutside);
    return () => document.removeEventListener('mousedown', handleClickOutside);
  }, []);

  // Close dropdown on Escape key
  useEffect(() => {
    function handleEscape(event: KeyboardEvent) {
      if (event.key === 'Escape') {
        setIsOpen(false);
      }
    }
    document.addEventListener('keydown', handleEscape);
    return () => document.removeEventListener('keydown', handleEscape);
  }, []);

  const themeOptions: { value: Theme; label: string; icon: string }[] = [
    { value: 'light', label: 'Light', icon: '‚òÄÔ∏è' },
    { value: 'dark', label: 'Dark', icon: 'üåô' },
    { value: 'system', label: 'System', icon: 'üíª' },
  ];

  const currentIcon = resolvedTheme === 'dark' ? 'üåô' : '‚òÄÔ∏è';
  const currentLabel =
    theme === 'system'
      ? `System (${resolvedTheme})`
      : theme.charAt(0).toUpperCase() + theme.slice(1);

  if (!showDropdown) {
    // Simple toggle button (just toggles between light and dark)
    return (
      <button
        onClick={toggleTheme}
        className={`
          ${sizeClasses[size]}
          flex items-center justify-center gap-2
          rounded-xl
          bg-white/10 hover:bg-white/20
          dark:bg-slate-800 dark:hover:bg-slate-700
          border border-white/20 dark:border-white/10
          text-slate-800 dark:text-slate-200
          transition-all duration-300
          hover:scale-105 active:scale-95
          focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2
          dark:focus:ring-offset-slate-900
        `}
        aria-label={`Switch to ${resolvedTheme === 'dark' ? 'light' : 'dark'} theme`}
        title={`Current: ${currentLabel}. Click to switch.`}
      >
        <span className={`${iconSizeClasses[size]} transition-transform duration-300`}>
          {currentIcon}
        </span>
        {showLabel && <span className="text-sm font-medium">{currentLabel}</span>}
      </button>
    );
  }

  // Dropdown toggle
  return (
    <div className="relative" ref={dropdownRef}>
      <button
        onClick={() => setIsOpen(!isOpen)}
        className={`
          ${sizeClasses[size]}
          flex items-center justify-center gap-2
          rounded-xl
          bg-white/10 hover:bg-white/20
          dark:bg-slate-800 dark:hover:bg-slate-700
          border border-white/20 dark:border-white/10
          text-slate-800 dark:text-slate-200
          transition-all duration-300
          hover:scale-105 active:scale-95
          focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2
          dark:focus:ring-offset-slate-900
        `}
        aria-label="Theme settings"
        aria-haspopup="true"
        aria-expanded={isOpen}
        title={`Current theme: ${currentLabel}`}
      >
        <span className={`${iconSizeClasses[size]} transition-transform duration-300`}>
          {currentIcon}
        </span>
        {showLabel && <span className="text-sm font-medium">{currentLabel}</span>}
      </button>

      {/* Dropdown Menu */}
      {isOpen && (
        <div
          className="
            absolute right-0 mt-2 w-40
            bg-white dark:bg-slate-800
            border border-slate-200 dark:border-slate-700
            rounded-xl shadow-lg
            py-1 z-50
            animate-fade-in-up
          "
          role="menu"
          aria-orientation="vertical"
        >
          {themeOptions.map((option) => (
            <button
              key={option.value}
              onClick={() => {
                setTheme(option.value);
                setIsOpen(false);
              }}
              className={`
                w-full px-4 py-2.5 text-left
                flex items-center gap-3
                transition-colors duration-200
                ${
                  theme === option.value
                    ? 'bg-blue-100 dark:bg-blue-900/30 text-blue-700 dark:text-blue-300'
                    : 'text-slate-700 dark:text-slate-300 hover:bg-slate-100 dark:hover:bg-slate-700'
                }
              `}
              role="menuitem"
              aria-current={theme === option.value ? 'true' : undefined}
            >
              <span className="text-lg">{option.icon}</span>
              <span className="text-sm font-medium">{option.label}</span>
              {theme === option.value && <span className="ml-auto text-blue-500">‚úì</span>}
            </button>
          ))}
        </div>
      )}
    </div>
  );
}

export default ThemeToggle;
</file>

<file path="src/components/Toast.tsx">
'use client';

import React, { createContext, useContext, useState, useCallback, useEffect } from 'react';

type ToastType = 'success' | 'error' | 'warning' | 'info';

interface Toast {
  id: string;
  type: ToastType;
  message: string;
  description?: string;
  duration?: number;
}

/**
 * Toast input type for showToast - supports object-based API
 */
interface ToastInput {
  type: ToastType;
  message: string;
  description?: string;
  duration?: number;
}

interface ToastContextType {
  showToast: ((toast: ToastInput) => void) &
    ((type: ToastType, message: string, duration?: number) => void);
  hideToast: (id: string) => void;
}

const ToastContext = createContext<ToastContextType | undefined>(undefined);

/**
 * Toast notification icons by type
 */
const toastIcons: Record<ToastType, string> = {
  success: '‚úÖ',
  error: '‚ùå',
  warning: '‚ö†Ô∏è',
  info: '‚ÑπÔ∏è',
};

/**
 * Toast notification styles by type
 */
const toastStyles: Record<ToastType, string> = {
  success: 'bg-green-500/20 border-green-500/30 text-green-200',
  error: 'bg-red-500/20 border-red-500/30 text-red-200',
  warning: 'bg-yellow-500/20 border-yellow-500/30 text-yellow-200',
  info: 'bg-blue-500/20 border-blue-500/30 text-blue-200',
};

/**
 * Single Toast component
 */
interface ToastItemProps {
  toast: Toast;
  onClose: (id: string) => void;
}

function ToastItem({ toast, onClose }: ToastItemProps) {
  const [isExiting, setIsExiting] = useState(false);

  useEffect(() => {
    if (toast.duration && toast.duration > 0) {
      const exitTimer = setTimeout(() => {
        setIsExiting(true);
      }, toast.duration - 300);

      const removeTimer = setTimeout(() => {
        onClose(toast.id);
      }, toast.duration);

      return () => {
        clearTimeout(exitTimer);
        clearTimeout(removeTimer);
      };
    }
  }, [toast.id, toast.duration, onClose]);

  const handleClose = () => {
    setIsExiting(true);
    setTimeout(() => onClose(toast.id), 300);
  };

  return (
    <div
      className={`
        flex items-center gap-3 px-4 py-3 rounded-xl border shadow-lg backdrop-blur-sm
        transition-all duration-300
        ${toastStyles[toast.type]}
        ${isExiting ? 'opacity-0 translate-x-4' : 'opacity-100 translate-x-0'}
      `}
      role="alert"
    >
      <span className="text-lg flex-shrink-0">{toastIcons[toast.type]}</span>
      <p className="flex-1 text-sm font-medium">{toast.message}</p>
      <button
        onClick={handleClose}
        className="flex-shrink-0 p-1 rounded-lg hover:bg-white/10 transition-colors"
        aria-label="Dismiss notification"
      >
        <span className="text-sm opacity-70 hover:opacity-100">‚úï</span>
      </button>
    </div>
  );
}

/**
 * Toast Provider - Wraps app and provides toast functionality
 */
interface ToastProviderProps {
  children: React.ReactNode;
}

export function ToastProvider({ children }: ToastProviderProps) {
  const [toasts, setToasts] = useState<Toast[]>([]);

  // Support both API styles: showToast(type, message, duration) and showToast({ type, message, duration })
  const showToast = useCallback(
    (typeOrToast: ToastType | ToastInput, message?: string, duration = 4000) => {
      const id = `toast-${Date.now()}-${Math.random().toString(36).substring(2, 9)}`;

      let newToast: Toast;
      if (typeof typeOrToast === 'object') {
        // Object-based API: showToast({ type, message, duration })
        newToast = {
          id,
          type: typeOrToast.type,
          message: typeOrToast.message,
          description: typeOrToast.description,
          duration: typeOrToast.duration ?? 4000,
        };
      } else {
        // Legacy API: showToast(type, message, duration)
        newToast = {
          id,
          type: typeOrToast,
          message: message || '',
          duration,
        };
      }

      setToasts((prev) => [...prev, newToast]);
    },
    []
  ) as ToastContextType['showToast'];

  const hideToast = useCallback((id: string) => {
    setToasts((prev) => prev.filter((toast) => toast.id !== id));
  }, []);

  return (
    <ToastContext.Provider value={{ showToast, hideToast }}>
      {children}

      {/* Toast Container */}
      <div
        className="fixed bottom-4 right-4 z-[100] flex flex-col gap-2 max-w-sm w-full pointer-events-none"
        role="region"
        aria-label="Notifications"
      >
        {toasts.map((toast) => (
          <div key={toast.id} className="pointer-events-auto animate-fade-in-up">
            <ToastItem toast={toast} onClose={hideToast} />
          </div>
        ))}
      </div>
    </ToastContext.Provider>
  );
}

/**
 * useToast hook - Access toast functions
 */
export function useToast() {
  const context = useContext(ToastContext);

  if (!context) {
    throw new Error('useToast must be used within a ToastProvider');
  }

  return context;
}

/**
 * Standalone Toast component for direct rendering
 */
interface StandaloneToastProps {
  type: ToastType;
  message: string;
  onClose?: () => void;
}

export function Toast({ type, message, onClose }: StandaloneToastProps) {
  return (
    <div
      className={`
        flex items-center gap-3 px-4 py-3 rounded-xl border shadow-lg backdrop-blur-sm
        ${toastStyles[type]}
      `}
      role="alert"
    >
      <span className="text-lg flex-shrink-0">{toastIcons[type]}</span>
      <p className="flex-1 text-sm font-medium">{message}</p>
      {onClose && (
        <button
          onClick={onClose}
          className="flex-shrink-0 p-1 rounded-lg hover:bg-white/10 transition-colors"
          aria-label="Dismiss notification"
        >
          <span className="text-sm opacity-70 hover:opacity-100">‚úï</span>
        </button>
      )}
    </div>
  );
}

export default Toast;
</file>

<file path="src/components/ui/Icons.tsx">
'use client';

import React from 'react';

interface IconProps extends React.SVGProps<SVGSVGElement> {
  size?: number;
}

// Base icon component for consistency
const Icon: React.FC<IconProps & { children: React.ReactNode }> = ({
  size = 16,
  className = '',
  children,
  ...props
}) => (
  <svg
    width={size}
    height={size}
    viewBox="0 0 24 24"
    fill="none"
    stroke="currentColor"
    strokeWidth={2}
    strokeLinecap="round"
    strokeLinejoin="round"
    className={className}
    {...props}
  >
    {children}
  </svg>
);

// Chevron Down - for dropdowns
export const ChevronDownIcon: React.FC<IconProps> = (props) => (
  <Icon {...props}>
    <polyline points="6 9 12 15 18 9" />
  </Icon>
);

// Chevron Right - for submenus
export const ChevronRightIcon: React.FC<IconProps> = (props) => (
  <Icon {...props}>
    <polyline points="9 18 15 12 9 6" />
  </Icon>
);

// Folder - for projects/files
export const FolderIcon: React.FC<IconProps> = (props) => (
  <Icon {...props}>
    <path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z" />
  </Icon>
);

// Plus - for new/add
export const PlusIcon: React.FC<IconProps> = (props) => (
  <Icon {...props}>
    <line x1="12" y1="5" x2="12" y2="19" />
    <line x1="5" y1="12" x2="19" y2="12" />
  </Icon>
);

// Save/Disk - for save action
export const SaveIcon: React.FC<IconProps> = (props) => (
  <Icon {...props}>
    <path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z" />
    <polyline points="17 21 17 13 7 13 7 21" />
    <polyline points="7 3 7 8 15 8" />
  </Icon>
);

// Download/Export - for export
export const DownloadIcon: React.FC<IconProps> = (props) => (
  <Icon {...props}>
    <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4" />
    <polyline points="7 10 12 15 17 10" />
    <line x1="12" y1="15" x2="12" y2="3" />
  </Icon>
);

// Share - for sharing
export const ShareIcon: React.FC<IconProps> = (props) => (
  <Icon {...props}>
    <circle cx="18" cy="5" r="3" />
    <circle cx="6" cy="12" r="3" />
    <circle cx="18" cy="19" r="3" />
    <line x1="8.59" y1="13.51" x2="15.42" y2="17.49" />
    <line x1="15.41" y1="6.51" x2="8.59" y2="10.49" />
  </Icon>
);

// Settings/Cog - for settings
export const SettingsIcon: React.FC<IconProps> = (props) => (
  <Icon {...props}>
    <circle cx="12" cy="12" r="3" />
    <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z" />
  </Icon>
);

// Help/Question - for help
export const HelpIcon: React.FC<IconProps> = (props) => (
  <Icon {...props}>
    <circle cx="12" cy="12" r="10" />
    <path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3" />
    <line x1="12" y1="17" x2="12.01" y2="17" />
  </Icon>
);

// Sun - for light theme
export const SunIcon: React.FC<IconProps> = (props) => (
  <Icon {...props}>
    <circle cx="12" cy="12" r="5" />
    <line x1="12" y1="1" x2="12" y2="3" />
    <line x1="12" y1="21" x2="12" y2="23" />
    <line x1="4.22" y1="4.22" x2="5.64" y2="5.64" />
    <line x1="18.36" y1="18.36" x2="19.78" y2="19.78" />
    <line x1="1" y1="12" x2="3" y2="12" />
    <line x1="21" y1="12" x2="23" y2="12" />
    <line x1="4.22" y1="19.78" x2="5.64" y2="18.36" />
    <line x1="18.36" y1="5.64" x2="19.78" y2="4.22" />
  </Icon>
);

// Moon - for dark theme
export const MoonIcon: React.FC<IconProps> = (props) => (
  <Icon {...props}>
    <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z" />
  </Icon>
);

// History/Clock - for version history
export const HistoryIcon: React.FC<IconProps> = (props) => (
  <Icon {...props}>
    <circle cx="12" cy="12" r="10" />
    <polyline points="12 6 12 12 16 14" />
  </Icon>
);

// Wand/Magic - for wizard
export const WandIcon: React.FC<IconProps> = (props) => (
  <Icon {...props}>
    <path d="M15 4V2" />
    <path d="M15 16v-2" />
    <path d="M8 9h2" />
    <path d="M20 9h2" />
    <path d="M17.8 11.8 19 13" />
    <path d="M15 9h0" />
    <path d="M17.8 6.2 19 5" />
    <path d="m3 21 9-9" />
    <path d="M12.2 6.2 11 5" />
  </Icon>
);

// Rocket - for plan/launch
export const RocketIcon: React.FC<IconProps> = (props) => (
  <Icon {...props}>
    <path d="M4.5 16.5c-1.5 1.26-2 5-2 5s3.74-.5 5-2c.71-.84.7-2.13-.09-2.91a2.18 2.18 0 0 0-2.91-.09z" />
    <path d="m12 15-3-3a22 22 0 0 1 2-3.95A12.88 12.88 0 0 1 22 2c0 2.72-.78 7.5-6 11a22.35 22.35 0 0 1-4 2z" />
    <path d="M9 12H4s.55-3.03 2-4c1.62-1.08 5 0 5 0" />
    <path d="M12 15v5s3.03-.55 4-2c1.08-1.62 0-5 0-5" />
  </Icon>
);

// Layers - for phases/build
export const LayersIcon: React.FC<IconProps> = (props) => (
  <Icon {...props}>
    <polygon points="12 2 2 7 12 12 22 7 12 2" />
    <polyline points="2 17 12 22 22 17" />
    <polyline points="2 12 12 17 22 12" />
  </Icon>
);

// Layout/Grid - for layout builder
export const LayoutIcon: React.FC<IconProps> = (props) => (
  <Icon {...props}>
    <rect x="3" y="3" width="18" height="18" rx="2" ry="2" />
    <line x1="3" y1="9" x2="21" y2="9" />
    <line x1="9" y1="21" x2="9" y2="9" />
  </Icon>
);

// Apps/Grid - for my apps
export const AppsIcon: React.FC<IconProps> = (props) => (
  <Icon {...props}>
    <rect x="3" y="3" width="7" height="7" />
    <rect x="14" y="3" width="7" height="7" />
    <rect x="14" y="14" width="7" height="7" />
    <rect x="3" y="14" width="7" height="7" />
  </Icon>
);

// Message/Chat - for chat view
export const MessageIcon: React.FC<IconProps> = (props) => (
  <Icon {...props}>
    <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z" />
  </Icon>
);

// Code - for code view
export const CodeIcon: React.FC<IconProps> = (props) => (
  <Icon {...props}>
    <polyline points="16 18 22 12 16 6" />
    <polyline points="8 6 2 12 8 18" />
  </Icon>
);

// Eye - for preview view
export const EyeIcon: React.FC<IconProps> = (props) => (
  <Icon {...props}>
    <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z" />
    <circle cx="12" cy="12" r="3" />
  </Icon>
);

// Columns - for split view
export const ColumnsIcon: React.FC<IconProps> = (props) => (
  <Icon {...props}>
    <rect x="3" y="3" width="18" height="18" rx="2" ry="2" />
    <line x1="12" y1="3" x2="12" y2="21" />
  </Icon>
);

// Menu - for mobile menu
export const MenuIcon: React.FC<IconProps> = (props) => (
  <Icon {...props}>
    <line x1="3" y1="12" x2="21" y2="12" />
    <line x1="3" y1="6" x2="21" y2="6" />
    <line x1="3" y1="18" x2="21" y2="18" />
  </Icon>
);

// X/Close - for close
export const XIcon: React.FC<IconProps> = (props) => (
  <Icon {...props}>
    <line x1="18" y1="6" x2="6" y2="18" />
    <line x1="6" y1="6" x2="18" y2="18" />
  </Icon>
);

// Check - for checkmarks
export const CheckIcon: React.FC<IconProps> = (props) => (
  <Icon {...props}>
    <polyline points="20 6 9 17 4 12" />
  </Icon>
);

// Clipboard - for copy
export const ClipboardIcon: React.FC<IconProps> = (props) => (
  <Icon {...props}>
    <path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2" />
    <rect x="8" y="2" width="8" height="4" rx="1" ry="1" />
  </Icon>
);

// File/Document - for files
export const FileIcon: React.FC<IconProps> = (props) => (
  <Icon {...props}>
    <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z" />
    <polyline points="14 2 14 8 20 8" />
  </Icon>
);

// Archive/Zip - for zip export
export const ArchiveIcon: React.FC<IconProps> = (props) => (
  <Icon {...props}>
    <polyline points="21 8 21 21 3 21 3 8" />
    <rect x="1" y="3" width="22" height="5" />
    <line x1="10" y1="12" x2="14" y2="12" />
  </Icon>
);

// Play - for actions
export const PlayIcon: React.FC<IconProps> = (props) => (
  <Icon {...props}>
    <polygon points="5 3 19 12 5 21 5 3" />
  </Icon>
);

// ToggleLeft - for toggle off
export const ToggleLeftIcon: React.FC<IconProps> = (props) => (
  <Icon {...props}>
    <rect x="1" y="5" width="22" height="14" rx="7" ry="7" />
    <circle cx="8" cy="12" r="3" />
  </Icon>
);

// ToggleRight - for toggle on
export const ToggleRightIcon: React.FC<IconProps> = (props) => (
  <Icon {...props}>
    <rect x="1" y="5" width="22" height="14" rx="7" ry="7" />
    <circle cx="16" cy="12" r="3" />
  </Icon>
);

// Keyboard - for shortcuts
export const KeyboardIcon: React.FC<IconProps> = (props) => (
  <Icon {...props}>
    <rect x="2" y="4" width="20" height="16" rx="2" ry="2" />
    <path d="M6 8h.001" />
    <path d="M10 8h.001" />
    <path d="M14 8h.001" />
    <path d="M18 8h.001" />
    <path d="M8 12h.001" />
    <path d="M12 12h.001" />
    <path d="M16 12h.001" />
    <path d="M7 16h10" />
  </Icon>
);

// Zap/Lightning - for act mode
export const ZapIcon: React.FC<IconProps> = (props) => (
  <Icon {...props}>
    <polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2" />
  </Icon>
);

// Brain/Think - for plan mode
export const BrainIcon: React.FC<IconProps> = (props) => (
  <Icon {...props}>
    <path d="M9.5 2A2.5 2.5 0 0 1 12 4.5v15a2.5 2.5 0 0 1-4.96.44 2.5 2.5 0 0 1-2.96-3.08 3 3 0 0 1-.34-5.58 2.5 2.5 0 0 1 1.32-4.24 2.5 2.5 0 0 1 4.44-1.54" />
    <path d="M14.5 2A2.5 2.5 0 0 0 12 4.5v15a2.5 2.5 0 0 0 4.96.44 2.5 2.5 0 0 0 2.96-3.08 3 3 0 0 0 .34-5.58 2.5 2.5 0 0 0-1.32-4.24 2.5 2.5 0 0 0-4.44-1.54" />
  </Icon>
);
</file>

<file path="src/components/ui/ResizablePanel.tsx">
'use client';

import React from 'react';

// Symbol for component identification
export const RESIZABLE_PANEL_TYPE = Symbol.for('ResizablePanel');

export interface ResizablePanelProps {
  children: React.ReactNode;
  defaultSize?: number; // Percentage (0-100)
  minSize?: number; // Minimum percentage
  maxSize?: number; // Maximum percentage
  collapsible?: boolean;
  collapsedSize?: number;
  onCollapse?: () => void;
  onExpand?: () => void;
  className?: string;
  style?: React.CSSProperties;
  id?: string;
}

export interface ResizablePanelContextValue {
  size: number;
  isCollapsed: boolean;
  collapse: () => void;
  expand: () => void;
}

// Context for panel data (set by ResizablePanelGroup)
export const ResizablePanelContext = React.createContext<ResizablePanelContextValue | null>(null);

/**
 * ResizablePanel - A panel that can be resized within a ResizablePanelGroup
 *
 * @example
 * ```tsx
 * <ResizablePanelGroup direction="horizontal">
 *   <ResizablePanel defaultSize={30} minSize={20}>
 *     <ChatPanel />
 *   </ResizablePanel>
 *   <ResizableHandle />
 *   <ResizablePanel defaultSize={70} minSize={30}>
 *     <PreviewPanel />
 *   </ResizablePanel>
 * </ResizablePanelGroup>
 * ```
 */
export function ResizablePanel({
  children,
  defaultSize,
  minSize,
  maxSize,
  collapsible = false,
  collapsedSize = 0,
  onCollapse,
  onExpand,
  className = '',
  style = {},
  id,
}: ResizablePanelProps) {
  const context = React.useContext(ResizablePanelContext);

  // Get size from context or use default
  const currentSize = context?.size ?? defaultSize ?? 50;
  const isCollapsed = context?.isCollapsed ?? false;

  // Panel styles
  const panelStyle: React.CSSProperties = {
    ...style,
    overflow: 'hidden',
    position: 'relative',
  };

  return (
    <div
      className={`resizable-panel ${className} ${isCollapsed ? 'resizable-panel-collapsed' : ''}`}
      style={panelStyle}
      data-panel-id={id}
      data-panel-size={currentSize}
      data-min-size={minSize}
      data-max-size={maxSize}
      data-collapsible={collapsible}
      data-collapsed-size={collapsedSize}
      data-default-size={defaultSize}
    >
      {children}
    </div>
  );
}

// Attach type symbol for identification
ResizablePanel.displayName = 'ResizablePanel';
(ResizablePanel as any).__RESIZABLE_TYPE__ = RESIZABLE_PANEL_TYPE;

/**
 * Hook to access panel context from within a ResizablePanel
 */
export function useResizablePanelContext(): ResizablePanelContextValue | null {
  return React.useContext(ResizablePanelContext);
}

export default ResizablePanel;
</file>

<file path="src/components/ValidationMessage.tsx">
'use client';

import React from 'react';
import type { ValidationError } from '../utils/wizardValidation';

/**
 * ValidationMessage - Displays a single validation error or warning
 */
interface ValidationMessageProps {
  error: ValidationError | null;
  className?: string;
}

export function ValidationMessage({ error, className = '' }: ValidationMessageProps) {
  if (!error) return null;

  const isWarning = error.type === 'warning';

  return (
    <div
      className={`flex items-center gap-2 text-sm mt-1.5 animate-fade-in-up ${
        isWarning ? 'text-yellow-400' : 'text-red-400'
      } ${className}`}
    >
      <span className="flex-shrink-0">{isWarning ? '‚ö†Ô∏è' : '‚ùå'}</span>
      <span>{error.message}</span>
    </div>
  );
}

/**
 * CharacterCounter - Shows character count with visual feedback
 */
interface CharacterCounterProps {
  current: number;
  limit: number;
  className?: string;
}

export function CharacterCounter({ current, limit, className = '' }: CharacterCounterProps) {
  const percentage = (current / limit) * 100;
  const isOverLimit = current > limit;
  const isNearLimit = percentage >= 80 && percentage < 100;

  return (
    <div className={`flex items-center gap-2 ${className}`}>
      <div className="flex-1 h-1 bg-slate-700 rounded-full overflow-hidden">
        <div
          className={`h-full transition-all duration-300 ${
            isOverLimit ? 'bg-red-500' : isNearLimit ? 'bg-yellow-500' : 'bg-blue-500'
          }`}
          style={{ width: `${Math.min(percentage, 100)}%` }}
        />
      </div>
      <span
        className={`text-xs font-medium tabular-nums ${
          isOverLimit ? 'text-red-400' : isNearLimit ? 'text-yellow-400' : 'text-slate-400'
        }`}
      >
        {current}/{limit}
      </span>
    </div>
  );
}

/**
 * ValidatedField - Wrapper component with label, error display, character counter, and hint
 */
interface ValidatedFieldProps {
  label: string;
  required?: boolean;
  error?: ValidationError | null;
  hint?: string;
  characterCount?: {
    current: number;
    limit: number;
  };
  children: React.ReactNode;
  className?: string;
}

export function ValidatedField({
  label,
  required = false,
  error,
  hint,
  characterCount,
  children,
  className = '',
}: ValidatedFieldProps) {
  const hasError = error && error.type === 'error';
  const hasWarning = error && error.type === 'warning';

  return (
    <div className={`space-y-2 ${className}`}>
      <label className="flex items-center gap-1.5 text-sm font-medium text-slate-200">
        <span>{label}</span>
        {required && <span className="text-red-400 text-xs">*</span>}
      </label>

      <div
        className={`rounded-lg transition-all duration-200 ${
          hasError ? 'ring-2 ring-red-500/50' : hasWarning ? 'ring-2 ring-yellow-500/50' : ''
        }`}
      >
        {children}
      </div>

      {characterCount && (
        <CharacterCounter current={characterCount.current} limit={characterCount.limit} />
      )}

      {error && <ValidationMessage error={error} />}

      {hint && !error && <p className="text-xs text-slate-500 mt-1">{hint}</p>}
    </div>
  );
}

/**
 * ValidationSummary - Shows all validation errors in a summary box
 */
interface ValidationSummaryProps {
  errors: ValidationError[];
  className?: string;
}

export function ValidationSummary({ errors, className = '' }: ValidationSummaryProps) {
  const errorCount = errors.filter((e) => e.type === 'error').length;
  const warningCount = errors.filter((e) => e.type === 'warning').length;

  if (errors.length === 0) return null;

  return (
    <div
      className={`rounded-xl border p-4 ${
        errorCount > 0 ? 'bg-red-500/10 border-red-500/30' : 'bg-yellow-500/10 border-yellow-500/30'
      } ${className}`}
    >
      <div className="flex items-start gap-3">
        <span className="text-xl flex-shrink-0">{errorCount > 0 ? '‚ùå' : '‚ö†Ô∏è'}</span>
        <div className="flex-1">
          <h4 className={`font-medium mb-2 ${errorCount > 0 ? 'text-red-200' : 'text-yellow-200'}`}>
            {errorCount > 0
              ? `${errorCount} error${errorCount === 1 ? '' : 's'} found`
              : `${warningCount} warning${warningCount === 1 ? '' : 's'}`}
          </h4>
          <ul className="space-y-1">
            {errors.map((error, index) => (
              <li
                key={`${error.field}-${index}`}
                className={`text-sm ${error.type === 'error' ? 'text-red-300' : 'text-yellow-300'}`}
              >
                ‚Ä¢ {error.message}
              </li>
            ))}
          </ul>
        </div>
      </div>
    </div>
  );
}

export default ValidationMessage;
</file>

<file path="tailwind.config.js">
/** @type {import('tailwindcss').Config} */
module.exports = {
  content: [
    './src/app/**/*.{js,ts,jsx,tsx,mdx}',
    './src/pages/**/*.{js,ts,jsx,tsx,mdx}',
    './src/components/**/*.{js,ts,jsx,tsx,mdx}',
  ],
  darkMode: 'class',
  theme: {
    extend: {
      fontFamily: {
        'sans': ['Inter', 'system-ui', '-apple-system', 'BlinkMacSystemFont', 'Segoe UI', 'Roboto', 'Helvetica Neue', 'Arial', 'sans-serif'],
      },
      colors: {
        'primary': '#3B82F6',
        'secondary': '#6366F1',
        // Linear/Vercel-inspired color palette
        linear: {
          bg: '#0a0a0a',
          'bg-elevated': '#141414',
          'bg-hover': '#1a1a1a',
          'bg-subtle': '#18181b',
          border: '#262626',
          'border-subtle': '#1f1f1f',
          text: '#fafafa',
          'text-secondary': '#a1a1aa',
          'text-muted': '#71717a',
          accent: '#3b82f6',
          'accent-hover': '#2563eb',
        },
        zinc: {
          750: '#323238',
          850: '#1f1f23',
          925: '#131316',
        },
        // Extended grays with more steps
        gray: {
          850: '#1f2937',
          950: '#0d1117',
        },
        // Semantic colors
        success: {
          50: '#f0fdf4',
          100: '#dcfce7',
          200: '#bbf7d0',
          300: '#86efac',
          400: '#4ade80',
          500: '#22c55e',
          600: '#16a34a',
          700: '#15803d',
          800: '#166534',
          900: '#14532d',
        },
        warning: {
          50: '#fffbeb',
          100: '#fef3c7',
          200: '#fde68a',
          300: '#fcd34d',
          400: '#fbbf24',
          500: '#f59e0b',
          600: '#d97706',
          700: '#b45309',
          800: '#92400e',
          900: '#78350f',
        },
        error: {
          50: '#fef2f2',
          100: '#fee2e2',
          200: '#fecaca',
          300: '#fca5a5',
          400: '#f87171',
          500: '#ef4444',
          600: '#dc2626',
          700: '#b91c1c',
          800: '#991b1b',
          900: '#7f1d1d',
        },
        // Glass/transparency utilities
        glass: {
          light: 'rgba(255, 255, 255, 0.1)',
          medium: 'rgba(255, 255, 255, 0.2)',
          heavy: 'rgba(255, 255, 255, 0.3)',
        },
      },
      // Extended spacing scale
      spacing: {
        '18': '4.5rem',
        '22': '5.5rem',
        '30': '7.5rem',
        '34': '8.5rem',
        '38': '9.5rem',
        '42': '10.5rem',
        '50': '12.5rem',
        '58': '14.5rem',
        '66': '16.5rem',
        '74': '18.5rem',
        '82': '20.5rem',
        '90': '22.5rem',
        '128': '32rem',
        '144': '36rem',
      },
      // Typography extensions
      fontSize: {
        '2xs': ['0.625rem', { lineHeight: '0.875rem' }],
        '3xl': ['1.875rem', { lineHeight: '2.25rem' }],
        '4xl': ['2.25rem', { lineHeight: '2.5rem' }],
        '5xl': ['3rem', { lineHeight: '1.16' }],
        '6xl': ['3.75rem', { lineHeight: '1.1' }],
        '7xl': ['4.5rem', { lineHeight: '1.05' }],
        '8xl': ['6rem', { lineHeight: '1' }],
        '9xl': ['8rem', { lineHeight: '1' }],
      },
      // Custom box shadows
      boxShadow: {
        'inner-sm': 'inset 0 1px 2px 0 rgb(0 0 0 / 0.05)',
        'inner-md': 'inset 0 2px 4px 0 rgb(0 0 0 / 0.1)',
        'glow-sm': '0 0 10px rgba(59, 130, 246, 0.3)',
        'glow-md': '0 0 20px rgba(59, 130, 246, 0.4)',
        'glow-lg': '0 0 30px rgba(59, 130, 246, 0.5)',
        'glow-purple': '0 0 20px rgba(147, 51, 234, 0.4)',
        'glow-green': '0 0 20px rgba(34, 197, 94, 0.4)',
        'elevated-sm': '0 2px 8px -2px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.06)',
        'elevated-md': '0 4px 16px -4px rgba(0, 0, 0, 0.15), 0 2px 8px -2px rgba(0, 0, 0, 0.1)',
        'elevated-lg': '0 8px 32px -8px rgba(0, 0, 0, 0.2), 0 4px 16px -4px rgba(0, 0, 0, 0.15)',
      },
      // Backdrop blur extensions
      backdropBlur: {
        xs: '2px',
        '2xl': '40px',
        '3xl': '64px',
      },
      // Border radius extensions
      borderRadius: {
        '4xl': '2rem',
        '5xl': '2.5rem',
      },
      // Z-index scale
      zIndex: {
        '60': '60',
        '70': '70',
        '80': '80',
        '90': '90',
        '100': '100',
        'dropdown': '1000',
        'sticky': '1020',
        'modal': '1050',
        'popover': '1060',
        'tooltip': '1070',
        'toast': '1080',
      },
      // Transition timing functions
      transitionTimingFunction: {
        'bounce-in': 'cubic-bezier(0.68, -0.55, 0.265, 1.55)',
        'bounce-out': 'cubic-bezier(0.34, 1.56, 0.64, 1)',
        'smooth': 'cubic-bezier(0.4, 0, 0.2, 1)',
      },
      // Screen breakpoints
      screens: {
        'xs': '475px',
        '3xl': '1920px',
      },
      keyframes: {
        fadeIn: {
          '0%': { opacity: '0' },
          '100%': { opacity: '1' },
        },
        fadeOut: {
          '0%': { opacity: '1' },
          '100%': { opacity: '0' },
        },
        fadeInUp: {
          '0%': { opacity: '0', transform: 'translateY(10px)' },
          '100%': { opacity: '1', transform: 'translateY(0)' }
        },
        slideInRight: {
          '0%': { transform: 'translateX(100%)', opacity: '0' },
          '100%': { transform: 'translateX(0)', opacity: '1' },
        },
        slideInLeft: {
          '0%': { transform: 'translateX(-100%)', opacity: '0' },
          '100%': { transform: 'translateX(0)', opacity: '1' },
        },
        slideInUp: {
          '0%': { transform: 'translateY(100%)', opacity: '0' },
          '100%': { transform: 'translateY(0)', opacity: '1' },
        },
        slideInDown: {
          '0%': { transform: 'translateY(-100%)', opacity: '0' },
          '100%': { transform: 'translateY(0)', opacity: '1' },
        },
        scaleIn: {
          '0%': { transform: 'scale(0.9)', opacity: '0' },
          '100%': { transform: 'scale(1)', opacity: '1' },
        },
        pulseSoft: {
          '0%, 100%': { opacity: '1' },
          '50%': { opacity: '0.7' },
        },
        bounceSoft: {
          '0%, 100%': { transform: 'translateY(0)' },
          '50%': { transform: 'translateY(-5px)' },
        },
        shimmer: {
          '0%': { backgroundPosition: '-200% 0' },
          '100%': { backgroundPosition: '200% 0' },
        },
        glow: {
          '0%, 100%': { boxShadow: '0 0 5px rgba(59, 130, 246, 0.5)' },
          '50%': { boxShadow: '0 0 20px rgba(59, 130, 246, 0.8)' },
        },
        pulseGlow: {
          '0%, 100%': { boxShadow: '0 0 20px rgba(59, 130, 246, 0.5)' },
          '50%': { boxShadow: '0 0 40px rgba(59, 130, 246, 0.8)' }
        }
      },
      animation: {
        'fadeIn': 'fadeIn 0.3s ease-out',
        'fade-in': 'fadeIn 0.3s ease-out',
        'fade-out': 'fadeOut 0.3s ease-out',
        'fade-in-up': 'fadeInUp 0.5s ease-out',
        'slide-in-right': 'slideInRight 0.3s ease-out',
        'slide-in-left': 'slideInLeft 0.3s ease-out',
        'slide-in-up': 'slideInUp 0.3s ease-out',
        'slide-in-down': 'slideInDown 0.3s ease-out',
        'scale-in': 'scaleIn 0.2s ease-out',
        'spin-slow': 'spin 3s linear infinite',
        'pulse-soft': 'pulseSoft 2s ease-in-out infinite',
        'bounce-soft': 'bounceSoft 1s ease-in-out infinite',
        'shimmer': 'shimmer 2s linear infinite',
        'glow': 'glow 2s ease-in-out infinite',
        'pulse-glow': 'pulseGlow 2s ease-in-out infinite'
      }
    },
  },
  plugins: [],
  future: {
    removeDeprecatedGapUtilities: true,
    purgeLayersByDefault: true,
  },
}
</file>

<file path="src/app/signup/page.tsx">
'use client';

import { useState } from 'react';
import { useRouter } from 'next/navigation';
import Link from 'next/link';
import { useAuth } from '@/contexts/AuthContext';
import ThemeToggle from '@/components/ThemeToggle';

export default function SignupPage() {
  const [email, setEmail] = useState('');
  const [password, setPassword] = useState('');
  const [confirmPassword, setConfirmPassword] = useState('');
  const [fullName, setFullName] = useState('');
  const [showPassword, setShowPassword] = useState(false);
  const [showConfirmPassword, setShowConfirmPassword] = useState(false);
  const [error, setError] = useState('');
  const [loading, setLoading] = useState(false);
  const [successMessage, setSuccessMessage] = useState('');
  const router = useRouter();
  const { signUp } = useAuth();

  const handleSubmit = async (e: React.FormEvent) => {
    e.preventDefault();
    setLoading(true);
    setError('');
    setSuccessMessage('');

    // Validate passwords match
    if (password !== confirmPassword) {
      setError('Passwords do not match');
      setLoading(false);
      return;
    }

    // Validate password strength
    if (password.length < 6) {
      setError('Password must be at least 6 characters long');
      setLoading(false);
      return;
    }

    try {
      const { error } = await signUp(email, password, fullName);

      if (error) {
        setError(error.message || 'Failed to sign up');
      } else {
        setSuccessMessage(
          'Account created! Please check your email to confirm your account before signing in.'
        );
        // Clear form
        setEmail('');
        setPassword('');
        setConfirmPassword('');
        setFullName('');

        // Redirect to login after 3 seconds
        setTimeout(() => {
          router.push('/login');
        }, 3000);
      }
    } catch (err) {
      setError('Something went wrong');
    } finally {
      setLoading(false);
    }
  };

  return (
    <div className="min-h-screen bg-gradient-to-br from-slate-100 via-blue-50 to-slate-100 dark:from-slate-900 dark:via-purple-900 dark:to-slate-900 flex items-center justify-center p-4 transition-colors duration-300">
      {/* Theme Toggle - Top Right */}
      <div className="absolute top-4 right-4">
        <ThemeToggle size="md" showDropdown={true} />
      </div>

      <div className="max-w-md w-full">
        <div className="bg-white/80 dark:bg-slate-800/50 backdrop-blur-xl rounded-2xl border border-slate-200 dark:border-white/10 p-8 shadow-2xl transition-colors duration-300">
          {/* Logo/Title */}
          <div className="text-center mb-8">
            <div className="text-6xl mb-4">ü§ñ</div>
            <h1 className="text-3xl font-bold text-slate-900 dark:text-white mb-2 transition-colors duration-300">
              AI App Builder
            </h1>
            <p className="text-slate-600 dark:text-slate-400 transition-colors duration-300">
              Create your account
            </p>
          </div>

          {/* Success Message */}
          {successMessage && (
            <div className="mb-6 bg-green-500/10 border border-green-500/50 rounded-lg p-4 text-green-600 dark:text-green-400 text-sm transition-colors duration-300">
              <div className="flex items-start gap-2">
                <span className="text-xl">‚úÖ</span>
                <div>
                  <p className="font-semibold mb-1">Success!</p>
                  <p>{successMessage}</p>
                  <p className="mt-2 text-xs text-green-500 dark:text-green-300">
                    Redirecting to login...
                  </p>
                </div>
              </div>
            </div>
          )}

          {/* Signup Form */}
          <form onSubmit={handleSubmit} className="space-y-6">
            <div>
              <label
                htmlFor="fullName"
                className="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2 transition-colors duration-300"
              >
                Full Name (Optional)
              </label>
              <input
                id="fullName"
                type="text"
                value={fullName}
                onChange={(e) => setFullName(e.target.value)}
                placeholder="John Doe"
                disabled={loading || !!successMessage}
                className="w-full px-4 py-3 rounded-xl bg-slate-100 dark:bg-slate-900/80 border border-slate-300 dark:border-white/10 text-slate-900 dark:text-white placeholder-slate-400 dark:placeholder-slate-500 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent disabled:opacity-50 transition-colors duration-300"
                autoFocus
              />
            </div>

            <div>
              <label
                htmlFor="email"
                className="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2 transition-colors duration-300"
              >
                Email Address
              </label>
              <input
                id="email"
                type="email"
                value={email}
                onChange={(e) => setEmail(e.target.value)}
                placeholder="you@example.com"
                disabled={loading || !!successMessage}
                required
                className="w-full px-4 py-3 rounded-xl bg-slate-100 dark:bg-slate-900/80 border border-slate-300 dark:border-white/10 text-slate-900 dark:text-white placeholder-slate-400 dark:placeholder-slate-500 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent disabled:opacity-50 transition-colors duration-300"
              />
            </div>

            <div>
              <label
                htmlFor="password"
                className="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2 transition-colors duration-300"
              >
                Password
              </label>
              <div className="relative">
                <input
                  id="password"
                  type={showPassword ? 'text' : 'password'}
                  value={password}
                  onChange={(e) => setPassword(e.target.value)}
                  placeholder="At least 6 characters"
                  disabled={loading || !!successMessage}
                  required
                  className="w-full px-4 py-3 pr-12 rounded-xl bg-slate-100 dark:bg-slate-900/80 border border-slate-300 dark:border-white/10 text-slate-900 dark:text-white placeholder-slate-400 dark:placeholder-slate-500 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent disabled:opacity-50 transition-colors duration-300"
                />
                <button
                  type="button"
                  onClick={() => setShowPassword(!showPassword)}
                  className="absolute right-3 top-1/2 -translate-y-1/2 text-slate-500 hover:text-slate-700 dark:text-slate-400 dark:hover:text-slate-200 transition-colors"
                  tabIndex={-1}
                >
                  {showPassword ? (
                    <svg
                      xmlns="http://www.w3.org/2000/svg"
                      fill="none"
                      viewBox="0 0 24 24"
                      strokeWidth={1.5}
                      stroke="currentColor"
                      className="w-5 h-5"
                    >
                      <path
                        strokeLinecap="round"
                        strokeLinejoin="round"
                        d="M3.98 8.223A10.477 10.477 0 001.934 12C3.226 16.338 7.244 19.5 12 19.5c.993 0 1.953-.138 2.863-.395M6.228 6.228A10.45 10.45 0 0112 4.5c4.756 0 8.773 3.162 10.065 7.498a10.523 10.523 0 01-4.293 5.774M6.228 6.228L3 3m3.228 3.228l3.65 3.65m7.894 7.894L21 21m-3.228-3.228l-3.65-3.65m0 0a3 3 0 10-4.243-4.243m4.242 4.242L9.88 9.88"
                      />
                    </svg>
                  ) : (
                    <svg
                      xmlns="http://www.w3.org/2000/svg"
                      fill="none"
                      viewBox="0 0 24 24"
                      strokeWidth={1.5}
                      stroke="currentColor"
                      className="w-5 h-5"
                    >
                      <path
                        strokeLinecap="round"
                        strokeLinejoin="round"
                        d="M2.036 12.322a1.012 1.012 0 010-.639C3.423 7.51 7.36 4.5 12 4.5c4.638 0 8.573 3.007 9.963 7.178.07.207.07.431 0 .639C20.577 16.49 16.64 19.5 12 19.5c-4.638 0-8.573-3.007-9.963-7.178z"
                      />
                      <path
                        strokeLinecap="round"
                        strokeLinejoin="round"
                        d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"
                      />
                    </svg>
                  )}
                </button>
              </div>
            </div>

            <div>
              <label
                htmlFor="confirmPassword"
                className="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2 transition-colors duration-300"
              >
                Confirm Password
              </label>
              <div className="relative">
                <input
                  id="confirmPassword"
                  type={showConfirmPassword ? 'text' : 'password'}
                  value={confirmPassword}
                  onChange={(e) => setConfirmPassword(e.target.value)}
                  placeholder="Re-enter your password"
                  disabled={loading || !!successMessage}
                  required
                  className="w-full px-4 py-3 pr-12 rounded-xl bg-slate-100 dark:bg-slate-900/80 border border-slate-300 dark:border-white/10 text-slate-900 dark:text-white placeholder-slate-400 dark:placeholder-slate-500 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent disabled:opacity-50 transition-colors duration-300"
                />
                <button
                  type="button"
                  onClick={() => setShowConfirmPassword(!showConfirmPassword)}
                  className="absolute right-3 top-1/2 -translate-y-1/2 text-slate-500 hover:text-slate-700 dark:text-slate-400 dark:hover:text-slate-200 transition-colors"
                  tabIndex={-1}
                >
                  {showConfirmPassword ? (
                    <svg
                      xmlns="http://www.w3.org/2000/svg"
                      fill="none"
                      viewBox="0 0 24 24"
                      strokeWidth={1.5}
                      stroke="currentColor"
                      className="w-5 h-5"
                    >
                      <path
                        strokeLinecap="round"
                        strokeLinejoin="round"
                        d="M3.98 8.223A10.477 10.477 0 001.934 12C3.226 16.338 7.244 19.5 12 19.5c.993 0 1.953-.138 2.863-.395M6.228 6.228A10.45 10.45 0 0112 4.5c4.756 0 8.773 3.162 10.065 7.498a10.523 10.523 0 01-4.293 5.774M6.228 6.228L3 3m3.228 3.228l3.65 3.65m7.894 7.894L21 21m-3.228-3.228l-3.65-3.65m0 0a3 3 0 10-4.243-4.243m4.242 4.242L9.88 9.88"
                      />
                    </svg>
                  ) : (
                    <svg
                      xmlns="http://www.w3.org/2000/svg"
                      fill="none"
                      viewBox="0 0 24 24"
                      strokeWidth={1.5}
                      stroke="currentColor"
                      className="w-5 h-5"
                    >
                      <path
                        strokeLinecap="round"
                        strokeLinejoin="round"
                        d="M2.036 12.322a1.012 1.012 0 010-.639C3.423 7.51 7.36 4.5 12 4.5c4.638 0 8.573 3.007 9.963 7.178.07.207.07.431 0 .639C20.577 16.49 16.64 19.5 12 19.5c-4.638 0-8.573-3.007-9.963-7.178z"
                      />
                      <path
                        strokeLinecap="round"
                        strokeLinejoin="round"
                        d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"
                      />
                    </svg>
                  )}
                </button>
              </div>
            </div>

            {error && (
              <div className="bg-red-500/10 border border-red-500/50 rounded-lg p-3 text-red-600 dark:text-red-400 text-sm transition-colors duration-300">
                {error}
              </div>
            )}

            <button
              type="submit"
              disabled={loading || !email || !password || !confirmPassword || !!successMessage}
              className="w-full px-6 py-3 rounded-xl bg-gradient-to-r from-blue-600 to-purple-600 text-white font-medium hover:shadow-lg hover:shadow-blue-500/20 transition-all disabled:opacity-50 disabled:cursor-not-allowed"
            >
              {loading ? 'Creating account...' : 'Create Account'}
            </button>
          </form>

          {/* Sign In Link */}
          <div className="mt-6 text-center">
            <p className="text-sm text-slate-600 dark:text-slate-400 transition-colors duration-300">
              Already have an account?{' '}
              <Link
                href="/login"
                className="text-blue-600 dark:text-blue-400 hover:text-blue-500 dark:hover:text-blue-300 font-medium transition-colors"
              >
                Sign in
              </Link>
            </p>
          </div>

          {/* Footer */}
          <div className="mt-6 text-center text-xs text-slate-500 dark:text-slate-500 transition-colors duration-300">
            üîí Secure authentication with Supabase
          </div>
        </div>
      </div>
    </div>
  );
}
</file>

<file path="src/components/AppConceptWizard.tsx">
'use client';

import React, { useState, useEffect, useCallback, useMemo } from 'react';
import type {
  AppConcept,
  Feature,
  UIPreferences,
  TechnicalRequirements,
} from '../types/appConcept';
import type { FullTemplate } from '../types/architectureTemplates';
import {
  validateBasicInfo,
  validateFeatures,
  validateFeatureName,
  validateFeatureDescription,
  getCharacterCount,
  sanitizeInput,
} from '../utils/wizardValidation';
import type { ValidationError } from '../utils/wizardValidation';
import {
  createAutoSaver,
  WIZARD_DRAFT_KEYS,
  formatDraftAge,
  clearAllDrafts,
} from '../utils/wizardAutoSave';
import { ValidatedField, ValidationSummary } from './ValidationMessage';
import { FeatureLibrary } from './FeatureLibrary';
import { LayoutPreview } from './LayoutPreview';
import { TemplateSelector } from './TemplateSelector';

/**
 * Props for AppConceptWizard
 */
interface AppConceptWizardProps {
  onComplete: (concept: AppConcept) => void;
  onCancel: () => void;
  initialConcept?: Partial<AppConcept>;
}

/**
 * Wizard step configuration
 */
const STEPS = [
  { number: 1, title: 'Template', description: 'Choose a starting point' },
  { number: 2, title: 'Basic Info', description: 'Name and describe your app' },
  { number: 3, title: 'Features', description: 'Define core functionality' },
  { number: 4, title: 'Design', description: 'Choose look and feel' },
  { number: 5, title: 'Technical', description: 'Set requirements' },
  { number: 6, title: 'Review', description: 'Confirm and create' },
];

/**
 * Default UI preferences
 */
const defaultUIPreferences: UIPreferences = {
  style: 'modern',
  colorScheme: 'dark',
  layout: 'single-page',
  primaryColor: '#3B82F6',
};

/**
 * Default technical requirements
 */
const defaultTechnicalRequirements: TechnicalRequirements = {
  needsAuth: false,
  needsDatabase: false,
  needsAPI: false,
  needsFileUpload: false,
  needsRealtime: false,
};

/**
 * AppConceptWizard component
 */
export function AppConceptWizard({ onComplete, onCancel, initialConcept }: AppConceptWizardProps) {
  // Step navigation
  const [currentStep, setCurrentStep] = useState(1);

  // Template selection (Step 1)
  const [selectedTemplate, setSelectedTemplate] = useState<FullTemplate | null>(null);

  // Basic Info (Step 2)
  const [name, setName] = useState(initialConcept?.name || '');
  const [description, setDescription] = useState(initialConcept?.description || '');
  const [purpose, setPurpose] = useState(initialConcept?.purpose || '');
  const [targetUsers, setTargetUsers] = useState(initialConcept?.targetUsers || '');

  // Features (Step 3)
  const [features, setFeatures] = useState<Feature[]>(initialConcept?.coreFeatures || []);
  const [newFeatureName, setNewFeatureName] = useState('');
  const [newFeatureDescription, setNewFeatureDescription] = useState('');
  const [newFeaturePriority, setNewFeaturePriority] = useState<'high' | 'medium' | 'low'>('medium');
  const [showFeatureLibrary, setShowFeatureLibrary] = useState(false);

  // Design (Step 4)
  const [uiPreferences, setUiPreferences] = useState<UIPreferences>(
    initialConcept?.uiPreferences || defaultUIPreferences
  );

  // Technical (Step 5)
  const [technical, setTechnical] = useState<TechnicalRequirements>(
    initialConcept?.technical || defaultTechnicalRequirements
  );

  // Validation
  const [errors, setErrors] = useState<ValidationError[]>([]);
  const [touched, setTouched] = useState<Set<string>>(new Set());

  // Draft management
  const [showDraftPrompt, setShowDraftPrompt] = useState(false);
  const [draftAge, setDraftAge] = useState<string>('');

  // Auto-saver
  const autoSaver = useMemo(
    () => createAutoSaver<Partial<AppConcept>>(WIZARD_DRAFT_KEYS.APP_CONCEPT, 2000),
    []
  );

  // Check for existing draft on mount
  useEffect(() => {
    if (autoSaver.hasDraft() && !initialConcept) {
      const metadata = autoSaver.getMetadata();
      if (metadata && metadata.exists && metadata.timestamp) {
        setDraftAge(formatDraftAge(metadata.timestamp));
        setShowDraftPrompt(true);
      }
    }
  }, [autoSaver, initialConcept]);

  // Auto-save on data changes
  useEffect(() => {
    if (!showDraftPrompt) {
      const conceptData: Partial<AppConcept> = {
        name,
        description,
        purpose,
        targetUsers,
        coreFeatures: features,
        uiPreferences,
        technical,
      };
      autoSaver.start(conceptData);
    }

    return () => autoSaver.stop();
  }, [
    name,
    description,
    purpose,
    targetUsers,
    features,
    uiPreferences,
    technical,
    autoSaver,
    showDraftPrompt,
  ]);

  // Resume draft
  const resumeDraft = useCallback(() => {
    const draft = autoSaver.load();
    if (draft) {
      setName(draft.name || '');
      setDescription(draft.description || '');
      setPurpose(draft.purpose || '');
      setTargetUsers(draft.targetUsers || '');
      setFeatures(draft.coreFeatures || []);
      setUiPreferences(draft.uiPreferences || defaultUIPreferences);
      setTechnical(draft.technical || defaultTechnicalRequirements);
    }
    setShowDraftPrompt(false);
  }, [autoSaver]);

  // Discard draft
  const discardDraft = useCallback(() => {
    autoSaver.delete();
    setShowDraftPrompt(false);
  }, [autoSaver]);

  // Handle template selection
  const handleTemplateSelect = useCallback((template: FullTemplate) => {
    setSelectedTemplate(template);

    // Pre-populate description with template description (user-facing)
    setDescription(template.description);
    setPurpose(
      `Build a ${template.name.toLowerCase()} application using the ${template.layoutStructure.type} layout pattern.`
    );

    // Pre-populate features from template with meaningful descriptions
    const featureDescriptions: Record<string, string> = {
      'Sidebar navigation': 'Collapsible sidebar menu for easy navigation between sections',
      'Header with user menu': 'Top header bar with user profile, notifications, and settings',
      'Dashboard grid layout': 'Responsive grid system for organizing widgets and content',
      'Metric cards': 'Cards displaying key metrics and KPIs with icons',
      'Item list/table': 'Sortable table or list view for displaying data records',
      'Create form': 'Form with validation for creating new records',
      'Edit functionality': 'Inline or modal editing capabilities for existing records',
      'Delete with confirmation': 'Safe deletion with confirmation dialog',
      'Product listing': 'Grid or list view of products with filtering options',
      'Product detail page': 'Detailed product view with images, description, and variants',
      'Shopping cart': 'Cart functionality with item management and totals',
      'Checkout process': 'Multi-step checkout flow with payment integration',
      'User authentication': 'Login, registration, and password reset flows',
      'Onboarding flow': 'Multi-step wizard for new user setup',
      Dashboard: 'Main dashboard with overview metrics and quick actions',
      'Settings pages': 'User profile and account settings management',
      'Hero section': 'Prominent headline with call-to-action button',
      'Features showcase': 'Grid of feature cards highlighting key benefits',
      'Call-to-action buttons': 'Prominent buttons guiding users to take action',
      Footer: 'Site footer with navigation links and social icons',
      'Article listing': 'List of articles with pagination and filtering',
      'Article detail page': 'Full article view with rich content rendering',
      'Category navigation': 'Navigation by categories and tags',
      'Search functionality': 'Search with autocomplete and filters',
    };

    const templateFeatures: Feature[] = template.requiredFeatures.map((f, index) => ({
      id: `template-feature-${index}`,
      name: f,
      description: featureDescriptions[f] || `Implementation of ${f.toLowerCase()} functionality`,
      priority: 'high' as const,
    }));
    setFeatures(templateFeatures);

    // Pre-populate UI preferences based on template layout
    const layoutMap: Record<string, UIPreferences['layout']> = {
      sidebar: 'dashboard',
      topnav: 'multi-page',
      minimal: 'single-page',
      split: 'dashboard',
    };
    setUiPreferences((prev) => ({
      ...prev,
      layout: layoutMap[template.layoutStructure.type] || 'single-page',
    }));

    // Pre-populate technical requirements
    setTechnical((prev) => ({
      ...prev,
      needsAuth: template.technicalRequirements.needsAuth,
      needsDatabase: template.technicalRequirements.needsDatabase,
      needsAPI: template.technicalRequirements.needsAPI,
      needsFileUpload: template.technicalRequirements.needsFileUpload,
    }));

    // Move to next step
    setCurrentStep(2);
  }, []);

  // Handle skipping template selection
  const handleSkipTemplate = useCallback(() => {
    setSelectedTemplate(null);
    setCurrentStep(2);
  }, []);

  // Validate current step
  const validateCurrentStep = useCallback((): ValidationError[] => {
    switch (currentStep) {
      case 1:
        // Template selection is optional
        return [];
      case 2: {
        const result = validateBasicInfo({ name, description, purpose, targetUsers });
        return result.errors;
      }
      case 3: {
        const featuresError = validateFeatures(features);
        return featuresError ? [featuresError] : [];
      }
      default:
        return [];
    }
  }, [currentStep, name, description, purpose, targetUsers, features]);

  // Handle step navigation
  const goToNextStep = useCallback(() => {
    const stepErrors = validateCurrentStep();
    if (stepErrors.length > 0) {
      setErrors(stepErrors);
      // Mark all fields as touched
      setTouched(new Set(['name', 'description', 'purpose', 'targetUsers', 'features']));
      return;
    }

    setErrors([]);
    if (currentStep < STEPS.length) {
      setCurrentStep(currentStep + 1);
    }
  }, [currentStep, validateCurrentStep]);

  const goToPrevStep = useCallback(() => {
    if (currentStep > 1) {
      setCurrentStep(currentStep - 1);
      setErrors([]);
    }
  }, [currentStep]);

  // Handle feature management
  const addFeature = useCallback(() => {
    const nameError = validateFeatureName(newFeatureName, features);
    const descError = validateFeatureDescription(newFeatureDescription);

    if (nameError || descError) {
      const newErrors: ValidationError[] = [];
      if (nameError) newErrors.push(nameError);
      if (descError) newErrors.push(descError);
      setErrors(newErrors);
      return;
    }

    const newFeature: Feature = {
      id: `feature-${Date.now()}`,
      name: sanitizeInput(newFeatureName),
      description: sanitizeInput(newFeatureDescription),
      priority: newFeaturePriority,
    };

    setFeatures([...features, newFeature]);
    setNewFeatureName('');
    setNewFeatureDescription('');
    setNewFeaturePriority('medium');
    setErrors([]);
  }, [newFeatureName, newFeatureDescription, newFeaturePriority, features]);

  const removeFeature = useCallback(
    (id: string) => {
      setFeatures(features.filter((f) => f.id !== id));
    },
    [features]
  );

  const updateFeaturePriority = useCallback(
    (id: string, priority: 'high' | 'medium' | 'low') => {
      setFeatures(features.map((f) => (f.id === id ? { ...f, priority } : f)));
    },
    [features]
  );

  // Add feature from library
  const addFeatureFromLibrary = useCallback(
    (feature: Omit<Feature, 'id'>) => {
      const newFeature: Feature = {
        ...feature,
        id: `feature-${Date.now()}`,
      };
      setFeatures([...features, newFeature]);
    },
    [features]
  );

  // Handle completion
  const handleComplete = useCallback(() => {
    const concept: AppConcept = {
      name: sanitizeInput(name),
      description: sanitizeInput(description),
      purpose: sanitizeInput(purpose),
      targetUsers: sanitizeInput(targetUsers),
      coreFeatures: features,
      uiPreferences,
      technical,
      createdAt: new Date().toISOString(),
      updatedAt: new Date().toISOString(),
    };

    // Clear draft on successful completion
    clearAllDrafts();

    onComplete(concept);
  }, [name, description, purpose, targetUsers, features, uiPreferences, technical, onComplete]);

  // Mark field as touched on blur
  const handleBlur = (field: string) => {
    setTouched((prev) => new Set([...prev, field]));
  };

  // Get error for specific field
  const getFieldError = (field: string): ValidationError | null => {
    if (!touched.has(field)) return null;
    return errors.find((e) => e.field === field) || null;
  };

  // Build current concept for preview
  const currentConcept = useMemo(
    (): Partial<AppConcept> => ({
      name,
      description,
      purpose,
      targetUsers,
      coreFeatures: features,
      uiPreferences,
      technical,
    }),
    [name, description, purpose, targetUsers, features, uiPreferences, technical]
  );

  // Render step content
  const renderStepContent = () => {
    switch (currentStep) {
      case 1:
        return (
          <TemplateSelector
            onSelect={handleTemplateSelect}
            onSkip={handleSkipTemplate}
            userDescription={description}
          />
        );

      case 2:
        return (
          <div className="space-y-6">
            {/* Show selected template badge */}
            {selectedTemplate && (
              <div className="p-3 rounded-lg bg-blue-500/10 border border-blue-500/30 flex items-center gap-3">
                <span className="text-xl">{selectedTemplate.icon}</span>
                <div className="flex-1">
                  <span className="text-sm text-blue-200">Using template:</span>
                  <span className="ml-2 font-medium text-white">{selectedTemplate.name}</span>
                </div>
                <button
                  onClick={() => setCurrentStep(1)}
                  className="text-xs text-blue-300 hover:text-blue-200"
                >
                  Change
                </button>
              </div>
            )}

            <ValidatedField
              label="App Name"
              required
              error={getFieldError('name')}
              characterCount={getCharacterCount(name, 50)}
              hint="Choose a memorable name for your app"
            >
              <input
                type="text"
                value={name}
                onChange={(e) => setName(e.target.value)}
                onBlur={() => handleBlur('name')}
                placeholder="My Amazing App"
                className="w-full px-4 py-3 rounded-lg bg-slate-800 border border-white/10 text-white placeholder-slate-500 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
              />
            </ValidatedField>

            <ValidatedField
              label="Description"
              required
              error={getFieldError('description')}
              characterCount={getCharacterCount(description, 500)}
              hint="What does your app do? Be specific about its main purpose"
            >
              <textarea
                value={description}
                onChange={(e) => setDescription(e.target.value)}
                onBlur={() => handleBlur('description')}
                placeholder="A comprehensive app that helps users..."
                rows={4}
                className="w-full px-4 py-3 rounded-lg bg-slate-800 border border-white/10 text-white placeholder-slate-500 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent resize-none"
              />
            </ValidatedField>

            <ValidatedField
              label="Purpose"
              required
              error={getFieldError('purpose')}
              characterCount={getCharacterCount(purpose, 300)}
              hint="What problem does your app solve?"
            >
              <textarea
                value={purpose}
                onChange={(e) => setPurpose(e.target.value)}
                onBlur={() => handleBlur('purpose')}
                placeholder="The main goal is to help users..."
                rows={3}
                className="w-full px-4 py-3 rounded-lg bg-slate-800 border border-white/10 text-white placeholder-slate-500 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent resize-none"
              />
            </ValidatedField>

            <ValidatedField
              label="Target Users"
              required
              error={getFieldError('targetUsers')}
              characterCount={getCharacterCount(targetUsers, 200)}
              hint="Who will use this app?"
            >
              <input
                type="text"
                value={targetUsers}
                onChange={(e) => setTargetUsers(e.target.value)}
                onBlur={() => handleBlur('targetUsers')}
                placeholder="Small business owners, developers, students..."
                className="w-full px-4 py-3 rounded-lg bg-slate-800 border border-white/10 text-white placeholder-slate-500 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
              />
            </ValidatedField>
          </div>
        );

      case 3:
        return (
          <div className="space-y-6">
            {/* Feature Library Button */}
            <button
              onClick={() => setShowFeatureLibrary(true)}
              className="w-full px-4 py-3 rounded-lg bg-purple-600/20 border border-purple-500/30 text-purple-200 hover:bg-purple-600/30 transition-all flex items-center justify-center gap-2"
            >
              <span>üìö</span>
              <span>Browse Feature Library</span>
            </button>

            {/* Existing Features */}
            {features.length > 0 && (
              <div className="space-y-3">
                <h4 className="text-sm font-medium text-slate-300">
                  Added Features ({features.length})
                </h4>
                <div className="space-y-2">
                  {features.map((feature) => (
                    <div
                      key={feature.id}
                      className="flex items-start gap-3 p-4 rounded-lg bg-slate-800/50 border border-white/5"
                    >
                      <div className="flex-1">
                        <div className="flex items-center gap-2 mb-1">
                          <span className="font-medium text-white">{feature.name}</span>
                          <select
                            value={feature.priority}
                            onChange={(e) =>
                              updateFeaturePriority(
                                feature.id,
                                e.target.value as 'high' | 'medium' | 'low'
                              )
                            }
                            className={`text-xs px-2 py-0.5 rounded-full border-0 ${
                              feature.priority === 'high'
                                ? 'bg-red-500/20 text-red-300'
                                : feature.priority === 'medium'
                                  ? 'bg-yellow-500/20 text-yellow-300'
                                  : 'bg-green-500/20 text-green-300'
                            }`}
                          >
                            <option value="high">High</option>
                            <option value="medium">Medium</option>
                            <option value="low">Low</option>
                          </select>
                        </div>
                        <p className="text-sm text-slate-400">{feature.description}</p>
                      </div>
                      <button
                        onClick={() => removeFeature(feature.id)}
                        className="p-1.5 rounded-lg hover:bg-white/10 text-red-400 hover:text-red-300 transition-colors"
                      >
                        üóëÔ∏è
                      </button>
                    </div>
                  ))}
                </div>
              </div>
            )}

            {/* Add Custom Feature */}
            <div className="p-4 rounded-lg bg-slate-800/30 border border-white/5 space-y-4">
              <h4 className="text-sm font-medium text-slate-300">Add Custom Feature</h4>

              <div className="grid grid-cols-1 sm:grid-cols-2 gap-4">
                <input
                  type="text"
                  value={newFeatureName}
                  onChange={(e) => setNewFeatureName(e.target.value)}
                  placeholder="Feature name"
                  className="px-4 py-2.5 rounded-lg bg-slate-800 border border-white/10 text-white placeholder-slate-500 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                />
                <select
                  value={newFeaturePriority}
                  onChange={(e) =>
                    setNewFeaturePriority(e.target.value as 'high' | 'medium' | 'low')
                  }
                  className="px-4 py-2.5 rounded-lg bg-slate-800 border border-white/10 text-white focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                >
                  <option value="high">High Priority</option>
                  <option value="medium">Medium Priority</option>
                  <option value="low">Low Priority</option>
                </select>
              </div>

              <textarea
                value={newFeatureDescription}
                onChange={(e) => setNewFeatureDescription(e.target.value)}
                placeholder="Describe what this feature does..."
                rows={2}
                className="w-full px-4 py-2.5 rounded-lg bg-slate-800 border border-white/10 text-white placeholder-slate-500 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent resize-none"
              />

              <button
                onClick={addFeature}
                disabled={!newFeatureName.trim() || !newFeatureDescription.trim()}
                className="w-full px-4 py-2.5 rounded-lg bg-blue-600 hover:bg-blue-700 text-white font-medium transition-all disabled:opacity-50 disabled:cursor-not-allowed"
              >
                Add Feature
              </button>
            </div>

            {errors.length > 0 && <ValidationSummary errors={errors} />}
          </div>
        );

      case 4:
        return (
          <div className="space-y-6">
            <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
              {/* Design Options */}
              <div className="space-y-6">
                {/* Style */}
                <div className="space-y-3">
                  <label className="text-sm font-medium text-slate-300">Visual Style</label>
                  <div className="grid grid-cols-2 gap-2">
                    {(['modern', 'minimalist', 'playful', 'professional'] as const).map((style) => (
                      <button
                        key={style}
                        onClick={() => setUiPreferences({ ...uiPreferences, style })}
                        className={`px-4 py-3 rounded-lg border text-left transition-all ${
                          uiPreferences.style === style
                            ? 'bg-blue-600/20 border-blue-500/50 text-blue-200'
                            : 'bg-slate-800/50 border-white/10 text-slate-300 hover:bg-slate-800'
                        }`}
                      >
                        <span className="capitalize font-medium">{style}</span>
                      </button>
                    ))}
                  </div>
                </div>

                {/* Color Scheme */}
                <div className="space-y-3">
                  <label className="text-sm font-medium text-slate-300">Color Scheme</label>
                  <div className="grid grid-cols-2 gap-2">
                    {(['light', 'dark'] as const).map((scheme) => (
                      <button
                        key={scheme}
                        onClick={() => setUiPreferences({ ...uiPreferences, colorScheme: scheme })}
                        className={`px-4 py-3 rounded-lg border text-left transition-all ${
                          uiPreferences.colorScheme === scheme
                            ? 'bg-blue-600/20 border-blue-500/50 text-blue-200'
                            : 'bg-slate-800/50 border-white/10 text-slate-300 hover:bg-slate-800'
                        }`}
                      >
                        <span className="capitalize font-medium">
                          {scheme === 'light' ? '‚òÄÔ∏è Light' : 'üåô Dark'}
                        </span>
                      </button>
                    ))}
                  </div>
                </div>

                {/* Layout */}
                <div className="space-y-3">
                  <label className="text-sm font-medium text-slate-300">Layout Type</label>
                  <div className="grid grid-cols-1 gap-2">
                    {[
                      { value: 'single-page', label: 'Single Page', icon: 'üìÑ' },
                      { value: 'multi-page', label: 'Multi-Page', icon: 'üìë' },
                      { value: 'dashboard', label: 'Dashboard', icon: 'üìä' },
                    ].map((layout) => (
                      <button
                        key={layout.value}
                        onClick={() =>
                          setUiPreferences({
                            ...uiPreferences,
                            layout: layout.value as UIPreferences['layout'],
                          })
                        }
                        className={`px-4 py-3 rounded-lg border text-left transition-all ${
                          uiPreferences.layout === layout.value
                            ? 'bg-blue-600/20 border-blue-500/50 text-blue-200'
                            : 'bg-slate-800/50 border-white/10 text-slate-300 hover:bg-slate-800'
                        }`}
                      >
                        <span className="font-medium">
                          {layout.icon} {layout.label}
                        </span>
                      </button>
                    ))}
                  </div>
                </div>

                {/* Primary Color */}
                <div className="space-y-3">
                  <label className="text-sm font-medium text-slate-300">Primary Color</label>
                  <div className="flex items-center gap-3">
                    <input
                      type="color"
                      value={uiPreferences.primaryColor || '#3B82F6'}
                      onChange={(e) =>
                        setUiPreferences({ ...uiPreferences, primaryColor: e.target.value })
                      }
                      className="w-12 h-12 rounded-lg cursor-pointer border border-white/10"
                    />
                    <input
                      type="text"
                      value={uiPreferences.primaryColor || '#3B82F6'}
                      onChange={(e) =>
                        setUiPreferences({ ...uiPreferences, primaryColor: e.target.value })
                      }
                      className="flex-1 px-4 py-2.5 rounded-lg bg-slate-800 border border-white/10 text-white placeholder-slate-500 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent font-mono text-sm"
                    />
                  </div>
                </div>
              </div>

              {/* Live Preview */}
              <div className="bg-slate-900 rounded-xl border border-white/10 p-4 h-[500px]">
                <h4 className="text-sm font-medium text-slate-300 mb-3">Live Preview</h4>
                <LayoutPreview
                  preferences={uiPreferences}
                  concept={currentConcept}
                  className="h-[calc(100%-28px)]"
                  onPreferenceChange={(prefs) => setUiPreferences({ ...uiPreferences, ...prefs })}
                />
              </div>
            </div>
          </div>
        );

      case 5:
        return (
          <div className="space-y-6">
            <div className="grid grid-cols-1 sm:grid-cols-2 gap-4">
              {/* Authentication */}
              <div
                onClick={() => setTechnical({ ...technical, needsAuth: !technical.needsAuth })}
                className={`p-4 rounded-xl border cursor-pointer transition-all ${
                  technical.needsAuth
                    ? 'bg-blue-600/20 border-blue-500/50'
                    : 'bg-slate-800/50 border-white/10 hover:bg-slate-800'
                }`}
              >
                <div className="flex items-center gap-3 mb-2">
                  <span className="text-2xl">üîê</span>
                  <span
                    className={`font-medium ${technical.needsAuth ? 'text-blue-200' : 'text-white'}`}
                  >
                    User Authentication
                  </span>
                </div>
                <p className="text-sm text-slate-400">Login, signup, and user sessions</p>
                {technical.needsAuth && (
                  <div className="mt-3 flex gap-2">
                    {(['simple', 'email', 'oauth'] as const).map((type) => (
                      <button
                        key={type}
                        onClick={(e) => {
                          e.stopPropagation();
                          setTechnical({ ...technical, authType: type });
                        }}
                        className={`px-2 py-1 rounded text-xs ${
                          technical.authType === type
                            ? 'bg-blue-500 text-white'
                            : 'bg-slate-700 text-slate-300 hover:bg-slate-600'
                        }`}
                      >
                        {type}
                      </button>
                    ))}
                  </div>
                )}
              </div>

              {/* Database */}
              <div
                onClick={() =>
                  setTechnical({ ...technical, needsDatabase: !technical.needsDatabase })
                }
                className={`p-4 rounded-xl border cursor-pointer transition-all ${
                  technical.needsDatabase
                    ? 'bg-blue-600/20 border-blue-500/50'
                    : 'bg-slate-800/50 border-white/10 hover:bg-slate-800'
                }`}
              >
                <div className="flex items-center gap-3 mb-2">
                  <span className="text-2xl">üóÑÔ∏è</span>
                  <span
                    className={`font-medium ${technical.needsDatabase ? 'text-blue-200' : 'text-white'}`}
                  >
                    Database Storage
                  </span>
                </div>
                <p className="text-sm text-slate-400">Persistent data storage and retrieval</p>
              </div>

              {/* API */}
              <div
                onClick={() => setTechnical({ ...technical, needsAPI: !technical.needsAPI })}
                className={`p-4 rounded-xl border cursor-pointer transition-all ${
                  technical.needsAPI
                    ? 'bg-blue-600/20 border-blue-500/50'
                    : 'bg-slate-800/50 border-white/10 hover:bg-slate-800'
                }`}
              >
                <div className="flex items-center gap-3 mb-2">
                  <span className="text-2xl">üîå</span>
                  <span
                    className={`font-medium ${technical.needsAPI ? 'text-blue-200' : 'text-white'}`}
                  >
                    External APIs
                  </span>
                </div>
                <p className="text-sm text-slate-400">Connect to third-party services</p>
              </div>

              {/* File Upload */}
              <div
                onClick={() =>
                  setTechnical({ ...technical, needsFileUpload: !technical.needsFileUpload })
                }
                className={`p-4 rounded-xl border cursor-pointer transition-all ${
                  technical.needsFileUpload
                    ? 'bg-blue-600/20 border-blue-500/50'
                    : 'bg-slate-800/50 border-white/10 hover:bg-slate-800'
                }`}
              >
                <div className="flex items-center gap-3 mb-2">
                  <span className="text-2xl">üìÅ</span>
                  <span
                    className={`font-medium ${technical.needsFileUpload ? 'text-blue-200' : 'text-white'}`}
                  >
                    File Upload
                  </span>
                </div>
                <p className="text-sm text-slate-400">Upload and manage files/images</p>
              </div>

              {/* Realtime */}
              <div
                onClick={() =>
                  setTechnical({ ...technical, needsRealtime: !technical.needsRealtime })
                }
                className={`p-4 rounded-xl border cursor-pointer transition-all ${
                  technical.needsRealtime
                    ? 'bg-blue-600/20 border-blue-500/50'
                    : 'bg-slate-800/50 border-white/10 hover:bg-slate-800'
                }`}
              >
                <div className="flex items-center gap-3 mb-2">
                  <span className="text-2xl">‚ö°</span>
                  <span
                    className={`font-medium ${technical.needsRealtime ? 'text-blue-200' : 'text-white'}`}
                  >
                    Real-time Updates
                  </span>
                </div>
                <p className="text-sm text-slate-400">Live data sync and notifications</p>
              </div>
            </div>
          </div>
        );

      case 6:
        return (
          <div className="space-y-6">
            {/* Template Info if selected */}
            {selectedTemplate && (
              <div className="p-4 rounded-xl bg-gradient-to-r from-blue-500/10 to-purple-500/10 border border-blue-500/30">
                <h4 className="font-medium text-white mb-2 flex items-center gap-2">
                  <span>{selectedTemplate.icon}</span> Using {selectedTemplate.name} Template
                </h4>
                <p className="text-sm text-slate-400">{selectedTemplate.description}</p>
              </div>
            )}

            {/* Summary Cards */}
            <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
              {/* Basic Info Summary */}
              <div className="p-4 rounded-xl bg-slate-800/50 border border-white/10">
                <h4 className="font-medium text-white mb-3 flex items-center gap-2">
                  <span>üìã</span> Basic Information
                </h4>
                <div className="space-y-2 text-sm">
                  <div>
                    <span className="text-slate-400">Name:</span>{' '}
                    <span className="text-white">{name}</span>
                  </div>
                  <div>
                    <span className="text-slate-400">Target Users:</span>{' '}
                    <span className="text-white">{targetUsers}</span>
                  </div>
                  <div className="text-slate-300 line-clamp-2">{description}</div>
                </div>
              </div>

              {/* Features Summary */}
              <div className="p-4 rounded-xl bg-slate-800/50 border border-white/10">
                <h4 className="font-medium text-white mb-3 flex items-center gap-2">
                  <span>‚ú®</span> Features ({features.length})
                </h4>
                <div className="space-y-1.5">
                  {features.slice(0, 4).map((f) => (
                    <div key={f.id} className="flex items-center gap-2 text-sm">
                      <span
                        className={`w-2 h-2 rounded-full ${
                          f.priority === 'high'
                            ? 'bg-red-500'
                            : f.priority === 'medium'
                              ? 'bg-yellow-500'
                              : 'bg-green-500'
                        }`}
                      />
                      <span className="text-slate-300">{f.name}</span>
                    </div>
                  ))}
                  {features.length > 4 && (
                    <p className="text-xs text-slate-500">+{features.length - 4} more</p>
                  )}
                </div>
              </div>

              {/* Design Summary */}
              <div className="p-4 rounded-xl bg-slate-800/50 border border-white/10">
                <h4 className="font-medium text-white mb-3 flex items-center gap-2">
                  <span>üé®</span> Design
                </h4>
                <div className="flex flex-wrap gap-2">
                  <span className="px-2 py-1 rounded bg-slate-700 text-slate-300 text-xs capitalize">
                    {uiPreferences.style}
                  </span>
                  <span className="px-2 py-1 rounded bg-slate-700 text-slate-300 text-xs capitalize">
                    {uiPreferences.colorScheme}
                  </span>
                  <span className="px-2 py-1 rounded bg-slate-700 text-slate-300 text-xs">
                    {uiPreferences.layout}
                  </span>
                  <span
                    className="px-2 py-1 rounded text-white text-xs"
                    style={{ backgroundColor: uiPreferences.primaryColor }}
                  >
                    {uiPreferences.primaryColor}
                  </span>
                </div>
              </div>

              {/* Technical Summary */}
              <div className="p-4 rounded-xl bg-slate-800/50 border border-white/10">
                <h4 className="font-medium text-white mb-3 flex items-center gap-2">
                  <span>‚öôÔ∏è</span> Technical
                </h4>
                <div className="flex flex-wrap gap-2">
                  {technical.needsAuth && (
                    <span className="px-2 py-1 rounded bg-blue-500/20 text-blue-200 text-xs">
                      üîê Auth ({technical.authType || 'simple'})
                    </span>
                  )}
                  {technical.needsDatabase && (
                    <span className="px-2 py-1 rounded bg-blue-500/20 text-blue-200 text-xs">
                      üóÑÔ∏è Database
                    </span>
                  )}
                  {technical.needsAPI && (
                    <span className="px-2 py-1 rounded bg-blue-500/20 text-blue-200 text-xs">
                      üîå API
                    </span>
                  )}
                  {technical.needsFileUpload && (
                    <span className="px-2 py-1 rounded bg-blue-500/20 text-blue-200 text-xs">
                      üìÅ File Upload
                    </span>
                  )}
                  {technical.needsRealtime && (
                    <span className="px-2 py-1 rounded bg-blue-500/20 text-blue-200 text-xs">
                      ‚ö° Realtime
                    </span>
                  )}
                  {!technical.needsAuth &&
                    !technical.needsDatabase &&
                    !technical.needsAPI &&
                    !technical.needsFileUpload &&
                    !technical.needsRealtime && (
                      <span className="text-xs text-slate-500">No special requirements</span>
                    )}
                </div>
              </div>
            </div>

            {/* Preview */}
            <div className="bg-slate-900 rounded-xl border border-white/10 p-4 h-[300px]">
              <h4 className="text-sm font-medium text-slate-300 mb-3">Final Preview</h4>
              <LayoutPreview
                preferences={uiPreferences}
                concept={currentConcept}
                className="h-[calc(100%-28px)]"
              />
            </div>
          </div>
        );

      default:
        return null;
    }
  };

  return (
    <div className="fixed inset-0 bg-black/80 backdrop-blur-sm z-50 flex items-center justify-center p-4">
      <div className="bg-slate-900 rounded-2xl border border-white/10 max-w-5xl w-full max-h-[90vh] overflow-hidden shadow-2xl flex flex-col">
        {/* Draft Resume Prompt */}
        {showDraftPrompt && (
          <div className="absolute inset-0 bg-black/80 backdrop-blur-sm z-10 flex items-center justify-center p-4">
            <div className="bg-slate-800 rounded-2xl border border-white/10 max-w-md w-full p-6 text-center">
              <div className="text-4xl mb-4">üìù</div>
              <h3 className="text-xl font-bold text-white mb-2">Resume Draft?</h3>
              <p className="text-slate-400 mb-6">
                You have an unsaved draft from {draftAge}. Would you like to continue where you left
                off?
              </p>
              <div className="flex gap-3">
                <button
                  onClick={discardDraft}
                  className="flex-1 px-4 py-2.5 rounded-lg bg-slate-700 hover:bg-slate-600 text-white font-medium transition-all"
                >
                  Start Fresh
                </button>
                <button
                  onClick={resumeDraft}
                  className="flex-1 px-4 py-2.5 rounded-lg bg-blue-600 hover:bg-blue-700 text-white font-medium transition-all"
                >
                  Resume Draft
                </button>
              </div>
            </div>
          </div>
        )}

        {/* Header */}
        <div className="px-6 py-5 border-b border-white/10 bg-gradient-to-r from-purple-500/20 to-blue-500/20">
          <div className="flex items-center justify-between">
            <div className="flex items-center gap-3">
              <div className="w-12 h-12 rounded-xl bg-purple-500/20 flex items-center justify-center">
                <span className="text-3xl">üöÄ</span>
              </div>
              <div>
                <h2 className="text-xl font-bold text-white">App Concept Wizard</h2>
                <p className="text-sm text-slate-300">
                  Step {currentStep} of {STEPS.length}: {STEPS[currentStep - 1].title}
                </p>
              </div>
            </div>
            <button onClick={onCancel} className="p-2 rounded-lg hover:bg-white/10 transition-all">
              <span className="text-slate-400 text-xl">‚úï</span>
            </button>
          </div>
        </div>

        {/* Progress Bar */}
        <div className="px-6 py-4 border-b border-white/10 bg-black/20">
          <div className="flex items-center gap-2">
            {STEPS.map((step, index) => (
              <React.Fragment key={step.number}>
                <button
                  onClick={() => {
                    if (step.number < currentStep) {
                      setCurrentStep(step.number);
                    }
                  }}
                  disabled={step.number > currentStep}
                  className={`flex items-center gap-2 px-3 py-1.5 rounded-lg transition-all ${
                    step.number === currentStep
                      ? 'bg-blue-600 text-white'
                      : step.number < currentStep
                        ? 'bg-green-600/20 text-green-300 hover:bg-green-600/30 cursor-pointer'
                        : 'bg-slate-800 text-slate-500 cursor-not-allowed'
                  }`}
                >
                  <span className="w-6 h-6 rounded-full bg-white/10 flex items-center justify-center text-sm">
                    {step.number < currentStep ? '‚úì' : step.number}
                  </span>
                  <span className="hidden sm:inline text-sm font-medium">{step.title}</span>
                </button>
                {index < STEPS.length - 1 && (
                  <div
                    className={`flex-1 h-0.5 ${
                      step.number < currentStep ? 'bg-green-500' : 'bg-slate-700'
                    }`}
                  />
                )}
              </React.Fragment>
            ))}
          </div>
        </div>

        {/* Content */}
        <div className="flex-1 min-h-0 overflow-y-auto p-6">{renderStepContent()}</div>

        {/* Footer */}
        <div className="px-6 py-4 border-t border-white/10 bg-black/20 flex items-center justify-between">
          <button
            onClick={onCancel}
            className="px-4 py-2.5 rounded-lg bg-slate-700 hover:bg-slate-600 text-white font-medium transition-all"
          >
            Cancel
          </button>

          <div className="flex gap-3">
            {currentStep > 1 && (
              <button
                onClick={goToPrevStep}
                className="px-4 py-2.5 rounded-lg bg-slate-700 hover:bg-slate-600 text-white font-medium transition-all"
              >
                ‚Üê Back
              </button>
            )}

            {currentStep < STEPS.length ? (
              <button
                onClick={goToNextStep}
                className="px-6 py-2.5 rounded-lg bg-blue-600 hover:bg-blue-700 text-white font-medium transition-all"
              >
                Next ‚Üí
              </button>
            ) : (
              <button
                onClick={handleComplete}
                className="px-6 py-2.5 rounded-lg bg-gradient-to-r from-green-500 to-emerald-600 hover:from-green-600 hover:to-emerald-700 text-white font-medium transition-all shadow-lg"
              >
                ‚ú® Create App Concept
              </button>
            )}
          </div>
        </div>
      </div>

      {/* Feature Library Modal */}
      <FeatureLibrary
        isOpen={showFeatureLibrary}
        onClose={() => setShowFeatureLibrary(false)}
        onSelectFeature={addFeatureFromLibrary}
        existingFeatureNames={features.map((f) => f.name)}
      />
    </div>
  );
}

export default AppConceptWizard;
</file>

<file path="src/components/build/PhaseDetailView.tsx">
'use client';

import React from 'react';
import type { BuildPhase, PhaseTask, ValidationCheck } from '../../types/buildPhases';

/** Maximum length for code preview in task details */
const MAX_TASK_CODE_PREVIEW_LENGTH = 500;

interface PhaseDetailViewProps {
  phase: BuildPhase;
  isOpen: boolean;
  onClose: () => void;
  onBuildPhase: () => void;
  onSkipPhase: () => void;
  onRetryPhase: () => void;
  generatedCode?: string;
  className?: string;
}

/**
 * Modal showing detailed phase information and generated code
 */
export function PhaseDetailView({
  phase,
  isOpen,
  onClose,
  onBuildPhase,
  onSkipPhase,
  onRetryPhase,
  generatedCode,
  className = '',
}: PhaseDetailViewProps) {
  const [activeTab, setActiveTab] = React.useState<'tasks' | 'validation' | 'code'>('tasks');

  if (!isOpen) return null;

  const completedTasks = phase.tasks.filter((t) => t.status === 'completed').length;
  const failedTasks = phase.tasks.filter((t) => t.status === 'failed').length;
  const passedChecks = phase.validationChecks.filter((c) => c.passed).length;

  const getTaskStatusIcon = (status: PhaseTask['status']) => {
    switch (status) {
      case 'completed':
        return '‚úÖ';
      case 'failed':
        return '‚ùå';
      case 'pending':
      default:
        return '‚óã';
    }
  };

  const getTaskStatusColor = (status: PhaseTask['status']) => {
    switch (status) {
      case 'completed':
        return 'text-green-400 bg-green-500/10';
      case 'failed':
        return 'text-red-400 bg-red-500/10';
      case 'pending':
      default:
        return 'text-slate-400 bg-white/5';
    }
  };

  return (
    <div
      className="fixed inset-0 bg-black/80 backdrop-blur-sm z-50 flex items-center justify-center p-4"
      onClick={onClose}
    >
      <div
        className={`bg-slate-900 rounded-2xl border border-white/10 max-w-3xl w-full max-h-[85vh] overflow-hidden flex flex-col shadow-2xl ${className}`}
        onClick={(e) => e.stopPropagation()}
      >
        {/* Header */}
        <div className="px-6 py-5 border-b border-white/10 bg-gradient-to-r from-blue-500/10 to-purple-500/10">
          <div className="flex items-center justify-between">
            <div className="flex items-center gap-4">
              <div
                className={`w-12 h-12 rounded-xl flex items-center justify-center ${
                  phase.status === 'completed'
                    ? 'bg-green-500/20'
                    : phase.status === 'in-progress'
                      ? 'bg-blue-500/20'
                      : phase.status === 'skipped'
                        ? 'bg-slate-600/20'
                        : 'bg-white/10'
                }`}
              >
                <span className="text-2xl">
                  {phase.status === 'completed'
                    ? '‚úÖ'
                    : phase.status === 'in-progress'
                      ? '‚è≥'
                      : phase.status === 'skipped'
                        ? '‚è≠Ô∏è'
                        : 'üìã'}
                </span>
              </div>
              <div>
                <h3 className="text-xl font-bold text-white">
                  Phase {phase.order}: {phase.name}
                </h3>
                <p className="text-sm text-slate-400 mt-0.5">{phase.description}</p>
              </div>
            </div>
            <button onClick={onClose} className="p-2 rounded-lg hover:bg-white/10 transition-all">
              <span className="text-slate-400 text-xl">‚úï</span>
            </button>
          </div>

          {/* Stats */}
          <div className="flex gap-4 mt-4">
            <div className="flex items-center gap-2 px-3 py-1.5 bg-white/5 rounded-lg">
              <span className="text-green-400">‚úÖ</span>
              <span className="text-sm text-slate-300">
                {completedTasks}/{phase.tasks.length} Tasks
              </span>
            </div>
            <div className="flex items-center gap-2 px-3 py-1.5 bg-white/5 rounded-lg">
              <span className="text-blue-400">üîç</span>
              <span className="text-sm text-slate-300">
                {passedChecks}/{phase.validationChecks.length} Checks
              </span>
            </div>
            <div className="flex items-center gap-2 px-3 py-1.5 bg-white/5 rounded-lg">
              <span className="text-purple-400">‚è±Ô∏è</span>
              <span className="text-sm text-slate-300">{phase.estimatedTime}</span>
            </div>
          </div>
        </div>

        {/* Tabs */}
        <div className="flex border-b border-white/10 px-6">
          <button
            onClick={() => setActiveTab('tasks')}
            className={`px-4 py-3 text-sm font-medium transition-all border-b-2 -mb-px ${
              activeTab === 'tasks'
                ? 'text-blue-400 border-blue-400'
                : 'text-slate-400 border-transparent hover:text-white'
            }`}
          >
            üìã Tasks
          </button>
          <button
            onClick={() => setActiveTab('validation')}
            className={`px-4 py-3 text-sm font-medium transition-all border-b-2 -mb-px ${
              activeTab === 'validation'
                ? 'text-blue-400 border-blue-400'
                : 'text-slate-400 border-transparent hover:text-white'
            }`}
          >
            üîç Validation
          </button>
          <button
            onClick={() => setActiveTab('code')}
            className={`px-4 py-3 text-sm font-medium transition-all border-b-2 -mb-px ${
              activeTab === 'code'
                ? 'text-blue-400 border-blue-400'
                : 'text-slate-400 border-transparent hover:text-white'
            }`}
          >
            üíª Generated Code
          </button>
        </div>

        {/* Content */}
        <div className="flex-1 min-h-0 overflow-y-auto p-6">
          {activeTab === 'tasks' && (
            <div className="space-y-2">
              {phase.tasks.map((task) => (
                <div
                  key={task.id}
                  className={`flex items-start gap-3 p-3 rounded-lg ${getTaskStatusColor(task.status)}`}
                >
                  <span className="text-lg mt-0.5">{getTaskStatusIcon(task.status)}</span>
                  <div className="flex-1">
                    <div className="text-sm font-medium text-white">{task.name}</div>
                    <div className="text-xs text-slate-400 mt-0.5">{task.description}</div>
                    {task.errors && task.errors.length > 0 && (
                      <div className="mt-2 text-xs text-red-400 bg-red-500/10 rounded px-2 py-1">
                        {task.errors.join(', ')}
                      </div>
                    )}
                    {task.generatedCode && (
                      <details className="mt-2">
                        <summary className="text-xs text-blue-400 cursor-pointer hover:text-blue-300">
                          View generated code
                        </summary>
                        <pre className="mt-2 text-xs text-slate-300 bg-black/30 rounded p-2 overflow-x-auto">
                          {task.generatedCode.substring(0, MAX_TASK_CODE_PREVIEW_LENGTH)}...
                        </pre>
                      </details>
                    )}
                  </div>
                </div>
              ))}
            </div>
          )}

          {activeTab === 'validation' && (
            <div className="space-y-2">
              {phase.validationChecks.map((check) => (
                <div
                  key={check.id}
                  className={`flex items-start gap-3 p-3 rounded-lg ${
                    check.passed ? 'bg-green-500/10 text-green-400' : 'bg-red-500/10 text-red-400'
                  }`}
                >
                  <span className="text-lg mt-0.5">{check.passed ? '‚úÖ' : '‚ùå'}</span>
                  <div className="flex-1">
                    <div className="flex items-center gap-2">
                      <span className="text-sm font-medium text-white">{check.name}</span>
                      <span className="text-xs px-2 py-0.5 rounded bg-white/10">{check.type}</span>
                    </div>
                    {check.message && (
                      <div className="text-xs mt-1 opacity-80">{check.message}</div>
                    )}
                  </div>
                </div>
              ))}
            </div>
          )}

          {activeTab === 'code' && (
            <div>
              {generatedCode ? (
                <div className="relative">
                  <button
                    onClick={() => navigator.clipboard.writeText(generatedCode)}
                    className="absolute top-2 right-2 px-3 py-1 text-xs bg-blue-600 hover:bg-blue-500 text-white rounded transition-all"
                  >
                    Copy
                  </button>
                  <pre className="bg-black/40 rounded-lg p-4 overflow-x-auto text-sm text-slate-300">
                    <code>{generatedCode}</code>
                  </pre>
                </div>
              ) : (
                <div className="text-center py-12">
                  <div className="text-4xl mb-4">üìù</div>
                  <p className="text-slate-400">
                    No code generated yet. Build this phase to see the generated code.
                  </p>
                </div>
              )}
            </div>
          )}
        </div>

        {/* Footer Actions */}
        <div className="px-6 py-4 border-t border-white/10 bg-black/20 flex gap-3">
          {phase.status === 'pending' && (
            <button
              onClick={onBuildPhase}
              className="flex-1 px-4 py-2.5 rounded-lg bg-gradient-to-r from-blue-600 to-purple-600 hover:from-blue-500 hover:to-purple-500 text-white font-medium transition-all flex items-center justify-center gap-2"
            >
              <span>üöÄ</span>
              <span>Build This Phase</span>
            </button>
          )}
          {phase.status === 'in-progress' && (
            <button
              onClick={onSkipPhase}
              className="flex-1 px-4 py-2.5 rounded-lg bg-slate-700 hover:bg-slate-600 text-white font-medium transition-all flex items-center justify-center gap-2"
            >
              <span>‚è≠Ô∏è</span>
              <span>Skip Phase</span>
            </button>
          )}
          {(phase.status === 'completed' || failedTasks > 0) && (
            <button
              onClick={onRetryPhase}
              className="flex-1 px-4 py-2.5 rounded-lg bg-orange-600 hover:bg-orange-500 text-white font-medium transition-all flex items-center justify-center gap-2"
            >
              <span>üîÑ</span>
              <span>Retry Phase</span>
            </button>
          )}
          <button
            onClick={onClose}
            className="px-6 py-2.5 rounded-lg bg-slate-700 hover:bg-slate-600 text-white font-medium transition-all"
          >
            Close
          </button>
        </div>
      </div>
    </div>
  );
}

export default PhaseDetailView;
</file>

<file path="src/components/build/PhaseProgressIndicator.tsx">
'use client';

import React, { useState } from 'react';
import type { BuildPhase, PhaseId, BuildProgress } from '../../types/buildPhases';

interface PhaseProgressIndicatorProps {
  phases: BuildPhase[];
  progress: BuildProgress;
  onPhaseClick?: (phaseId: PhaseId) => void;
  className?: string;
  /** Max phases to show in horizontal view before switching to compact */
  maxHorizontalPhases?: number;
}

/**
 * Visual timeline showing all phases with current phase highlighted
 * Automatically adapts to compact view when there are many phases (>7)
 */
export function PhaseProgressIndicator({
  phases,
  progress,
  onPhaseClick,
  className = '',
  maxHorizontalPhases = 7,
}: PhaseProgressIndicatorProps) {
  const [expandedView, setExpandedView] = useState(false);
  const usesCompactMode = phases.length > maxHorizontalPhases;
  const getPhaseStatusIcon = (status: BuildPhase['status']) => {
    switch (status) {
      case 'completed':
        return '‚úÖ';
      case 'in-progress':
        return '‚è≥';
      case 'skipped':
        return '‚è≠Ô∏è';
      case 'pending':
      default:
        return '‚è∏Ô∏è';
    }
  };

  const getPhaseStatusColor = (status: BuildPhase['status'], isCurrentPhase: boolean) => {
    if (isCurrentPhase && status === 'in-progress') {
      return 'bg-blue-500/30 border-blue-500/60 shadow-blue-500/20';
    }
    switch (status) {
      case 'completed':
        return 'bg-green-500/20 border-green-500/40';
      case 'in-progress':
        return 'bg-blue-500/20 border-blue-500/40 animate-pulse';
      case 'skipped':
        return 'bg-slate-600/20 border-slate-500/40 opacity-50';
      case 'pending':
      default:
        return 'bg-white/5 border-white/10';
    }
  };

  const getConnectorColor = (status: BuildPhase['status']) => {
    switch (status) {
      case 'completed':
        return 'bg-green-500';
      case 'in-progress':
        return 'bg-blue-500';
      default:
        return 'bg-slate-600';
    }
  };

  // Render compact view for many phases
  const renderCompactView = () => {
    const completedCount = phases.filter((p) => p.status === 'completed').length;
    const inProgressPhase = phases.find((p) => p.status === 'in-progress');
    const pendingCount = phases.filter((p) => p.status === 'pending').length;

    return (
      <div className="space-y-3">
        {/* Compact progress summary */}
        <div className="flex items-center gap-4 text-sm">
          <span className="text-green-400">‚úÖ {completedCount} done</span>
          {inProgressPhase && (
            <span className="text-blue-400">
              ‚è≥ Phase {inProgressPhase.order}: {inProgressPhase.name}
            </span>
          )}
          <span className="text-slate-400">‚è∏Ô∏è {pendingCount} pending</span>
        </div>

        {/* Toggle to expand */}
        <button
          onClick={() => setExpandedView(!expandedView)}
          className="text-xs text-blue-400 hover:text-blue-300 transition-colors"
        >
          {expandedView ? '‚ñ≤ Collapse phases' : `‚ñº Show all ${phases.length} phases`}
        </button>

        {/* Expanded phase list */}
        {expandedView && (
          <div className="max-h-64 overflow-y-auto space-y-1 pr-2">
            {phases.map((phase) => {
              const isCurrentPhase = phase.id === progress.currentPhaseId;
              return (
                <button
                  key={phase.id}
                  onClick={() => onPhaseClick?.(phase.id)}
                  className={`w-full flex items-center gap-2 px-3 py-2 rounded-lg text-left text-sm transition-all ${
                    isCurrentPhase
                      ? 'bg-blue-500/20 border border-blue-500/40'
                      : 'bg-white/5 hover:bg-white/10'
                  }`}
                >
                  <span>{getPhaseStatusIcon(phase.status)}</span>
                  <span className="font-medium text-white">Phase {phase.order}</span>
                  <span className="text-slate-400 flex-1 truncate">{phase.name}</span>
                  <span className="text-xs text-slate-500">{phase.estimatedTime}</span>
                </button>
              );
            })}
          </div>
        )}
      </div>
    );
  };

  // Render horizontal view for fewer phases
  const renderHorizontalView = () => (
    <div className="relative">
      {/* Horizontal connector line */}
      <div className="absolute top-6 left-6 right-6 h-0.5 bg-slate-700 -z-10" />

      {/* Phases */}
      <div className="flex justify-between">
        {phases.map((phase, index) => {
          const isCurrentPhase = phase.id === progress.currentPhaseId;
          const isPast = progress.completedPhases.includes(phase.id);

          return (
            <div
              key={phase.id}
              className="flex flex-col items-center relative group"
              style={{ width: `${100 / phases.length}%` }}
            >
              {/* Phase Circle */}
              <button
                onClick={() => onPhaseClick?.(phase.id)}
                disabled={phase.status === 'pending' && !isPast}
                className={`
                  w-12 h-12 rounded-full border-2 flex items-center justify-center
                  transition-all duration-300 hover:scale-110
                  ${getPhaseStatusColor(phase.status, isCurrentPhase)}
                  ${onPhaseClick && (phase.status !== 'pending' || isPast) ? 'cursor-pointer' : 'cursor-default'}
                  ${isCurrentPhase ? 'ring-2 ring-blue-400 ring-offset-2 ring-offset-slate-900' : ''}
                `}
              >
                <span className="text-lg">{getPhaseStatusIcon(phase.status)}</span>
              </button>

              {/* Phase connector to next */}
              {index < phases.length - 1 && (
                <div
                  className={`absolute top-6 left-1/2 w-full h-0.5 ${getConnectorColor(phase.status)} transition-all duration-500`}
                  style={{ transform: 'translateY(-50%)' }}
                />
              )}

              {/* Phase Info */}
              <div className="mt-3 text-center">
                <div className="text-xs font-medium text-white">Phase {phase.order}</div>
                <div className="text-xs text-slate-400 mt-0.5">{phase.name}</div>
              </div>

              {/* Hover Tooltip */}
              <div className="absolute top-full mt-4 left-1/2 -translate-x-1/2 w-48 p-3 bg-slate-800 rounded-lg border border-white/10 shadow-xl opacity-0 invisible group-hover:opacity-100 group-hover:visible transition-all duration-200 z-10">
                <div className="text-sm font-medium text-white mb-1">{phase.name}</div>
                <div className="text-xs text-slate-400 mb-2">{phase.description}</div>
                <div className="text-xs text-slate-500">Est. time: {phase.estimatedTime}</div>
                {phase.tasks.length > 0 && (
                  <div className="mt-2 pt-2 border-t border-white/10">
                    <div className="text-xs text-slate-500">
                      {phase.tasks.filter((t) => t.status === 'completed').length}/
                      {phase.tasks.length} tasks
                    </div>
                  </div>
                )}
              </div>
            </div>
          );
        })}
      </div>
    </div>
  );

  return (
    <div className={`${className}`}>
      {/* Progress Header */}
      <div className="flex items-center justify-between mb-4">
        <h3 className="text-white font-bold flex items-center gap-2">
          <span>üèóÔ∏è</span>
          <span>Build Progress</span>
          {usesCompactMode && (
            <span className="text-xs font-normal text-slate-400">({phases.length} phases)</span>
          )}
        </h3>
        <div className="flex items-center gap-3">
          <div className="text-sm text-slate-400">{progress.percentComplete}% Complete</div>
          <div className="text-xs text-slate-500">~{progress.estimatedTimeRemaining} remaining</div>
        </div>
      </div>

      {/* Progress Bar */}
      <div className="w-full h-2 bg-slate-700 rounded-full mb-6 overflow-hidden">
        <div
          className="h-full bg-gradient-to-r from-blue-500 to-purple-500 rounded-full transition-all duration-500"
          style={{ width: `${progress.percentComplete}%` }}
        />
      </div>

      {/* Phase Timeline - Adaptive layout */}
      {usesCompactMode ? renderCompactView() : renderHorizontalView()}
    </div>
  );
}

export default PhaseProgressIndicator;
</file>

<file path="src/components/CodeQualityReport.tsx">
'use client';

import React, { useState } from 'react';
import type { QualityReport, QualityMetrics, QualityIssue } from '@/types/aiBuilderTypes';

export interface CodeQualityReportProps {
  isOpen: boolean;
  onClose: () => void;
  report: QualityReport | null;
  onReanalyze?: () => void;
  isAnalyzing?: boolean;
}

// Helper functions for determining score-based text and background colors
const getScoreColor = (score: number): string => {
  if (score >= 90) return 'text-green-400';
  if (score >= 70) return 'text-yellow-400';
  if (score >= 50) return 'text-orange-400';
  return 'text-red-400';
};

const getScoreBgColor = (score: number): string => {
  if (score >= 90) return 'bg-green-500/20 border-green-500/30';
  if (score >= 70) return 'bg-yellow-500/20 border-yellow-500/30';
  if (score >= 50) return 'bg-orange-500/20 border-orange-500/30';
  return 'bg-red-500/20 border-red-500/30';
};

const getSeverityColor = (severity: string): string => {
  switch (severity) {
    case 'critical':
      return 'bg-red-500/20 text-red-300 border-red-500/30';
    case 'high':
      return 'bg-orange-500/20 text-orange-300 border-orange-500/30';
    case 'medium':
      return 'bg-yellow-500/20 text-yellow-300 border-yellow-500/30';
    case 'low':
      return 'bg-blue-500/20 text-blue-300 border-blue-500/30';
    default:
      return 'bg-slate-500/20 text-slate-300 border-slate-500/30';
  }
};

const MetricCard: React.FC<{ label: string; score: number; icon: string }> = ({
  label,
  score,
  icon,
}) => (
  <div className={`p-4 rounded-xl border transition-all hover:scale-105 ${getScoreBgColor(score)}`}>
    <div className="flex items-center gap-2 mb-2">
      <span className="text-xl">{icon}</span>
      <span className="text-sm text-slate-300 font-medium">{label}</span>
    </div>
    <div className={`text-2xl font-bold ${getScoreColor(score)}`}>{score}</div>
    <div className="mt-1 w-full bg-slate-700/50 rounded-full h-1.5">
      <div
        className={`h-1.5 rounded-full transition-all ${
          score >= 90
            ? 'bg-green-500'
            : score >= 70
              ? 'bg-yellow-500'
              : score >= 50
                ? 'bg-orange-500'
                : 'bg-red-500'
        }`}
        style={{ width: `${score}%` }}
      />
    </div>
  </div>
);

export function CodeQualityReport({
  isOpen,
  onClose,
  report,
  onReanalyze,
  isAnalyzing = false,
}: CodeQualityReportProps) {
  const [expandedSeverity, setExpandedSeverity] = useState<string | null>(null);

  if (!isOpen) return null;

  const groupedIssues =
    report?.issues.reduce(
      (acc, issue) => {
        if (!acc[issue.severity]) acc[issue.severity] = [];
        acc[issue.severity].push(issue);
        return acc;
      },
      {} as Record<string, QualityIssue[]>
    ) || {};

  const severityOrder = ['critical', 'high', 'medium', 'low'];

  return (
    <div
      className="fixed inset-0 bg-black/80 backdrop-blur-sm z-[60] flex items-center justify-center p-4"
      onClick={onClose}
      role="dialog"
      aria-modal="true"
      aria-labelledby="quality-report-title"
    >
      <div
        className="bg-slate-900 rounded-2xl border border-blue-500/30 max-w-4xl w-full max-h-[85vh] overflow-hidden flex flex-col shadow-2xl"
        onClick={(e) => e.stopPropagation()}
      >
        {/* Modal Header */}
        <div className="px-6 py-5 border-b border-blue-500/30 bg-blue-500/10">
          <div className="flex items-center justify-between">
            <div className="flex items-center gap-3">
              <div className="w-12 h-12 rounded-xl bg-blue-500/20 flex items-center justify-center">
                <span className="text-3xl">üìä</span>
              </div>
              <div>
                <h3 id="quality-report-title" className="text-xl font-bold text-white">
                  Code Quality Report
                </h3>
                {report && (
                  <p className="text-sm text-blue-200/80">
                    Generated {new Date(report.timestamp).toLocaleString()}
                  </p>
                )}
              </div>
            </div>
            <button
              onClick={onClose}
              className="p-2 rounded-lg hover:bg-white/10 transition-all"
              aria-label="Close modal"
            >
              <span className="text-slate-400 text-xl">‚úï</span>
            </button>
          </div>
        </div>

        {/* Modal Content */}
        <div className="flex-1 min-h-0 overflow-y-auto p-6">
          {isAnalyzing ? (
            <div className="flex flex-col items-center justify-center py-16">
              <div className="w-16 h-16 border-4 border-blue-500/30 border-t-blue-500 rounded-full animate-spin mb-4" />
              <p className="text-slate-400 text-lg">Analyzing code quality...</p>
            </div>
          ) : !report ? (
            <div className="flex flex-col items-center justify-center py-16">
              <div className="text-6xl mb-4">üìù</div>
              <p className="text-slate-400 text-lg mb-4">No quality report available</p>
              {onReanalyze && (
                <button
                  onClick={onReanalyze}
                  className="px-4 py-2 rounded-lg bg-blue-600 hover:bg-blue-700 text-white font-medium transition-all"
                >
                  Run Analysis
                </button>
              )}
            </div>
          ) : (
            <div className="space-y-6">
              {/* Overall Score */}
              <div className="flex items-center justify-center">
                <div
                  className={`relative w-32 h-32 rounded-full flex items-center justify-center ${getScoreBgColor(report.metrics.overall)} border-4`}
                >
                  <div className="text-center">
                    <div className={`text-4xl font-bold ${getScoreColor(report.metrics.overall)}`}>
                      {report.metrics.overall}
                    </div>
                    <div className="text-xs text-slate-400 mt-1">Overall Score</div>
                  </div>
                </div>
              </div>

              {/* Pass/Fail Status */}
              <div className="flex justify-center">
                <div
                  className={`px-4 py-2 rounded-full border ${
                    report.passed
                      ? 'bg-green-500/20 border-green-500/30 text-green-300'
                      : 'bg-red-500/20 border-red-500/30 text-red-300'
                  }`}
                >
                  {report.passed ? '‚úì Quality Check Passed' : '‚úó Quality Check Failed'}
                </div>
              </div>

              {/* Metric Cards */}
              <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
                <MetricCard label="Accessibility" score={report.metrics.accessibility} icon="‚ôø" />
                <MetricCard label="Best Practices" score={report.metrics.bestPractices} icon="‚ú®" />
                <MetricCard label="SEO" score={report.metrics.seo} icon="üîç" />
                <MetricCard label="Code Quality" score={report.metrics.codeQuality} icon="üíª" />
              </div>

              {/* Issues List */}
              {report.issues.length > 0 && (
                <div className="space-y-4">
                  <h4 className="text-lg font-semibold text-white flex items-center gap-2">
                    <span>‚ö†Ô∏è</span>
                    Issues ({report.issues.length})
                  </h4>
                  <div className="space-y-3">
                    {severityOrder.map((severity) => {
                      const issues = groupedIssues[severity];
                      if (!issues || issues.length === 0) return null;

                      const isExpanded = expandedSeverity === severity;

                      return (
                        <div
                          key={severity}
                          className="rounded-xl border border-white/10 overflow-hidden"
                        >
                          <button
                            onClick={() => setExpandedSeverity(isExpanded ? null : severity)}
                            className="w-full px-4 py-3 flex items-center justify-between bg-slate-800/50 hover:bg-slate-800 transition-all"
                            aria-expanded={isExpanded}
                          >
                            <div className="flex items-center gap-3">
                              <span
                                className={`px-2 py-1 rounded-full border text-xs font-medium capitalize ${getSeverityColor(severity)}`}
                              >
                                {severity}
                              </span>
                              <span className="text-white">
                                {issues.length} issue{issues.length !== 1 ? 's' : ''}
                              </span>
                            </div>
                            <span className="text-slate-400">{isExpanded ? '‚ñº' : '‚ñ∂'}</span>
                          </button>
                          {isExpanded && (
                            <div className="p-4 space-y-3 bg-black/20">
                              {issues.map((issue) => (
                                <div
                                  key={issue.id}
                                  className="p-3 rounded-lg bg-slate-800/50 border border-white/10"
                                >
                                  <div className="flex items-start gap-2">
                                    <span
                                      className={`text-xs ${
                                        issue.type === 'error'
                                          ? 'text-red-400'
                                          : issue.type === 'warning'
                                            ? 'text-yellow-400'
                                            : 'text-blue-400'
                                      }`}
                                    >
                                      {issue.type === 'error'
                                        ? '‚ùå'
                                        : issue.type === 'warning'
                                          ? '‚ö†Ô∏è'
                                          : '‚ÑπÔ∏è'}
                                    </span>
                                    <div className="flex-1">
                                      <p className="text-sm text-slate-300">{issue.message}</p>
                                      {(issue.file || issue.line) && (
                                        <p className="text-xs text-slate-500 mt-1">
                                          {issue.file && <span>{issue.file}</span>}
                                          {issue.line && <span>:{issue.line}</span>}
                                        </p>
                                      )}
                                    </div>
                                  </div>
                                </div>
                              ))}
                            </div>
                          )}
                        </div>
                      );
                    })}
                  </div>
                </div>
              )}
            </div>
          )}
        </div>

        {/* Modal Footer */}
        <div className="px-6 py-4 border-t border-white/10 bg-black/20 flex items-center justify-between">
          <div className="flex items-center gap-3 text-xs text-slate-400">
            <span>üí°</span>
            <p>Address issues from highest to lowest severity for best results.</p>
          </div>
          {onReanalyze && !isAnalyzing && (
            <button
              onClick={onReanalyze}
              className="px-4 py-2 rounded-lg bg-blue-600 hover:bg-blue-700 text-white text-sm font-medium transition-all"
            >
              üîÑ Re-analyze
            </button>
          )}
        </div>
      </div>
    </div>
  );
}

export default CodeQualityReport;
</file>

<file path="src/components/DesignControlPanel.tsx">
'use client';

/**
 * DesignControlPanel Component
 *
 * Real-time control panel for adjusting design settings directly.
 * Provides sliders and toggles for spacing, effects, colors, and component visibility.
 */

import React, { useState } from 'react';
import type { EffectsSettings, ColorSettings } from '@/types/layoutDesign';

// ============================================================================
// TYPES
// ============================================================================

interface ComponentVisibility {
  showHeader?: boolean;
  showSidebar?: boolean;
  showHero?: boolean;
  showFooter?: boolean;
  showCards?: boolean;
  showStats?: boolean;
  showList?: boolean;
}

interface DesignControlPanelProps {
  effectsSettings?: Partial<EffectsSettings>;
  colorSettings?: Partial<ColorSettings>;
  onEffectsChange?: (effects: Partial<EffectsSettings>) => void;
  onColorChange?: (colors: Partial<ColorSettings>) => void;
  primaryColor?: string;
  onPrimaryColorChange?: (color: string) => void;
  componentVisibility?: ComponentVisibility;
  onVisibilityChange?: (visibility: ComponentVisibility) => void;
  className?: string;
}

// ============================================================================
// CONSTANTS
// ============================================================================

const SPACING_OPTIONS = [
  { value: 'compact', label: 'Compact' },
  { value: 'normal', label: 'Normal' },
  { value: 'relaxed', label: 'Relaxed' },
] as const;

const BORDER_RADIUS_OPTIONS = [
  { value: 'none', label: 'None' },
  { value: 'sm', label: 'Small' },
  { value: 'md', label: 'Medium' },
  { value: 'lg', label: 'Large' },
  { value: 'xl', label: 'XL' },
  { value: 'full', label: 'Full' },
] as const;

const SHADOW_OPTIONS = [
  { value: 'none', label: 'None' },
  { value: 'subtle', label: 'Subtle' },
  { value: 'medium', label: 'Medium' },
  { value: 'strong', label: 'Strong' },
] as const;

const BLUR_OPTIONS = [
  { value: 'none', label: 'None' },
  { value: 'subtle', label: 'Subtle' },
  { value: 'medium', label: 'Medium' },
  { value: 'strong', label: 'Strong' },
] as const;

const ANIMATION_OPTIONS = [
  { value: 'none', label: 'None' },
  { value: 'subtle', label: 'Subtle' },
  { value: 'smooth', label: 'Smooth' },
  { value: 'playful', label: 'Playful' },
] as const;

// ============================================================================
// SUB-COMPONENTS
// ============================================================================

/**
 * Collapsible section component
 */
function Section({
  title,
  isOpen,
  onToggle,
  children,
}: {
  title: string;
  isOpen: boolean;
  onToggle: () => void;
  children: React.ReactNode;
}) {
  return (
    <div className="border-b border-slate-700 last:border-b-0">
      <button
        type="button"
        onClick={onToggle}
        className="w-full px-3 py-2 flex items-center justify-between text-xs font-medium text-slate-300 hover:bg-slate-700/50 transition-colors"
      >
        <span>{title}</span>
        <svg
          className={`w-4 h-4 transition-transform ${isOpen ? 'rotate-180' : ''}`}
          fill="none"
          viewBox="0 0 24 24"
          stroke="currentColor"
        >
          <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 9l-7 7-7-7" />
        </svg>
      </button>
      {isOpen && <div className="px-3 pb-3 space-y-3">{children}</div>}
    </div>
  );
}

/**
 * Segmented control for selecting from predefined options
 */
function SegmentedControl<T extends string>({
  label,
  value,
  options,
  onChange,
}: {
  label: string;
  value?: T;
  options: readonly { value: T; label: string }[];
  onChange: (value: T) => void;
}) {
  return (
    <div>
      <label className="block text-xs text-slate-400 mb-1.5">{label}</label>
      <div className="flex gap-1 bg-slate-800 p-0.5 rounded-md">
        {options.map((option) => (
          <button
            key={option.value}
            type="button"
            onClick={() => onChange(option.value)}
            className={`flex-1 px-2 py-1 text-xs rounded transition-all ${
              value === option.value ? 'bg-blue-600 text-white' : 'text-slate-400 hover:text-white'
            }`}
          >
            {option.label}
          </button>
        ))}
      </div>
    </div>
  );
}

/**
 * Color picker with label
 */
function ColorPicker({
  label,
  value,
  onChange,
}: {
  label: string;
  value?: string;
  onChange: (value: string) => void;
}) {
  const defaultColor = '#3B82F6';

  return (
    <div className="flex items-center justify-between">
      <label className="text-xs text-slate-400">{label}</label>
      <label className="relative cursor-pointer">
        <span className="sr-only">Choose {label}</span>
        <input
          type="color"
          value={value || defaultColor}
          onChange={(e) => onChange(e.target.value)}
          className="absolute inset-0 w-full h-full opacity-0 cursor-pointer"
        />
        <div
          className="w-6 h-6 rounded border border-white/20"
          style={{ backgroundColor: value || defaultColor }}
        />
      </label>
    </div>
  );
}

/**
 * Toggle switch
 */
function Toggle({
  label,
  checked,
  onChange,
}: {
  label: string;
  checked: boolean;
  onChange: (checked: boolean) => void;
}) {
  return (
    <div className="flex items-center justify-between">
      <label className="text-xs text-slate-400">{label}</label>
      <button
        type="button"
        role="switch"
        aria-checked={checked}
        onClick={() => onChange(!checked)}
        className={`relative w-9 h-5 rounded-full transition-colors ${
          checked ? 'bg-blue-600' : 'bg-slate-600'
        }`}
      >
        <span
          className={`absolute top-0.5 left-0.5 w-4 h-4 bg-white rounded-full transition-transform ${
            checked ? 'translate-x-4' : ''
          }`}
        />
      </button>
    </div>
  );
}

// ============================================================================
// MAIN COMPONENT
// ============================================================================

export function DesignControlPanel({
  effectsSettings,
  colorSettings,
  onEffectsChange,
  onColorChange,
  primaryColor,
  onPrimaryColorChange,
  componentVisibility,
  onVisibilityChange,
  className = '',
}: DesignControlPanelProps) {
  const [isExpanded, setIsExpanded] = useState(true);
  const [openSections, setOpenSections] = useState({
    components: false,
    effects: true,
    colors: false,
  });

  const toggleSection = (section: keyof typeof openSections) => {
    setOpenSections((prev) => ({
      ...prev,
      [section]: !prev[section],
    }));
  };

  const handleEffectChange = <K extends keyof EffectsSettings>(
    key: K,
    value: EffectsSettings[K]
  ) => {
    onEffectsChange?.({
      ...effectsSettings,
      [key]: value,
    });
  };

  const handleColorSettingChange = <K extends keyof ColorSettings>(
    key: K,
    value: ColorSettings[K]
  ) => {
    onColorChange?.({
      ...colorSettings,
      [key]: value,
    });
  };

  const handleVisibilityChange = <K extends keyof ComponentVisibility>(key: K, value: boolean) => {
    onVisibilityChange?.({
      ...componentVisibility,
      [key]: value,
    });
  };

  // Default visibility (all visible if not specified)
  const visibility: ComponentVisibility = {
    showHeader: componentVisibility?.showHeader ?? true,
    showSidebar: componentVisibility?.showSidebar ?? true,
    showHero: componentVisibility?.showHero ?? true,
    showFooter: componentVisibility?.showFooter ?? true,
    showCards: componentVisibility?.showCards ?? true,
    showStats: componentVisibility?.showStats ?? true,
    showList: componentVisibility?.showList ?? true,
  };

  return (
    <div
      className={`bg-slate-800/95 rounded-lg border border-slate-700 overflow-hidden ${className}`}
    >
      {/* Header */}
      <button
        type="button"
        onClick={() => setIsExpanded(!isExpanded)}
        className="w-full px-3 py-2 flex items-center justify-between bg-slate-700/50"
      >
        <div className="flex items-center gap-2">
          <svg
            className="w-4 h-4 text-blue-400"
            fill="none"
            viewBox="0 0 24 24"
            stroke="currentColor"
          >
            <path
              strokeLinecap="round"
              strokeLinejoin="round"
              strokeWidth={2}
              d="M12 6V4m0 2a2 2 0 100 4m0-4a2 2 0 110 4m-6 8a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4m6 6v10m6-2a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4"
            />
          </svg>
          <span className="text-xs font-medium text-slate-300">Design Controls</span>
        </div>
        <svg
          className={`w-4 h-4 text-slate-400 transition-transform ${isExpanded ? 'rotate-180' : ''}`}
          fill="none"
          viewBox="0 0 24 24"
          stroke="currentColor"
        >
          <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 9l-7 7-7-7" />
        </svg>
      </button>

      {/* Content */}
      {isExpanded && (
        <div className="max-h-80 overflow-y-auto">
          {/* Components Section */}
          <Section
            title="Component Visibility"
            isOpen={openSections.components}
            onToggle={() => toggleSection('components')}
          >
            <div className="space-y-2">
              <Toggle
                label="Header"
                checked={visibility.showHeader || false}
                onChange={(v) => handleVisibilityChange('showHeader', v)}
              />
              <Toggle
                label="Sidebar"
                checked={visibility.showSidebar || false}
                onChange={(v) => handleVisibilityChange('showSidebar', v)}
              />
              <Toggle
                label="Hero Section"
                checked={visibility.showHero || false}
                onChange={(v) => handleVisibilityChange('showHero', v)}
              />
              <Toggle
                label="Stats"
                checked={visibility.showStats || false}
                onChange={(v) => handleVisibilityChange('showStats', v)}
              />
              <Toggle
                label="Cards"
                checked={visibility.showCards || false}
                onChange={(v) => handleVisibilityChange('showCards', v)}
              />
              <Toggle
                label="List"
                checked={visibility.showList || false}
                onChange={(v) => handleVisibilityChange('showList', v)}
              />
              <Toggle
                label="Footer"
                checked={visibility.showFooter || false}
                onChange={(v) => handleVisibilityChange('showFooter', v)}
              />
            </div>
          </Section>

          {/* Effects Section */}
          <Section
            title="Effects & Layout"
            isOpen={openSections.effects}
            onToggle={() => toggleSection('effects')}
          >
            <SegmentedControl
              label="Border Radius"
              value={effectsSettings?.borderRadius}
              options={BORDER_RADIUS_OPTIONS}
              onChange={(v) => handleEffectChange('borderRadius', v)}
            />

            <SegmentedControl
              label="Shadows"
              value={effectsSettings?.shadows}
              options={SHADOW_OPTIONS}
              onChange={(v) => handleEffectChange('shadows', v)}
            />

            <SegmentedControl
              label="Blur Effects"
              value={effectsSettings?.blur}
              options={BLUR_OPTIONS}
              onChange={(v) => handleEffectChange('blur', v)}
            />

            <SegmentedControl
              label="Animations"
              value={effectsSettings?.animations}
              options={ANIMATION_OPTIONS}
              onChange={(v) => handleEffectChange('animations', v)}
            />

            <Toggle
              label="Enable Gradients"
              checked={effectsSettings?.gradients || false}
              onChange={(v) => handleEffectChange('gradients', v)}
            />
          </Section>

          {/* Colors Section */}
          <Section
            title="Colors"
            isOpen={openSections.colors}
            onToggle={() => toggleSection('colors')}
          >
            <ColorPicker
              label="Primary"
              value={primaryColor || colorSettings?.primary}
              onChange={(v) => {
                onPrimaryColorChange?.(v);
                handleColorSettingChange('primary', v);
              }}
            />

            <ColorPicker
              label="Secondary"
              value={colorSettings?.secondary}
              onChange={(v) => handleColorSettingChange('secondary', v)}
            />

            <ColorPicker
              label="Accent"
              value={colorSettings?.accent}
              onChange={(v) => handleColorSettingChange('accent', v)}
            />

            <div className="border-t border-slate-700 pt-2 mt-2">
              <div className="text-xs text-slate-500 mb-2">Status Colors</div>

              <ColorPicker
                label="Success"
                value={colorSettings?.success || '#22c55e'}
                onChange={(v) => handleColorSettingChange('success', v)}
              />

              <ColorPicker
                label="Warning"
                value={colorSettings?.warning || '#eab308'}
                onChange={(v) => handleColorSettingChange('warning', v)}
              />

              <ColorPicker
                label="Error"
                value={colorSettings?.error || '#ef4444'}
                onChange={(v) => handleColorSettingChange('error', v)}
              />

              <ColorPicker
                label="Info"
                value={colorSettings?.info || '#3b82f6'}
                onChange={(v) => handleColorSettingChange('info', v)}
              />
            </div>
          </Section>
        </div>
      )}
    </div>
  );
}

export default DesignControlPanel;
</file>

<file path="src/components/dev/DebugPanel.tsx">
'use client';

/**
 * DebugPanel - Development-only debug overlay
 *
 * Shows real-time information about:
 * - Zustand store state (all slices)
 * - Recent API requests with timing
 * - SSE stream events
 * - Token usage statistics
 *
 * Only renders when NEXT_PUBLIC_DEBUG_PANEL=true in development
 */

import React, { useState, useEffect, useCallback } from 'react';
import { DEBUG } from '@/utils/debug';
import { useAppStore } from '@/store/useAppStore';

// Types for tracking
interface APIRequest {
  id: string;
  method: string;
  route: string;
  status: 'pending' | 'success' | 'error';
  duration?: number;
  timestamp: Date;
}

interface SSEEvent {
  id: string;
  type: string;
  data: string;
  timestamp: Date;
}

interface TokenUsage {
  route: string;
  input: number;
  output: number;
  cached: number;
  timestamp: Date;
}

// In-memory storage for debug data (not persisted)
const debugStore = {
  apiRequests: [] as APIRequest[],
  sseEvents: [] as SSEEvent[],
  tokenUsage: [] as TokenUsage[],
};

/**
 * Add an API request to the debug store
 */
export function trackAPIRequest(request: Omit<APIRequest, 'id' | 'timestamp'>): string {
  const id = `api_${Date.now()}_${Math.random().toString(36).slice(2, 6)}`;
  debugStore.apiRequests.unshift({
    ...request,
    id,
    timestamp: new Date(),
  });
  // Keep only last 50 requests
  if (debugStore.apiRequests.length > 50) {
    debugStore.apiRequests.pop();
  }
  return id;
}

/**
 * Update an API request status
 */
export function updateAPIRequest(
  id: string,
  update: Partial<Pick<APIRequest, 'status' | 'duration'>>
): void {
  const request = debugStore.apiRequests.find((r) => r.id === id);
  if (request) {
    Object.assign(request, update);
  }
}

/**
 * Track an SSE event
 */
export function trackSSEEvent(type: string, data: unknown): void {
  debugStore.sseEvents.unshift({
    id: `sse_${Date.now()}_${Math.random().toString(36).slice(2, 6)}`,
    type,
    data: typeof data === 'string' ? data : JSON.stringify(data).slice(0, 200),
    timestamp: new Date(),
  });
  // Keep only last 100 events
  if (debugStore.sseEvents.length > 100) {
    debugStore.sseEvents.pop();
  }
}

/**
 * Track token usage
 */
export function trackTokenUsage(
  route: string,
  usage: { input: number; output: number; cached?: number }
): void {
  debugStore.tokenUsage.unshift({
    route,
    input: usage.input,
    output: usage.output,
    cached: usage.cached || 0,
    timestamp: new Date(),
  });
  // Keep only last 50 entries
  if (debugStore.tokenUsage.length > 50) {
    debugStore.tokenUsage.pop();
  }
}

/**
 * DebugPanel Component
 */
export function DebugPanel(): React.ReactElement | null {
  const [isOpen, setIsOpen] = useState(false);
  const [activeTab, setActiveTab] = useState<'state' | 'api' | 'sse' | 'tokens'>('state');
  const [refreshKey, setRefreshKey] = useState(0);

  // Get store state
  const storeState = useAppStore();

  // Force refresh every second when open - MUST be called before any conditional returns
  useEffect(() => {
    if (!isOpen || !DEBUG.SHOW_PANEL) return;
    const interval = setInterval(() => setRefreshKey((k) => k + 1), 1000);
    return () => clearInterval(interval);
  }, [isOpen]);

  const formatTime = useCallback((date: Date) => {
    return date.toLocaleTimeString('en-US', {
      hour12: false,
      hour: '2-digit',
      minute: '2-digit',
      second: '2-digit',
    });
  }, []);

  // Don't render in production or if debug panel is disabled
  // This MUST come after all hooks
  if (!DEBUG.SHOW_PANEL) {
    return null;
  }

  // Collapsed state - just show toggle button
  if (!isOpen) {
    return (
      <button
        onClick={() => setIsOpen(true)}
        className="fixed bottom-4 right-4 z-[9999] bg-gray-900 text-white px-3 py-2 rounded-lg shadow-lg hover:bg-gray-800 transition font-mono text-sm"
        title="Open Debug Panel"
      >
        üîß Debug
      </button>
    );
  }

  // Extract relevant state for display
  const stateSnapshot = {
    mode: storeState.currentMode,
    isGenerating: storeState.isGenerating,
    messagesCount: storeState.chatMessages?.length || 0,
    componentsCount: storeState.components?.length || 0,
    undoStackSize: storeState.undoStack?.length || 0,
    redoStackSize: storeState.redoStack?.length || 0,
    hasPendingChange: !!storeState.pendingChange,
    hasPendingDiff: !!storeState.pendingDiff,
    hasAppConcept: !!storeState.appConcept,
  };

  return (
    <div className="fixed bottom-4 right-4 z-[9999] w-96 max-h-[70vh] bg-gray-900 text-white rounded-lg shadow-2xl overflow-hidden font-mono text-xs">
      {/* Header */}
      <div className="flex items-center justify-between px-3 py-2 bg-gray-800 border-b border-gray-700">
        <span className="font-semibold">üîß Debug Panel</span>
        <button
          onClick={() => setIsOpen(false)}
          className="text-gray-400 hover:text-white transition"
        >
          ‚úï
        </button>
      </div>

      {/* Tabs */}
      <div className="flex border-b border-gray-700">
        {(['state', 'api', 'sse', 'tokens'] as const).map((tab) => (
          <button
            key={tab}
            onClick={() => setActiveTab(tab)}
            className={`flex-1 px-2 py-1.5 text-center transition ${
              activeTab === tab
                ? 'bg-gray-700 text-white'
                : 'text-gray-400 hover:text-white hover:bg-gray-800'
            }`}
          >
            {tab === 'state' && 'üì¶'}
            {tab === 'api' && 'üåê'}
            {tab === 'sse' && 'üì°'}
            {tab === 'tokens' && 'üé´'}
            <span className="ml-1 capitalize">{tab}</span>
          </button>
        ))}
      </div>

      {/* Content */}
      <div className="p-3 overflow-auto max-h-[50vh]">
        {/* State Tab */}
        {activeTab === 'state' && (
          <div className="space-y-2">
            <div className="text-gray-400 text-[10px] uppercase tracking-wide mb-2">
              Store Snapshot
            </div>
            {Object.entries(stateSnapshot).map(([key, value]) => (
              <div key={key} className="flex justify-between">
                <span className="text-gray-400">{key}:</span>
                <span
                  className={
                    typeof value === 'boolean'
                      ? value
                        ? 'text-green-400'
                        : 'text-gray-500'
                      : 'text-blue-400'
                  }
                >
                  {String(value)}
                </span>
              </div>
            ))}
            <div className="mt-4 pt-2 border-t border-gray-700">
              <div className="text-gray-400 text-[10px] uppercase tracking-wide mb-2">
                Active Modals
              </div>
              <div className="text-gray-500 text-[10px]">
                {[
                  storeState.showLibrary && 'Library',
                  storeState.showApprovalModal && 'Approval',
                  storeState.showVersionHistory && 'VersionHistory',
                  storeState.showDeploymentModal && 'Deployment',
                ]
                  .filter(Boolean)
                  .join(', ') || 'None'}
              </div>
            </div>
          </div>
        )}

        {/* API Tab */}
        {activeTab === 'api' && (
          <div className="space-y-2">
            <div className="text-gray-400 text-[10px] uppercase tracking-wide mb-2">
              Recent Requests ({debugStore.apiRequests.length})
            </div>
            {debugStore.apiRequests.length === 0 ? (
              <div className="text-gray-500 text-center py-4">No requests yet</div>
            ) : (
              debugStore.apiRequests.slice(0, 20).map((req) => (
                <div
                  key={req.id}
                  className="flex items-center justify-between py-1 border-b border-gray-800"
                >
                  <div className="flex items-center gap-2">
                    <span
                      className={`w-2 h-2 rounded-full ${
                        req.status === 'pending'
                          ? 'bg-yellow-500 animate-pulse'
                          : req.status === 'success'
                            ? 'bg-green-500'
                            : 'bg-red-500'
                      }`}
                    />
                    <span className="text-gray-300">{req.route}</span>
                  </div>
                  <div className="text-gray-500">{req.duration ? `${req.duration}ms` : '...'}</div>
                </div>
              ))
            )}
          </div>
        )}

        {/* SSE Tab */}
        {activeTab === 'sse' && (
          <div className="space-y-2">
            <div className="text-gray-400 text-[10px] uppercase tracking-wide mb-2">
              SSE Events ({debugStore.sseEvents.length})
            </div>
            {debugStore.sseEvents.length === 0 ? (
              <div className="text-gray-500 text-center py-4">No events yet</div>
            ) : (
              debugStore.sseEvents.slice(0, 30).map((evt) => (
                <div key={evt.id} className="py-1 border-b border-gray-800">
                  <div className="flex items-center justify-between">
                    <span className="text-purple-400">{evt.type}</span>
                    <span className="text-gray-600">{formatTime(evt.timestamp)}</span>
                  </div>
                  <div className="text-gray-500 truncate text-[10px]">{evt.data}</div>
                </div>
              ))
            )}
          </div>
        )}

        {/* Tokens Tab */}
        {activeTab === 'tokens' && (
          <div className="space-y-2">
            <div className="text-gray-400 text-[10px] uppercase tracking-wide mb-2">
              Token Usage
            </div>
            {debugStore.tokenUsage.length === 0 ? (
              <div className="text-gray-500 text-center py-4">No usage tracked yet</div>
            ) : (
              <>
                {/* Summary */}
                <div className="bg-gray-800 rounded p-2 mb-3">
                  <div className="flex justify-between mb-1">
                    <span className="text-gray-400">Total Input:</span>
                    <span className="text-blue-400">
                      {debugStore.tokenUsage.reduce((sum, u) => sum + u.input, 0).toLocaleString()}
                    </span>
                  </div>
                  <div className="flex justify-between mb-1">
                    <span className="text-gray-400">Total Output:</span>
                    <span className="text-green-400">
                      {debugStore.tokenUsage.reduce((sum, u) => sum + u.output, 0).toLocaleString()}
                    </span>
                  </div>
                  <div className="flex justify-between">
                    <span className="text-gray-400">Total Cached:</span>
                    <span className="text-yellow-400">
                      {debugStore.tokenUsage.reduce((sum, u) => sum + u.cached, 0).toLocaleString()}
                    </span>
                  </div>
                </div>
                {/* Per-request */}
                {debugStore.tokenUsage.slice(0, 15).map((usage, i) => (
                  <div key={i} className="py-1 border-b border-gray-800">
                    <div className="flex items-center justify-between">
                      <span className="text-gray-300 truncate max-w-[200px]">{usage.route}</span>
                      <span className="text-gray-600">{formatTime(usage.timestamp)}</span>
                    </div>
                    <div className="flex gap-3 text-[10px]">
                      <span className="text-blue-400">in: {usage.input}</span>
                      <span className="text-green-400">out: {usage.output}</span>
                      {usage.cached > 0 && (
                        <span className="text-yellow-400">cached: {usage.cached}</span>
                      )}
                    </div>
                  </div>
                ))}
              </>
            )}
          </div>
        )}
      </div>

      {/* Footer */}
      <div className="px-3 py-2 bg-gray-800 border-t border-gray-700 text-[10px] text-gray-500">
        Refresh: {refreshKey} | Press Ctrl+Shift+D to toggle
      </div>
    </div>
  );
}

export default DebugPanel;
</file>

<file path="src/components/dev/DevTools.tsx">
'use client';

/**
 * DevTools - Combined development tools component
 *
 * Aggregates all development/debugging tools in one component:
 * - MockAIBanner: Visual warning when mock AI is enabled
 * - DebugPanel: Floating debug overlay
 * - StateInspector: Exposes state to window.__APP_STATE__
 *
 * Only active in development mode.
 */

import React from 'react';
import { MockAIBanner } from './MockAIBanner';
import { DebugPanel } from './DebugPanel';
import { ElementInspector } from './ElementInspector';
import { useStateInspector } from '@/hooks/useStateInspector';
import { SHOW_DEV_TOOLS } from '@/utils/debug';

export function DevTools(): React.ReactElement | null {
  // Initialize state inspector (exposes state to window.__APP_STATE__)
  useStateInspector();

  // Don't render if dev tools are disabled
  // Enable via: NEXT_PUBLIC_DEV_TOOLS=true (or automatically in development mode)
  if (!SHOW_DEV_TOOLS) {
    return null;
  }

  return (
    <>
      {/* Mock AI warning banner - shows at top of page when mock mode enabled */}
      <MockAIBanner />

      {/* Debug Panel - floating overlay with state/API/token info */}
      <DebugPanel />

      {/* Element Inspector - visual element selection and Claude prompt generation */}
      <ElementInspector />
    </>
  );
}

export default DevTools;
</file>

<file path="src/components/dev/ElementInspector/PromptGeneratorModal.tsx">
'use client';

/**
 * PromptGeneratorModal - Modal for reviewing and copying the generated prompt
 */

import React, { useState } from 'react';

interface PromptGeneratorModalProps {
  isOpen: boolean;
  prompt: string;
  onClose: () => void;
  onCopy: () => Promise<boolean>;
}

export function PromptGeneratorModal({
  isOpen,
  prompt,
  onClose,
  onCopy,
}: PromptGeneratorModalProps): React.ReactElement | null {
  const [copyStatus, setCopyStatus] = useState<'idle' | 'copied' | 'error'>('idle');

  if (!isOpen) return null;

  const handleCopy = async () => {
    const success = await onCopy();
    setCopyStatus(success ? 'copied' : 'error');
    setTimeout(() => setCopyStatus('idle'), 2000);
  };

  return (
    <div
      data-inspector-modal
      className="fixed inset-0 bg-black/80 backdrop-blur-sm z-[10000] flex items-center justify-center p-4"
      onClick={onClose}
    >
      <div
        className="bg-slate-900 rounded-2xl border border-cyan-500/30 max-w-4xl w-full max-h-[85vh] overflow-hidden shadow-2xl"
        onClick={(e) => e.stopPropagation()}
      >
        {/* Header */}
        <div className="px-6 py-5 border-b border-cyan-500/30 bg-cyan-500/10">
          <div className="flex items-center justify-between">
            <div className="flex items-center gap-3">
              <div className="w-12 h-12 rounded-xl bg-cyan-500/20 flex items-center justify-center">
                <span className="text-3xl">üìã</span>
              </div>
              <div>
                <h3 className="text-xl font-bold text-white">Generated Prompt</h3>
                <p className="text-sm text-cyan-200/80">Review and copy to Claude</p>
              </div>
            </div>
            <button onClick={onClose} className="p-2 rounded-lg hover:bg-white/10 transition-all">
              <span className="text-slate-400 text-xl">‚úï</span>
            </button>
          </div>
        </div>

        {/* Content */}
        <div className="p-6 overflow-y-auto max-h-[60vh]">
          <pre className="bg-gray-800 rounded-lg p-4 text-sm text-gray-300 whitespace-pre-wrap font-mono overflow-x-auto">
            {prompt}
          </pre>
        </div>

        {/* Footer */}
        <div className="px-6 py-4 border-t border-white/10 bg-black/20 flex items-center justify-between">
          <div className="text-sm text-gray-400">{prompt.length} characters</div>
          <div className="flex gap-3">
            <button
              onClick={onClose}
              className="px-4 py-2 rounded-lg bg-gray-700 hover:bg-gray-600 text-white font-medium transition-all"
            >
              Close
            </button>
            <button
              onClick={handleCopy}
              className={`
                px-6 py-2 rounded-lg font-medium transition-all
                ${
                  copyStatus === 'copied'
                    ? 'bg-green-500 text-white'
                    : copyStatus === 'error'
                      ? 'bg-red-500 text-white'
                      : 'bg-gradient-to-r from-cyan-500 to-blue-600 hover:from-cyan-600 hover:to-blue-700 text-white shadow-lg'
                }
              `}
            >
              {copyStatus === 'copied'
                ? '‚úì Copied!'
                : copyStatus === 'error'
                  ? 'Copy Failed'
                  : 'üìã Copy to Clipboard'}
            </button>
          </div>
        </div>
      </div>
    </div>
  );
}

export default PromptGeneratorModal;
</file>

<file path="src/components/dev/ElementInspector/SelectedElementCard.tsx">
'use client';

/**
 * SelectedElementCard - Card showing info about a selected element
 */

import React, { useState } from 'react';
import type { InspectedElement } from '@/types/elementInspector';

interface SelectedElementCardProps {
  element: InspectedElement;
  index: number;
  onRemove: () => void;
}

export function SelectedElementCard({
  element,
  index,
  onRemove,
}: SelectedElementCardProps): React.ReactElement {
  const [isExpanded, setIsExpanded] = useState(false);

  return (
    <div className="bg-gray-800 rounded-lg border border-gray-700 overflow-hidden">
      {/* Header */}
      <div className="flex items-center justify-between px-3 py-2 bg-gray-800/50">
        <div className="flex items-center gap-2 flex-1 min-w-0">
          <span className="flex-shrink-0 w-5 h-5 flex items-center justify-center bg-green-500/20 text-green-400 text-xs rounded-full">
            {index}
          </span>
          <span className="text-sm text-white truncate font-mono">{element.displayName}</span>
        </div>
        <div className="flex items-center gap-1">
          <button
            onClick={() => setIsExpanded(!isExpanded)}
            className="p-1 hover:bg-gray-600 rounded transition-colors"
            title={isExpanded ? 'Collapse' : 'Expand'}
          >
            <span className="text-gray-400 text-xs">{isExpanded ? '‚ñº' : '‚ñ∂'}</span>
          </button>
          <button
            onClick={onRemove}
            className="p-1 hover:bg-red-500/20 rounded transition-colors"
            title="Remove"
          >
            <span className="text-red-400 text-xs">‚úï</span>
          </button>
        </div>
      </div>

      {/* Quick Info */}
      <div className="px-3 py-2 text-xs space-y-1">
        <div className="flex items-center gap-2">
          <span className="text-gray-500">Tag:</span>
          <code className="text-cyan-400">&lt;{element.tagName}&gt;</code>
        </div>

        {element.reactComponentName && (
          <div className="flex items-center gap-2">
            <span className="text-gray-500">Component:</span>
            <code className="text-purple-400">{element.reactComponentName}</code>
          </div>
        )}

        {element.classNames.length > 0 && (
          <div className="flex items-start gap-2">
            <span className="text-gray-500 flex-shrink-0">Classes:</span>
            <code className="text-yellow-400 break-all">
              {element.classNames.slice(0, 3).join(' ')}
              {element.classNames.length > 3 && ` +${element.classNames.length - 3}`}
            </code>
          </div>
        )}
      </div>

      {/* Expanded Details */}
      {isExpanded && (
        <div className="px-3 py-2 border-t border-gray-700 text-xs space-y-2">
          {/* Selector Path */}
          <div>
            <span className="text-gray-500 block mb-1">Selector:</span>
            <code className="text-green-400 block bg-gray-900 px-2 py-1 rounded text-[10px] break-all">
              {element.selectorPath}
            </code>
          </div>

          {/* Source File Guesses */}
          {element.guessedSourceFiles.length > 0 && (
            <div>
              <span className="text-gray-500 block mb-1">Likely files:</span>
              <div className="space-y-0.5">
                {element.guessedSourceFiles.slice(0, 3).map((file, i) => (
                  <code key={i} className="text-blue-400 block text-[10px]">
                    {file}
                  </code>
                ))}
              </div>
            </div>
          )}

          {/* Key Styles */}
          <div>
            <span className="text-gray-500 block mb-1">Key styles:</span>
            <div className="bg-gray-900 px-2 py-1 rounded text-[10px] text-gray-300 font-mono">
              {element.computedStyles.display !== 'block' && (
                <div>display: {element.computedStyles.display}</div>
              )}
              <div>
                size: {element.computedStyles.width} √ó {element.computedStyles.height}
              </div>
              <div>color: {element.computedStyles.color}</div>
              {element.computedStyles.backgroundColor !== 'transparent' && (
                <div>bg: {element.computedStyles.backgroundColor}</div>
              )}
            </div>
          </div>
        </div>
      )}
    </div>
  );
}

export default SelectedElementCard;
</file>

<file path="src/components/dev/index.ts">
/**
 * Development Tools - Index
 *
 * Export all development/debugging components from a single entry point.
 * These are only active in development mode.
 */

export { DevTools } from './DevTools';
export {
  DebugPanel,
  trackAPIRequest,
  updateAPIRequest,
  trackSSEEvent,
  trackTokenUsage,
} from './DebugPanel';
export { MockAIBanner } from './MockAIBanner';

// Re-export performance metrics utilities for convenience
export {
  useRenderPerformance,
  getPerformanceMetrics,
  getComponentMetrics,
  clearPerformanceMetrics,
  getSlowRenderSummary,
  getTotalRenderStats,
  withRenderPerformance,
} from '@/hooks/useRenderPerformance';
export type { RenderMetrics, PerformanceOptions } from '@/hooks/useRenderPerformance';

// Re-export error report utilities
export { getStoredErrorReports, clearStoredErrorReports } from '@/components/ErrorBoundary';
export type { ErrorReport } from '@/components/ErrorBoundary';

// Re-export logger utilities
export { logger, createRequestLogger, generateRequestId } from '@/utils/logger';
export type { LogLevel, LogEntry, LogContext } from '@/utils/logger';
</file>

<file path="src/components/dev/MockAIBanner.tsx">
'use client';

/**
 * MockAIBanner - Visual warning when Mock AI Mode is active
 *
 * Displays a prominent yellow banner at the top of the screen when
 * NEXT_PUBLIC_MOCK_AI=true, so developers know AI responses are fake.
 *
 * Only renders in development mode when mock AI is enabled.
 */

import React from 'react';
import { DEBUG } from '@/utils/debug';

export function MockAIBanner(): React.ReactElement | null {
  // Only show in development with mock AI enabled
  if (!DEBUG.MOCK_AI) {
    return null;
  }

  return (
    <div className="fixed top-0 left-0 right-0 z-[10000] bg-yellow-400 text-yellow-900 text-center py-1.5 px-4 text-sm font-medium shadow-md">
      <span className="mr-2">‚ö†Ô∏è</span>
      <span>MOCK AI MODE - Responses are fake placeholders</span>
      <span className="mx-2">|</span>
      <span className="opacity-75">
        Disable with:{' '}
        <code className="bg-yellow-500/30 px-1 rounded">NEXT_PUBLIC_MOCK_AI=false</code>
      </span>
    </div>
  );
}

export default MockAIBanner;
</file>

<file path="src/components/header/BuildDropdown.tsx">
'use client';

import React from 'react';
import { HeaderDropdown, DropdownItem } from '../ui/HeaderDropdown';
import { LayersIcon, RocketIcon, HistoryIcon, ToggleLeftIcon, ToggleRightIcon } from '../ui/Icons';

interface BuildDropdownProps {
  // Conditional visibility props
  showPlanApp?: boolean;
  showPhasedBuild?: boolean;
  showPhasesToggle?: boolean;
  showVersionHistory?: boolean;

  // State props
  isPhasedMode?: boolean;
  versionCount?: number;

  // Action handlers
  onPlanApp?: () => void;
  onPhasedBuild?: () => void;
  onTogglePhases?: () => void;
  onVersionHistory?: () => void;
}

export const BuildDropdown: React.FC<BuildDropdownProps> = ({
  showPlanApp = false,
  showPhasedBuild = false,
  showPhasesToggle = false,
  showVersionHistory = false,
  isPhasedMode = false,
  versionCount = 0,
  onPlanApp,
  onPhasedBuild,
  onTogglePhases,
  onVersionHistory,
}) => {
  const items: DropdownItem[] = [];

  // Plan App (conditional)
  if (showPlanApp && onPlanApp) {
    items.push({
      id: 'plan-app',
      label: 'Plan App',
      icon: <RocketIcon size={16} />,
      onClick: onPlanApp,
    });
  }

  // Phased Build (conditional)
  if (showPhasedBuild && onPhasedBuild) {
    items.push({
      id: 'phased-build',
      label: 'Phased Build',
      icon: <LayersIcon size={16} />,
      onClick: onPhasedBuild,
    });
  }

  // Phases Toggle (conditional)
  if (showPhasesToggle && onTogglePhases) {
    items.push({
      id: 'phases-toggle',
      label: isPhasedMode ? 'Hide Phases' : 'Show Phases',
      icon: isPhasedMode ? <ToggleRightIcon size={16} /> : <ToggleLeftIcon size={16} />,
      onClick: onTogglePhases,
      dividerAfter: showVersionHistory,
    });
  }

  // Version History (conditional)
  if (showVersionHistory && onVersionHistory) {
    items.push({
      id: 'version-history',
      label: 'Version History',
      icon: <HistoryIcon size={16} />,
      onClick: onVersionHistory,
      badge: versionCount > 0 ? versionCount : undefined,
    });
  }

  // If no items are available, show a disabled message
  if (items.length === 0) {
    items.push({
      id: 'no-options',
      label: 'No build options available',
      disabled: true,
    });
  }

  return (
    <HeaderDropdown
      trigger={
        <span className="flex items-center gap-2">
          <LayersIcon size={16} />
          <span className="hidden sm:inline">Build</span>
        </span>
      }
      label="Build menu"
      items={items}
      align="left"
    />
  );
};

export default BuildDropdown;
</file>

<file path="src/components/header/ProjectInfo.tsx">
'use client';

import React, { useState, useRef, useEffect } from 'react';

type ProjectStatus = 'draft' | 'saved' | 'generating' | 'error';

interface ProjectInfoProps {
  projectName: string;
  status: ProjectStatus;
  lastSaved?: string;
  onRename?: (newName: string) => void;
  isEditable?: boolean;
}

const statusConfig: Record<ProjectStatus, { label: string; dotClass: string }> = {
  draft: { label: 'Draft', dotClass: 'status-dot-draft' },
  saved: { label: 'Saved', dotClass: 'status-dot-saved' },
  generating: { label: 'Generating', dotClass: 'status-dot-generating' },
  error: { label: 'Error', dotClass: 'status-dot-error' },
};

export const ProjectInfo: React.FC<ProjectInfoProps> = ({
  projectName,
  status,
  lastSaved,
  onRename,
  isEditable = true,
}) => {
  const [isEditing, setIsEditing] = useState(false);
  const [editValue, setEditValue] = useState(projectName);
  const inputRef = useRef<HTMLInputElement>(null);

  useEffect(() => {
    if (isEditing && inputRef.current) {
      inputRef.current.focus();
      inputRef.current.select();
    }
  }, [isEditing]);

  useEffect(() => {
    setEditValue(projectName);
  }, [projectName]);

  const handleStartEdit = () => {
    if (isEditable && onRename) {
      setIsEditing(true);
      setEditValue(projectName);
    }
  };

  const handleSave = () => {
    const trimmed = editValue.trim();
    if (trimmed && trimmed !== projectName) {
      onRename?.(trimmed);
    }
    setIsEditing(false);
  };

  const handleCancel = () => {
    setEditValue(projectName);
    setIsEditing(false);
  };

  const handleKeyDown = (e: React.KeyboardEvent) => {
    if (e.key === 'Enter') {
      handleSave();
    } else if (e.key === 'Escape') {
      handleCancel();
    }
  };

  const { label: statusLabel, dotClass } = statusConfig[status];

  return (
    <div className="flex items-center gap-3">
      {/* Project Name */}
      <div className="flex items-center">
        {isEditing ? (
          <input
            ref={inputRef}
            type="text"
            value={editValue}
            onChange={(e) => setEditValue(e.target.value)}
            onBlur={handleSave}
            onKeyDown={handleKeyDown}
            className="px-2 py-1 text-sm font-medium bg-zinc-800 border border-zinc-700 rounded text-zinc-100 outline-none focus:border-blue-500 min-w-[120px]"
            maxLength={50}
          />
        ) : (
          <button
            onClick={handleStartEdit}
            className={`
              text-sm font-medium text-zinc-100 hover:text-white
              ${isEditable ? 'cursor-text hover:bg-zinc-800/50 px-2 py-1 rounded' : 'cursor-default'}
            `}
            title={isEditable ? 'Click to rename' : undefined}
          >
            {projectName}
          </button>
        )}
      </div>

      {/* Divider */}
      <div className="w-px h-4 bg-zinc-700" />

      {/* Status Indicator */}
      <div className="flex items-center gap-2 text-sm text-zinc-400">
        <span className={`status-dot ${dotClass}`} />
        <span>{statusLabel}</span>
        {lastSaved && status === 'saved' && (
          <span className="hidden lg:inline text-zinc-500">{lastSaved}</span>
        )}
      </div>
    </div>
  );
};

export default ProjectInfo;
</file>

<file path="src/components/header/SettingsDropdown.tsx">
'use client';

import React from 'react';
import { HeaderDropdown, DropdownItem } from '../ui/HeaderDropdown';
import { SettingsIcon, SunIcon, MoonIcon, HelpIcon, KeyboardIcon } from '../ui/Icons';

type Theme = 'light' | 'dark' | 'system';

interface SettingsDropdownProps {
  theme?: Theme;
  onThemeChange?: (theme: Theme) => void;
  onSettings?: () => void;
  onHelp?: () => void;
}

export const SettingsDropdown: React.FC<SettingsDropdownProps> = ({
  theme = 'dark',
  onThemeChange,
  onSettings,
  onHelp,
}) => {
  const items: DropdownItem[] = [
    {
      id: 'settings',
      label: 'Settings',
      icon: <SettingsIcon size={16} />,
      onClick: onSettings,
      dividerAfter: true,
    },
    {
      id: 'theme',
      label: 'Theme',
      icon: theme === 'dark' ? <MoonIcon size={16} /> : <SunIcon size={16} />,
      subItems: [
        {
          id: 'theme-light',
          label: 'Light',
          icon: <SunIcon size={16} />,
          onClick: () => onThemeChange?.('light'),
        },
        {
          id: 'theme-dark',
          label: 'Dark',
          icon: <MoonIcon size={16} />,
          onClick: () => onThemeChange?.('dark'),
        },
        {
          id: 'theme-system',
          label: 'System',
          icon: <SettingsIcon size={16} />,
          onClick: () => onThemeChange?.('system'),
        },
      ],
      dividerAfter: true,
    },
    {
      id: 'help',
      label: 'Help & Shortcuts',
      icon: <HelpIcon size={16} />,
      shortcut: '?',
      onClick: onHelp,
    },
  ];

  return (
    <HeaderDropdown
      trigger={<SettingsIcon size={18} />}
      label="Settings menu"
      items={items}
      align="right"
    />
  );
};

export default SettingsDropdown;
</file>

<file path="src/components/header/ViewModeToggle.tsx">
'use client';

import React from 'react';
import { MessageIcon, CodeIcon, EyeIcon, ColumnsIcon } from '../ui/Icons';

type ViewMode = 'chat' | 'code' | 'preview' | 'split';

interface ViewModeToggleProps {
  currentView: ViewMode;
  onViewChange: (view: ViewMode) => void;
}

const viewModes: { id: ViewMode; icon: React.ReactNode; label: string }[] = [
  { id: 'chat', icon: <MessageIcon size={16} />, label: 'Chat' },
  { id: 'code', icon: <CodeIcon size={16} />, label: 'Code' },
  { id: 'preview', icon: <EyeIcon size={16} />, label: 'Preview' },
  { id: 'split', icon: <ColumnsIcon size={16} />, label: 'Split' },
];

export const ViewModeToggle: React.FC<ViewModeToggleProps> = ({ currentView, onViewChange }) => {
  return (
    <div className="flex items-center bg-zinc-900 rounded-md p-0.5 border border-zinc-800">
      {viewModes.map((mode) => (
        <button
          key={mode.id}
          onClick={() => onViewChange(mode.id)}
          className={`
            px-2.5 py-1.5 rounded text-sm flex items-center gap-1.5 transition-colors
            ${
              currentView === mode.id
                ? 'bg-zinc-700 text-white'
                : 'text-zinc-400 hover:text-zinc-200 hover:bg-zinc-800'
            }
          `}
          title={mode.label}
          aria-label={mode.label}
          aria-pressed={currentView === mode.id}
        >
          {mode.icon}
          <span className="hidden lg:inline">{mode.label}</span>
        </button>
      ))}
    </div>
  );
};

export default ViewModeToggle;
</file>

<file path="src/components/layout/DragDropCanvas.tsx">
'use client';

import React, { useState, useCallback } from 'react';
import {
  DndContext,
  DragOverlay,
  closestCenter,
  KeyboardSensor,
  PointerSensor,
  useSensor,
  useSensors,
  type DragEndEvent,
  type DragStartEvent,
} from '@dnd-kit/core';
import {
  SortableContext,
  sortableKeyboardCoordinates,
  useSortable,
  verticalListSortingStrategy,
  arrayMove,
} from '@dnd-kit/sortable';
import { CSS } from '@dnd-kit/utilities';

/**
 * Section types that can be reordered in the layout
 */
export type SectionType = 'header' | 'hero' | 'stats' | 'cards' | 'list' | 'footer' | 'sidebar';

/**
 * Section configuration for drag-and-drop
 */
export interface LayoutSection {
  id: SectionType;
  label: string;
  visible: boolean;
  locked?: boolean; // Header/footer typically locked to position
}

/**
 * Default section order for different layout types
 */
export const DEFAULT_SECTION_ORDER: Record<string, LayoutSection[]> = {
  'single-page': [
    { id: 'header', label: 'Header', visible: true, locked: true },
    { id: 'hero', label: 'Hero Section', visible: true },
    { id: 'cards', label: 'Card Grid', visible: true },
    { id: 'list', label: 'List Section', visible: true },
    { id: 'footer', label: 'Footer', visible: true, locked: true },
  ],
  'multi-page': [
    { id: 'header', label: 'Header', visible: true, locked: true },
    { id: 'hero', label: 'Hero Section', visible: true },
    { id: 'stats', label: 'Stats Row', visible: true },
    { id: 'cards', label: 'Card Grid', visible: true },
    { id: 'footer', label: 'Footer', visible: true, locked: true },
  ],
  dashboard: [
    { id: 'header', label: 'Header', visible: true, locked: true },
    { id: 'stats', label: 'Stats Row', visible: true },
    { id: 'cards', label: 'Card Grid', visible: true },
    { id: 'list', label: 'List Section', visible: true },
    { id: 'footer', label: 'Footer', visible: true, locked: true },
  ],
};

/**
 * Props for sortable section wrapper
 */
interface SortableSectionProps {
  id: string;
  children: React.ReactNode;
  isLocked?: boolean;
  isDragging?: boolean;
}

/**
 * Sortable wrapper for layout sections
 */
export function SortableSection({
  id,
  children,
  isLocked = false,
  isDragging,
}: SortableSectionProps) {
  const {
    attributes,
    listeners,
    setNodeRef,
    transform,
    transition,
    isDragging: isSortableDragging,
  } = useSortable({
    id,
    disabled: isLocked,
  });

  const style: React.CSSProperties = {
    transform: CSS.Transform.toString(transform),
    transition,
    opacity: isSortableDragging ? 0.5 : 1,
    position: 'relative',
  };

  return (
    <div ref={setNodeRef} style={style} className="relative group">
      {/* Drag handle - only show for non-locked sections */}
      {!isLocked && (
        <div
          {...attributes}
          {...listeners}
          className={`absolute left-0 top-1/2 -translate-y-1/2 -translate-x-8 z-10
            opacity-0 group-hover:opacity-100 transition-opacity cursor-grab active:cursor-grabbing
            bg-slate-700 rounded-l-md p-1.5 shadow-lg border border-slate-600
            ${isDragging ? 'opacity-100' : ''}`}
          title="Drag to reorder"
        >
          <svg
            className="w-4 h-4 text-slate-400"
            fill="none"
            viewBox="0 0 24 24"
            stroke="currentColor"
          >
            <path
              strokeLinecap="round"
              strokeLinejoin="round"
              strokeWidth={2}
              d="M4 8h16M4 16h16"
            />
          </svg>
        </div>
      )}

      {/* Lock indicator for locked sections */}
      {isLocked && (
        <div
          className="absolute left-0 top-1/2 -translate-y-1/2 -translate-x-8 z-10
            opacity-0 group-hover:opacity-60 transition-opacity
            bg-slate-800 rounded-l-md p-1.5 border border-slate-700"
          title="Position locked"
        >
          <svg
            className="w-4 h-4 text-slate-500"
            fill="none"
            viewBox="0 0 24 24"
            stroke="currentColor"
          >
            <path
              strokeLinecap="round"
              strokeLinejoin="round"
              strokeWidth={2}
              d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"
            />
          </svg>
        </div>
      )}

      {children}
    </div>
  );
}

/**
 * Props for DragDropCanvas
 */
interface DragDropCanvasProps {
  sections: LayoutSection[];
  onSectionsChange: (sections: LayoutSection[]) => void;
  children: (section: LayoutSection, index: number) => React.ReactNode;
  className?: string;
  disabled?: boolean;
}

/**
 * Drag-and-drop canvas for reordering layout sections
 */
export function DragDropCanvas({
  sections,
  onSectionsChange,
  children,
  className = '',
  disabled = false,
}: DragDropCanvasProps) {
  const [activeId, setActiveId] = useState<string | null>(null);

  const sensors = useSensors(
    useSensor(PointerSensor, {
      activationConstraint: {
        distance: 8, // Require 8px movement before drag starts
      },
    }),
    useSensor(KeyboardSensor, {
      coordinateGetter: sortableKeyboardCoordinates,
    })
  );

  const handleDragStart = useCallback((event: DragStartEvent) => {
    setActiveId(event.active.id as string);
  }, []);

  const handleDragEnd = useCallback(
    (event: DragEndEvent) => {
      const { active, over } = event;
      setActiveId(null);

      if (!over || active.id === over.id) {
        return;
      }

      const oldIndex = sections.findIndex((s) => s.id === active.id);
      const newIndex = sections.findIndex((s) => s.id === over.id);

      // Don't allow moving to/from locked positions
      const activeSection = sections[oldIndex];
      const overSection = sections[newIndex];

      if (activeSection?.locked || overSection?.locked) {
        return;
      }

      const newSections = arrayMove(sections, oldIndex, newIndex);
      onSectionsChange(newSections);
    },
    [sections, onSectionsChange]
  );

  const handleDragCancel = useCallback(() => {
    setActiveId(null);
  }, []);

  // Get sortable IDs (only non-locked sections can be sorted)
  const sortableIds = sections.filter((s) => !s.locked).map((s) => s.id);

  // Find the active section for the drag overlay
  const activeSection = activeId ? sections.find((s) => s.id === activeId) : null;

  if (disabled) {
    // When disabled, just render children without drag functionality
    return (
      <div className={className}>
        {sections.map((section, index) => (
          <div key={section.id}>{children(section, index)}</div>
        ))}
      </div>
    );
  }

  return (
    <DndContext
      sensors={sensors}
      collisionDetection={closestCenter}
      onDragStart={handleDragStart}
      onDragEnd={handleDragEnd}
      onDragCancel={handleDragCancel}
    >
      <SortableContext items={sortableIds} strategy={verticalListSortingStrategy}>
        <div className={className}>
          {sections.map((section, index) => (
            <SortableSection
              key={section.id}
              id={section.id}
              isLocked={section.locked}
              isDragging={activeId === section.id}
            >
              {children(section, index)}
            </SortableSection>
          ))}
        </div>
      </SortableContext>

      {/* Drag overlay for visual feedback */}
      <DragOverlay>
        {activeSection ? (
          <div className="bg-slate-800/90 border-2 border-blue-500 rounded-lg p-4 shadow-2xl">
            <div className="flex items-center gap-2 text-white">
              <svg
                className="w-5 h-5 text-blue-400"
                fill="none"
                viewBox="0 0 24 24"
                stroke="currentColor"
              >
                <path
                  strokeLinecap="round"
                  strokeLinejoin="round"
                  strokeWidth={2}
                  d="M4 8h16M4 16h16"
                />
              </svg>
              <span className="font-medium">{activeSection.label}</span>
            </div>
          </div>
        ) : null}
      </DragOverlay>
    </DndContext>
  );
}

/**
 * Hook for managing section order state
 */
export function useSectionOrder(layoutType: string = 'single-page') {
  const [sections, setSections] = useState<LayoutSection[]>(
    () => DEFAULT_SECTION_ORDER[layoutType] || DEFAULT_SECTION_ORDER['single-page']
  );

  const reorderSections = useCallback((newSections: LayoutSection[]) => {
    setSections(newSections);
  }, []);

  const toggleSectionVisibility = useCallback((sectionId: SectionType) => {
    setSections((prev) =>
      prev.map((s) => (s.id === sectionId ? { ...s, visible: !s.visible } : s))
    );
  }, []);

  const resetToDefault = useCallback(() => {
    setSections(DEFAULT_SECTION_ORDER[layoutType] || DEFAULT_SECTION_ORDER['single-page']);
  }, [layoutType]);

  return {
    sections,
    reorderSections,
    toggleSectionVisibility,
    resetToDefault,
  };
}

export default DragDropCanvas;
</file>

<file path="src/components/modals/LibraryModal.tsx">
'use client';

import React from 'react';
import { FileCard, FileGrid, FileFilters, FileUploader, StorageStats } from '../storage';
import type { GeneratedComponent } from '@/types/aiBuilderTypes';
import type { FileMetadata, StorageStats as StorageStatsType, FileId } from '@/types/storage';

export interface LibraryModalProps {
  isOpen: boolean;
  onClose: () => void;

  // Apps tab
  components: GeneratedComponent[];
  filteredComponents: GeneratedComponent[];
  searchQuery: string;
  onSearchChange: (query: string) => void;
  onLoadComponent: (component: GeneratedComponent) => void;
  onToggleFavorite: (id: string) => void;
  onDeleteComponent: (id: string) => void;
  onExportComponent: (component: GeneratedComponent) => void;
  exportingAppId?: string | null;

  // Files tab
  contentTab: 'apps' | 'files';
  onContentTabChange: (tab: 'apps' | 'files') => void;
  storageFiles: FileMetadata[];
  filteredFiles: FileMetadata[];
  fileSearchQuery: string;
  onFileSearchChange: (query: string) => void;
  fileTypeFilter: string;
  onFileTypeFilterChange: (filter: string) => void;
  fileSortBy: 'name' | 'size' | 'created_at' | 'updated_at';
  fileSortOrder: 'asc' | 'desc';
  onSortChange: (
    sortBy: 'name' | 'size' | 'created_at' | 'updated_at',
    order: 'asc' | 'desc'
  ) => void;
  selectedFiles: Set<string>;
  onFileSelect: (fileId: string) => void;
  onFileUpload: (files: File[]) => Promise<void>;
  onFileDownload: (file: FileMetadata) => void;
  onFileDelete: (fileId: FileId) => void;
  onBulkDelete: () => void;
  onClearSelection: () => void;
  loadingFiles: boolean;
  deletingFiles: Set<string>;
  storageStats: StorageStatsType | null;
  user: { id: string; email?: string } | null;
}

export function LibraryModal({
  isOpen,
  onClose,
  components,
  filteredComponents,
  searchQuery,
  onSearchChange,
  onLoadComponent,
  onToggleFavorite,
  onDeleteComponent,
  onExportComponent,
  exportingAppId,
  contentTab,
  onContentTabChange,
  storageFiles,
  filteredFiles,
  fileSearchQuery,
  onFileSearchChange,
  fileTypeFilter,
  onFileTypeFilterChange,
  fileSortBy,
  fileSortOrder,
  onSortChange,
  selectedFiles,
  onFileSelect,
  onFileUpload,
  onFileDownload,
  onFileDelete,
  onBulkDelete,
  onClearSelection,
  loadingFiles,
  deletingFiles,
  storageStats,
  user,
}: LibraryModalProps) {
  if (!isOpen) return null;

  return (
    <div
      className="fixed inset-0 bg-black/60 backdrop-blur-sm z-50 flex items-center justify-center p-4"
      onClick={onClose}
    >
      <div
        className="bg-slate-900 rounded-2xl border border-white/10 max-w-4xl w-full max-h-[80vh] overflow-hidden flex flex-col"
        onClick={(e) => e.stopPropagation()}
      >
        {/* Library Header */}
        <div className="px-6 py-4 border-b border-white/10 bg-black/20">
          <div className="flex items-center justify-between mb-4">
            <h2 className="text-xl font-bold text-white flex items-center gap-2">
              <span>üìÇ</span>
              <span>My Content</span>
              <span className="text-sm font-normal text-slate-400">
                ({contentTab === 'apps' ? components.length : storageFiles.length})
              </span>
            </h2>
            <button onClick={onClose} className="p-2 rounded-lg hover:bg-white/10 transition-all">
              <span className="text-slate-400 text-xl">‚úï</span>
            </button>
          </div>

          {/* Tabs */}
          <div className="flex gap-2 mb-4">
            <button
              onClick={() => onContentTabChange('apps')}
              className={`flex-1 px-4 py-2 rounded-lg text-sm font-medium transition-all ${
                contentTab === 'apps'
                  ? 'bg-purple-600 text-white shadow-lg'
                  : 'bg-slate-800 text-slate-400 hover:text-white hover:bg-slate-700'
              }`}
            >
              üöÄ Apps ({components.length})
            </button>
            <button
              onClick={() => onContentTabChange('files')}
              className={`flex-1 px-4 py-2 rounded-lg text-sm font-medium transition-all ${
                contentTab === 'files'
                  ? 'bg-purple-600 text-white shadow-lg'
                  : 'bg-slate-800 text-slate-400 hover:text-white hover:bg-slate-700'
              }`}
            >
              üìÅ Files ({storageFiles.length})
            </button>
          </div>

          {/* Search */}
          {contentTab === 'apps' ? (
            <input
              type="text"
              value={searchQuery}
              onChange={(e) => onSearchChange(e.target.value)}
              placeholder="Search apps..."
              className="w-full px-4 py-2 rounded-lg bg-slate-800 border border-white/10 text-white placeholder-slate-500 focus:outline-none focus:ring-2 focus:ring-purple-500"
              id="app-search"
              name="app-search"
              autoComplete="off"
            />
          ) : (
            <FileFilters
              searchQuery={fileSearchQuery}
              onSearchChange={onFileSearchChange}
              selectedType={fileTypeFilter}
              onTypeChange={onFileTypeFilterChange}
              sortBy={fileSortBy}
              sortOrder={fileSortOrder}
              onSortChange={onSortChange}
              onClearFilters={() => {
                onFileSearchChange('');
                onFileTypeFilterChange('all');
                onSortChange('created_at', 'desc');
              }}
            />
          )}
        </div>

        {/* Library Content */}
        <div className="flex-1 min-h-0 overflow-y-auto p-6">
          {contentTab === 'apps' ? (
            // Apps Tab Content
            filteredComponents.length === 0 ? (
              <div className="text-center py-12">
                <div className="text-6xl mb-4">üì≠</div>
                <p className="text-slate-400">
                  {searchQuery ? 'No components found' : 'No components yet. Start building!'}
                </p>
              </div>
            ) : (
              <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                {filteredComponents.map((comp) => (
                  <div
                    key={comp.id}
                    className="bg-white/5 rounded-xl border border-white/10 p-4 hover:bg-white/10 transition-all cursor-pointer group"
                    onClick={() => onLoadComponent(comp)}
                  >
                    <div className="flex items-start justify-between mb-2">
                      <h3 className="font-semibold text-white group-hover:text-blue-400 transition-colors">
                        {comp.name}
                      </h3>
                      <div className="flex gap-2">
                        <button
                          onClick={(e) => {
                            e.stopPropagation();
                            onToggleFavorite(comp.id);
                          }}
                          className="text-xl hover:scale-125 transition-transform"
                        >
                          {comp.isFavorite ? '‚≠ê' : '‚òÜ'}
                        </button>
                        <button
                          onClick={(e) => {
                            e.stopPropagation();
                            onExportComponent(comp);
                          }}
                          className="text-lg hover:scale-125 transition-transform text-green-400 hover:text-green-300"
                          title="Export & Deploy"
                          disabled={exportingAppId === comp.id}
                        >
                          {exportingAppId === comp.id ? '‚è≥' : 'üì¶'}
                        </button>
                        <button
                          onClick={(e) => {
                            e.stopPropagation();
                            if (confirm(`Delete "${comp.name}"?`)) {
                              onDeleteComponent(comp.id);
                            }
                          }}
                          className="text-lg hover:scale-125 transition-transform text-red-400 hover:text-red-300"
                          title="Delete app"
                        >
                          üóëÔ∏è
                        </button>
                      </div>
                    </div>
                    <p className="text-sm text-slate-400 line-clamp-2 mb-3">{comp.description}</p>
                    <div className="flex items-center justify-between text-xs text-slate-500">
                      <span>{new Date(comp.timestamp).toLocaleDateString()}</span>
                      <span className="text-blue-400">‚Üí Load</span>
                    </div>
                  </div>
                ))}
              </div>
            )
          ) : (
            // Files Tab Content
            <>
              {!user ? (
                <div className="flex flex-col items-center justify-center py-16 px-4">
                  <div className="text-6xl mb-4">üîí</div>
                  <h3 className="text-xl font-semibold text-white mb-2">Sign In Required</h3>
                  <p className="text-slate-400 text-center max-w-md">
                    Please sign in to access file storage
                  </p>
                </div>
              ) : (
                <div className="space-y-6">
                  {/* File Uploader */}
                  <FileUploader
                    onUpload={onFileUpload}
                    maxFileSize={10 * 1024 * 1024}
                    allowedTypes={[]}
                    allowedExtensions={[]}
                    disabled={!user}
                  />

                  {/* Storage Stats */}
                  {storageStats && <StorageStats stats={storageStats} />}

                  {/* File Grid */}
                  <FileGrid
                    files={filteredFiles}
                    selectedFiles={selectedFiles}
                    onSelectFile={(file) => onFileSelect(file.id)}
                    onDownload={onFileDownload}
                    onDelete={(file) => onFileDelete(file.id as FileId)}
                    loadingFileIds={deletingFiles}
                    isLoading={loadingFiles}
                  />

                  {/* Bulk Actions */}
                  {selectedFiles.size > 0 && (
                    <div className="fixed bottom-6 right-6 bg-slate-800 rounded-xl border border-white/20 shadow-2xl p-4">
                      <div className="flex items-center gap-3">
                        <span className="text-white text-sm">{selectedFiles.size} selected</span>
                        <button
                          onClick={onBulkDelete}
                          className="px-4 py-2 rounded-lg bg-red-600 hover:bg-red-700 text-white text-sm font-medium transition-all"
                        >
                          üóëÔ∏è Delete Selected
                        </button>
                        <button
                          onClick={onClearSelection}
                          className="px-4 py-2 rounded-lg bg-slate-700 hover:bg-slate-600 text-white text-sm font-medium transition-all"
                        >
                          Clear Selection
                        </button>
                      </div>
                    </div>
                  )}
                </div>
              )}
            </>
          )}
        </div>
      </div>
    </div>
  );
}

export default LibraryModal;
</file>

<file path="src/components/modals/VersionHistoryModal.tsx">
'use client';

import React from 'react';
import type { AppVersion, GeneratedComponent } from '@/types/aiBuilderTypes';

export interface VersionHistoryModalProps {
  isOpen: boolean;
  onClose: () => void;
  currentComponent: GeneratedComponent | null;
  onRevertToVersion: (version: AppVersion) => void;
  onForkVersion: (component: GeneratedComponent, version: AppVersion) => void;
  onCompareVersions: (v1: AppVersion, v2: AppVersion) => void;
}

export function VersionHistoryModal({
  isOpen,
  onClose,
  currentComponent,
  onRevertToVersion,
  onForkVersion,
  onCompareVersions,
}: VersionHistoryModalProps) {
  if (!isOpen || !currentComponent || !currentComponent.versions) return null;

  const changeTypeColors: Record<string, string> = {
    NEW_APP: 'bg-purple-500/20 border-purple-500/30 text-purple-200',
    MAJOR_CHANGE: 'bg-orange-500/20 border-orange-500/30 text-orange-200',
    MINOR_CHANGE: 'bg-green-500/20 border-green-500/30 text-green-200',
  };

  const changeTypeIcons: Record<string, string> = {
    NEW_APP: 'üöÄ',
    MAJOR_CHANGE: '‚ö°',
    MINOR_CHANGE: '‚ú®',
  };

  return (
    <div
      className="fixed inset-0 bg-black/80 backdrop-blur-sm z-[60] flex items-center justify-center p-4"
      onClick={onClose}
    >
      <div
        className="bg-slate-900 rounded-2xl border border-blue-500/30 max-w-3xl w-full max-h-[85vh] overflow-hidden flex flex-col shadow-2xl"
        onClick={(e) => e.stopPropagation()}
      >
        {/* Modal Header */}
        <div className="px-6 py-5 border-b border-blue-500/30 bg-blue-500/10">
          <div className="flex items-center justify-between">
            <div className="flex items-center gap-3">
              <div className="w-12 h-12 rounded-xl bg-blue-500/20 flex items-center justify-center">
                <span className="text-3xl">üïí</span>
              </div>
              <div>
                <h3 className="text-xl font-bold text-white">Version History</h3>
                <p className="text-sm text-blue-200/80">
                  {currentComponent.name} - {currentComponent.versions.length} versions
                </p>
              </div>
            </div>
            <button onClick={onClose} className="p-2 rounded-lg hover:bg-white/10 transition-all">
              <span className="text-slate-400 text-xl">‚úï</span>
            </button>
          </div>
        </div>

        {/* Version List */}
        <div className="flex-1 min-h-0 overflow-y-auto p-6">
          <div className="space-y-3">
            {[...currentComponent.versions].reverse().map((version, idx) => {
              const isCurrentVersion = idx === 0;

              return (
                <div
                  key={version.id}
                  className={`p-4 rounded-xl border transition-all ${
                    isCurrentVersion
                      ? 'bg-blue-500/20 border-blue-500/40'
                      : 'bg-slate-800/50 border-white/10 hover:bg-slate-800 hover:border-white/20'
                  }`}
                >
                  <div className="flex items-start justify-between mb-3">
                    <div className="flex items-center gap-3">
                      <div className="text-2xl">{isCurrentVersion ? 'üìç' : 'üìå'}</div>
                      <div>
                        <div className="flex items-center gap-2 mb-1">
                          <h4 className="text-white font-semibold">
                            Version {version.versionNumber}
                          </h4>
                          {isCurrentVersion && (
                            <span className="px-2 py-0.5 rounded-full bg-blue-500 text-white text-xs font-medium">
                              Current
                            </span>
                          )}
                          <span
                            className={`px-2 py-0.5 rounded-full border text-xs font-medium ${changeTypeColors[version.changeType]}`}
                          >
                            {changeTypeIcons[version.changeType]}{' '}
                            {version.changeType.replace('_', ' ')}
                          </span>
                        </div>
                        <p className="text-xs text-slate-400">
                          {new Date(version.timestamp).toLocaleString()}
                        </p>
                      </div>
                    </div>

                    <div className="flex gap-2">
                      {!isCurrentVersion && (
                        <>
                          <button
                            onClick={() => onForkVersion(currentComponent, version)}
                            className="px-3 py-1.5 rounded-lg bg-white/5 border border-white/10 hover:bg-white/10 text-slate-300 hover:text-white text-sm font-medium transition-all"
                            title="Fork this version"
                          >
                            üç¥ Fork
                          </button>
                          <button
                            onClick={() => {
                              if (
                                window.confirm(
                                  `Revert to Version ${version.versionNumber}? Your current version will be saved.`
                                )
                              ) {
                                onRevertToVersion(version);
                              }
                            }}
                            className="px-3 py-1.5 rounded-lg bg-blue-600 hover:bg-blue-700 text-white text-sm font-medium transition-all"
                          >
                            üîÑ Revert
                          </button>
                        </>
                      )}
                    </div>
                  </div>

                  <p className="text-sm text-slate-300 leading-relaxed mb-3">
                    {version.description}
                  </p>

                  {/* Compare button */}
                  {!isCurrentVersion &&
                    currentComponent.versions &&
                    currentComponent.versions.length > 1 && (
                      <button
                        onClick={() => {
                          const currentVer = currentComponent.versions?.find(
                            (v) =>
                              v.versionNumber ===
                              Math.max(
                                ...(currentComponent.versions?.map((ver) => ver.versionNumber) ||
                                  [])
                              )
                          );
                          if (currentVer) {
                            onCompareVersions(version, currentVer);
                          }
                        }}
                        className="text-xs text-blue-400 hover:text-blue-300 flex items-center gap-1"
                      >
                        üîç Compare with current
                      </button>
                    )}
                </div>
              );
            })}
          </div>
        </div>

        {/* Modal Footer */}
        <div className="px-6 py-4 border-t border-white/10 bg-black/20">
          <div className="flex items-center gap-3 text-xs text-slate-400">
            <span>üí°</span>
            <p>
              Click &quot;Revert&quot; to restore a previous version. Your current version will be
              preserved in history.
            </p>
          </div>
        </div>
      </div>
    </div>
  );
}

export default VersionHistoryModal;
</file>

<file path="src/components/PerformanceReport.tsx">
'use client';

import React, { useState } from 'react';
import type {
  PerformanceReport as PerformanceReportType,
  PerformanceMetrics,
  PerformanceIssue,
} from '@/types/aiBuilderTypes';

export interface PerformanceReportProps {
  isOpen: boolean;
  onClose: () => void;
  report: PerformanceReportType | null;
  onRunBenchmark?: () => void;
  isBenchmarking?: boolean;
}

// Helper function to get impact badge class name
const getImpactBadgeClassName = (impact: string): string => {
  const baseClasses = 'px-2 py-1 rounded-full border text-xs font-medium capitalize';
  const colorClasses = getImpactColor(impact);
  const animationClass = impact === 'critical' ? 'animate-pulse' : '';
  return `${baseClasses} ${colorClasses} ${animationClass}`.trim();
};

// Performance thresholds for metrics
const thresholds = {
  loadTime: { good: 1000, ok: 3000 },
  firstContentfulPaint: { good: 1800, ok: 3000 },
  timeToInteractive: { good: 3800, ok: 7300 },
  bundleSize: { good: 200, ok: 500 },
  renderTime: { good: 100, ok: 300 },
};

// Get status based on thresholds
const getMetricStatus = (
  metric: keyof typeof thresholds,
  value: number
): 'good' | 'ok' | 'poor' => {
  const threshold = thresholds[metric];
  if (value <= threshold.good) return 'good';
  if (value <= threshold.ok) return 'ok';
  return 'poor';
};

const getStatusColor = (status: 'good' | 'ok' | 'poor'): string => {
  switch (status) {
    case 'good':
      return 'text-green-400';
    case 'ok':
      return 'text-yellow-400';
    case 'poor':
      return 'text-red-400';
  }
};

const getStatusBgColor = (status: 'good' | 'ok' | 'poor'): string => {
  switch (status) {
    case 'good':
      return 'bg-green-500/20 border-green-500/30';
    case 'ok':
      return 'bg-yellow-500/20 border-yellow-500/30';
    case 'poor':
      return 'bg-red-500/20 border-red-500/30';
  }
};

const getImpactColor = (impact: string): string => {
  switch (impact) {
    case 'critical':
      return 'bg-red-500/20 text-red-300 border-red-500/30';
    case 'high':
      return 'bg-orange-500/20 text-orange-300 border-orange-500/30';
    case 'medium':
      return 'bg-yellow-500/20 text-yellow-300 border-yellow-500/30';
    case 'low':
      return 'bg-slate-500/20 text-slate-300 border-slate-500/30';
    default:
      return 'bg-slate-500/20 text-slate-300 border-slate-500/30';
  }
};

interface MetricCardProps {
  label: string;
  value: number;
  unit: string;
  metricKey: keyof typeof thresholds;
  icon: string;
}

const MetricCard: React.FC<MetricCardProps> = ({ label, value, unit, metricKey, icon }) => {
  const status = getMetricStatus(metricKey, value);
  const threshold = thresholds[metricKey];
  const progressMax = threshold.ok * 1.5;
  const progressValue = Math.min((value / progressMax) * 100, 100);

  return (
    <div
      className={`p-4 rounded-xl border transition-all hover:scale-105 ${getStatusBgColor(status)}`}
    >
      <div className="flex items-center gap-2 mb-2">
        <span className="text-xl">{icon}</span>
        <span className="text-sm text-slate-300 font-medium">{label}</span>
      </div>
      <div className={`text-2xl font-bold ${getStatusColor(status)}`}>
        {value.toLocaleString()}
        <span className="text-sm font-normal text-slate-400 ml-1">{unit}</span>
      </div>
      <div className="mt-2 w-full bg-slate-700/50 rounded-full h-2">
        <div
          className={`h-2 rounded-full transition-all ${
            status === 'good' ? 'bg-green-500' : status === 'ok' ? 'bg-yellow-500' : 'bg-red-500'
          }`}
          style={{ width: `${progressValue}%` }}
        />
      </div>
      <div className="mt-1 text-xs text-slate-500">
        Good: &lt;{threshold.good}
        {unit === 'KB' ? 'KB' : 'ms'} | OK: &lt;{threshold.ok}
        {unit === 'KB' ? 'KB' : 'ms'}
      </div>
    </div>
  );
};

const getOverallStatus = (metrics: PerformanceMetrics): 'good' | 'ok' | 'poor' => {
  const statuses = [
    getMetricStatus('loadTime', metrics.loadTime),
    getMetricStatus('firstContentfulPaint', metrics.firstContentfulPaint),
    getMetricStatus('timeToInteractive', metrics.timeToInteractive),
    getMetricStatus('bundleSize', metrics.bundleSize),
    getMetricStatus('renderTime', metrics.renderTime),
  ];

  if (statuses.some((s) => s === 'poor')) return 'poor';
  if (statuses.some((s) => s === 'ok')) return 'ok';
  return 'good';
};

export function PerformanceReport({
  isOpen,
  onClose,
  report,
  onRunBenchmark,
  isBenchmarking = false,
}: PerformanceReportProps) {
  const [expandedImpact, setExpandedImpact] = useState<string | null>(null);

  if (!isOpen) return null;

  const groupedIssues =
    report?.issues.reduce(
      (acc, issue) => {
        if (!acc[issue.impact]) acc[issue.impact] = [];
        acc[issue.impact].push(issue);
        return acc;
      },
      {} as Record<string, PerformanceIssue[]>
    ) || {};

  const impactOrder = ['critical', 'high', 'medium', 'low'];

  // Compute status labels
  const statusLabels: Record<'good' | 'ok' | 'poor', string> = {
    good: 'Good Performance',
    ok: 'Needs Improvement',
    poor: 'Poor Performance',
  };

  // Helper function to render status content safely
  const renderStatusContent = () => {
    if (!report) return null;
    const status = getOverallStatus(report.metrics);
    return (
      <>
        {/* Overall Status Banner */}
        <div className={`p-4 rounded-xl border text-center ${getStatusBgColor(status)}`}>
          <div className="flex items-center justify-center gap-3">
            <span className="text-3xl">
              {status === 'good' ? 'üöÄ' : status === 'ok' ? '‚ö†Ô∏è' : 'üêå'}
            </span>
            <div>
              <div className={`text-xl font-bold ${getStatusColor(status)}`}>
                {statusLabels[status]}
              </div>
              <div className="text-sm text-slate-400">
                {report.passed
                  ? 'Performance within acceptable range'
                  : 'Performance needs optimization'}
              </div>
            </div>
          </div>
        </div>

        {/* Metric Cards */}
        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
          <MetricCard
            label="Load Time"
            value={report.metrics.loadTime}
            unit="ms"
            metricKey="loadTime"
            icon="‚è±Ô∏è"
          />
          <MetricCard
            label="First Contentful Paint"
            value={report.metrics.firstContentfulPaint}
            unit="ms"
            metricKey="firstContentfulPaint"
            icon="üé®"
          />
          <MetricCard
            label="Time to Interactive"
            value={report.metrics.timeToInteractive}
            unit="ms"
            metricKey="timeToInteractive"
            icon="üëÜ"
          />
          <MetricCard
            label="Bundle Size"
            value={report.metrics.bundleSize}
            unit="KB"
            metricKey="bundleSize"
            icon="üì¶"
          />
          <MetricCard
            label="Render Time"
            value={report.metrics.renderTime}
            unit="ms"
            metricKey="renderTime"
            icon="üîÑ"
          />
        </div>
      </>
    );
  };

  return (
    <div
      className="fixed inset-0 bg-black/80 backdrop-blur-sm z-[60] flex items-center justify-center p-4"
      onClick={onClose}
      role="dialog"
      aria-modal="true"
      aria-labelledby="performance-report-title"
    >
      <div
        className="bg-slate-900 rounded-2xl border border-purple-500/30 max-w-4xl w-full max-h-[85vh] overflow-hidden flex flex-col shadow-2xl"
        onClick={(e) => e.stopPropagation()}
      >
        {/* Modal Header */}
        <div className="px-6 py-5 border-b border-purple-500/30 bg-purple-500/10">
          <div className="flex items-center justify-between">
            <div className="flex items-center gap-3">
              <div className="w-12 h-12 rounded-xl bg-purple-500/20 flex items-center justify-center">
                <span className="text-3xl">‚ö°</span>
              </div>
              <div>
                <h3 id="performance-report-title" className="text-xl font-bold text-white">
                  Performance Report
                </h3>
                {report && (
                  <p className="text-sm text-purple-200/80">
                    Benchmarked {new Date(report.timestamp).toLocaleString()}
                  </p>
                )}
              </div>
            </div>
            <button
              onClick={onClose}
              className="p-2 rounded-lg hover:bg-white/10 transition-all"
              aria-label="Close modal"
            >
              <span className="text-slate-400 text-xl">‚úï</span>
            </button>
          </div>
        </div>

        {/* Modal Content */}
        <div className="flex-1 min-h-0 overflow-y-auto p-6">
          {isBenchmarking ? (
            <div className="flex flex-col items-center justify-center py-16">
              <div className="w-16 h-16 border-4 border-purple-500/30 border-t-purple-500 rounded-full animate-spin mb-4" />
              <p className="text-slate-400 text-lg">Running performance benchmark...</p>
            </div>
          ) : !report ? (
            <div className="flex flex-col items-center justify-center py-16">
              <div className="text-6xl mb-4">‚ö°</div>
              <p className="text-slate-400 text-lg mb-4">No performance report available</p>
              {onRunBenchmark && (
                <button
                  onClick={onRunBenchmark}
                  className="px-4 py-2 rounded-lg bg-purple-600 hover:bg-purple-700 text-white font-medium transition-all"
                >
                  Run Benchmark
                </button>
              )}
            </div>
          ) : (
            <div className="space-y-6">
              {renderStatusContent()}

              {/* Performance Issues */}
              {report.issues.length > 0 && (
                <div className="space-y-4">
                  <h4 className="text-lg font-semibold text-white flex items-center gap-2">
                    <span>üîß</span>
                    Performance Issues ({report.issues.length})
                  </h4>
                  <div className="space-y-3">
                    {impactOrder.map((impact) => {
                      const issues = groupedIssues[impact];
                      if (!issues || issues.length === 0) return null;

                      const isExpanded = expandedImpact === impact;

                      return (
                        <div
                          key={impact}
                          className="rounded-xl border border-white/10 overflow-hidden"
                        >
                          <button
                            onClick={() => setExpandedImpact(isExpanded ? null : impact)}
                            className="w-full px-4 py-3 flex items-center justify-between bg-slate-800/50 hover:bg-slate-800 transition-all"
                            aria-expanded={isExpanded}
                          >
                            <div className="flex items-center gap-3">
                              <span className={getImpactBadgeClassName(impact)}>{impact}</span>
                              <span className="text-white">
                                {issues.length} issue{issues.length !== 1 ? 's' : ''}
                              </span>
                            </div>
                            <span className="text-slate-400">{isExpanded ? '‚ñº' : '‚ñ∂'}</span>
                          </button>
                          {isExpanded && (
                            <div className="p-4 space-y-3 bg-black/20">
                              {issues.map((issue) => (
                                <div
                                  key={issue.id}
                                  className="p-3 rounded-lg bg-slate-800/50 border border-white/10"
                                >
                                  <div className="flex items-start gap-2">
                                    <span
                                      className={`text-xs ${
                                        issue.type === 'error'
                                          ? 'text-red-400'
                                          : issue.type === 'warning'
                                            ? 'text-yellow-400'
                                            : 'text-blue-400'
                                      }`}
                                    >
                                      {issue.type === 'error'
                                        ? '‚ùå'
                                        : issue.type === 'warning'
                                          ? '‚ö†Ô∏è'
                                          : '‚ÑπÔ∏è'}
                                    </span>
                                    <div className="flex-1">
                                      <p className="text-sm text-slate-300">{issue.message}</p>
                                      {issue.recommendation && (
                                        <div className="mt-2 p-2 rounded-lg bg-blue-500/10 border border-blue-500/20">
                                          <p className="text-xs text-blue-300 flex items-start gap-2">
                                            <span>üí°</span>
                                            <span>{issue.recommendation}</span>
                                          </p>
                                        </div>
                                      )}
                                    </div>
                                  </div>
                                </div>
                              ))}
                            </div>
                          )}
                        </div>
                      );
                    })}
                  </div>
                </div>
              )}
            </div>
          )}
        </div>

        {/* Modal Footer */}
        <div className="px-6 py-4 border-t border-white/10 bg-black/20 flex items-center justify-between">
          <div className="flex items-center gap-3 text-xs text-slate-400">
            <span>üí°</span>
            <p>Focus on critical and high impact issues for best performance gains.</p>
          </div>
          {onRunBenchmark && !isBenchmarking && (
            <button
              onClick={onRunBenchmark}
              className="px-4 py-2 rounded-lg bg-purple-600 hover:bg-purple-700 text-white text-sm font-medium transition-all"
            >
              üîÑ Run Benchmark
            </button>
          )}
        </div>
      </div>
    </div>
  );
}

export default PerformanceReport;
</file>

<file path="src/components/review/ReviewSidebar.tsx">
'use client';

import React from 'react';
import type { ReviewSidebarProps, ChangeCategory, ApprovalStatus } from '@/types/review';
import {
  getCategoryDisplayName,
  getCategoryIcon,
  getRiskLevelColor,
  getRiskLevelBgColor,
  getStatusColor,
} from '@/types/review';

/**
 * ReviewSidebar - Change list sidebar with filters
 *
 * Features:
 * - List of files with changes
 * - Category and status filters
 * - Visual indicators for risk levels
 * - Approval progress per file
 */
export default function ReviewSidebar({
  changes,
  selectedFilePath,
  onSelectFile,
  categoryFilter,
  onCategoryFilterChange,
  statusFilter,
  onStatusFilterChange,
}: ReviewSidebarProps) {
  const categories: (ChangeCategory | 'all')[] = [
    'all',
    'structure',
    'styling',
    'logic',
    'content',
    'configuration',
    'dependencies',
  ];

  const statuses: (ApprovalStatus | 'all')[] = ['all', 'pending', 'approved', 'rejected'];

  const getFileIcon = (path: string): string => {
    const ext = path.split('.').pop()?.toLowerCase() || '';
    const iconMap: Record<string, string> = {
      ts: 'üìò',
      tsx: '‚öõÔ∏è',
      js: 'üìô',
      jsx: '‚öõÔ∏è',
      css: 'üé®',
      scss: 'üé®',
      json: 'üìã',
      md: 'üìù',
      html: 'üåê',
    };
    return iconMap[ext] || 'üìÑ';
  };

  const getApprovalProgress = (
    hunks: { status: ApprovalStatus }[]
  ): {
    approved: number;
    rejected: number;
    pending: number;
    total: number;
  } => {
    const approved = hunks.filter((h) => h.status === 'approved').length;
    const rejected = hunks.filter((h) => h.status === 'rejected').length;
    const pending = hunks.filter((h) => h.status === 'pending').length;
    return { approved, rejected, pending, total: hunks.length };
  };

  return (
    <div className="h-full flex flex-col bg-slate-900 border-r border-white/10">
      {/* Header */}
      <div className="px-4 py-3 border-b border-white/10 bg-black/20">
        <h2 className="text-white font-semibold flex items-center gap-2">
          <span>üìã</span>
          <span>Changes to Review</span>
          <span className="text-xs bg-blue-500/20 text-blue-400 px-2 py-0.5 rounded-full">
            {changes.length}
          </span>
        </h2>
      </div>

      {/* Filters */}
      <div className="px-3 py-3 border-b border-white/10 space-y-3">
        {/* Category Filter */}
        <div>
          <label className="text-xs text-slate-400 block mb-1.5">Category</label>
          <select
            value={categoryFilter}
            onChange={(e) => onCategoryFilterChange(e.target.value as ChangeCategory | 'all')}
            className="w-full px-3 py-1.5 rounded-lg bg-slate-800 border border-white/10 text-white text-sm focus:outline-none focus:ring-2 focus:ring-blue-500"
          >
            {categories.map((cat) => (
              <option key={cat} value={cat}>
                {cat === 'all'
                  ? 'üìÅ All Categories'
                  : `${getCategoryIcon(cat)} ${getCategoryDisplayName(cat)}`}
              </option>
            ))}
          </select>
        </div>

        {/* Status Filter */}
        <div>
          <label className="text-xs text-slate-400 block mb-1.5">Status</label>
          <div className="flex gap-1">
            {statuses.map((status) => (
              <button
                key={status}
                onClick={() => onStatusFilterChange(status)}
                className={`flex-1 px-2 py-1.5 rounded-lg text-xs font-medium transition-all ${
                  statusFilter === status
                    ? 'bg-blue-600 text-white'
                    : 'bg-slate-800 text-slate-400 hover:bg-slate-700 hover:text-white'
                }`}
              >
                {status === 'all' ? 'All' : status.charAt(0).toUpperCase() + status.slice(1)}
              </button>
            ))}
          </div>
        </div>
      </div>

      {/* File List */}
      <div className="flex-1 min-h-0 overflow-y-auto">
        {changes.length === 0 ? (
          <div className="p-4 text-center">
            <span className="text-4xl block mb-2">üì≠</span>
            <p className="text-sm text-slate-400">No changes to review</p>
          </div>
        ) : (
          <div className="py-2">
            {changes.map((change) => {
              const progress = getApprovalProgress(change.hunks);
              const isSelected = change.path === selectedFilePath;

              return (
                <button
                  key={change.path}
                  onClick={() => onSelectFile(change.path)}
                  className={`w-full px-3 py-2.5 text-left transition-all ${
                    isSelected
                      ? 'bg-blue-500/20 border-l-2 border-blue-500'
                      : 'hover:bg-white/5 border-l-2 border-transparent'
                  }`}
                >
                  <div className="flex items-start gap-2">
                    {/* File Icon */}
                    <span className="text-lg flex-shrink-0">{getFileIcon(change.path)}</span>

                    {/* File Info */}
                    <div className="flex-1 min-w-0">
                      <div className="flex items-center gap-2">
                        <span
                          className={`text-sm font-medium truncate ${
                            isSelected ? 'text-white' : 'text-slate-300'
                          }`}
                        >
                          {change.path.split('/').pop()}
                        </span>
                        <span
                          className={`text-xs px-1.5 py-0.5 rounded border ${getRiskLevelBgColor(
                            change.riskLevel
                          )} ${getRiskLevelColor(change.riskLevel)}`}
                        >
                          {change.riskLevel}
                        </span>
                      </div>

                      {/* Path */}
                      <p className="text-xs text-slate-500 truncate mt-0.5">{change.path}</p>

                      {/* Category & Action */}
                      <div className="flex items-center gap-2 mt-1 text-xs">
                        <span className="text-slate-400">
                          {getCategoryIcon(change.category)}{' '}
                          {getCategoryDisplayName(change.category)}
                        </span>
                        <span className="text-slate-600">‚Ä¢</span>
                        <span
                          className={
                            change.action === 'create'
                              ? 'text-green-400'
                              : change.action === 'delete'
                                ? 'text-red-400'
                                : 'text-yellow-400'
                          }
                        >
                          {change.action}
                        </span>
                      </div>

                      {/* Approval Progress */}
                      <div className="mt-2">
                        <div className="flex items-center gap-1 text-xs">
                          <span className="text-green-400">{progress.approved}‚úì</span>
                          <span className="text-red-400">{progress.rejected}‚úó</span>
                          <span className="text-slate-400">{progress.pending}?</span>
                          <span className="text-slate-500">/ {progress.total} hunks</span>
                        </div>
                        {/* Progress Bar */}
                        <div className="h-1 bg-slate-700 rounded-full mt-1 overflow-hidden flex">
                          {progress.approved > 0 && (
                            <div
                              className="h-full bg-green-500"
                              style={{ width: `${(progress.approved / progress.total) * 100}%` }}
                            />
                          )}
                          {progress.rejected > 0 && (
                            <div
                              className="h-full bg-red-500"
                              style={{ width: `${(progress.rejected / progress.total) * 100}%` }}
                            />
                          )}
                          {progress.pending > 0 && (
                            <div
                              className="h-full bg-slate-500"
                              style={{ width: `${(progress.pending / progress.total) * 100}%` }}
                            />
                          )}
                        </div>
                      </div>
                    </div>
                  </div>
                </button>
              );
            })}
          </div>
        )}
      </div>

      {/* Summary Footer */}
      {changes.length > 0 && (
        <div className="px-4 py-3 border-t border-white/10 bg-black/20">
          <div className="flex items-center justify-between text-xs text-slate-400">
            <span>{changes.reduce((sum, c) => sum + c.hunks.length, 0)} total hunks</span>
            <span>
              {changes.reduce(
                (sum, c) => sum + c.hunks.filter((h) => h.status === 'pending').length,
                0
              )}{' '}
              pending
            </span>
          </div>
        </div>
      )}
    </div>
  );
}
</file>

<file path="src/components/storage/StorageStats.tsx">
'use client';

import React from 'react';
import type { StorageStats as StorageStatsType } from '@/types/storage';

interface StorageStatsProps {
  stats: StorageStatsType;
  onUpgrade?: () => void;
}

/**
 * StorageStats Component
 *
 * Displays storage usage, quota, and breakdown by file type.
 * Shows warnings when approaching quota limits.
 */
export function StorageStats({ stats, onUpgrade }: StorageStatsProps) {
  // Calculate usage percentage (handle undefined quota)
  const usagePercentage =
    stats.quota && stats.quota > 0 ? (stats.totalSize / stats.quota) * 100 : 0;

  // Determine warning level
  const isWarning = usagePercentage >= 80;
  const isCritical = usagePercentage >= 95;

  // Format bytes to human-readable
  const formatBytes = (bytes: number): string => {
    const units = ['B', 'KB', 'MB', 'GB'];
    let size = bytes;
    let unitIndex = 0;

    while (size >= 1024 && unitIndex < units.length - 1) {
      size /= 1024;
      unitIndex++;
    }

    return `${size.toFixed(1)} ${units[unitIndex]}`;
  };

  // Get progress bar color based on usage
  const getProgressColor = (): string => {
    if (isCritical) return 'bg-red-500';
    if (isWarning) return 'bg-yellow-500';
    return 'bg-blue-500';
  };

  // Get icon based on usage
  const getIcon = (): string => {
    if (isCritical) return 'üö®';
    if (isWarning) return '‚ö†Ô∏è';
    return 'üíæ';
  };

  return (
    <div className="rounded-xl border border-white/10 bg-white/5 p-4">
      {/* Header */}
      <div className="flex items-center justify-between mb-3">
        <div className="flex items-center gap-2">
          <span className="text-2xl">{getIcon()}</span>
          <h3 className="text-white font-semibold text-sm">Storage Usage</h3>
        </div>
        {onUpgrade && (isWarning || isCritical) && (
          <button
            onClick={onUpgrade}
            className="px-3 py-1.5 rounded-lg bg-purple-600 hover:bg-purple-700 text-white text-xs font-medium transition-all"
            aria-label="Upgrade storage"
          >
            ‚¨ÜÔ∏è Upgrade
          </button>
        )}
      </div>

      {/* Usage Bar */}
      <div className="mb-3">
        <div className="flex items-center justify-between mb-2 text-xs">
          <span className="text-slate-300">{formatBytes(stats.totalSize)} used</span>
          <span className="text-slate-400">
            {stats.quota ? `of ${formatBytes(stats.quota)}` : '(no quota)'}
          </span>
        </div>

        <div className="h-2 bg-slate-800/50 rounded-full overflow-hidden">
          <div
            className={`h-full ${getProgressColor()} transition-all duration-500 rounded-full`}
            style={{ width: `${Math.min(usagePercentage, 100)}%` }}
            role="progressbar"
            aria-valuenow={usagePercentage}
            aria-valuemin={0}
            aria-valuemax={100}
            aria-label={`Storage usage: ${usagePercentage.toFixed(1)}%`}
          />
        </div>

        <div className="mt-1 text-xs text-slate-400 text-center">
          {usagePercentage.toFixed(1)}% used
        </div>
      </div>

      {/* Warning Messages */}
      {isCritical && (
        <div className="mb-3 p-3 rounded-lg bg-red-500/10 border border-red-500/30">
          <div className="flex items-start gap-2">
            <span className="text-red-400 text-lg">üö®</span>
            <div>
              <p className="text-red-200 text-xs font-medium mb-1">Storage Almost Full!</p>
              <p className="text-red-200/70 text-xs">
                You&apos;re using {usagePercentage.toFixed(1)}% of your storage. Delete some files
                or upgrade to continue uploading.
              </p>
            </div>
          </div>
        </div>
      )}

      {isWarning && !isCritical && (
        <div className="mb-3 p-3 rounded-lg bg-yellow-500/10 border border-yellow-500/30">
          <div className="flex items-start gap-2">
            <span className="text-yellow-400 text-lg">‚ö†Ô∏è</span>
            <div>
              <p className="text-yellow-200 text-xs font-medium mb-1">Storage Running Low</p>
              <p className="text-yellow-200/70 text-xs">
                You&apos;ve used {usagePercentage.toFixed(1)}% of your storage quota.
              </p>
            </div>
          </div>
        </div>
      )}

      {/* File Count and Type Breakdown */}
      <div className="grid grid-cols-2 gap-2">
        <div className="bg-slate-800/30 rounded-lg p-2">
          <div className="text-slate-400 text-xs mb-1">Total Files</div>
          <div className="text-white font-semibold text-lg">{stats.totalFiles}</div>
        </div>

        <div className="bg-slate-800/30 rounded-lg p-2">
          <div className="text-slate-400 text-xs mb-1">Available</div>
          <div className="text-white font-semibold text-lg">
            {stats.quota ? formatBytes(stats.quota - stats.totalSize) : 'N/A'}
          </div>
        </div>
      </div>

      {/* File Type Breakdown (if provided) */}
      {stats.byType && Object.keys(stats.byType).length > 0 && (
        <div className="mt-3 pt-3 border-t border-white/10">
          <div className="text-slate-400 text-xs mb-2">By Type</div>
          <div className="space-y-1">
            {Object.entries(stats.byType)
              .sort((a, b) => b[1].fileCount - a[1].fileCount)
              .slice(0, 5)
              .map(([type, data]) => (
                <div key={type} className="flex items-center justify-between text-xs">
                  <span className="text-slate-300 capitalize">{type}</span>
                  <span className="text-slate-400">{data.fileCount}</span>
                </div>
              ))}
          </div>
        </div>
      )}
    </div>
  );
}
</file>

<file path="src/components/StreamingProgress.tsx">
'use client';

/**
 * StreamingProgress Component
 *
 * Displays real-time progress during app generation with:
 * - Current phase indicator
 * - File-by-file progress
 * - Elapsed time
 * - Token usage stats
 */

import React, { useEffect, useState } from 'react';
import { type StreamingProgress as ProgressType } from '@/types/streaming';

interface StreamingProgressProps {
  progress: ProgressType;
  onCancel?: () => void;
}

/**
 * Format elapsed time as mm:ss
 */
function formatTime(ms: number): string {
  const seconds = Math.floor(ms / 1000);
  const mins = Math.floor(seconds / 60);
  const secs = seconds % 60;
  return `${mins}:${secs.toString().padStart(2, '0')}`;
}

/**
 * Get phase icon
 */
function getPhaseIcon(phase: ProgressType['phase']): string {
  switch (phase) {
    case 'starting':
      return 'üöÄ';
    case 'thinking':
      return 'üß†';
    case 'generating':
      return '‚ö°';
    case 'validating':
      return 'üîç';
    case 'complete':
      return '‚úÖ';
    case 'error':
      return '‚ùå';
    default:
      return '‚è≥';
  }
}

/**
 * Get phase color classes
 */
function getPhaseColor(phase: ProgressType['phase']): string {
  switch (phase) {
    case 'starting':
      return 'text-blue-400';
    case 'thinking':
      return 'text-purple-400';
    case 'generating':
      return 'text-yellow-400';
    case 'validating':
      return 'text-cyan-400';
    case 'complete':
      return 'text-green-400';
    case 'error':
      return 'text-red-400';
    default:
      return 'text-slate-400';
  }
}

export function StreamingProgress({ progress, onCancel }: StreamingProgressProps) {
  const [elapsedTime, setElapsedTime] = useState(0);

  // Update elapsed time every 100ms when streaming
  useEffect(() => {
    if (!progress.isStreaming || !progress.startTime) {
      return;
    }

    const interval = setInterval(() => {
      setElapsedTime(Date.now() - progress.startTime!);
    }, 100);

    return () => clearInterval(interval);
  }, [progress.isStreaming, progress.startTime]);

  if (!progress.isStreaming && progress.phase === 'idle') {
    return null;
  }

  const completedCount = progress.filesCompleted.length;
  const totalCount = progress.totalFiles || completedCount;
  const progressPercent = totalCount > 0 ? (completedCount / totalCount) * 100 : 0;

  return (
    <div className="bg-slate-800/80 backdrop-blur-sm border border-white/10 rounded-xl p-4 shadow-xl">
      {/* Header with phase and time */}
      <div className="flex items-center justify-between mb-3">
        <div className="flex items-center gap-2">
          <span className="text-2xl animate-pulse">{getPhaseIcon(progress.phase)}</span>
          <span className={`font-medium ${getPhaseColor(progress.phase)}`}>
            {progress.phase.charAt(0).toUpperCase() + progress.phase.slice(1)}
          </span>
        </div>
        <div className="flex items-center gap-3">
          <span className="text-slate-400 text-sm font-mono">{formatTime(elapsedTime)}</span>
          {progress.isStreaming && onCancel && (
            <button
              onClick={onCancel}
              className="text-xs px-2 py-1 rounded bg-red-500/20 text-red-400 hover:bg-red-500/30 transition-colors"
            >
              Cancel
            </button>
          )}
        </div>
      </div>

      {/* Current message */}
      <p className="text-slate-300 text-sm mb-3 truncate">{progress.message}</p>

      {/* Progress bar */}
      {progress.totalFiles > 0 && (
        <div className="mb-3">
          <div className="flex justify-between text-xs text-slate-400 mb-1">
            <span>
              Files: {completedCount} / {totalCount}
            </span>
            <span>{Math.round(progressPercent)}%</span>
          </div>
          <div className="h-2 bg-slate-700 rounded-full overflow-hidden">
            <div
              className="h-full bg-gradient-to-r from-blue-500 via-purple-500 to-pink-500 transition-all duration-300 ease-out"
              style={{ width: `${progressPercent}%` }}
            />
          </div>
        </div>
      )}

      {/* File list (compact) */}
      {progress.filesCompleted.length > 0 && (
        <div className="mt-3 pt-3 border-t border-white/5">
          <div className="text-xs text-slate-500 mb-2">Generated files:</div>
          <div className="flex flex-wrap gap-1">
            {progress.filesCompleted.slice(-6).map((file, i) => (
              <span
                key={i}
                className="text-xs px-2 py-0.5 rounded bg-green-500/10 text-green-400 border border-green-500/20"
              >
                {file.split('/').pop()}
              </span>
            ))}
            {progress.filesCompleted.length > 6 && (
              <span className="text-xs px-2 py-0.5 text-slate-500">
                +{progress.filesCompleted.length - 6} more
              </span>
            )}
          </div>
        </div>
      )}

      {/* Current file being generated */}
      {progress.currentFile && progress.phase === 'generating' && (
        <div className="mt-2 flex items-center gap-2">
          <div className="w-2 h-2 bg-yellow-400 rounded-full animate-pulse" />
          <span className="text-xs text-yellow-400/80 truncate">{progress.currentFile}</span>
        </div>
      )}

      {/* Stats on completion */}
      {progress.phase === 'complete' && progress.stats.outputTokens > 0 && (
        <div className="mt-3 pt-3 border-t border-white/5 flex gap-4 text-xs text-slate-500">
          <span>Input: {progress.stats.inputTokens.toLocaleString()} tokens</span>
          <span>Output: {progress.stats.outputTokens.toLocaleString()} tokens</span>
          {progress.stats.cachedTokens > 0 && (
            <span className="text-green-400/60">
              Cached: {progress.stats.cachedTokens.toLocaleString()}
            </span>
          )}
        </div>
      )}
    </div>
  );
}

/**
 * Compact inline progress indicator for use in chat
 */
export function InlineStreamingProgress({ progress }: { progress: ProgressType }) {
  if (!progress.isStreaming && progress.phase === 'idle') {
    return null;
  }

  return (
    <div className="flex items-center gap-2 text-sm">
      <span className="animate-pulse">{getPhaseIcon(progress.phase)}</span>
      <span className={getPhaseColor(progress.phase)}>{progress.message || 'Processing...'}</span>
      {progress.totalFiles > 0 && (
        <span className="text-slate-500">
          ({progress.filesCompleted.length}/{progress.totalFiles} files)
        </span>
      )}
    </div>
  );
}

export default StreamingProgress;
</file>

<file path="src/components/TabNavigation.tsx">
'use client';

import React from 'react';
import { useAppStore, type MainView } from '@/store/useAppStore';

interface TabConfig {
  id: MainView;
  label: string;
  icon: React.ReactNode;
  description: string;
}

const tabs: TabConfig[] = [
  {
    id: 'main',
    label: 'Builder',
    icon: (
      <svg className="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path
          strokeLinecap="round"
          strokeLinejoin="round"
          strokeWidth={2}
          d="M8 9l3 3-3 3m5 0h3M5 20h14a2 2 0 002-2V6a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"
        />
      </svg>
    ),
    description: 'Chat & Preview',
  },
  {
    id: 'wizard',
    label: 'Wizard',
    icon: (
      <svg className="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path
          strokeLinecap="round"
          strokeLinejoin="round"
          strokeWidth={2}
          d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"
        />
      </svg>
    ),
    description: 'Plan your app',
  },
  {
    id: 'layout',
    label: 'Layout',
    icon: (
      <svg className="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path
          strokeLinecap="round"
          strokeLinejoin="round"
          strokeWidth={2}
          d="M4 5a1 1 0 011-1h14a1 1 0 011 1v2a1 1 0 01-1 1H5a1 1 0 01-1-1V5zM4 13a1 1 0 011-1h6a1 1 0 011 1v6a1 1 0 01-1 1H5a1 1 0 01-1-1v-6zM16 13a1 1 0 011-1h2a1 1 0 011 1v6a1 1 0 01-1 1h-2a1 1 0 01-1-1v-6z"
        />
      </svg>
    ),
    description: 'Design layouts',
  },
  {
    id: 'build',
    label: 'Build',
    icon: (
      <svg className="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path
          strokeLinecap="round"
          strokeLinejoin="round"
          strokeWidth={2}
          d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"
        />
      </svg>
    ),
    description: 'Phased building',
  },
];

export function TabNavigation() {
  const activeView = useAppStore((state) => state.activeView);
  const setActiveView = useAppStore((state) => state.setActiveView);

  return (
    <nav className="flex items-center gap-1 px-2 py-1 bg-slate-800/50 border-b border-slate-700">
      {tabs.map((tab) => {
        const isActive = activeView === tab.id;
        return (
          <button
            key={tab.id}
            onClick={() => setActiveView(tab.id)}
            className={`
              flex items-center gap-2 px-4 py-2 rounded-lg text-sm font-medium transition-all
              ${
                isActive
                  ? 'bg-blue-600 text-white shadow-lg shadow-blue-500/20'
                  : 'text-slate-400 hover:text-white hover:bg-slate-700/50'
              }
            `}
            title={tab.description}
          >
            {tab.icon}
            <span>{tab.label}</span>
          </button>
        );
      })}
    </nav>
  );
}

export default TabNavigation;
</file>

<file path="src/components/ui/HeaderDropdown.tsx">
'use client';

import React, { useState, useRef, useEffect, useCallback } from 'react';
import { ChevronDownIcon, ChevronRightIcon } from './Icons';

export interface DropdownItem {
  id: string;
  label: string;
  icon?: React.ReactNode;
  shortcut?: string;
  onClick?: () => void;
  disabled?: boolean;
  variant?: 'default' | 'danger';
  dividerAfter?: boolean;
  subItems?: DropdownItem[];
  badge?: string | number;
}

export interface HeaderDropdownProps {
  trigger: React.ReactNode;
  label: string;
  items: DropdownItem[];
  align?: 'left' | 'right';
  disabled?: boolean;
}

export const HeaderDropdown: React.FC<HeaderDropdownProps> = ({
  trigger,
  label,
  items,
  align = 'left',
  disabled = false,
}) => {
  const [isOpen, setIsOpen] = useState(false);
  const [activeSubmenu, setActiveSubmenu] = useState<string | null>(null);
  const dropdownRef = useRef<HTMLDivElement>(null);
  const triggerRef = useRef<HTMLButtonElement>(null);

  // Close on click outside
  useEffect(() => {
    const handleClickOutside = (event: MouseEvent) => {
      if (dropdownRef.current && !dropdownRef.current.contains(event.target as Node)) {
        setIsOpen(false);
        setActiveSubmenu(null);
      }
    };

    if (isOpen) {
      document.addEventListener('mousedown', handleClickOutside);
    }

    return () => {
      document.removeEventListener('mousedown', handleClickOutside);
    };
  }, [isOpen]);

  // Keyboard navigation
  const handleKeyDown = useCallback(
    (event: React.KeyboardEvent) => {
      if (event.key === 'Escape') {
        setIsOpen(false);
        setActiveSubmenu(null);
        triggerRef.current?.focus();
      } else if (event.key === 'Enter' || event.key === ' ') {
        if (!isOpen) {
          event.preventDefault();
          setIsOpen(true);
        }
      }
    },
    [isOpen]
  );

  const handleItemClick = (item: DropdownItem) => {
    if (item.disabled) return;
    if (item.subItems) {
      setActiveSubmenu(activeSubmenu === item.id ? null : item.id);
      return;
    }
    item.onClick?.();
    setIsOpen(false);
    setActiveSubmenu(null);
  };

  const toggleDropdown = () => {
    if (!disabled) {
      setIsOpen(!isOpen);
      setActiveSubmenu(null);
    }
  };

  const renderItem = (item: DropdownItem, isSubmenuItem = false) => {
    const hasSubmenu = item.subItems && item.subItems.length > 0;
    const isSubmenuOpen = activeSubmenu === item.id;

    return (
      <div key={item.id} className="relative">
        <button
          onClick={() => handleItemClick(item)}
          onMouseEnter={() => hasSubmenu && setActiveSubmenu(item.id)}
          disabled={item.disabled}
          className={`
            w-full px-3 py-2 text-sm flex items-center gap-3 transition-colors
            ${
              item.variant === 'danger'
                ? 'text-red-400 hover:text-red-300 hover:bg-red-950/50'
                : 'text-zinc-300 hover:bg-zinc-800 hover:text-white'
            }
            ${item.disabled ? 'opacity-50 cursor-not-allowed' : 'cursor-pointer'}
            ${isSubmenuItem ? 'pl-4' : ''}
          `}
          role="menuitem"
          aria-disabled={item.disabled}
        >
          {item.icon && (
            <span className="w-4 h-4 flex items-center justify-center text-zinc-500">
              {item.icon}
            </span>
          )}
          <span className="flex-1 text-left">{item.label}</span>
          {item.badge !== undefined && (
            <span className="px-1.5 py-0.5 text-xs bg-zinc-700 text-zinc-300 rounded">
              {item.badge}
            </span>
          )}
          {item.shortcut && (
            <span className="ml-auto text-xs text-zinc-500 font-mono">{item.shortcut}</span>
          )}
          {hasSubmenu && <ChevronRightIcon size={14} className="text-zinc-500" />}
        </button>

        {/* Submenu */}
        {hasSubmenu && isSubmenuOpen && (
          <div
            className="absolute left-full top-0 ml-1 min-w-[180px] py-1 bg-zinc-900 border border-zinc-800 rounded-lg shadow-lg shadow-black/30 z-50"
            role="menu"
          >
            {item.subItems!.map((subItem) => renderItem(subItem, true))}
          </div>
        )}

        {item.dividerAfter && <div className="my-1 h-px bg-zinc-800" />}
      </div>
    );
  };

  // Filter out items that have no visible content
  const visibleItems = items.filter((item) => !item.disabled || item.label);

  if (visibleItems.length === 0) {
    return null;
  }

  return (
    <div ref={dropdownRef} className="relative" onKeyDown={handleKeyDown}>
      <button
        ref={triggerRef}
        onClick={toggleDropdown}
        disabled={disabled}
        className={`
          linear-btn-ghost flex items-center gap-1.5
          ${disabled ? 'opacity-50 cursor-not-allowed' : ''}
          ${isOpen ? 'bg-zinc-800 text-white' : ''}
        `}
        aria-haspopup="true"
        aria-expanded={isOpen}
        aria-label={label}
      >
        {trigger}
        <ChevronDownIcon
          size={14}
          className={`transition-transform duration-150 ${isOpen ? 'rotate-180' : ''}`}
        />
      </button>

      {isOpen && (
        <div
          className={`
            absolute top-full mt-1 min-w-[200px] py-1
            bg-zinc-900 border border-zinc-800 rounded-lg
            shadow-lg shadow-black/30 z-dropdown
            animate-fade-in
            ${align === 'right' ? 'right-0' : 'left-0'}
          `}
          role="menu"
          aria-label={label}
        >
          {visibleItems.map((item) => renderItem(item))}
        </div>
      )}
    </div>
  );
};

export default HeaderDropdown;
</file>

<file path="src/components/ui/index.ts">
// Resizable Panels System
// Export all components for easy importing

export {
  ResizablePanel,
  ResizablePanelContext,
  useResizablePanelContext,
  RESIZABLE_PANEL_TYPE,
} from './ResizablePanel';
export type { ResizablePanelProps, ResizablePanelContextValue } from './ResizablePanel';

export { ResizableHandle, ResizableHandleContext, RESIZABLE_HANDLE_TYPE } from './ResizableHandle';
export type { ResizableHandleProps, ResizableHandleContextValue } from './ResizableHandle';

export { ResizablePanelGroup } from './ResizablePanelGroup';
export type { ResizablePanelGroupProps } from './ResizablePanelGroup';

// Icons
export * from './Icons';

// Header Components
export { HeaderDropdown } from './HeaderDropdown';
export type { HeaderDropdownProps, DropdownItem } from './HeaderDropdown';
</file>

<file path="src/components/ui/Toast.tsx">
'use client';

/**
 * Toast Component
 *
 * A styled toast notification component that displays messages to users.
 */

import React, { useEffect, useState } from 'react';
import type { Toast as ToastType, ToastType as ToastVariant } from '@/hooks/useToast';

// ============================================================================
// TYPES
// ============================================================================

interface ToastProps {
  toast: ToastType;
  onDismiss: (id: string) => void;
}

interface ToastContainerProps {
  toasts: ToastType[];
  onDismiss: (id: string) => void;
  position?:
    | 'top-right'
    | 'top-left'
    | 'bottom-right'
    | 'bottom-left'
    | 'top-center'
    | 'bottom-center';
}

// ============================================================================
// ICON COMPONENTS
// ============================================================================

function SuccessIcon() {
  return (
    <svg className="w-5 h-5 text-green-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M5 13l4 4L19 7" />
    </svg>
  );
}

function ErrorIcon() {
  return (
    <svg className="w-5 h-5 text-red-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" />
    </svg>
  );
}

function InfoIcon() {
  return (
    <svg className="w-5 h-5 text-blue-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
      <path
        strokeLinecap="round"
        strokeLinejoin="round"
        strokeWidth={2}
        d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"
      />
    </svg>
  );
}

function WarningIcon() {
  return (
    <svg className="w-5 h-5 text-yellow-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
      <path
        strokeLinecap="round"
        strokeLinejoin="round"
        strokeWidth={2}
        d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"
      />
    </svg>
  );
}

function CloseIcon() {
  return (
    <svg className="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" />
    </svg>
  );
}

// ============================================================================
// HELPER FUNCTIONS
// ============================================================================

function getIcon(type: ToastVariant) {
  switch (type) {
    case 'success':
      return <SuccessIcon />;
    case 'error':
      return <ErrorIcon />;
    case 'warning':
      return <WarningIcon />;
    case 'info':
    default:
      return <InfoIcon />;
  }
}

function getStyles(type: ToastVariant): string {
  const baseStyles = 'border-l-4';

  switch (type) {
    case 'success':
      return `${baseStyles} border-green-500 bg-green-500/10`;
    case 'error':
      return `${baseStyles} border-red-500 bg-red-500/10`;
    case 'warning':
      return `${baseStyles} border-yellow-500 bg-yellow-500/10`;
    case 'info':
    default:
      return `${baseStyles} border-blue-500 bg-blue-500/10`;
  }
}

function getPositionStyles(position: ToastContainerProps['position']): string {
  switch (position) {
    case 'top-left':
      return 'top-4 left-4';
    case 'bottom-right':
      return 'bottom-4 right-4';
    case 'bottom-left':
      return 'bottom-4 left-4';
    case 'top-center':
      return 'top-4 left-1/2 -translate-x-1/2';
    case 'bottom-center':
      return 'bottom-4 left-1/2 -translate-x-1/2';
    case 'top-right':
    default:
      return 'top-4 right-4';
  }
}

// ============================================================================
// TOAST COMPONENT
// ============================================================================

export function Toast({ toast, onDismiss }: ToastProps) {
  const [isVisible, setIsVisible] = useState(false);
  const [isExiting, setIsExiting] = useState(false);

  // Animate in on mount
  useEffect(() => {
    const timer = setTimeout(() => setIsVisible(true), 10);
    return () => clearTimeout(timer);
  }, []);

  // Handle dismiss with animation
  const handleDismiss = () => {
    setIsExiting(true);
    setTimeout(() => onDismiss(toast.id), 150);
  };

  return (
    <div
      className={`
        flex items-start gap-3 p-4 rounded-lg shadow-lg backdrop-blur-sm
        bg-slate-800/95 border border-slate-700
        transform transition-all duration-150 ease-out
        ${getStyles(toast.type)}
        ${isVisible && !isExiting ? 'translate-x-0 opacity-100' : 'translate-x-4 opacity-0'}
      `}
      role="alert"
    >
      {/* Icon */}
      <div className="flex-shrink-0 mt-0.5">{getIcon(toast.type)}</div>

      {/* Message */}
      <div className="flex-1 min-w-0">
        <p className="text-sm text-white leading-relaxed">{toast.message}</p>
      </div>

      {/* Close button */}
      <button
        onClick={handleDismiss}
        className="flex-shrink-0 text-slate-400 hover:text-white transition-colors p-1 -m-1"
        aria-label="Dismiss"
      >
        <CloseIcon />
      </button>
    </div>
  );
}

// ============================================================================
// TOAST CONTAINER
// ============================================================================

export function ToastContainer({ toasts, onDismiss, position = 'top-right' }: ToastContainerProps) {
  if (toasts.length === 0) return null;

  return (
    <div
      className={`fixed z-[100] flex flex-col gap-2 max-w-sm w-full ${getPositionStyles(position)}`}
      aria-live="polite"
      aria-atomic="true"
    >
      {toasts.map((toast) => (
        <Toast key={toast.id} toast={toast} onDismiss={onDismiss} />
      ))}
    </div>
  );
}

export default ToastContainer;
</file>

<file path="src/app/login/page.tsx">
'use client';

import { useState } from 'react';
import { useRouter } from 'next/navigation';
import Link from 'next/link';
import { useAuth } from '@/contexts/AuthContext';
import ThemeToggle from '@/components/ThemeToggle';

export default function LoginPage() {
  const [email, setEmail] = useState('');
  const [password, setPassword] = useState('');
  const [showPassword, setShowPassword] = useState(false);
  const [error, setError] = useState('');
  const [loading, setLoading] = useState(false);
  const router = useRouter();
  const { signIn } = useAuth();

  const handleSubmit = async (e: React.FormEvent) => {
    e.preventDefault();
    setLoading(true);
    setError('');

    try {
      const { error } = await signIn(email, password);

      if (error) {
        setError(error.message || 'Failed to sign in');
      } else {
        router.push('/');
        router.refresh();
      }
    } catch (err) {
      setError('Something went wrong');
    } finally {
      setLoading(false);
    }
  };

  return (
    <div className="min-h-screen bg-gradient-to-br from-slate-100 via-blue-50 to-slate-100 dark:from-slate-900 dark:via-purple-900 dark:to-slate-900 flex items-center justify-center p-4 transition-colors duration-300">
      {/* Theme Toggle - Top Right */}
      <div className="absolute top-4 right-4">
        <ThemeToggle size="md" showDropdown={true} />
      </div>

      <div className="max-w-md w-full">
        <div className="bg-white/80 dark:bg-slate-800/50 backdrop-blur-xl rounded-2xl border border-slate-200 dark:border-white/10 p-8 shadow-2xl transition-colors duration-300">
          {/* Logo/Title */}
          <div className="text-center mb-8">
            <div className="text-6xl mb-4">ü§ñ</div>
            <h1 className="text-3xl font-bold text-slate-900 dark:text-white mb-2 transition-colors duration-300">
              AI App Builder
            </h1>
            <p className="text-slate-600 dark:text-slate-400 transition-colors duration-300">
              Sign in to your account
            </p>
          </div>

          {/* Login Form */}
          <form onSubmit={handleSubmit} className="space-y-6">
            <div>
              <label
                htmlFor="email"
                className="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2 transition-colors duration-300"
              >
                Email Address
              </label>
              <input
                id="email"
                type="email"
                value={email}
                onChange={(e) => setEmail(e.target.value)}
                placeholder="you@example.com"
                disabled={loading}
                required
                className="w-full px-4 py-3 rounded-xl bg-slate-100 dark:bg-slate-900/80 border border-slate-300 dark:border-white/10 text-slate-900 dark:text-white placeholder-slate-400 dark:placeholder-slate-500 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent disabled:opacity-50 transition-colors duration-300"
                autoFocus
              />
            </div>

            <div>
              <label
                htmlFor="password"
                className="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2 transition-colors duration-300"
              >
                Password
              </label>
              <div className="relative">
                <input
                  id="password"
                  type={showPassword ? 'text' : 'password'}
                  value={password}
                  onChange={(e) => setPassword(e.target.value)}
                  placeholder="Enter your password"
                  disabled={loading}
                  required
                  className="w-full px-4 py-3 pr-12 rounded-xl bg-slate-100 dark:bg-slate-900/80 border border-slate-300 dark:border-white/10 text-slate-900 dark:text-white placeholder-slate-400 dark:placeholder-slate-500 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent disabled:opacity-50 transition-colors duration-300"
                />
                <button
                  type="button"
                  onClick={() => setShowPassword(!showPassword)}
                  className="absolute right-3 top-1/2 -translate-y-1/2 text-slate-500 hover:text-slate-700 dark:text-slate-400 dark:hover:text-slate-200 transition-colors"
                  tabIndex={-1}
                >
                  {showPassword ? (
                    <svg
                      xmlns="http://www.w3.org/2000/svg"
                      fill="none"
                      viewBox="0 0 24 24"
                      strokeWidth={1.5}
                      stroke="currentColor"
                      className="w-5 h-5"
                    >
                      <path
                        strokeLinecap="round"
                        strokeLinejoin="round"
                        d="M3.98 8.223A10.477 10.477 0 001.934 12C3.226 16.338 7.244 19.5 12 19.5c.993 0 1.953-.138 2.863-.395M6.228 6.228A10.45 10.45 0 0112 4.5c4.756 0 8.773 3.162 10.065 7.498a10.523 10.523 0 01-4.293 5.774M6.228 6.228L3 3m3.228 3.228l3.65 3.65m7.894 7.894L21 21m-3.228-3.228l-3.65-3.65m0 0a3 3 0 10-4.243-4.243m4.242 4.242L9.88 9.88"
                      />
                    </svg>
                  ) : (
                    <svg
                      xmlns="http://www.w3.org/2000/svg"
                      fill="none"
                      viewBox="0 0 24 24"
                      strokeWidth={1.5}
                      stroke="currentColor"
                      className="w-5 h-5"
                    >
                      <path
                        strokeLinecap="round"
                        strokeLinejoin="round"
                        d="M2.036 12.322a1.012 1.012 0 010-.639C3.423 7.51 7.36 4.5 12 4.5c4.638 0 8.573 3.007 9.963 7.178.07.207.07.431 0 .639C20.577 16.49 16.64 19.5 12 19.5c-4.638 0-8.573-3.007-9.963-7.178z"
                      />
                      <path
                        strokeLinecap="round"
                        strokeLinejoin="round"
                        d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"
                      />
                    </svg>
                  )}
                </button>
              </div>
            </div>

            {error && (
              <div className="bg-red-500/10 border border-red-500/50 rounded-lg p-3 text-red-600 dark:text-red-400 text-sm transition-colors duration-300">
                {error}
              </div>
            )}

            <button
              type="submit"
              disabled={loading || !email || !password}
              className="w-full px-6 py-3 rounded-xl bg-gradient-to-r from-blue-600 to-purple-600 text-white font-medium hover:shadow-lg hover:shadow-blue-500/20 transition-all disabled:opacity-50 disabled:cursor-not-allowed"
            >
              {loading ? 'Signing in...' : 'Sign In'}
            </button>
          </form>

          {/* Sign Up Link */}
          <div className="mt-6 text-center">
            <p className="text-sm text-slate-600 dark:text-slate-400 transition-colors duration-300">
              Don&apos;t have an account?{' '}
              <Link
                href="/signup"
                className="text-blue-600 dark:text-blue-400 hover:text-blue-500 dark:hover:text-blue-300 font-medium transition-colors"
              >
                Sign up
              </Link>
            </p>
          </div>

          {/* Footer */}
          <div className="mt-6 text-center text-xs text-slate-500 dark:text-slate-500 transition-colors duration-300">
            üîí Secure authentication with Supabase
          </div>
        </div>
      </div>
    </div>
  );
}
</file>

<file path="src/components/ChatPanel.tsx">
'use client';

import React, { useRef, useEffect } from 'react';
import type { ChatMessage, StagePlan, Phase } from '../types/aiBuilderTypes';
import type { StreamingProgress as StreamingProgressType } from '../types/streaming';
import { InlineStreamingProgress } from './StreamingProgress';

// ============================================================================
// INTERNAL COMPONENTS
// ============================================================================

interface PhaseProgressCardProps {
  phases: Phase[];
  currentPhase: number;
  onBuildPhase?: (phase: Phase) => void;
}

const PhaseProgressCard: React.FC<PhaseProgressCardProps> = ({
  phases,
  currentPhase,
  onBuildPhase,
}) => (
  <div className="bg-gradient-to-br from-purple-500/20 to-blue-500/20 rounded-xl p-4 border border-purple-500/30 mb-4">
    <h3 className="text-white font-bold mb-3 flex items-center gap-2">
      <span>üèóÔ∏è</span> Build Plan ({phases.length} Phases)
    </h3>
    <div className="space-y-2">
      {phases.map((phase, idx) => (
        <div
          key={idx}
          className={`p-3 rounded-lg border transition-all ${
            phase.status === 'complete'
              ? 'bg-green-500/20 border-green-500/30'
              : phase.status === 'building'
                ? 'bg-blue-500/20 border-blue-500/30 animate-pulse'
                : 'bg-white/5 border-white/10 hover:bg-white/10'
          }`}
        >
          <div className="flex items-center justify-between">
            <span className="text-white font-medium text-sm">
              Phase {phase.number}: {phase.name}
            </span>
            <div className="flex items-center gap-2">
              {phase.status === 'pending' && idx === currentPhase && onBuildPhase && (
                <button
                  onClick={() => onBuildPhase(phase)}
                  className="px-3 py-1 rounded bg-blue-600 hover:bg-blue-700 text-white text-xs font-medium transition-all hover:scale-105"
                >
                  Build
                </button>
              )}
              {phase.status === 'complete' && <span className="text-green-400">‚úÖ</span>}
              {phase.status === 'building' && (
                <span className="text-blue-400 animate-spin">‚è≥</span>
              )}
              {phase.status === 'pending' && idx !== currentPhase && (
                <span className="text-slate-500">‚è∏Ô∏è</span>
              )}
            </div>
          </div>
          <p className="text-xs text-slate-400 mt-1">{phase.description}</p>
          {phase.features && phase.features.length > 0 && (
            <div className="mt-2 flex flex-wrap gap-1">
              {phase.features.slice(0, 3).map((feature, fIdx) => (
                <span key={fIdx} className="text-xs bg-white/10 px-2 py-0.5 rounded text-slate-300">
                  {feature.length > 25 ? feature.substring(0, 25) + '...' : feature}
                </span>
              ))}
              {phase.features.length > 3 && (
                <span className="text-xs text-slate-500">+{phase.features.length - 3} more</span>
              )}
            </div>
          )}
        </div>
      ))}
    </div>
  </div>
);

// ============================================================================
// MAIN COMPONENT
// ============================================================================

export interface ChatPanelProps {
  // Messages
  messages: ChatMessage[];

  // Generation state
  isGenerating: boolean;
  generationProgress: string;

  // Input state
  userInput: string;
  onUserInputChange: (value: string) => void;
  onSendMessage: () => void;

  // Image upload
  uploadedImage: string | null;
  onImageUpload: (e: React.ChangeEvent<HTMLInputElement>) => void;
  onRemoveImage: () => void;

  // Mode toggle
  currentMode: 'PLAN' | 'ACT';
  onModeChange: (mode: 'PLAN' | 'ACT') => void;

  // Phase progress (optional)
  stagePlan?: StagePlan | null;
  onBuildPhase?: (phase: Phase) => void;

  // View component action
  onViewComponent?: () => void;

  // Streaming progress (optional)
  streamingProgress?: StreamingProgressType;
  isStreamingActive?: boolean;
}

export const ChatPanel: React.FC<ChatPanelProps> = ({
  messages,
  isGenerating,
  generationProgress,
  userInput,
  onUserInputChange,
  onSendMessage,
  uploadedImage,
  onImageUpload,
  onRemoveImage,
  currentMode,
  onModeChange,
  stagePlan,
  onBuildPhase,
  onViewComponent,
  streamingProgress,
  isStreamingActive,
}) => {
  const chatContainerRef = useRef<HTMLDivElement>(null);
  const fileInputRef = useRef<HTMLInputElement>(null);

  // Auto-scroll to bottom when messages change or streaming progress updates
  useEffect(() => {
    if (chatContainerRef.current) {
      chatContainerRef.current.scrollTop = chatContainerRef.current.scrollHeight;
    }
  }, [messages, isGenerating, isStreamingActive, streamingProgress]);

  return (
    <div className="glass-panel rounded-2xl border border-white/10 overflow-hidden flex flex-col h-full shadow-2xl shadow-black/40">
      {/* Chat Header */}
      <div className="px-6 py-4 border-b border-white/10 bg-black/30 backdrop-blur-sm">
        <div className="flex items-center justify-between mb-3">
          <h2 className="text-lg font-semibold text-white flex items-center gap-2">
            <span>üí¨</span>
            <span>Conversation</span>
          </h2>

          {/* Plan/Act Mode Toggle */}
          <div className="flex gap-2 bg-slate-900/50 p-1 rounded-lg border border-white/10">
            <button
              onClick={() => onModeChange('PLAN')}
              className={`px-3 py-1.5 rounded-md text-xs font-medium transition-all ${
                currentMode === 'PLAN'
                  ? 'bg-purple-600 text-white shadow-lg'
                  : 'text-slate-400 hover:text-white hover:bg-white/5'
              }`}
              title="Plan Mode: AI discusses and explains (no code changes)"
            >
              üí≠ Plan
            </button>
            <button
              onClick={() => onModeChange('ACT')}
              className={`px-3 py-1.5 rounded-md text-xs font-medium transition-all ${
                currentMode === 'ACT'
                  ? 'bg-blue-600 text-white shadow-lg'
                  : 'text-slate-400 hover:text-white hover:bg-white/5'
              }`}
              title="Act Mode: AI can modify code"
            >
              ‚ö° Act
            </button>
          </div>
        </div>

        {/* Mode Description */}
        <p className="text-sm text-slate-400">
          {currentMode === 'PLAN'
            ? 'üí≠ Plan Mode: AI will discuss and explain (no code changes)'
            : '‚ö° Act Mode: AI can modify your app'}
        </p>
      </div>

      {/* Chat Messages */}
      <div ref={chatContainerRef} className="flex-1 min-h-0 overflow-y-auto p-6 space-y-4">
        {/* Phase Progress Display */}
        {stagePlan && stagePlan.phases && stagePlan.phases.length > 0 && (
          <PhaseProgressCard
            phases={stagePlan.phases}
            currentPhase={Math.max(0, stagePlan.currentPhase - 1)}
            onBuildPhase={onBuildPhase}
          />
        )}

        {messages.map((message) => (
          <div
            key={message.id}
            className={`flex ${message.role === 'user' ? 'justify-end' : 'justify-start'} animate-fade-in-up`}
          >
            <div
              className={`max-w-[80%] rounded-2xl px-4 py-3 shadow-lg transition-all duration-300 hover:shadow-2xl hover:scale-[1.02] ${
                message.role === 'user'
                  ? 'bg-gradient-to-br from-blue-600 to-blue-700 text-white shadow-blue-500/30 hover:shadow-blue-500/50'
                  : message.role === 'system'
                    ? 'glass-panel text-purple-200 border border-purple-500/40 shadow-purple-500/20 hover:shadow-purple-500/40 hover:border-purple-500/60'
                    : 'glass-panel text-slate-200 border border-white/20 hover:border-white/30'
              }`}
            >
              <p className="text-sm whitespace-pre-wrap">{message.content}</p>
              {message.componentPreview && onViewComponent && (
                <button
                  onClick={onViewComponent}
                  className="mt-3 text-xs px-3 py-1.5 rounded-lg bg-white/20 hover:bg-white/30 transition-all"
                >
                  üëÅÔ∏è View Component
                </button>
              )}
              <p className="text-xs opacity-50 mt-2" suppressHydrationWarning>
                {new Date(message.timestamp).toLocaleTimeString()}
              </p>
            </div>
          </div>
        ))}

        {/* Inline Streaming Progress */}
        {isStreamingActive && streamingProgress && (
          <div className="flex justify-start animate-fade-in-up">
            <div className="glass-panel text-slate-200 border border-white/20 rounded-2xl px-4 py-3 shadow-lg">
              <InlineStreamingProgress progress={streamingProgress} />
            </div>
          </div>
        )}

        {/* Non-streaming generation indicator */}
        {isGenerating && !isStreamingActive && (
          <div className="flex justify-start">
            <div className="bg-gradient-to-r from-blue-500/20 to-purple-500/20 rounded-2xl px-4 py-3 border border-blue-500/30">
              <div className="flex items-center gap-3">
                <div className="flex gap-1">
                  <div
                    className="w-2 h-2 bg-blue-500 rounded-full animate-bounce"
                    style={{ animationDelay: '0ms' }}
                  ></div>
                  <div
                    className="w-2 h-2 bg-blue-500 rounded-full animate-bounce"
                    style={{ animationDelay: '150ms' }}
                  ></div>
                  <div
                    className="w-2 h-2 bg-blue-500 rounded-full animate-bounce"
                    style={{ animationDelay: '300ms' }}
                  ></div>
                </div>
                <div>
                  <div className="text-sm font-medium text-white">Generating your app...</div>
                  {generationProgress && (
                    <div className="text-xs text-blue-200 mt-1">{generationProgress}</div>
                  )}
                </div>
              </div>
            </div>
          </div>
        )}
      </div>

      {/* Input Area */}
      <div className="p-4 border-t border-white/10 bg-black/20">
        {/* Image Preview */}
        {uploadedImage && (
          <div className="mb-3 relative inline-block">
            <img
              src={uploadedImage}
              alt="Uploaded inspiration"
              className="h-20 w-20 object-cover rounded-lg border-2 border-blue-500"
            />
            <button
              onClick={onRemoveImage}
              className="absolute -top-2 -right-2 bg-red-500 hover:bg-red-600 text-white rounded-full w-6 h-6 flex items-center justify-center text-xs font-bold"
            >
              ‚úï
            </button>
            <div className="text-xs text-slate-400 mt-1">
              üé® AI will use this for design inspiration
            </div>
          </div>
        )}

        <div className="flex gap-2">
          {/* Image Upload Button */}
          <label
            className="px-3 py-3 rounded-xl bg-slate-800 hover:bg-slate-700 border border-white/10 text-white cursor-pointer transition-all hover:scale-105 active:scale-95 flex items-center justify-center"
            title="Upload image for AI-inspired design"
          >
            <span className="text-xl">üñºÔ∏è</span>
            <input
              ref={fileInputRef}
              type="file"
              accept="image/*"
              onChange={onImageUpload}
              className="hidden"
              id="chat-panel-image-upload"
              name="chat-panel-image-upload"
            />
          </label>

          <input
            type="text"
            value={userInput}
            onChange={(e) => onUserInputChange(e.target.value)}
            onKeyPress={(e) => e.key === 'Enter' && onSendMessage()}
            placeholder="Describe what you want to build or change..."
            disabled={isGenerating}
            className="flex-1 px-4 py-3 rounded-xl glass-panel border border-white/20 text-white placeholder-slate-500 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500/60 disabled:opacity-50 transition-all duration-300 focus:shadow-xl focus:shadow-blue-500/30 focus:scale-[1.01] hover:border-white/30"
            id="chat-panel-user-message"
            name="chat-panel-user-message"
            autoComplete="off"
          />
          <button
            onClick={onSendMessage}
            disabled={isGenerating || (!userInput.trim() && !uploadedImage)}
            data-send-button="true"
            className="px-6 py-3 rounded-xl bg-gradient-to-r from-blue-600 via-purple-600 to-pink-600 text-white font-bold shadow-xl shadow-blue-500/40 hover:shadow-2xl hover:shadow-purple-500/50 transition-all duration-300 disabled:opacity-50 disabled:cursor-not-allowed hover:scale-110 active:scale-95 hover:from-blue-500 hover:via-purple-500 hover:to-pink-500 relative overflow-hidden group"
          >
            <span className="relative z-10">{isGenerating ? '‚è≥' : 'üöÄ'}</span>
            <div className="absolute inset-0 bg-gradient-to-r from-blue-400 via-purple-400 to-pink-400 opacity-0 group-hover:opacity-20 transition-opacity duration-300"></div>
          </button>
        </div>
      </div>
    </div>
  );
};

export default ChatPanel;
</file>

<file path="src/components/dev/ElementInspector/ElementInspector.tsx">
'use client';

/**
 * ElementInspector - Visual Element Inspector Dev Tool
 *
 * Allows developers to visually select elements, describe problems,
 * and generate Claude-ready prompts for assistance.
 *
 * Only renders in development mode or when NEXT_PUBLIC_DEV_TOOLS=true.
 */

import React from 'react';
import { useElementInspector } from '@/hooks/useElementInspector';
import { SHOW_DEV_TOOLS } from '@/utils/debug';
import { InspectorButton } from './InspectorButton';
import { InspectorOverlay } from './InspectorOverlay';
import { InspectorPanel } from './InspectorPanel';
import { PromptGeneratorModal } from './PromptGeneratorModal';

export function ElementInspector(): React.ReactElement | null {
  const inspector = useElementInspector();

  // Don't render if dev tools are disabled
  if (!SHOW_DEV_TOOLS) {
    return null;
  }

  return (
    <>
      {/* Toggle Button - positioned next to Debug button */}
      <InspectorButton
        isActive={inspector.isActive}
        onClick={inspector.toggleInspectMode}
        selectedCount={inspector.selectedElements.length}
      />

      {/* Overlay for hover/click detection */}
      {inspector.isActive && (
        <InspectorOverlay
          hoveredElement={inspector.hoveredElement}
          selectedElements={inspector.selectedElements}
          onHover={inspector.setHoveredElement}
          onSelect={inspector.toggleElementSelection}
        />
      )}

      {/* Side Panel with selection details and input */}
      {inspector.isActive && (
        <InspectorPanel
          selectedElements={inspector.selectedElements}
          problemDescription={inspector.problemDescription}
          desiredChange={inspector.desiredChange}
          onProblemDescriptionChange={inspector.setProblemDescription}
          onDesiredChangeChange={inspector.setDesiredChange}
          onRemoveElement={inspector.removeSelectedElement}
          onClearAll={inspector.clearAllSelections}
          onGeneratePrompt={inspector.generatePrompt}
          onClose={inspector.toggleInspectMode}
        />
      )}

      {/* Prompt Generation Modal */}
      <PromptGeneratorModal
        isOpen={inspector.isPromptModalOpen}
        prompt={inspector.generatedPrompt}
        onClose={() => inspector.setPromptModalOpen(false)}
        onCopy={inspector.copyPromptToClipboard}
      />
    </>
  );
}

export default ElementInspector;
</file>

<file path="src/components/ErrorBoundary.tsx">
'use client';

import React, { Component, ErrorInfo, ReactNode } from 'react';
import { useAppStore } from '@/store/useAppStore';
import { logger } from '@/utils/logger';

/**
 * Error Report structure for persisted errors
 */
export interface ErrorReport {
  id: string;
  timestamp: string;
  error: {
    name: string;
    message: string;
    stack?: string;
  };
  componentStack: string;
  storeSnapshot: {
    currentMode: string;
    isGenerating: boolean;
    messagesCount: number;
    componentsCount: number;
    hasAppConcept: boolean;
    hasPendingChange: boolean;
    activeTab: string;
  };
  url: string;
  userAgent: string;
}

interface Props {
  children: ReactNode;
  fallback?: ReactNode;
}

interface State {
  hasError: boolean;
  error: Error | null;
  errorInfo: ErrorInfo | null;
  report: ErrorReport | null;
}

const ERROR_STORAGE_KEY = 'error_reports';
const MAX_STORED_ERRORS = 10;

/**
 * Get stored error reports from localStorage
 */
export function getStoredErrorReports(): ErrorReport[] {
  if (typeof window === 'undefined') return [];

  try {
    const stored = localStorage.getItem(ERROR_STORAGE_KEY);
    return stored ? JSON.parse(stored) : [];
  } catch {
    return [];
  }
}

/**
 * Clear stored error reports
 */
export function clearStoredErrorReports(): void {
  if (typeof window === 'undefined') return;

  try {
    localStorage.removeItem(ERROR_STORAGE_KEY);
  } catch {
    // Ignore errors
  }
}

/**
 * Error Boundary component to catch JavaScript errors anywhere in the child
 * component tree, log those errors, and display a fallback UI.
 *
 * Enhanced with:
 * - Store state snapshot capture
 * - Error persistence to localStorage
 * - Structured logging integration
 *
 * This prevents the entire app from crashing when a component throws an error.
 */
class ErrorBoundary extends Component<Props, State> {
  constructor(props: Props) {
    super(props);
    this.state = {
      hasError: false,
      error: null,
      errorInfo: null,
      report: null,
    };
  }

  static getDerivedStateFromError(error: Error): Partial<State> {
    // Update state so the next render shows the fallback UI
    return { hasError: true, error };
  }

  componentDidCatch(error: Error, errorInfo: ErrorInfo): void {
    // Capture store state snapshot (wrapped in try-catch to prevent cascade failures)
    let storeSnapshot: ErrorReport['storeSnapshot'] = {
      currentMode: 'unknown',
      isGenerating: false,
      messagesCount: 0,
      componentsCount: 0,
      hasAppConcept: false,
      hasPendingChange: false,
      activeTab: 'preview',
    };

    try {
      const storeState = useAppStore.getState();
      storeSnapshot = {
        currentMode: storeState.currentMode || 'unknown',
        isGenerating: storeState.isGenerating || false,
        messagesCount: storeState.chatMessages?.length || 0,
        componentsCount: storeState.components?.length || 0,
        hasAppConcept: !!storeState.appConcept,
        hasPendingChange: !!storeState.pendingChange,
        activeTab: storeState.activeTab || 'preview',
      };
    } catch (storeError) {
      // Store access failed - use defaults and log the failure
      logger.warn('Failed to capture store state in ErrorBoundary', {
        storeError: storeError instanceof Error ? storeError.message : String(storeError),
      });
    }

    // Generate error report
    const report: ErrorReport = {
      id: `err_${Date.now()}_${Math.random().toString(36).slice(2, 6)}`,
      timestamp: new Date().toISOString(),
      error: {
        name: error.name,
        message: error.message,
        stack: error.stack,
      },
      componentStack: errorInfo.componentStack || '',
      storeSnapshot,
      url: typeof window !== 'undefined' ? window.location.href : '',
      userAgent: typeof navigator !== 'undefined' ? navigator.userAgent : '',
    };

    // Log with structured logger
    logger.error('React Error Boundary caught error', error, {
      reportId: report.id,
      componentStack: errorInfo.componentStack,
      storeSnapshot: report.storeSnapshot,
    });

    // Persist to localStorage
    this.persistError(report);

    // Update component state
    this.setState({
      error,
      errorInfo,
      report,
    });
  }

  /**
   * Persist error report to localStorage (keeps last N errors)
   */
  private persistError(report: ErrorReport): void {
    if (typeof window === 'undefined') return;

    try {
      const stored = getStoredErrorReports();
      stored.unshift(report);

      // Keep only the last N errors
      const trimmed = stored.slice(0, MAX_STORED_ERRORS);
      localStorage.setItem(ERROR_STORAGE_KEY, JSON.stringify(trimmed));
    } catch (err) {
      // localStorage might be full or unavailable
      logger.warn('Failed to persist error report', { error: err });
    }
  }

  handleReset = (): void => {
    this.setState({
      hasError: false,
      error: null,
      errorInfo: null,
      report: null,
    });
  };

  /**
   * Copy error details to clipboard
   */
  handleCopyError = (): void => {
    if (!this.state.report) return;

    const errorText = JSON.stringify(this.state.report, null, 2);

    navigator.clipboard.writeText(errorText).then(
      () => {
        // Could show a toast here
        logger.info('Error report copied to clipboard');
      },
      () => {
        logger.warn('Failed to copy error report to clipboard');
      }
    );
  };

  render(): ReactNode {
    if (this.state.hasError) {
      // If a custom fallback is provided, use it
      if (this.props.fallback) {
        return this.props.fallback;
      }

      const { error, errorInfo, report } = this.state;

      // Default fallback UI
      return (
        <div className="min-h-screen flex items-center justify-center bg-gradient-to-br from-slate-900 via-slate-800 to-slate-900 p-4">
          <div className="max-w-lg w-full bg-slate-800/50 border border-red-500/30 rounded-xl p-6 shadow-xl backdrop-blur-sm">
            <div className="flex items-center gap-3 mb-4">
              <div className="w-12 h-12 rounded-full bg-red-500/20 flex items-center justify-center text-2xl">
                ‚ö†Ô∏è
              </div>
              <div>
                <h2 className="text-xl font-bold text-red-400">Something went wrong</h2>
                <p className="text-sm text-slate-400">An unexpected error occurred</p>
              </div>
            </div>

            {error && (
              <div className="mb-4 p-3 bg-black/30 rounded-lg border border-red-500/20">
                <p className="text-sm font-mono text-red-300 break-words">{error.message}</p>
              </div>
            )}

            {/* Error ID for support reference */}
            {report && (
              <div className="mb-4 text-xs text-slate-500">
                Error ID: <code className="text-slate-400">{report.id}</code>
              </div>
            )}

            <div className="flex gap-3">
              <button
                onClick={this.handleReset}
                className="flex-1 px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg transition-colors font-medium"
              >
                Try Again
              </button>
              <button
                onClick={() => window.location.reload()}
                className="flex-1 px-4 py-2 bg-slate-700 hover:bg-slate-600 text-white rounded-lg transition-colors font-medium"
              >
                Reload Page
              </button>
            </div>

            {/* Copy error button */}
            <button
              onClick={this.handleCopyError}
              className="w-full mt-3 px-4 py-2 bg-slate-700/50 hover:bg-slate-700 text-slate-300 rounded-lg transition-colors text-sm"
            >
              Copy Error Details
            </button>

            {/* Development-only details */}
            {process.env.NODE_ENV === 'development' && (
              <>
                {/* Component Stack */}
                {errorInfo && (
                  <details className="mt-4">
                    <summary className="text-sm text-slate-400 cursor-pointer hover:text-slate-300">
                      Component Stack
                    </summary>
                    <pre className="mt-2 p-3 bg-black/30 rounded-lg text-xs text-slate-400 overflow-auto max-h-48">
                      {errorInfo.componentStack}
                    </pre>
                  </details>
                )}

                {/* Store Snapshot */}
                {report && (
                  <details className="mt-2">
                    <summary className="text-sm text-slate-400 cursor-pointer hover:text-slate-300">
                      App State Snapshot
                    </summary>
                    <pre className="mt-2 p-3 bg-black/30 rounded-lg text-xs text-slate-400 overflow-auto max-h-48">
                      {JSON.stringify(report.storeSnapshot, null, 2)}
                    </pre>
                  </details>
                )}

                {/* Full Error Stack */}
                {error?.stack && (
                  <details className="mt-2">
                    <summary className="text-sm text-slate-400 cursor-pointer hover:text-slate-300">
                      Error Stack Trace
                    </summary>
                    <pre className="mt-2 p-3 bg-black/30 rounded-lg text-xs text-slate-400 overflow-auto max-h-48">
                      {error.stack}
                    </pre>
                  </details>
                )}
              </>
            )}
          </div>
        </div>
      );
    }

    return this.props.children;
  }
}

export default ErrorBoundary;
</file>

<file path="src/components/SettingsPage.tsx">
'use client';

import React, { useState, useRef, useEffect, useCallback } from 'react';
import { useRouter } from 'next/navigation';
import { useSettings } from '@/hooks/useSettings';
import { useAuth } from '@/contexts/AuthContext';
import type {
  SettingsSection,
  SettingsPageProps,
  EditorTheme,
  PreviewSize,
  UIDensity,
} from '@/types/settings';

// Section navigation items
const SECTIONS: { id: SettingsSection; label: string; icon: string }[] = [
  { id: 'general', label: 'General', icon: '‚öôÔ∏è' },
  { id: 'editor', label: 'Editor', icon: 'üìù' },
  { id: 'ai', label: 'AI', icon: 'ü§ñ' },
  { id: 'preview', label: 'Preview', icon: 'üëÅÔ∏è' },
  { id: 'build', label: 'Build', icon: 'üî®' },
  { id: 'appearance', label: 'Appearance', icon: 'üé®' },
  { id: 'shortcuts', label: 'Shortcuts', icon: '‚å®Ô∏è' },
  { id: 'storage', label: 'Storage & Data', icon: 'üíæ' },
  { id: 'account', label: 'Account', icon: 'üë§' },
];

// Toggle Switch Component
function ToggleSwitch({
  enabled,
  onChange,
  label,
  description,
}: {
  enabled: boolean;
  onChange: (value: boolean) => void;
  label: string;
  description?: string;
}) {
  return (
    <div className="flex items-center justify-between py-3">
      <div className="flex-1">
        <label className="text-white font-medium">{label}</label>
        {description && <p className="text-sm text-slate-400 mt-0.5">{description}</p>}
      </div>
      <button
        type="button"
        role="switch"
        aria-checked={enabled}
        onClick={() => onChange(!enabled)}
        className={`
          relative inline-flex h-6 w-11 items-center rounded-full transition-colors
          ${enabled ? 'bg-blue-600' : 'bg-slate-600'}
        `}
      >
        <span
          className={`
            inline-block h-4 w-4 transform rounded-full bg-white transition-transform
            ${enabled ? 'translate-x-6' : 'translate-x-1'}
          `}
        />
      </button>
    </div>
  );
}

// Slider Component
function Slider({
  value,
  onChange,
  min,
  max,
  step,
  label,
  description,
  formatValue,
}: {
  value: number;
  onChange: (value: number) => void;
  min: number;
  max: number;
  step: number;
  label: string;
  description?: string;
  formatValue?: (value: number) => string;
}) {
  return (
    <div className="py-3">
      <div className="flex items-center justify-between mb-2">
        <div>
          <label className="text-white font-medium">{label}</label>
          {description && <p className="text-sm text-slate-400 mt-0.5">{description}</p>}
        </div>
        <span className="text-blue-400 font-mono text-sm">
          {formatValue ? formatValue(value) : value}
        </span>
      </div>
      <input
        type="range"
        min={min}
        max={max}
        step={step}
        value={value}
        onChange={(e) => onChange(Number(e.target.value))}
        className="w-full h-2 bg-slate-700 rounded-lg appearance-none cursor-pointer accent-blue-500"
      />
    </div>
  );
}

// Select Component
function Select<T extends string>({
  value,
  onChange,
  options,
  label,
  description,
}: {
  value: T;
  onChange: (value: T) => void;
  options: { value: T; label: string }[];
  label: string;
  description?: string;
}) {
  return (
    <div className="py-3">
      <div className="mb-2">
        <label className="text-white font-medium">{label}</label>
        {description && <p className="text-sm text-slate-400 mt-0.5">{description}</p>}
      </div>
      <select
        value={value}
        onChange={(e) => onChange(e.target.value as T)}
        className="w-full px-3 py-2 rounded-lg bg-slate-800 border border-white/10 text-white focus:outline-none focus:ring-2 focus:ring-blue-500"
      >
        {options.map((option) => (
          <option key={option.value} value={option.value}>
            {option.label}
          </option>
        ))}
      </select>
    </div>
  );
}

// Text Input Component
function TextInput({
  value,
  onChange,
  label,
  description,
  placeholder,
  type = 'text',
}: {
  value: string;
  onChange: (value: string) => void;
  label: string;
  description?: string;
  placeholder?: string;
  type?: 'text' | 'email' | 'password';
}) {
  return (
    <div className="py-3">
      <div className="mb-2">
        <label className="text-white font-medium">{label}</label>
        {description && <p className="text-sm text-slate-400 mt-0.5">{description}</p>}
      </div>
      <input
        type={type}
        value={value}
        onChange={(e) => onChange(e.target.value)}
        placeholder={placeholder}
        className="w-full px-3 py-2 rounded-lg bg-slate-800 border border-white/10 text-white placeholder-slate-500 focus:outline-none focus:ring-2 focus:ring-blue-500"
      />
    </div>
  );
}

// Textarea Component
function TextArea({
  value,
  onChange,
  label,
  description,
  placeholder,
  rows = 4,
}: {
  value: string;
  onChange: (value: string) => void;
  label: string;
  description?: string;
  placeholder?: string;
  rows?: number;
}) {
  return (
    <div className="py-3">
      <div className="mb-2">
        <label className="text-white font-medium">{label}</label>
        {description && <p className="text-sm text-slate-400 mt-0.5">{description}</p>}
      </div>
      <textarea
        value={value}
        onChange={(e) => onChange(e.target.value)}
        placeholder={placeholder}
        rows={rows}
        className="w-full px-3 py-2 rounded-lg bg-slate-800 border border-white/10 text-white placeholder-slate-500 focus:outline-none focus:ring-2 focus:ring-blue-500 resize-none"
      />
    </div>
  );
}

// Color Picker Component
function ColorPicker({
  value,
  onChange,
  label,
  description,
  presets,
}: {
  value: string;
  onChange: (value: string) => void;
  label: string;
  description?: string;
  presets?: string[];
}) {
  return (
    <div className="py-3">
      <div className="mb-2">
        <label className="text-white font-medium">{label}</label>
        {description && <p className="text-sm text-slate-400 mt-0.5">{description}</p>}
      </div>
      <div className="flex items-center gap-3">
        <input
          type="color"
          value={value}
          onChange={(e) => onChange(e.target.value)}
          className="w-10 h-10 rounded-lg cursor-pointer border-0 bg-transparent"
        />
        <input
          type="text"
          value={value}
          onChange={(e) => onChange(e.target.value)}
          className="flex-1 px-3 py-2 rounded-lg bg-slate-800 border border-white/10 text-white font-mono text-sm focus:outline-none focus:ring-2 focus:ring-blue-500"
        />
      </div>
      {presets && presets.length > 0 && (
        <div className="flex gap-2 mt-2">
          {presets.map((color) => (
            <button
              key={color}
              type="button"
              onClick={() => onChange(color)}
              className={`w-6 h-6 rounded-full border-2 transition-all ${
                value === color ? 'border-white scale-110' : 'border-transparent'
              }`}
              style={{ backgroundColor: color }}
              title={color}
            />
          ))}
        </div>
      )}
    </div>
  );
}

// Section Header Component
function SectionHeader({ title, description }: { title: string; description?: string }) {
  return (
    <div className="mb-6 pb-4 border-b border-white/10">
      <h2 className="text-xl font-bold text-white">{title}</h2>
      {description && <p className="text-sm text-slate-400 mt-1">{description}</p>}
    </div>
  );
}

// Settings Page Component
export function SettingsPage({ isOpen, onClose, initialSection = 'general' }: SettingsPageProps) {
  const {
    settings,
    updateGeneralSettings,
    updateEditorSettings,
    updateAISettings,
    updatePreviewSettings,
    updateBuildSettings,
    updateAppearanceSettings,
    updateShortcut,
    updateAccountSettings,
    resetSettings,
    resetSection,
    exportSettingsToJson,
    importSettingsFromJson,
    downloadSettingsFile,
  } = useSettings();

  const [activeSection, setActiveSection] = useState<SettingsSection>(initialSection);
  const [searchQuery, setSearchQuery] = useState('');
  const [importError, setImportError] = useState<string | null>(null);
  const fileInputRef = useRef<HTMLInputElement>(null);
  const modalRef = useRef<HTMLDivElement>(null);

  const router = useRouter();
  const { user, signOut } = useAuth();

  // Update active section when initialSection prop changes
  useEffect(() => {
    if (isOpen && initialSection) {
      setActiveSection(initialSection);
    }
  }, [isOpen, initialSection]);

  // Handle escape key to close
  useEffect(() => {
    const handleKeyDown = (e: KeyboardEvent) => {
      if (e.key === 'Escape' && isOpen) {
        onClose();
      }
    };
    document.addEventListener('keydown', handleKeyDown);
    return () => document.removeEventListener('keydown', handleKeyDown);
  }, [isOpen, onClose]);

  // Handle import file
  const handleImportFile = useCallback(
    (e: React.ChangeEvent<HTMLInputElement>) => {
      const file = e.target.files?.[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = (event) => {
        const content = event.target?.result as string;
        const success = importSettingsFromJson(content);
        if (!success) {
          setImportError('Failed to import settings. Invalid format.');
          setTimeout(() => setImportError(null), 3000);
        }
      };
      reader.onerror = () => {
        setImportError('Failed to read file.');
        setTimeout(() => setImportError(null), 3000);
      };
      reader.readAsText(file);

      // Reset file input
      if (fileInputRef.current) {
        fileInputRef.current.value = '';
      }
    },
    [importSettingsFromJson]
  );

  // Filter sections based on search
  const filteredSections = searchQuery
    ? SECTIONS.filter((s) => s.label.toLowerCase().includes(searchQuery.toLowerCase()))
    : SECTIONS;

  if (!isOpen) return null;

  // Render section content
  const renderSectionContent = () => {
    switch (activeSection) {
      case 'general':
        return (
          <div>
            <SectionHeader title="General Settings" description="Configure basic app preferences" />
            <TextInput
              value={settings.general.appName}
              onChange={(value) => updateGeneralSettings({ appName: value })}
              label="App Name"
              description="Customize the app branding name"
              placeholder="AI App Builder"
            />
            <Select
              value={settings.general.language}
              onChange={(value) => updateGeneralSettings({ language: value })}
              options={[
                { value: 'en', label: 'English' },
                { value: 'es', label: 'Spanish' },
                { value: 'fr', label: 'French' },
                { value: 'de', label: 'German' },
                { value: 'ja', label: 'Japanese' },
                { value: 'zh', label: 'Chinese' },
              ]}
              label="Language"
              description="Select your preferred language"
            />
            <Select
              value={settings.general.dateFormat}
              onChange={(value) => updateGeneralSettings({ dateFormat: value })}
              options={[
                { value: 'MM/DD/YYYY', label: 'MM/DD/YYYY' },
                { value: 'DD/MM/YYYY', label: 'DD/MM/YYYY' },
                { value: 'YYYY-MM-DD', label: 'YYYY-MM-DD' },
              ]}
              label="Date Format"
            />
            <Select
              value={settings.general.timeFormat}
              onChange={(value) => updateGeneralSettings({ timeFormat: value })}
              options={[
                { value: '12h', label: '12-hour (AM/PM)' },
                { value: '24h', label: '24-hour' },
              ]}
              label="Time Format"
            />
            <TextInput
              value={settings.general.timezone}
              onChange={(value) => updateGeneralSettings({ timezone: value })}
              label="Timezone"
              description="Your local timezone"
            />
          </div>
        );

      case 'editor':
        return (
          <div>
            <SectionHeader
              title="Editor Settings"
              description="Customize your code editing experience"
            />
            <Select<EditorTheme>
              value={settings.editor.theme}
              onChange={(value) => updateEditorSettings({ theme: value })}
              options={[
                { value: 'vs-dark', label: 'VS Code Dark' },
                { value: 'vs-light', label: 'VS Code Light' },
                { value: 'monokai', label: 'Monokai' },
                { value: 'github-dark', label: 'GitHub Dark' },
                { value: 'github-light', label: 'GitHub Light' },
              ]}
              label="Editor Theme"
              description="Choose your preferred code theme"
            />
            <Slider
              value={settings.editor.fontSize}
              onChange={(value) => updateEditorSettings({ fontSize: value })}
              min={10}
              max={24}
              step={1}
              label="Font Size"
              formatValue={(v) => `${v}px`}
            />
            <TextInput
              value={settings.editor.fontFamily}
              onChange={(value) => updateEditorSettings({ fontFamily: value })}
              label="Font Family"
              placeholder="Fira Code, monospace"
            />
            <Select<string>
              value={String(settings.editor.tabSize)}
              onChange={(value) => {
                const numValue = Number(value);
                // Validate that the value is a valid TabSize (2 or 4)
                if (numValue === 2 || numValue === 4) {
                  updateEditorSettings({ tabSize: numValue });
                }
              }}
              options={[
                { value: '2', label: '2 spaces' },
                { value: '4', label: '4 spaces' },
              ]}
              label="Tab Size"
            />
            <ToggleSwitch
              enabled={settings.editor.lineWrapping}
              onChange={(value) => updateEditorSettings({ lineWrapping: value })}
              label="Line Wrapping"
              description="Wrap long lines to fit the viewport"
            />
            <ToggleSwitch
              enabled={settings.editor.minimap}
              onChange={(value) => updateEditorSettings({ minimap: value })}
              label="Show Minimap"
              description="Display code overview on the side"
            />
            <Slider
              value={settings.editor.autoSaveInterval}
              onChange={(value) => updateEditorSettings({ autoSaveInterval: value })}
              min={0}
              max={120}
              step={5}
              label="Auto-save Interval"
              description="Set to 0 to disable auto-save"
              formatValue={(v) => (v === 0 ? 'Disabled' : `${v}s`)}
            />
          </div>
        );

      case 'ai':
        return (
          <div>
            <SectionHeader title="AI Settings" description="Configure AI model behavior" />
            <Select
              value={settings.ai.defaultModel}
              onChange={(value) => updateAISettings({ defaultModel: value })}
              options={[
                { value: 'gpt-4', label: 'GPT-4' },
                { value: 'gpt-4-turbo', label: 'GPT-4 Turbo' },
                { value: 'gpt-3.5-turbo', label: 'GPT-3.5 Turbo' },
                { value: 'claude-3-opus', label: 'Claude 3 Opus' },
                { value: 'claude-3-sonnet', label: 'Claude 3 Sonnet' },
              ]}
              label="Default AI Model"
              description="Select the default model for code generation"
            />
            <Slider
              value={settings.ai.temperature}
              onChange={(value) => updateAISettings({ temperature: value })}
              min={0}
              max={2}
              step={0.1}
              label="Temperature (Creativity)"
              description="Higher values make output more random"
              formatValue={(v) => v.toFixed(1)}
            />
            <Slider
              value={settings.ai.maxTokens}
              onChange={(value) => updateAISettings({ maxTokens: value })}
              min={1024}
              max={16384}
              step={512}
              label="Max Tokens"
              description="Maximum response length"
              formatValue={(v) => v.toLocaleString()}
            />
            <TextArea
              value={settings.ai.systemPrompt}
              onChange={(value) => updateAISettings({ systemPrompt: value })}
              label="Custom System Prompt"
              description="Override the default system instructions (leave empty for default)"
              placeholder="Enter custom instructions for the AI..."
              rows={4}
            />
            <Select
              value={settings.ai.responseFormat}
              onChange={(value) => updateAISettings({ responseFormat: value })}
              options={[
                { value: 'markdown', label: 'Markdown' },
                { value: 'plain', label: 'Plain Text' },
                { value: 'code', label: 'Code Only' },
              ]}
              label="Response Format"
            />
          </div>
        );

      case 'preview':
        return (
          <div>
            <SectionHeader
              title="Preview Settings"
              description="Configure the live preview panel"
            />
            <Select<PreviewSize>
              value={settings.preview.defaultSize}
              onChange={(value) => updatePreviewSettings({ defaultSize: value })}
              options={[
                { value: 'mobile', label: 'Mobile (375px)' },
                { value: 'tablet', label: 'Tablet (768px)' },
                { value: 'desktop', label: 'Desktop (100%)' },
              ]}
              label="Default Preview Size"
              description="Initial viewport size for previews"
            />
            <ToggleSwitch
              enabled={settings.preview.autoRefresh}
              onChange={(value) => updatePreviewSettings({ autoRefresh: value })}
              label="Auto-refresh Preview"
              description="Automatically update preview on code changes"
            />
            <ColorPicker
              value={settings.preview.backgroundColor}
              onChange={(value) => updatePreviewSettings({ backgroundColor: value })}
              label="Background Color"
              description="Preview panel background"
              presets={['#1a1a2e', '#0f0f1a', '#1e293b', '#18181b', '#ffffff']}
            />
            <ToggleSwitch
              enabled={settings.preview.showGrid}
              onChange={(value) => updatePreviewSettings({ showGrid: value })}
              label="Show Grid Overlay"
              description="Display alignment grid on preview"
            />
            <ToggleSwitch
              enabled={settings.preview.showConsole}
              onChange={(value) => updatePreviewSettings({ showConsole: value })}
              label="Show Console"
              description="Display console output below preview"
            />
          </div>
        );

      case 'build':
        return (
          <div>
            <SectionHeader
              title="Build Settings"
              description="Configure build and compilation options"
            />
            <ToggleSwitch
              enabled={settings.build.autoValidation}
              onChange={(value) => updateBuildSettings({ autoValidation: value })}
              label="Auto-validation"
              description="Automatically validate code before building"
            />
            <Select
              value={settings.build.optimizationLevel}
              onChange={(value) => updateBuildSettings({ optimizationLevel: value })}
              options={[
                { value: 'none', label: 'None (fastest builds)' },
                { value: 'basic', label: 'Basic (recommended)' },
                { value: 'advanced', label: 'Advanced (smallest output)' },
              ]}
              label="Optimization Level"
              description="Balance between build speed and output size"
            />
            <ToggleSwitch
              enabled={settings.build.generateSourceMaps}
              onChange={(value) => updateBuildSettings({ generateSourceMaps: value })}
              label="Generate Source Maps"
              description="Include source maps for debugging"
            />
            <ToggleSwitch
              enabled={settings.build.minify}
              onChange={(value) => updateBuildSettings({ minify: value })}
              label="Minify Output"
              description="Compress and minify generated code"
            />
          </div>
        );

      case 'appearance':
        return (
          <div>
            <SectionHeader title="Appearance Settings" description="Customize the look and feel" />
            <Select
              value={settings.appearance.theme}
              onChange={(value) => updateAppearanceSettings({ theme: value })}
              options={[
                { value: 'light', label: 'Light' },
                { value: 'dark', label: 'Dark' },
                { value: 'system', label: 'System (auto)' },
              ]}
              label="Theme"
              description="Choose light, dark, or follow system preference"
            />
            <ColorPicker
              value={settings.appearance.accentColor}
              onChange={(value) => updateAppearanceSettings({ accentColor: value })}
              label="Accent Color"
              description="Primary color for buttons and highlights"
              presets={['#3B82F6', '#6366F1', '#8B5CF6', '#EC4899', '#10B981', '#F59E0B']}
            />
            <Select<UIDensity>
              value={settings.appearance.uiDensity}
              onChange={(value) => updateAppearanceSettings({ uiDensity: value })}
              options={[
                { value: 'compact', label: 'Compact' },
                { value: 'comfortable', label: 'Comfortable' },
                { value: 'spacious', label: 'Spacious' },
              ]}
              label="UI Density"
              description="Control spacing and padding in the interface"
            />
          </div>
        );

      case 'shortcuts':
        return (
          <div>
            <SectionHeader
              title="Keyboard Shortcuts"
              description="View and customize key bindings"
            />
            <div className="space-y-3">
              {settings.shortcuts.map((shortcut) => (
                <div
                  key={shortcut.id}
                  className="flex items-center justify-between p-3 rounded-lg bg-slate-800/50 border border-white/5"
                >
                  <div>
                    <div className="text-white font-medium">{shortcut.name}</div>
                    <div className="text-sm text-slate-400">{shortcut.description}</div>
                  </div>
                  <div className="flex items-center gap-2">
                    <span className="px-3 py-1.5 rounded-lg bg-slate-700 text-white font-mono text-sm">
                      {shortcut.keys}
                    </span>
                  </div>
                </div>
              ))}
            </div>
            <div className="mt-6 p-4 rounded-lg bg-blue-500/10 border border-blue-500/20">
              <div className="flex items-start gap-3">
                <span className="text-xl">üí°</span>
                <p className="text-sm text-slate-300">
                  Custom shortcut editing coming soon. For now, these are the default shortcuts.
                </p>
              </div>
            </div>
          </div>
        );

      case 'storage':
        return (
          <div>
            <SectionHeader
              title="Storage & Data"
              description="Manage local storage and settings data"
            />

            {/* Export/Import Section */}
            <div className="py-4">
              <h3 className="text-white font-medium mb-3">Export & Import Settings</h3>
              <div className="flex gap-3">
                <button
                  type="button"
                  onClick={downloadSettingsFile}
                  className="px-4 py-2 rounded-lg bg-blue-600 hover:bg-blue-700 text-white font-medium transition-all flex items-center gap-2"
                >
                  <span>üì•</span> Export Settings
                </button>
                <label className="px-4 py-2 rounded-lg bg-slate-700 hover:bg-slate-600 text-white font-medium transition-all cursor-pointer flex items-center gap-2">
                  <span>üì§</span> Import Settings
                  <input
                    ref={fileInputRef}
                    type="file"
                    accept=".json"
                    onChange={handleImportFile}
                    className="hidden"
                  />
                </label>
              </div>
              {importError && <p className="mt-2 text-sm text-red-400">{importError}</p>}
            </div>

            {/* Reset Sections */}
            <div className="py-4 border-t border-white/10">
              <h3 className="text-white font-medium mb-3">Reset Individual Sections</h3>
              <div className="flex flex-wrap gap-2">
                {SECTIONS.filter((s) => s.id !== 'storage').map((section) => (
                  <button
                    key={section.id}
                    type="button"
                    onClick={() => {
                      if (window.confirm(`Reset ${section.label} settings to defaults?`)) {
                        resetSection(section.id);
                      }
                    }}
                    className="px-3 py-1.5 rounded-lg bg-slate-800 hover:bg-slate-700 text-slate-300 text-sm transition-all"
                  >
                    {section.icon} {section.label}
                  </button>
                ))}
              </div>
            </div>

            {/* Danger Zone */}
            <div className="py-4 border-t border-white/10">
              <h3 className="text-red-400 font-medium mb-3">Danger Zone</h3>
              <button
                type="button"
                onClick={() => {
                  if (
                    window.confirm(
                      'Are you sure you want to reset ALL settings to defaults? This cannot be undone.'
                    )
                  ) {
                    resetSettings();
                  }
                }}
                className="px-4 py-2 rounded-lg bg-red-600/20 hover:bg-red-600/30 border border-red-500/30 text-red-400 font-medium transition-all flex items-center gap-2"
              >
                <span>‚ö†Ô∏è</span> Reset All Settings
              </button>
            </div>

            {/* Storage Info */}
            <div className="py-4 border-t border-white/10">
              <h3 className="text-white font-medium mb-3">Storage Information</h3>
              <div className="p-3 rounded-lg bg-slate-800/50 border border-white/5">
                <div className="flex justify-between text-sm">
                  <span className="text-slate-400">Last Updated</span>
                  <span className="text-white">
                    {new Date(settings.lastUpdated).toLocaleString()}
                  </span>
                </div>
                <div className="flex justify-between text-sm mt-2">
                  <span className="text-slate-400">Settings Version</span>
                  <span className="text-white">{settings.version}</span>
                </div>
              </div>
            </div>
          </div>
        );

      case 'account':
        return (
          <div>
            <SectionHeader
              title="Account Settings"
              description="Manage your account and API configuration"
            />

            {/* User Info & Logout */}
            <div className="py-4">
              <h3 className="text-white font-medium mb-3">User</h3>
              <div className="p-4 rounded-lg bg-slate-800/50 border border-white/5">
                <div className="flex items-center justify-between">
                  <div>
                    <span className="text-slate-400 text-sm">Signed in as</span>
                    <p className="text-white font-medium">{user?.email || 'Unknown'}</p>
                  </div>
                  <button
                    type="button"
                    onClick={async () => {
                      await signOut();
                      onClose();
                      router.push('/login');
                    }}
                    className="px-4 py-2 rounded-lg bg-red-600/20 hover:bg-red-600/30 border border-red-500/30 text-red-400 font-medium transition-all flex items-center gap-2"
                  >
                    <span>üö™</span> Log Out
                  </button>
                </div>
              </div>
            </div>

            <div className="py-4 border-t border-white/10">
              <h3 className="text-white font-medium mb-3">API Configuration</h3>
              <div className="p-4 rounded-lg bg-slate-800/50 border border-white/5">
                <div className="flex items-center justify-between mb-3">
                  <span className="text-slate-300">API Key Status</span>
                  <span
                    className={`px-2 py-1 rounded text-xs font-medium ${
                      settings.account.apiKeyConfigured
                        ? 'bg-green-500/20 text-green-400'
                        : 'bg-yellow-500/20 text-yellow-400'
                    }`}
                  >
                    {settings.account.apiKeyConfigured ? 'Configured' : 'Not Configured'}
                  </span>
                </div>
                <p className="text-sm text-slate-400">
                  API keys are managed through environment variables for security.
                </p>
              </div>
            </div>
            <ToggleSwitch
              enabled={settings.account.showUsageStats}
              onChange={(value) => updateAccountSettings({ showUsageStats: value })}
              label="Show Usage Statistics"
              description="Display API usage and token counts"
            />
          </div>
        );

      default:
        return null;
    }
  };

  return (
    <div
      className="fixed inset-0 bg-black/60 backdrop-blur-sm z-50 flex items-center justify-center p-4"
      onClick={onClose}
    >
      <div
        ref={modalRef}
        className="bg-slate-900 rounded-2xl border border-white/10 w-full max-w-4xl max-h-[85vh] overflow-hidden flex flex-col shadow-2xl"
        onClick={(e) => e.stopPropagation()}
      >
        {/* Header */}
        <div className="px-6 py-4 border-b border-white/10 bg-black/20">
          <div className="flex items-center justify-between">
            <div className="flex items-center gap-3">
              <div className="w-10 h-10 rounded-xl bg-blue-500/20 flex items-center justify-center">
                <span className="text-2xl">‚öôÔ∏è</span>
              </div>
              <div>
                <h2 className="text-xl font-bold text-white">Settings</h2>
                <p className="text-sm text-slate-400">Configure your app preferences</p>
              </div>
            </div>
            <button
              type="button"
              onClick={onClose}
              className="p-2 rounded-lg hover:bg-white/10 transition-all"
              aria-label="Close settings"
            >
              <span className="text-slate-400 text-xl">‚úï</span>
            </button>
          </div>

          {/* Search */}
          <div className="mt-4">
            <input
              type="text"
              value={searchQuery}
              onChange={(e) => setSearchQuery(e.target.value)}
              placeholder="Search settings..."
              className="w-full px-4 py-2 rounded-lg bg-slate-800 border border-white/10 text-white placeholder-slate-500 focus:outline-none focus:ring-2 focus:ring-blue-500"
            />
          </div>
        </div>

        {/* Content */}
        <div className="flex flex-1 overflow-hidden">
          {/* Sidebar */}
          <nav className="w-48 border-r border-white/10 bg-black/10 overflow-y-auto">
            <div className="p-2">
              {filteredSections.map((section) => (
                <button
                  key={section.id}
                  type="button"
                  onClick={() => setActiveSection(section.id)}
                  className={`
                    w-full px-3 py-2.5 rounded-lg text-left flex items-center gap-3 transition-all
                    ${
                      activeSection === section.id
                        ? 'bg-blue-600/20 text-blue-400 border border-blue-500/30'
                        : 'text-slate-400 hover:text-white hover:bg-white/5'
                    }
                  `}
                >
                  <span>{section.icon}</span>
                  <span className="text-sm font-medium">{section.label}</span>
                </button>
              ))}
            </div>
          </nav>

          {/* Main Content */}
          <div className="flex-1 min-h-0 overflow-y-auto p-6">{renderSectionContent()}</div>
        </div>
      </div>
    </div>
  );
}

export default SettingsPage;
</file>

<file path="src/components/VersionHistoryPanel.tsx">
'use client';

/**
 * VersionHistoryPanel Component
 *
 * Displays version history of layout designs with ability to:
 * - View list of saved versions with timestamps
 * - Compare current design with a previous version
 * - Restore a previous version
 * - Delete versions from history
 */

import React, { useState, useMemo } from 'react';
import type { DesignVersion } from '@/hooks/useLayoutBuilder';
import type { LayoutDesign } from '@/types/layoutDesign';

// ============================================================================
// TYPES
// ============================================================================

interface VersionHistoryPanelProps {
  versions: DesignVersion[];
  currentVersionId: string | null;
  currentDesign: Partial<LayoutDesign>;
  onRestore: (versionId: string) => void;
  onDelete: (versionId: string) => void;
  onClose: () => void;
}

// ============================================================================
// HELPER FUNCTIONS
// ============================================================================

/**
 * Format relative time (e.g., "2 hours ago", "Just now")
 */
function formatRelativeTime(dateString: string): string {
  const date = new Date(dateString);
  const now = new Date();
  const diffMs = now.getTime() - date.getTime();
  const diffSecs = Math.floor(diffMs / 1000);
  const diffMins = Math.floor(diffSecs / 60);
  const diffHours = Math.floor(diffMins / 60);
  const diffDays = Math.floor(diffHours / 24);

  if (diffSecs < 60) return 'Just now';
  if (diffMins < 60) return `${diffMins} minute${diffMins > 1 ? 's' : ''} ago`;
  if (diffHours < 24) return `${diffHours} hour${diffHours > 1 ? 's' : ''} ago`;
  if (diffDays < 7) return `${diffDays} day${diffDays > 1 ? 's' : ''} ago`;

  return date.toLocaleDateString('en-US', {
    month: 'short',
    day: 'numeric',
    year: date.getFullYear() !== now.getFullYear() ? 'numeric' : undefined,
  });
}

/**
 * Get trigger icon
 */
function getTriggerIcon(trigger: 'save' | 'apply' | 'manual'): string {
  switch (trigger) {
    case 'save':
      return 'M8 7H5a2 2 0 00-2 2v9a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-3m-1 4l-3 3m0 0l-3-3m3 3V4';
    case 'apply':
      return 'M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z';
    case 'manual':
      return 'M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z';
    default:
      return 'M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z';
  }
}

/**
 * Get trigger label
 */
function getTriggerLabel(trigger: 'save' | 'apply' | 'manual'): string {
  switch (trigger) {
    case 'save':
      return 'Saved';
    case 'apply':
      return 'Applied';
    case 'manual':
      return 'Snapshot';
    default:
      return 'Unknown';
  }
}

/**
 * Compare two designs and return list of differences
 */
function compareDesigns(current: Partial<LayoutDesign>, previous: Partial<LayoutDesign>): string[] {
  const differences: string[] = [];

  // Compare base preferences
  if (current.basePreferences?.style !== previous.basePreferences?.style) {
    differences.push(
      `Style: ${previous.basePreferences?.style} ‚Üí ${current.basePreferences?.style}`
    );
  }
  if (current.basePreferences?.colorScheme !== previous.basePreferences?.colorScheme) {
    differences.push(
      `Color Scheme: ${previous.basePreferences?.colorScheme} ‚Üí ${current.basePreferences?.colorScheme}`
    );
  }
  if (current.basePreferences?.layout !== previous.basePreferences?.layout) {
    differences.push(
      `Layout: ${previous.basePreferences?.layout} ‚Üí ${current.basePreferences?.layout}`
    );
  }

  // Compare colors
  if (current.globalStyles?.colors?.primary !== previous.globalStyles?.colors?.primary) {
    differences.push(`Primary Color changed`);
  }
  if (current.globalStyles?.colors?.secondary !== previous.globalStyles?.colors?.secondary) {
    differences.push(`Secondary Color changed`);
  }

  // Compare typography
  if (
    current.globalStyles?.typography?.fontFamily !== previous.globalStyles?.typography?.fontFamily
  ) {
    differences.push(
      `Font: ${previous.globalStyles?.typography?.fontFamily} ‚Üí ${current.globalStyles?.typography?.fontFamily}`
    );
  }

  // Compare effects
  if (
    current.globalStyles?.effects?.borderRadius !== previous.globalStyles?.effects?.borderRadius
  ) {
    differences.push(
      `Border Radius: ${previous.globalStyles?.effects?.borderRadius} ‚Üí ${current.globalStyles?.effects?.borderRadius}`
    );
  }
  if (current.globalStyles?.effects?.shadows !== previous.globalStyles?.effects?.shadows) {
    differences.push(
      `Shadows: ${previous.globalStyles?.effects?.shadows} ‚Üí ${current.globalStyles?.effects?.shadows}`
    );
  }

  // Compare structure
  if (current.structure?.hasHeader !== previous.structure?.hasHeader) {
    differences.push(
      `Header: ${previous.structure?.hasHeader ? 'visible' : 'hidden'} ‚Üí ${current.structure?.hasHeader ? 'visible' : 'hidden'}`
    );
  }
  if (current.structure?.hasSidebar !== previous.structure?.hasSidebar) {
    differences.push(
      `Sidebar: ${previous.structure?.hasSidebar ? 'visible' : 'hidden'} ‚Üí ${current.structure?.hasSidebar ? 'visible' : 'hidden'}`
    );
  }
  if (current.structure?.hasFooter !== previous.structure?.hasFooter) {
    differences.push(
      `Footer: ${previous.structure?.hasFooter ? 'visible' : 'hidden'} ‚Üí ${current.structure?.hasFooter ? 'visible' : 'hidden'}`
    );
  }

  return differences.length > 0 ? differences : ['No significant changes detected'];
}

// ============================================================================
// SUB-COMPONENTS
// ============================================================================

/**
 * Version list item
 */
function VersionItem({
  version,
  isCurrentVersion,
  isSelected,
  onSelect,
  onRestore,
  onDelete,
}: {
  version: DesignVersion;
  isCurrentVersion: boolean;
  isSelected: boolean;
  onSelect: () => void;
  onRestore: () => void;
  onDelete: () => void;
}) {
  return (
    <button
      type="button"
      onClick={onSelect}
      className={`w-full text-left p-3 rounded-lg border transition-all ${
        isSelected
          ? 'bg-blue-600/20 border-blue-500'
          : 'bg-slate-800/50 border-slate-700 hover:bg-slate-700/50 hover:border-slate-600'
      }`}
    >
      <div className="flex items-start justify-between gap-2">
        <div className="flex-1 min-w-0">
          <div className="flex items-center gap-2">
            <svg
              className="w-4 h-4 text-slate-400 flex-shrink-0"
              fill="none"
              viewBox="0 0 24 24"
              stroke="currentColor"
            >
              <path
                strokeLinecap="round"
                strokeLinejoin="round"
                strokeWidth={2}
                d={getTriggerIcon(version.trigger)}
              />
            </svg>
            <span className="font-medium text-sm text-white truncate">{version.name}</span>
            {isCurrentVersion && (
              <span className="px-1.5 py-0.5 text-[10px] font-medium bg-green-600/20 text-green-400 rounded">
                CURRENT
              </span>
            )}
          </div>
          <div className="flex items-center gap-2 mt-1 text-xs text-slate-400">
            <span>{formatRelativeTime(version.savedAt)}</span>
            <span>‚Ä¢</span>
            <span>{getTriggerLabel(version.trigger)}</span>
          </div>
          {version.description && (
            <p className="mt-1 text-xs text-slate-500 truncate">{version.description}</p>
          )}
        </div>
        <div className="flex items-center gap-1 flex-shrink-0">
          {!isCurrentVersion && (
            <button
              type="button"
              onClick={(e) => {
                e.stopPropagation();
                onRestore();
              }}
              className="p-1.5 text-slate-400 hover:text-blue-400 hover:bg-blue-400/10 rounded transition-colors"
              title="Restore this version"
            >
              <svg className="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path
                  strokeLinecap="round"
                  strokeLinejoin="round"
                  strokeWidth={2}
                  d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"
                />
              </svg>
            </button>
          )}
          <button
            type="button"
            onClick={(e) => {
              e.stopPropagation();
              onDelete();
            }}
            className="p-1.5 text-slate-400 hover:text-red-400 hover:bg-red-400/10 rounded transition-colors"
            title="Delete this version"
          >
            <svg className="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path
                strokeLinecap="round"
                strokeLinejoin="round"
                strokeWidth={2}
                d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"
              />
            </svg>
          </button>
        </div>
      </div>
    </button>
  );
}

/**
 * Comparison view
 */
function ComparisonView({
  currentDesign,
  selectedVersion,
}: {
  currentDesign: Partial<LayoutDesign>;
  selectedVersion: DesignVersion;
}) {
  const differences = useMemo(
    () => compareDesigns(currentDesign, selectedVersion.design),
    [currentDesign, selectedVersion.design]
  );

  return (
    <div className="border-t border-slate-700 pt-4 mt-4">
      <h4 className="text-xs font-medium text-slate-300 mb-2 flex items-center gap-2">
        <svg className="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path
            strokeLinecap="round"
            strokeLinejoin="round"
            strokeWidth={2}
            d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"
          />
        </svg>
        Changes from &ldquo;{selectedVersion.name}&rdquo;
      </h4>
      <div className="space-y-1">
        {differences.map((diff, index) => (
          <div
            key={index}
            className="flex items-center gap-2 text-xs text-slate-400 bg-slate-800/50 px-2 py-1.5 rounded"
          >
            <svg
              className="w-3 h-3 text-blue-400 flex-shrink-0"
              fill="none"
              viewBox="0 0 24 24"
              stroke="currentColor"
            >
              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 5l7 7-7 7" />
            </svg>
            <span>{diff}</span>
          </div>
        ))}
      </div>
    </div>
  );
}

// ============================================================================
// MAIN COMPONENT
// ============================================================================

export function VersionHistoryPanel({
  versions,
  currentVersionId,
  currentDesign,
  onRestore,
  onDelete,
  onClose,
}: VersionHistoryPanelProps) {
  const [selectedVersionId, setSelectedVersionId] = useState<string | null>(null);
  const [confirmDelete, setConfirmDelete] = useState<string | null>(null);

  const selectedVersion = useMemo(
    () => versions.find((v) => v.id === selectedVersionId),
    [versions, selectedVersionId]
  );

  const handleDelete = (versionId: string) => {
    if (confirmDelete === versionId) {
      onDelete(versionId);
      setConfirmDelete(null);
      if (selectedVersionId === versionId) {
        setSelectedVersionId(null);
      }
    } else {
      setConfirmDelete(versionId);
      // Auto-clear confirmation after 3 seconds
      setTimeout(() => setConfirmDelete(null), 3000);
    }
  };

  return (
    <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/50 backdrop-blur-sm">
      <div className="bg-slate-900 border border-slate-700 rounded-xl shadow-2xl w-full max-w-lg max-h-[80vh] flex flex-col">
        {/* Header */}
        <div className="flex items-center justify-between px-4 py-3 border-b border-slate-700">
          <div className="flex items-center gap-2">
            <svg
              className="w-5 h-5 text-blue-400"
              fill="none"
              viewBox="0 0 24 24"
              stroke="currentColor"
            >
              <path
                strokeLinecap="round"
                strokeLinejoin="round"
                strokeWidth={2}
                d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"
              />
            </svg>
            <h3 className="text-sm font-semibold text-white">Version History</h3>
            <span className="px-1.5 py-0.5 text-[10px] font-medium bg-slate-700 text-slate-300 rounded">
              {versions.length} version{versions.length !== 1 ? 's' : ''}
            </span>
          </div>
          <button
            type="button"
            onClick={onClose}
            className="p-1.5 text-slate-400 hover:text-white hover:bg-slate-700 rounded-lg transition-colors"
          >
            <svg className="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path
                strokeLinecap="round"
                strokeLinejoin="round"
                strokeWidth={2}
                d="M6 18L18 6M6 6l12 12"
              />
            </svg>
          </button>
        </div>

        {/* Content */}
        <div className="flex-1 min-h-0 overflow-y-auto p-4">
          {versions.length === 0 ? (
            <div className="text-center py-8">
              <svg
                className="w-12 h-12 mx-auto text-slate-600 mb-3"
                fill="none"
                viewBox="0 0 24 24"
                stroke="currentColor"
              >
                <path
                  strokeLinecap="round"
                  strokeLinejoin="round"
                  strokeWidth={1.5}
                  d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"
                />
              </svg>
              <p className="text-sm text-slate-400">No versions saved yet</p>
              <p className="text-xs text-slate-500 mt-1">Save your design to create a version</p>
            </div>
          ) : (
            <div className="space-y-2">
              {versions.map((version) => (
                <VersionItem
                  key={version.id}
                  version={version}
                  isCurrentVersion={version.id === currentVersionId}
                  isSelected={version.id === selectedVersionId}
                  onSelect={() =>
                    setSelectedVersionId(selectedVersionId === version.id ? null : version.id)
                  }
                  onRestore={() => onRestore(version.id)}
                  onDelete={() => handleDelete(version.id)}
                />
              ))}
            </div>
          )}

          {/* Comparison View */}
          {selectedVersion && selectedVersion.id !== currentVersionId && (
            <ComparisonView currentDesign={currentDesign} selectedVersion={selectedVersion} />
          )}

          {/* Delete Confirmation */}
          {confirmDelete && (
            <div className="fixed bottom-4 left-1/2 -translate-x-1/2 bg-red-600/90 text-white px-4 py-2 rounded-lg text-sm shadow-lg">
              Click delete again to confirm
            </div>
          )}
        </div>

        {/* Footer */}
        <div className="px-4 py-3 border-t border-slate-700 bg-slate-800/50">
          <p className="text-xs text-slate-500 text-center">
            Versions are saved automatically when you save or apply designs
          </p>
        </div>
      </div>
    </div>
  );
}

export default VersionHistoryPanel;
</file>

<file path="src/app/layout.tsx">
import type { Metadata } from 'next';
import './globals.css';
import AuthGuard from '../components/AuthGuard';
import ErrorBoundary from '../components/ErrorBoundary';
import { AuthProvider } from '../contexts/AuthContext';
import { ThemeProvider } from '../contexts/ThemeContext';
import { SettingsProvider } from '../contexts/SettingsContext';
import { DevTools } from '../components/dev/DevTools';

export const metadata: Metadata = {
  title: 'Personal AI App Builder',
  description: 'Build React components and apps using AI - the right way',
  icons: {
    icon: '/favicon.ico',
  },
};

export default function RootLayout({ children }: { children: React.ReactNode }) {
  return (
    <html lang="en" suppressHydrationWarning>
      <body className="font-sans">
        <ThemeProvider>
          <SettingsProvider>
            <AuthProvider>
              <ErrorBoundary>
                {/* DevTools outside AuthGuard so it always renders in dev mode */}
                <DevTools />
                <AuthGuard>
                  <div className="min-h-screen bg-gradient-to-br from-slate-900 via-blue-900 to-slate-900 dark:from-slate-900 dark:via-blue-900 dark:to-slate-900 transition-colors duration-300">
                    {children}
                  </div>
                </AuthGuard>
              </ErrorBoundary>
            </AuthProvider>
          </SettingsProvider>
        </ThemeProvider>
      </body>
    </html>
  );
}
</file>

<file path="src/components/BuilderHeader.tsx">
'use client';

import React, { useState, useEffect } from 'react';
import { useThemeContext } from '../contexts/ThemeContext';

// New header components
import { ProjectDropdown, BuildDropdown, SettingsDropdown, ProjectInfo } from './header';
import { RocketIcon, LayoutIcon, WandIcon, SaveIcon, MenuIcon, XIcon } from './ui/Icons';

// ============================================================================
// TYPES
// ============================================================================

export type ExportFormat = 'html' | 'react' | 'zip' | 'clipboard';
export type ProjectStatus = 'draft' | 'saved' | 'generating' | 'error';
export type ViewType = 'chat' | 'code' | 'preview' | 'split';

export interface BuilderHeaderProps {
  projectName: string;
  onProjectNameChange: (name: string) => void;
  projectStatus: ProjectStatus;
  lastSaved?: Date;
  hasUnsavedChanges: boolean;
  currentView: ViewType;
  onViewChange: (view: ViewType) => void;
  onNewProject: () => void;
  onSave: () => void;
  onExport: (format: ExportFormat) => void;
  onOpenSettings: () => void;
  onShare?: () => void;
  onHelp?: () => void;
  isSaving?: boolean;
  appVersion?: string;

  // AI Builder workflow props
  onPlanApp?: () => void;
  onWizard?: () => void;
  onLayoutBuilder?: () => void;
  onPhasedBuild?: () => void;
  showPhasedBuildPanel?: boolean;
  onTogglePhasedPanel?: () => void;
  isPhasedMode?: boolean;
  hasAppConcept?: boolean;

  // Version history
  versionCount?: number;
  onShowHistory?: () => void;
  showHistory?: boolean;

  // App library
  appCount?: number;
  onShowLibrary?: () => void;
  showLibrary?: boolean;

  // Current mode toggle
  currentMode?: 'PLAN' | 'ACT';
  onModeChange?: (mode: 'PLAN' | 'ACT') => void;

  // New app action
  onNewApp?: () => void;
}

// ============================================================================
// HELPER FUNCTIONS
// ============================================================================

function getRelativeTime(date: Date): string {
  const now = new Date();
  const diffInSeconds = Math.floor((now.getTime() - date.getTime()) / 1000);

  if (diffInSeconds < 60) {
    return 'Just now';
  } else if (diffInSeconds < 3600) {
    const minutes = Math.floor(diffInSeconds / 60);
    return `${minutes}m ago`;
  } else if (diffInSeconds < 86400) {
    const hours = Math.floor(diffInSeconds / 3600);
    return `${hours}h ago`;
  } else {
    const days = Math.floor(diffInSeconds / 86400);
    return `${days}d ago`;
  }
}

// ============================================================================
// MOBILE MENU COMPONENT
// ============================================================================

interface MobileMenuProps {
  isOpen: boolean;
  onClose: () => void;
  onNewProject: () => void;
  onSave: () => void;
  onExport: (format: ExportFormat) => void;
  onOpenSettings: () => void;
  onHelp?: () => void;
  currentView: ViewType;
  onViewChange: (view: ViewType) => void;
  isSaving?: boolean;
  onPlanApp?: () => void;
  onWizard?: () => void;
  onLayoutBuilder?: () => void;
  onPhasedBuild?: () => void;
  isPhasedMode?: boolean;
  hasAppConcept?: boolean;
  showPhasedBuildPanel?: boolean;
  onTogglePhasedPanel?: () => void;
  versionCount?: number;
  onShowHistory?: () => void;
  onNewApp?: () => void;
  onShowLibrary?: () => void;
  appCount?: number;
  theme: string;
  onThemeChange: (theme: 'light' | 'dark' | 'system') => void;
}

function MobileMenu({
  isOpen,
  onClose,
  onNewProject,
  onSave,
  onExport,
  onOpenSettings,
  onHelp,
  currentView,
  onViewChange,
  isSaving,
  onPlanApp,
  onWizard,
  onLayoutBuilder,
  onPhasedBuild,
  isPhasedMode,
  hasAppConcept,
  showPhasedBuildPanel,
  onTogglePhasedPanel,
  versionCount,
  onShowHistory,
  onNewApp,
  onShowLibrary,
  appCount,
  theme,
  onThemeChange,
}: MobileMenuProps) {
  if (!isOpen) return null;

  const viewModes: ViewType[] = ['chat', 'code', 'preview', 'split'];
  const exportFormats: { format: ExportFormat; label: string }[] = [
    { format: 'html', label: 'Export as HTML' },
    { format: 'react', label: 'Export as React' },
    { format: 'zip', label: 'Export as ZIP' },
    { format: 'clipboard', label: 'Copy to Clipboard' },
  ];

  return (
    <div className="fixed inset-0 bg-black/80 backdrop-blur-sm z-50 md:hidden" onClick={onClose}>
      <div
        className="absolute right-0 top-0 h-full w-80 max-w-full bg-zinc-900 border-l border-zinc-800 p-6 space-y-6 animate-slide-in-right"
        onClick={(e) => e.stopPropagation()}
      >
        {/* Close Button */}
        <div className="flex justify-between items-center">
          <h3 className="text-lg font-semibold text-white">Menu</h3>
          <button onClick={onClose} className="p-2 rounded-md hover:bg-zinc-800 transition-colors">
            <XIcon size={20} className="text-zinc-400" />
          </button>
        </div>

        {/* View Controls */}
        <div className="space-y-2">
          <h4 className="text-sm font-medium text-zinc-500">View</h4>
          <div className="grid grid-cols-2 gap-2">
            {viewModes.map((view) => (
              <button
                key={view}
                onClick={() => {
                  onViewChange(view);
                  onClose();
                }}
                className={`px-4 py-2.5 rounded-md text-sm font-medium transition-colors capitalize ${
                  currentView === view
                    ? 'bg-blue-600 text-white'
                    : 'bg-zinc-800 text-zinc-300 hover:bg-zinc-700'
                }`}
              >
                {view}
              </button>
            ))}
          </div>
        </div>

        {/* Build Actions */}
        <div className="space-y-2">
          <h4 className="text-sm font-medium text-zinc-500">Build</h4>
          <div className="space-y-2">
            {onLayoutBuilder && (
              <button
                onClick={() => {
                  onLayoutBuilder();
                  onClose();
                }}
                className="w-full linear-btn-secondary justify-start"
              >
                <LayoutIcon size={16} />
                Layout Builder
              </button>
            )}
            {onWizard && (
              <button
                onClick={() => {
                  onWizard();
                  onClose();
                }}
                className="w-full linear-btn-secondary justify-start"
              >
                <WandIcon size={16} />
                Wizard
              </button>
            )}
            {onPlanApp && (
              <button
                onClick={() => {
                  onPlanApp();
                  onClose();
                }}
                className="w-full linear-btn-secondary justify-start"
              >
                <RocketIcon size={16} />
                Plan App
              </button>
            )}
            {hasAppConcept && onPhasedBuild && (
              <button
                onClick={() => {
                  onPhasedBuild();
                  onClose();
                }}
                className="w-full linear-btn-secondary justify-start"
              >
                Phased Build
              </button>
            )}
            {isPhasedMode && onTogglePhasedPanel && (
              <button
                onClick={() => {
                  onTogglePhasedPanel();
                  onClose();
                }}
                className={`w-full linear-btn-secondary justify-start ${showPhasedBuildPanel ? 'bg-zinc-700' : ''}`}
              >
                Phases
              </button>
            )}
            {versionCount !== undefined && versionCount > 0 && onShowHistory && (
              <button
                onClick={() => {
                  onShowHistory();
                  onClose();
                }}
                className="w-full linear-btn-secondary justify-start"
              >
                History
                <span className="ml-auto px-1.5 py-0.5 text-xs bg-zinc-700 rounded">
                  {versionCount}
                </span>
              </button>
            )}
          </div>
        </div>

        {/* Project Actions */}
        <div className="space-y-2">
          <h4 className="text-sm font-medium text-zinc-500">Project</h4>
          <div className="space-y-2">
            {onNewApp && (
              <button
                onClick={() => {
                  onNewApp();
                  onClose();
                }}
                className="w-full linear-btn-secondary justify-start"
              >
                New App
              </button>
            )}
            {onShowLibrary && (
              <button
                onClick={() => {
                  onShowLibrary();
                  onClose();
                }}
                className="w-full linear-btn-secondary justify-start"
              >
                My Apps
                {appCount && appCount > 0 && (
                  <span className="ml-auto px-1.5 py-0.5 text-xs bg-zinc-700 rounded">
                    {appCount}
                  </span>
                )}
              </button>
            )}
            <button
              onClick={() => {
                onNewProject();
                onClose();
              }}
              className="w-full linear-btn-secondary justify-start"
            >
              New App
            </button>
            <button
              onClick={() => {
                onSave();
                onClose();
              }}
              disabled={isSaving}
              className="w-full linear-btn-primary justify-start disabled:opacity-50"
            >
              <SaveIcon size={16} />
              {isSaving ? 'Saving...' : 'Save'}
            </button>
          </div>
        </div>

        {/* Export Options */}
        <div className="space-y-2">
          <h4 className="text-sm font-medium text-zinc-500">Export</h4>
          <div className="space-y-2">
            {exportFormats.map((option) => (
              <button
                key={option.format}
                onClick={() => {
                  onExport(option.format);
                  onClose();
                }}
                className="w-full linear-btn-secondary justify-start"
              >
                {option.label}
              </button>
            ))}
          </div>
        </div>

        {/* Settings */}
        <div className="space-y-2">
          <h4 className="text-sm font-medium text-zinc-500">Settings</h4>
          <div className="space-y-2">
            <button
              onClick={() => {
                onOpenSettings();
                onClose();
              }}
              className="w-full linear-btn-secondary justify-start"
            >
              Settings
            </button>
            {onHelp && (
              <button
                onClick={() => {
                  onHelp();
                  onClose();
                }}
                className="w-full linear-btn-secondary justify-start"
              >
                Help & Shortcuts
              </button>
            )}
          </div>
        </div>

        {/* Theme */}
        <div className="pt-4 border-t border-zinc-800">
          <h4 className="text-sm font-medium text-zinc-500 mb-2">Theme</h4>
          <div className="grid grid-cols-3 gap-2">
            {(['light', 'dark', 'system'] as const).map((t) => (
              <button
                key={t}
                onClick={() => onThemeChange(t)}
                className={`px-3 py-2 rounded-md text-sm capitalize transition-colors ${
                  theme === t
                    ? 'bg-zinc-700 text-white'
                    : 'bg-zinc-800 text-zinc-400 hover:text-white'
                }`}
              >
                {t}
              </button>
            ))}
          </div>
        </div>
      </div>
    </div>
  );
}

// ============================================================================
// MAIN BUILDER HEADER COMPONENT
// ============================================================================

export function BuilderHeader({
  projectName,
  onProjectNameChange,
  projectStatus,
  lastSaved,
  hasUnsavedChanges,
  currentView,
  onViewChange,
  onNewProject,
  onSave,
  onExport,
  onOpenSettings,
  onShare,
  onHelp,
  isSaving = false,
  appVersion = '1.0.0',
  onPlanApp,
  onWizard,
  onLayoutBuilder,
  onPhasedBuild,
  showPhasedBuildPanel,
  onTogglePhasedPanel,
  isPhasedMode,
  hasAppConcept,
  versionCount,
  onShowHistory,
  appCount,
  onShowLibrary,
  currentMode: _currentMode,
  onModeChange: _onModeChange,
  onNewApp,
}: BuilderHeaderProps) {
  const [showMobileMenu, setShowMobileMenu] = useState(false);
  const { theme, setTheme } = useThemeContext();

  // Close mobile menu on resize
  useEffect(() => {
    function handleResize() {
      if (window.innerWidth >= 768) {
        setShowMobileMenu(false);
      }
    }
    window.addEventListener('resize', handleResize);
    return () => window.removeEventListener('resize', handleResize);
  }, []);

  // Determine status for ProjectInfo
  const statusMap: Record<ProjectStatus, 'draft' | 'saved' | 'generating' | 'error'> = {
    draft: hasUnsavedChanges ? 'draft' : 'draft',
    saved: 'saved',
    generating: 'generating',
    error: 'error',
  };

  return (
    <>
      <header className="linear-header">
        {/* ============================================
            BRANDING SECTION (LEFT)
        ============================================ */}
        <div className="flex items-center gap-3 shrink-0">
          {/* Logo */}
          <div className="w-9 h-9 rounded-lg bg-gradient-to-br from-blue-500 to-purple-600 flex items-center justify-center">
            <RocketIcon size={18} className="text-white" />
          </div>
          {/* App Name & Version */}
          <div className="hidden sm:block">
            <h1 className="font-semibold text-zinc-100 text-sm leading-tight">AI App Builder</h1>
            <p className="text-xs text-zinc-500 leading-tight">v{appVersion}</p>
          </div>
        </div>

        {/* Divider */}
        <div className="hidden md:block w-px h-6 bg-zinc-800" />

        {/* ============================================
            PROJECT INFO (CENTER-LEFT)
        ============================================ */}
        <div className="hidden md:block flex-1 min-w-0">
          <ProjectInfo
            projectName={projectName}
            status={statusMap[projectStatus]}
            lastSaved={lastSaved ? getRelativeTime(lastSaved) : undefined}
            onRename={onProjectNameChange}
          />
        </div>

        {/* ============================================
            DROPDOWN MENUS
        ============================================ */}
        <div className="hidden md:flex items-center gap-1">
          <ProjectDropdown
            onNewProject={onNewProject}
            onMyApps={onShowLibrary}
            onExportHTML={() => onExport('html')}
            onExportReact={() => onExport('react')}
            onExportZip={() => onExport('zip')}
            onCopyToClipboard={() => onExport('clipboard')}
            onShare={onShare}
            appCount={appCount}
            showShare={!!onShare}
          />

          <BuildDropdown
            showPlanApp={!!onPlanApp}
            showPhasedBuild={!!hasAppConcept && !!onPhasedBuild}
            showPhasesToggle={!!isPhasedMode && !!onTogglePhasedPanel}
            showVersionHistory={!!versionCount && versionCount > 0 && !!onShowHistory}
            isPhasedMode={showPhasedBuildPanel}
            versionCount={versionCount}
            onPlanApp={onPlanApp}
            onPhasedBuild={onPhasedBuild}
            onTogglePhases={onTogglePhasedPanel}
            onVersionHistory={onShowHistory}
          />
        </div>

        {/* Divider */}
        <div className="hidden md:block w-px h-6 bg-zinc-800" />

        {/* ============================================
            PRIMARY ACTIONS
        ============================================ */}
        <div className="hidden md:flex items-center gap-2">
          {/* Layout Builder - Always visible */}
          {onLayoutBuilder && (
            <button onClick={onLayoutBuilder} className="linear-btn-ghost" title="Layout Builder">
              <LayoutIcon size={16} />
              <span className="hidden lg:inline">Layout</span>
            </button>
          )}

          {/* Wizard - Always visible */}
          {onWizard && (
            <button onClick={onWizard} className="linear-btn-ghost" title="App Wizard">
              <WandIcon size={16} />
              <span className="hidden lg:inline">Wizard</span>
            </button>
          )}

          {/* Save - Primary action */}
          <button
            onClick={onSave}
            disabled={isSaving || projectStatus === 'generating'}
            className="linear-btn-primary disabled:opacity-50 disabled:cursor-not-allowed"
            title="Save (Ctrl+S)"
          >
            <SaveIcon size={16} />
            <span className="hidden lg:inline">{isSaving ? 'Saving...' : 'Save'}</span>
          </button>
        </div>

        {/* Spacer for mobile */}
        <div className="flex-1 md:hidden" />

        {/* Mobile status indicator */}
        <div className="md:hidden flex items-center gap-2 text-sm text-zinc-400">
          <span
            className={`status-dot ${
              projectStatus === 'saved'
                ? 'status-dot-saved'
                : projectStatus === 'generating'
                  ? 'status-dot-generating'
                  : projectStatus === 'error'
                    ? 'status-dot-error'
                    : 'status-dot-draft'
            }`}
          />
          <span className="capitalize">{projectStatus}</span>
        </div>

        {/* ============================================
            SETTINGS (RIGHT)
        ============================================ */}
        <div className="hidden md:block">
          <SettingsDropdown
            theme={theme as 'light' | 'dark' | 'system'}
            onThemeChange={setTheme}
            onSettings={onOpenSettings}
            onHelp={onHelp}
          />
        </div>

        {/* ============================================
            MOBILE MENU BUTTON
        ============================================ */}
        <button
          onClick={() => setShowMobileMenu(true)}
          className="md:hidden w-9 h-9 rounded-md bg-zinc-800 hover:bg-zinc-700 border border-zinc-700 text-zinc-300 flex items-center justify-center transition-colors"
          title="Menu"
        >
          <MenuIcon size={18} />
        </button>
      </header>

      {/* Mobile Menu Overlay */}
      <MobileMenu
        isOpen={showMobileMenu}
        onClose={() => setShowMobileMenu(false)}
        onNewProject={onNewProject}
        onSave={onSave}
        onExport={onExport}
        onOpenSettings={onOpenSettings}
        onHelp={onHelp}
        currentView={currentView}
        onViewChange={onViewChange}
        isSaving={isSaving}
        onPlanApp={onPlanApp}
        onWizard={onWizard}
        onLayoutBuilder={onLayoutBuilder}
        onPhasedBuild={onPhasedBuild}
        isPhasedMode={isPhasedMode}
        hasAppConcept={hasAppConcept}
        showPhasedBuildPanel={showPhasedBuildPanel}
        onTogglePhasedPanel={onTogglePhasedPanel}
        versionCount={versionCount}
        onShowHistory={onShowHistory}
        onNewApp={onNewApp}
        onShowLibrary={onShowLibrary}
        appCount={appCount}
        theme={theme}
        onThemeChange={setTheme}
      />
    </>
  );
}

export default BuilderHeader;
</file>

<file path="src/components/dev/ElementInspector/InspectorButton.tsx">
'use client';

/**
 * InspectorButton - Toggle button for the Element Inspector
 * Positioned next to the existing Debug button in bottom-right corner.
 */

import React from 'react';

interface InspectorButtonProps {
  isActive: boolean;
  onClick: () => void;
  selectedCount: number;
}

export function InspectorButton({
  isActive,
  onClick,
  selectedCount,
}: InspectorButtonProps): React.ReactElement {
  const handleClick = () => {
    // eslint-disable-next-line no-console
    console.log('[InspectorButton] Clicked! Current isActive:', isActive);
    onClick();
  };

  return (
    <button
      onClick={handleClick}
      data-inspector-button
      className={`
        fixed bottom-4 right-24 z-[9999]
        px-3 py-2 rounded-lg shadow-lg
        font-mono text-sm transition-all
        ${
          isActive
            ? 'bg-cyan-600 text-white ring-2 ring-cyan-400/50'
            : 'bg-gray-900 text-white hover:bg-gray-800'
        }
      `}
      title={isActive ? 'Exit Inspect Mode (Esc)' : 'Enter Inspect Mode'}
    >
      <span className="mr-1">{isActive ? 'üéØ' : 'üîç'}</span>
      <span>Inspect</span>
      {selectedCount > 0 && (
        <span className="ml-2 px-1.5 py-0.5 bg-cyan-500/30 rounded text-xs">{selectedCount}</span>
      )}
    </button>
  );
}

export default InspectorButton;
</file>

<file path="src/components/PreviewPanel.tsx">
'use client';

import React from 'react';
import CodePreview from './CodePreview';
import FullAppPreview from './FullAppPreview';
import type { GeneratedComponent, ActiveTab } from '../types/aiBuilderTypes';

// ============================================================================
// PREVIEW PANEL PROPS
// ============================================================================

export interface PreviewPanelProps {
  // Current component
  currentComponent: GeneratedComponent | null;

  // Tab state
  activeTab: ActiveTab;
  onTabChange: (tab: ActiveTab) => void;

  // Undo/Redo
  canUndo: boolean;
  canRedo: boolean;
  onUndo: () => void;
  onRedo: () => void;
  undoCount?: number;
  redoCount?: number;

  // Actions
  onFork: (component: GeneratedComponent) => void;
  onExport: (component: GeneratedComponent) => void;
  onDownload: () => void;

  // Loading states
  isExporting?: boolean;

  // Screenshot capture
  onScreenshot?: (image: string) => void;
}

// ============================================================================
// PREVIEW PANEL COMPONENT
// ============================================================================

export function PreviewPanel({
  currentComponent,
  activeTab,
  onTabChange,
  canUndo,
  canRedo,
  onUndo,
  onRedo,
  undoCount = 0,
  redoCount = 0,
  onFork,
  onExport,
  onDownload,
  isExporting = false,
  onScreenshot,
}: PreviewPanelProps) {
  return (
    <div className="glass-panel rounded-2xl border border-white/10 overflow-hidden shadow-2xl shadow-black/40 h-full flex flex-col">
      {/* Tabs Header */}
      <div className="flex items-center gap-2 px-6 py-4 border-b border-white/10 bg-black/30 backdrop-blur-sm">
        {/* Tab Buttons */}
        <button
          onClick={() => onTabChange('preview')}
          className={`px-4 py-2 rounded-lg text-sm font-medium transition-all ${
            activeTab === 'preview' || (activeTab === 'chat' && currentComponent)
              ? 'bg-blue-600 text-white shadow-lg shadow-blue-500/20'
              : 'text-slate-400 hover:text-white hover:bg-white/5'
          }`}
        >
          üëÅÔ∏è Preview
        </button>
        <button
          onClick={() => onTabChange('code')}
          className={`px-4 py-2 rounded-lg text-sm font-medium transition-all ${
            activeTab === 'code'
              ? 'bg-blue-600 text-white shadow-lg shadow-blue-500/20'
              : 'text-slate-400 hover:text-white hover:bg-white/5'
          }`}
        >
          üíª Code
        </button>

        {/* Component Actions (only when component exists) */}
        {currentComponent && (
          <>
            {/* Undo/Redo Controls */}
            <div className="flex items-center gap-1 ml-2 px-2 py-1 rounded-lg bg-white/5 border border-white/10">
              <button
                onClick={onUndo}
                disabled={!canUndo}
                className="p-1.5 rounded text-slate-400 hover:text-white hover:bg-white/10 transition-all disabled:opacity-30 disabled:cursor-not-allowed"
                title={`Undo${undoCount > 0 ? ` (${undoCount})` : ''}`}
              >
                ‚Ü∂
              </button>
              <button
                onClick={onRedo}
                disabled={!canRedo}
                className="p-1.5 rounded text-slate-400 hover:text-white hover:bg-white/10 transition-all disabled:opacity-30 disabled:cursor-not-allowed"
                title={`Redo${redoCount > 0 ? ` (${redoCount})` : ''}`}
              >
                ‚Ü∑
              </button>
            </div>

            {/* Fork Button */}
            <button
              onClick={() => onFork(currentComponent)}
              className="px-3 py-2 rounded-lg bg-white/5 border border-white/10 hover:bg-white/10 text-slate-300 hover:text-white text-sm font-medium transition-all flex items-center gap-2"
              title="Fork this app"
            >
              <span>üç¥</span>
              <span className="hidden lg:inline">Fork</span>
            </button>
          </>
        )}

        {/* Spacer */}
        <div className="flex-1"></div>

        {/* Export/Download Actions (only when component exists) */}
        {currentComponent && (
          <>
            <button
              onClick={() => onExport(currentComponent)}
              disabled={isExporting}
              className="px-4 py-2 rounded-lg bg-purple-600 hover:bg-purple-700 text-white text-sm font-medium transition-all hover:shadow-lg hover:shadow-purple-500/20 flex items-center gap-2 disabled:opacity-50"
            >
              <span>{isExporting ? '‚è≥' : 'üì¶'}</span>
              <span className="hidden sm:inline">Export & Deploy</span>
            </button>
            <button
              onClick={onDownload}
              className="px-4 py-2 rounded-lg bg-green-600 hover:bg-green-700 text-white text-sm font-medium transition-all hover:shadow-lg hover:shadow-green-500/20 flex items-center gap-2"
            >
              <span>üì•</span>
              <span className="hidden sm:inline">Download</span>
            </button>
          </>
        )}
      </div>

      {/* Preview Content */}
      <div className="flex-1 p-6 overflow-auto">
        {!currentComponent ? (
          // Empty State
          <div className="h-full flex flex-col items-center justify-center text-center">
            <div className="text-6xl mb-4">üí¨</div>
            <h3 className="text-xl font-semibold text-white mb-2">Start Building Your App</h3>
            <p className="text-slate-400 max-w-md">
              Describe what you want to build in the chat, and I&apos;ll create a complete app with
              live preview for you.
            </p>
          </div>
        ) : (
          // Content based on active tab (default to preview when tab is 'chat')
          <>
            {(activeTab === 'preview' || activeTab === 'chat') && (
              <div className="h-full">
                <FullAppPreview appDataJson={currentComponent.code} onScreenshot={onScreenshot} />
              </div>
            )}

            {activeTab === 'code' && (
              <div className="h-full min-h-[500px]">
                <CodePreview code={currentComponent.code} />
              </div>
            )}
          </>
        )}
      </div>
    </div>
  );
}

export default PreviewPanel;
</file>

<file path="src/components/ui/ResizableHandle.tsx">
'use client';

import React, { useCallback, useRef } from 'react';

// Constants
const DOUBLE_CLICK_THRESHOLD_MS = 300;

// Symbol for component identification
export const RESIZABLE_HANDLE_TYPE = Symbol.for('ResizableHandle');

export interface ResizableHandleProps {
  className?: string;
  hitAreaMargins?: { coarse: number; fine: number };
  disabled?: boolean;
  onDoubleClick?: () => void;
  style?: React.CSSProperties;
}

export interface ResizableHandleContextValue {
  direction: 'horizontal' | 'vertical';
  isDragging: boolean;
  isActive: boolean;
  startResize: (event: React.MouseEvent | React.TouchEvent | React.KeyboardEvent) => void;
  onDoubleClick?: () => void;
}

// Context set by ResizablePanelGroup
export const ResizableHandleContext = React.createContext<ResizableHandleContextValue | null>(null);

/**
 * ResizableHandle - A draggable divider between resizable panels
 *
 * Features:
 * - Drag to resize adjacent panels
 * - Keyboard accessible (Arrow keys to resize, Home/End for min/max)
 * - Touch support for mobile devices
 * - Visual feedback on hover and drag
 * - Double-click to collapse/expand
 *
 * @example
 * ```tsx
 * <ResizablePanelGroup direction="horizontal">
 *   <ResizablePanel>Content A</ResizablePanel>
 *   <ResizableHandle />
 *   <ResizablePanel>Content B</ResizablePanel>
 * </ResizablePanelGroup>
 * ```
 */
export function ResizableHandle({
  className = '',
  hitAreaMargins = { coarse: 15, fine: 5 },
  disabled = false,
  onDoubleClick: onDoubleClickProp,
  style = {},
}: ResizableHandleProps) {
  const context = React.useContext(ResizableHandleContext);
  const handleRef = useRef<HTMLDivElement>(null);
  const lastClickTimeRef = useRef<number>(0);

  // Extract context values (with defaults for when context is null)
  const direction = context?.direction ?? 'horizontal';
  const isDragging = context?.isDragging ?? false;
  const isActive = context?.isActive ?? false;
  const startResize = context?.startResize;
  const contextOnDoubleClick = context?.onDoubleClick;
  const isHorizontal = direction === 'horizontal';

  // Handle mouse down - hooks must be called unconditionally
  const handleMouseDown = useCallback(
    (event: React.MouseEvent) => {
      if (disabled || !startResize) return;

      // Check for double-click
      const now = Date.now();
      if (now - lastClickTimeRef.current < DOUBLE_CLICK_THRESHOLD_MS) {
        // Double-click detected
        const handler = onDoubleClickProp || contextOnDoubleClick;
        if (handler) {
          handler();
          lastClickTimeRef.current = 0;
          return;
        }
      }
      lastClickTimeRef.current = now;

      startResize(event);
    },
    [disabled, startResize, onDoubleClickProp, contextOnDoubleClick]
  );

  // Handle touch start
  const handleTouchStart = useCallback(
    (event: React.TouchEvent) => {
      if (disabled || !startResize) return;
      startResize(event);
    },
    [disabled, startResize]
  );

  // Handle keyboard events for accessibility
  const handleKeyDown = useCallback(
    (event: React.KeyboardEvent) => {
      if (disabled || !startResize) return;

      const relevantKeys = ['ArrowLeft', 'ArrowRight', 'ArrowUp', 'ArrowDown', 'Home', 'End'];
      if (relevantKeys.includes(event.key)) {
        startResize(event);
      }
    },
    [disabled, startResize]
  );

  // Early return after all hooks are called
  if (!context) {
    return null;
  }

  // Calculate hit area sizes
  const hitAreaSize = isDragging ? hitAreaMargins.coarse : hitAreaMargins.fine;

  // Handle styles - width/height handled by CSS, just add cursor and touch-action
  const handleStyle: React.CSSProperties = {
    ...style,
    // Base styles
    position: 'relative',
    flexShrink: 0,
    touchAction: 'none',
    // Direction-specific cursor only
    cursor: disabled ? 'default' : isHorizontal ? 'col-resize' : 'row-resize',
  };

  // Build class names
  const classNames = [
    'resize-handle',
    isHorizontal ? 'resize-handle-horizontal' : 'resize-handle-vertical',
    isDragging ? 'resize-handle-dragging' : '',
    isActive ? 'resize-handle-active' : '',
    disabled ? 'resize-handle-disabled' : '',
    className,
  ]
    .filter(Boolean)
    .join(' ');

  return (
    <div
      ref={handleRef}
      className={classNames}
      style={handleStyle}
      role="separator"
      aria-orientation={isHorizontal ? 'vertical' : 'horizontal'}
      aria-valuenow={50} // Would be populated from context with actual position
      aria-valuemin={0}
      aria-valuemax={100}
      tabIndex={disabled ? -1 : 0}
      onMouseDown={handleMouseDown}
      onTouchStart={handleTouchStart}
      onKeyDown={handleKeyDown}
      data-handle-hit-area={hitAreaSize}
    >
      {/* Visual indicator */}
      <div
        className="resize-handle-indicator"
        style={{
          position: 'absolute',
          ...(isHorizontal
            ? {
                top: '50%',
                left: '50%',
                transform: 'translate(-50%, -50%)',
                width: '2px',
                height: '32px',
                borderRadius: '1px',
              }
            : {
                top: '50%',
                left: '50%',
                transform: 'translate(-50%, -50%)',
                width: '32px',
                height: '2px',
                borderRadius: '1px',
              }),
          transition: 'background 0.2s, opacity 0.2s',
        }}
      />
    </div>
  );
}

// Attach type symbol for identification
ResizableHandle.displayName = 'ResizableHandle';
(ResizableHandle as any).__RESIZABLE_TYPE__ = RESIZABLE_HANDLE_TYPE;

export default ResizableHandle;
</file>

<file path="src/components/ui/ResizablePanelGroup.tsx">
'use client';

import React, { useCallback, useMemo, useState, useRef, useEffect } from 'react';
import {
  ResizablePanelContext,
  type ResizablePanelProps,
  RESIZABLE_PANEL_TYPE,
} from './ResizablePanel';
import { ResizableHandleContext, RESIZABLE_HANDLE_TYPE } from './ResizableHandle';
import { useResizable } from '@/hooks/useResizable';
import { loadPanelLayout, savePanelLayout, mergePersistedLayout } from '@/utils/panelPersistence';

export interface ResizablePanelGroupProps {
  children: React.ReactNode;
  direction: 'horizontal' | 'vertical';
  onLayoutChange?: (sizes: number[]) => void;
  persistenceKey?: string;
  className?: string;
  style?: React.CSSProperties;
  autoSaveId?: string; // Alias for persistenceKey
}

interface PanelData {
  defaultSize?: number;
  minSize?: number;
  maxSize?: number;
  collapsible?: boolean;
  collapsedSize?: number;
}

// Type guard to check if element is a ResizablePanel
function isResizablePanel(child: React.ReactElement): boolean {
  const type = child.type as any;
  // Check for symbol first (most reliable)
  if (type?.__RESIZABLE_TYPE__ === RESIZABLE_PANEL_TYPE) return true;
  // Check displayName as fallback
  if (type?.displayName === 'ResizablePanel') return true;
  // Check props as last fallback
  const props = child.props as Partial<ResizablePanelProps>;
  return (
    props.defaultSize !== undefined || props.minSize !== undefined || props.maxSize !== undefined
  );
}

// Type guard to check if element is a ResizableHandle
function isResizableHandle(child: React.ReactElement): boolean {
  const type = child.type as any;
  // Check for symbol first (most reliable)
  if (type?.__RESIZABLE_TYPE__ === RESIZABLE_HANDLE_TYPE) return true;
  // Check displayName as fallback
  if (type?.displayName === 'ResizableHandle') return true;
  // Check props as last fallback
  const props = child.props as Record<string, unknown>;
  return props.hitAreaMargins !== undefined;
}

// Extract panel data from children
function extractPanelData(children: React.ReactNode): PanelData[] {
  const panels: PanelData[] = [];

  React.Children.forEach(children, (child) => {
    if (React.isValidElement(child) && isResizablePanel(child)) {
      const props = child.props as Partial<ResizablePanelProps>;
      panels.push({
        defaultSize: props.defaultSize,
        minSize: props.minSize,
        maxSize: props.maxSize,
        collapsible: props.collapsible,
        collapsedSize: props.collapsedSize,
      });
    }
  });

  return panels;
}

/**
 * ResizablePanelGroup - Container that manages multiple resizable panels
 *
 * Features:
 * - Manages layout of child ResizablePanels and ResizableHandles
 * - Handles drag-to-resize with smooth animations
 * - Persists layout to localStorage when persistenceKey is provided
 * - Supports both horizontal and vertical layouts
 * - Enforces min/max constraints from child panels
 *
 * @example
 * ```tsx
 * <ResizablePanelGroup
 *   direction="horizontal"
 *   persistenceKey="ai-builder-layout"
 *   onLayoutChange={(sizes) => console.log('Layout changed:', sizes)}
 * >
 *   <ResizablePanel defaultSize={30} minSize={20} maxSize={50}>
 *     <ChatPanel />
 *   </ResizablePanel>
 *   <ResizableHandle />
 *   <ResizablePanel defaultSize={70} minSize={30}>
 *     <PreviewPanel />
 *   </ResizablePanel>
 * </ResizablePanelGroup>
 * ```
 */
export function ResizablePanelGroup({
  children,
  direction,
  onLayoutChange,
  persistenceKey,
  className = '',
  style = {},
  autoSaveId,
}: ResizablePanelGroupProps) {
  const actualPersistenceKey = persistenceKey || autoSaveId;

  // Extract panel configuration from children
  const panelData = useMemo(() => extractPanelData(children), [children]);

  // Calculate initial sizes - compute once on mount to avoid race conditions
  const [initialSizes] = useState<number[]>(() => {
    const defaultSizes = panelData.map((p) => p.defaultSize ?? 100 / panelData.length);

    // Try to load persisted layout synchronously during initialization
    if (actualPersistenceKey && typeof window !== 'undefined') {
      const persisted = loadPanelLayout({ key: actualPersistenceKey });
      const minSizesArr = panelData.map((p) => p.minSize ?? 5);
      const maxSizesArr = panelData.map((p) => p.maxSize ?? 95);

      return mergePersistedLayout(
        persisted,
        panelData.length,
        defaultSizes,
        minSizesArr,
        maxSizesArr
      );
    }

    return defaultSizes;
  });

  // Extract min/max sizes
  const minSizes = useMemo(() => panelData.map((p) => p.minSize ?? 5), [panelData]);
  const maxSizes = useMemo(() => panelData.map((p) => p.maxSize ?? 95), [panelData]);

  // Use the resize hook
  const {
    sizes,
    setSizes,
    isDragging,
    activeIndex,
    startResize,
    containerRef,
    collapsePanel,
    expandPanel,
  } = useResizable({
    direction,
    defaultSizes: initialSizes,
    minSizes,
    maxSizes,
    onLayoutChange: (newSizes) => {
      onLayoutChange?.(newSizes);
      if (actualPersistenceKey) {
        savePanelLayout(newSizes, { key: actualPersistenceKey });
      }
    },
    persistenceKey: actualPersistenceKey,
  });

  // Track if initial sync has occurred to avoid resetting during drag
  const hasSyncedRef = useRef(false);
  const isDraggingRef = useRef(false);

  // Track dragging state in ref to avoid sync during drag
  useEffect(() => {
    isDraggingRef.current = isDragging;
  }, [isDragging]);

  // Sync initial sizes to the resize hook on first render only
  // Skip sync if currently dragging to prevent race condition
  useEffect(() => {
    if (
      !hasSyncedRef.current &&
      initialSizes.length === panelData.length &&
      !isDraggingRef.current
    ) {
      hasSyncedRef.current = true;
      setSizes(initialSizes);
    }
  }, [initialSizes, panelData.length, setSizes]);

  // Track collapsed state per panel
  const [collapsedPanels, setCollapsedPanels] = useState<Set<number>>(new Set());

  // Handle panel collapse/expand
  const handleCollapse = useCallback(
    (index: number) => {
      setCollapsedPanels((prev) => new Set(prev).add(index));
      collapsePanel(index);
    },
    [collapsePanel]
  );

  const handleExpand = useCallback(
    (index: number) => {
      setCollapsedPanels((prev) => {
        const next = new Set(prev);
        next.delete(index);
        return next;
      });
      expandPanel(index);
    },
    [expandPanel]
  );

  // Build enhanced children with contexts
  const enhancedChildren = useMemo(() => {
    let panelIndex = 0;
    let handleIndex = 0;

    return React.Children.map(children, (child) => {
      if (!React.isValidElement(child)) return child;

      // Check if it's a ResizablePanel using type guard
      if (isResizablePanel(child)) {
        const currentIndex = panelIndex;
        const size = sizes[currentIndex] ?? 50;
        const isCollapsed = collapsedPanels.has(currentIndex);

        const contextValue = {
          size,
          isCollapsed,
          collapse: () => handleCollapse(currentIndex),
          expand: () => handleExpand(currentIndex),
        };

        panelIndex++;

        // Create flex basis style
        const panelStyle: React.CSSProperties = {
          flexBasis: `${size}%`,
          flexGrow: 0,
          flexShrink: 0,
          minWidth: direction === 'horizontal' ? 0 : undefined,
          minHeight: direction === 'vertical' ? 0 : undefined,
          overflow: 'hidden',
          transition: isDragging ? 'none' : 'flex-basis 0.15s ease-out',
        };

        return (
          <ResizablePanelContext.Provider value={contextValue}>
            <div style={panelStyle} className="resizable-panel-wrapper">
              {child}
            </div>
          </ResizablePanelContext.Provider>
        );
      }

      // Check if it's a ResizableHandle using type guard
      if (isResizableHandle(child)) {
        const currentHandleIndex = handleIndex;

        const contextValue = {
          direction,
          isDragging,
          isActive: activeIndex === currentHandleIndex,
          startResize: (event: React.MouseEvent | React.TouchEvent | React.KeyboardEvent) =>
            startResize(currentHandleIndex, event),
          onDoubleClick: () => {
            // Toggle collapse of left/top panel
            const panelToToggle = currentHandleIndex;
            if (collapsedPanels.has(panelToToggle)) {
              handleExpand(panelToToggle);
            } else {
              handleCollapse(panelToToggle);
            }
          },
        };

        handleIndex++;

        return (
          <ResizableHandleContext.Provider value={contextValue}>
            {child}
          </ResizableHandleContext.Provider>
        );
      }

      // Return other children unchanged
      return child;
    });
  }, [
    children,
    sizes,
    collapsedPanels,
    direction,
    isDragging,
    activeIndex,
    startResize,
    handleCollapse,
    handleExpand,
  ]);

  // Container styles
  const containerStyle: React.CSSProperties = {
    ...style,
    display: 'flex',
    flexDirection: direction === 'horizontal' ? 'row' : 'column',
    width: '100%',
    height: '100%',
    overflow: 'hidden',
  };

  // Class names
  const containerClasses = [
    'resizable-panel-group',
    `resizable-panel-group-${direction}`,
    isDragging ? 'resizable-panel-group-dragging' : '',
    className,
  ]
    .filter(Boolean)
    .join(' ');

  return (
    <div
      ref={containerRef}
      className={containerClasses}
      style={containerStyle}
      data-direction={direction}
      data-panel-count={panelData.length}
    >
      {enhancedChildren}
    </div>
  );
}

export default ResizablePanelGroup;
</file>

<file path="src/components/dev/ElementInspector/InspectorOverlay.tsx">
'use client';

/**
 * InspectorOverlay - Full-page overlay for element hover/click detection
 * Renders highlight outlines for hovered and selected elements.
 */

import React, { useCallback, useEffect, useState } from 'react';
import type { InspectedElement } from '@/types/elementInspector';

interface InspectorOverlayProps {
  hoveredElement: HTMLElement | null;
  selectedElements: InspectedElement[];
  onHover: (element: HTMLElement | null) => void;
  onSelect: (element: HTMLElement) => void;
}

/** Elements to ignore during inspection */
const IGNORED_SELECTORS = [
  '[data-inspector-overlay]',
  '[data-inspector-panel]',
  '[data-inspector-button]',
  '[data-inspector-modal]',
  '.debug-panel',
];

export function InspectorOverlay({
  hoveredElement,
  selectedElements,
  onHover,
  onSelect,
}: InspectorOverlayProps): React.ReactElement {
  /** Check if an element should be ignored */
  const shouldIgnoreElement = useCallback((element: HTMLElement): boolean => {
    return IGNORED_SELECTORS.some((selector) => {
      try {
        return element.matches(selector) || element.closest(selector) !== null;
      } catch {
        return false;
      }
    });
  }, []);

  /** Handle mouse move to track hovered element */
  const handleMouseMove = useCallback(
    (e: MouseEvent) => {
      // elementFromPoint automatically skips elements with pointer-events: none
      const element = document.elementFromPoint(e.clientX, e.clientY) as HTMLElement | null;

      if (element && !shouldIgnoreElement(element)) {
        onHover(element);
      } else {
        onHover(null);
      }
    },
    [onHover, shouldIgnoreElement]
  );

  /** Handle click to select element */
  const handleClick = useCallback(
    (e: MouseEvent) => {
      // elementFromPoint automatically skips elements with pointer-events: none
      const element = document.elementFromPoint(e.clientX, e.clientY) as HTMLElement | null;

      // Check if the element should be ignored (inspector UI elements)
      if (!element || shouldIgnoreElement(element)) {
        return; // Let the click through to the UI
      }

      // Block the click and select the element for inspection
      e.preventDefault();
      e.stopPropagation();

      onSelect(element);
    },
    [onSelect, shouldIgnoreElement]
  );

  // Set up event listeners
  useEffect(() => {
    document.addEventListener('mousemove', handleMouseMove, true);
    document.addEventListener('click', handleClick, true);

    return () => {
      document.removeEventListener('mousemove', handleMouseMove, true);
      document.removeEventListener('click', handleClick, true);
    };
  }, [handleMouseMove, handleClick]);

  return (
    <div data-inspector-overlay className="fixed inset-0 z-[9998] pointer-events-none">
      {/* Hover Highlight */}
      {hoveredElement && (
        <ElementHighlight
          element={hoveredElement}
          color="rgba(59, 130, 246, 0.3)"
          borderColor="rgb(59, 130, 246)"
          label={generateQuickLabel(hoveredElement)}
        />
      )}

      {/* Selected Highlights */}
      {selectedElements.map((el, index) => (
        <ElementHighlight
          key={el.id}
          element={el.element}
          color="rgba(34, 197, 94, 0.2)"
          borderColor="rgb(34, 197, 94)"
          label={`${index + 1}: ${el.displayName}`}
          showIndex={index + 1}
        />
      ))}
    </div>
  );
}

/** Individual element highlight component */
interface ElementHighlightProps {
  element: HTMLElement;
  color: string;
  borderColor: string;
  label: string;
  showIndex?: number;
}

function ElementHighlight({
  element,
  color,
  borderColor,
  label,
  showIndex,
}: ElementHighlightProps): React.ReactElement | null {
  const [rect, setRect] = useState(() => element.getBoundingClientRect());

  // Update rect on scroll/resize
  useEffect(() => {
    const updateRect = () => setRect(element.getBoundingClientRect());
    window.addEventListener('scroll', updateRect, true);
    window.addEventListener('resize', updateRect);
    return () => {
      window.removeEventListener('scroll', updateRect, true);
      window.removeEventListener('resize', updateRect);
    };
  }, [element]);

  if (rect.width === 0 || rect.height === 0) {
    return null;
  }

  return (
    <>
      {/* Highlight box */}
      <div
        className="absolute pointer-events-none transition-all duration-75"
        style={{
          top: rect.top,
          left: rect.left,
          width: rect.width,
          height: rect.height,
          backgroundColor: color,
          border: `2px solid ${borderColor}`,
          boxSizing: 'border-box',
        }}
      />

      {/* Label */}
      <div
        className="absolute pointer-events-none px-2 py-1 rounded text-xs font-mono shadow-lg"
        style={{
          top: Math.max(0, rect.top - 24),
          left: rect.left,
          backgroundColor: borderColor,
          color: 'white',
          maxWidth: '300px',
          whiteSpace: 'nowrap',
          overflow: 'hidden',
          textOverflow: 'ellipsis',
        }}
      >
        {showIndex && (
          <span className="inline-flex items-center justify-center w-4 h-4 mr-1 bg-white/20 rounded-full text-[10px]">
            {showIndex}
          </span>
        )}
        {label}
      </div>
    </>
  );
}

/** Generate a quick label for hover preview */
function generateQuickLabel(element: HTMLElement): string {
  const tag = element.tagName.toLowerCase();
  const id = element.id ? `#${element.id}` : '';
  const cls = element.classList[0] ? `.${element.classList[0]}` : '';
  return `${tag}${id}${cls}`;
}

export default InspectorOverlay;
</file>

<file path="src/components/dev/ElementInspector/InspectorPanel.tsx">
'use client';

/**
 * InspectorPanel - Side panel showing selection details and input areas
 */

import React from 'react';
import type { InspectedElement } from '@/types/elementInspector';
import { SelectedElementCard } from './SelectedElementCard';

interface InspectorPanelProps {
  selectedElements: InspectedElement[];
  problemDescription: string;
  desiredChange: string;
  onProblemDescriptionChange: (text: string) => void;
  onDesiredChangeChange: (text: string) => void;
  onRemoveElement: (id: string) => void;
  onClearAll: () => void;
  onGeneratePrompt: () => void;
  onClose: () => void;
}

export function InspectorPanel({
  selectedElements,
  problemDescription,
  desiredChange,
  onProblemDescriptionChange,
  onDesiredChangeChange,
  onRemoveElement,
  onClearAll,
  onGeneratePrompt,
  onClose,
}: InspectorPanelProps): React.ReactElement {
  return (
    <div
      data-inspector-panel
      className="fixed top-4 left-4 bottom-4 w-96 z-[9999] bg-gray-900/95 backdrop-blur-sm rounded-xl border border-gray-700 shadow-2xl flex flex-col overflow-hidden"
    >
      {/* Header */}
      <div className="flex items-center justify-between px-4 py-3 border-b border-gray-700 bg-gray-800/50">
        <div className="flex items-center gap-2">
          <span className="text-lg">üîç</span>
          <h2 className="font-semibold text-white">Element Inspector</h2>
          <span className="text-xs text-gray-400 bg-gray-700 px-2 py-0.5 rounded">
            {selectedElements.length} selected
          </span>
        </div>
        <button
          onClick={onClose}
          className="p-1 hover:bg-gray-700 rounded transition-colors"
          title="Close (Esc)"
        >
          <span className="text-gray-400 hover:text-white">‚úï</span>
        </button>
      </div>

      {/* Selected Elements */}
      <div className="flex-1 min-h-0 overflow-y-auto p-4 space-y-3">
        <div className="flex items-center justify-between mb-2">
          <span className="text-xs text-gray-400 uppercase tracking-wide">Selected Elements</span>
          {selectedElements.length > 0 && (
            <button
              onClick={onClearAll}
              className="text-xs text-red-400 hover:text-red-300 transition-colors"
            >
              Clear All
            </button>
          )}
        </div>

        {selectedElements.length === 0 ? (
          <div className="text-center py-8 text-gray-500">
            <p className="text-sm">Click on elements in the page to select them</p>
            <p className="text-xs mt-2">Click again to deselect</p>
          </div>
        ) : (
          selectedElements.map((element, index) => (
            <SelectedElementCard
              key={element.id}
              element={element}
              index={index + 1}
              onRemove={() => onRemoveElement(element.id)}
            />
          ))
        )}
      </div>

      {/* Input Areas */}
      <div className="p-4 border-t border-gray-700 space-y-4">
        {/* Problem Description */}
        <div>
          <label className="block text-xs text-gray-400 uppercase tracking-wide mb-2">
            What&apos;s the problem?
          </label>
          <textarea
            value={problemDescription}
            onChange={(e) => onProblemDescriptionChange(e.target.value)}
            placeholder="Describe what's wrong with these elements..."
            className="w-full h-20 px-3 py-2 bg-gray-800 border border-gray-600 rounded-lg text-white text-sm placeholder-gray-500 focus:border-cyan-500 focus:outline-none resize-none"
          />
        </div>

        {/* Desired Change */}
        <div>
          <label className="block text-xs text-gray-400 uppercase tracking-wide mb-2">
            What do you want changed?
          </label>
          <textarea
            value={desiredChange}
            onChange={(e) => onDesiredChangeChange(e.target.value)}
            placeholder="Describe the desired outcome..."
            className="w-full h-20 px-3 py-2 bg-gray-800 border border-gray-600 rounded-lg text-white text-sm placeholder-gray-500 focus:border-cyan-500 focus:outline-none resize-none"
          />
        </div>

        {/* Generate Button */}
        <button
          onClick={onGeneratePrompt}
          disabled={selectedElements.length === 0}
          className={`
            w-full py-3 rounded-lg font-medium transition-all
            ${
              selectedElements.length > 0
                ? 'bg-gradient-to-r from-cyan-500 to-blue-600 hover:from-cyan-600 hover:to-blue-700 text-white shadow-lg'
                : 'bg-gray-700 text-gray-400 cursor-not-allowed'
            }
          `}
        >
          Generate Claude Prompt
        </button>
      </div>
    </div>
  );
}

export default InspectorPanel;
</file>

<file path="src/components/modals/PhasedBuildPanel.tsx">
'use client';

import React from 'react';
import { PhaseProgressIndicator, PhaseControlPanel, ValidationDashboard } from '../build';
import type { BuildPhase, BuildProgress, PhaseId } from '@/types/buildPhases';
import type { DynamicPhasePlan } from '@/types/dynamicPhases';

export interface PhasedBuildPanelProps {
  isOpen: boolean;
  onClose: () => void;
  phases: BuildPhase[];
  progress: BuildProgress;
  currentPhase: BuildPhase | null;
  isBuilding: boolean;
  isPaused: boolean;
  isValidating: boolean;
  onStartBuild: () => void;
  onPauseBuild: () => void;
  onResumeBuild: () => void;
  onSkipPhase: (phaseId: PhaseId) => void;
  onRetryPhase: (phaseId: PhaseId) => void;
  onViewPhaseDetails: (phaseId: PhaseId) => void;
  onRunValidation: () => void;
  onResetBuild: () => void;
  onExecuteCurrentPhase: () => void;
  onProceedToNextPhase: () => void;
  /** Optional: The dynamic phase plan for additional info display */
  dynamicPlan?: DynamicPhasePlan | null;
  /** When true, renders inline without modal overlay */
  isFullPage?: boolean;
}

export function PhasedBuildPanel({
  isOpen,
  onClose,
  phases,
  progress,
  currentPhase,
  isBuilding,
  isPaused,
  isValidating,
  onStartBuild,
  onPauseBuild,
  onResumeBuild,
  onSkipPhase,
  onRetryPhase,
  onViewPhaseDetails,
  onRunValidation,
  onResetBuild,
  onExecuteCurrentPhase,
  onProceedToNextPhase,
  dynamicPlan,
  isFullPage = false,
}: PhasedBuildPanelProps) {
  if (!isOpen) return null;

  const content = (
    <div
      className={`bg-slate-900 rounded-2xl border border-white/10 ${isFullPage ? 'w-full h-full max-h-full' : 'max-w-4xl w-full max-h-[80vh]'} overflow-hidden flex flex-col shadow-2xl`}
      onClick={(e) => e.stopPropagation()}
    >
      {/* Panel Header */}
      <div className="px-6 py-4 border-b border-white/10 bg-gradient-to-r from-orange-500/10 to-amber-500/10">
        <div className="flex items-center justify-between">
          <div className="flex items-center gap-3">
            <div className="w-10 h-10 rounded-xl bg-orange-500/20 flex items-center justify-center">
              <span className="text-2xl">üèóÔ∏è</span>
            </div>
            <div>
              <h2 className="text-xl font-bold text-white">
                {dynamicPlan ? `Building: ${dynamicPlan.appName}` : 'Phase-Driven Build'}
              </h2>
              <p className="text-sm text-slate-400">
                {dynamicPlan && (
                  <span className="mr-2 px-1.5 py-0.5 rounded bg-white/10 text-xs">
                    {dynamicPlan.complexity}
                  </span>
                )}
                {phases.length} phases ‚Ä¢ {progress.percentComplete}% complete ‚Ä¢{' '}
                {progress.estimatedTimeRemaining} remaining
              </p>
            </div>
          </div>
          <button onClick={onClose} className="p-2 rounded-lg hover:bg-white/10 transition-all">
            <span className="text-slate-400 text-xl">‚úï</span>
          </button>
        </div>
      </div>

      {/* Panel Content */}
      <div className="flex-1 min-h-0 overflow-y-auto p-6 space-y-6">
        {/* Phase Progress Indicator */}
        <PhaseProgressIndicator
          phases={phases}
          progress={progress}
          onPhaseClick={onViewPhaseDetails}
        />

        {/* Control Panel and Validation */}
        <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
          {/* Phase Control Panel */}
          <PhaseControlPanel
            phases={phases}
            progress={progress}
            isBuilding={isBuilding}
            isPaused={isPaused}
            onStartBuild={onStartBuild}
            onPauseBuild={onPauseBuild}
            onResumeBuild={onResumeBuild}
            onSkipPhase={onSkipPhase}
            onRetryPhase={onRetryPhase}
            onViewPhaseDetails={onViewPhaseDetails}
          />

          {/* Validation Dashboard */}
          {currentPhase && (
            <ValidationDashboard
              phase={currentPhase}
              onRunValidation={onRunValidation}
              onProceedAnyway={onProceedToNextPhase}
              onRetryPhase={onRetryPhase.bind(null, currentPhase.id)}
              isValidating={isValidating}
            />
          )}
        </div>
      </div>

      {/* Panel Footer */}
      <div className="px-6 py-4 border-t border-white/10 bg-black/20 flex justify-between items-center">
        <div className="flex items-center gap-2 text-xs text-slate-400">
          <span>üí°</span>
          <span>Each phase focuses on specific aspects of your app for better quality.</span>
        </div>
        <div className="flex gap-2">
          <button
            onClick={() => {
              onResetBuild();
              onClose();
            }}
            className="px-4 py-2 rounded-lg bg-slate-700 hover:bg-slate-600 text-white text-sm font-medium transition-all"
          >
            Reset Build
          </button>
          {currentPhase && currentPhase.status === 'pending' && (
            <button
              onClick={onExecuteCurrentPhase}
              className="px-4 py-2 rounded-lg bg-gradient-to-r from-blue-600 to-purple-600 hover:from-blue-500 hover:to-purple-500 text-white text-sm font-medium transition-all"
            >
              Build Current Phase
            </button>
          )}
        </div>
      </div>
    </div>
  );

  if (isFullPage) {
    return content;
  }

  return (
    <div
      className="fixed inset-0 bg-black/60 backdrop-blur-sm z-50 flex items-start justify-center p-4 pt-20"
      onClick={onClose}
    >
      {content}
    </div>
  );
}

export default PhasedBuildPanel;
</file>

<file path="src/components/FullAppPreview.tsx">
'use client';

import React, { useState, useMemo, useEffect, useRef, useCallback } from 'react';
import { createPortal } from 'react-dom';
import PowerfulPreview from './PowerfulPreview';
import { useToast } from './Toast';

interface AppFile {
  path: string;
  content: string;
  description: string;
}

interface FullAppData {
  name: string;
  description: string;
  appType?: 'FRONTEND_ONLY' | 'FULL_STACK';
  files: AppFile[];
  dependencies: Record<string, string>;
  setupInstructions: string;
}

interface FullAppPreviewProps {
  appDataJson: string;
  onScreenshot?: (image: string) => void;
}

export default function FullAppPreview({ appDataJson, onScreenshot }: FullAppPreviewProps) {
  const [selectedFile, setSelectedFile] = useState<string | null>(null);
  const [activeTab, setActiveTab] = useState<'preview' | 'code'>('preview');
  const [isFullscreen, setIsFullscreen] = useState(false);
  const [isClient, setIsClient] = useState(false);
  const [isCapturing, setIsCapturing] = useState(false);
  const [captureSuccess, setCaptureSuccess] = useState(false);
  const captureFunc = useRef<(() => Promise<string | null>) | null>(null);
  const { showToast } = useToast();

  // Handle capture function from PowerfulPreview
  const handleCaptureReady = useCallback((fn: () => Promise<string | null>) => {
    captureFunc.current = fn;
  }, []);

  // Handle capture button click
  const handleCapture = useCallback(async () => {
    if (!captureFunc.current) {
      showToast({ type: 'error', message: 'Capture not ready - please wait for preview to load' });
      return;
    }

    setIsCapturing(true);
    const image = await captureFunc.current();
    setIsCapturing(false);

    if (image) {
      setCaptureSuccess(true);
      onScreenshot?.(image);
      showToast({
        type: 'success',
        message: 'Screenshot captured! Will be sent with your next message.',
      });
      setTimeout(() => setCaptureSuccess(false), 2000);
    } else {
      showToast({ type: 'error', message: 'Failed to capture screenshot. Please try again.' });
    }
  }, [onScreenshot, showToast]);

  // Detect client-side rendering for portal
  useEffect(() => {
    setIsClient(true);
  }, []);

  // Handle body overflow when entering/exiting fullscreen
  useEffect(() => {
    if (isFullscreen) {
      document.body.style.overflow = 'hidden';
    } else {
      document.body.style.overflow = '';
    }

    // Cleanup on unmount
    return () => {
      document.body.style.overflow = '';
    };
  }, [isFullscreen]);

  // Memoize parsed app data
  const appData = useMemo(() => {
    try {
      return JSON.parse(appDataJson) as FullAppData;
    } catch (error) {
      console.error('Parse error:', error);
      return null;
    }
  }, [appDataJson]);

  // Set initial selected file - moved to useEffect to avoid state update during render
  useEffect(() => {
    if (!selectedFile && appData?.files && appData.files.length > 0) {
      setSelectedFile(appData.files[0].path);
    }
  }, [selectedFile, appData]);

  // Handle parse error or missing files
  if (!appData || !appData.files || !Array.isArray(appData.files) || appData.files.length === 0) {
    return (
      <div className="p-6 bg-red-500/10 border border-red-500/20 rounded-xl">
        <p className="text-red-400">
          {!appData ? 'Error parsing app data' : 'No files found in app data'}
        </p>
      </div>
    );
  }

  const currentFile = appData.files.find((f) => f.path === selectedFile);

  // Fullscreen content that will be rendered via portal
  const fullscreenContent = (
    <div className="fixed inset-0 w-screen h-screen z-[9999] bg-black flex flex-col overflow-hidden">
      {/* Header with tabs - conditionally hide in fullscreen preview mode */}
      {activeTab === 'code' && (
        <div className="flex items-center justify-between px-4 py-3 bg-black/30 border-b border-white/10">
          <div className="flex gap-2">
            <button
              onClick={() => setActiveTab('preview')}
              className="px-4 py-2 rounded-lg font-medium transition-all bg-slate-800 text-slate-400 hover:text-white"
            >
              üëÅÔ∏è Live Preview
            </button>
            <button
              onClick={() => setActiveTab('code')}
              className="px-4 py-2 rounded-lg font-medium transition-all bg-blue-600 text-white"
            >
              üíª Code
            </button>
          </div>

          <div className="flex items-center gap-3">
            <div className="flex items-center gap-2 text-sm text-slate-400">
              <span className="w-2 h-2 rounded-full bg-green-400 animate-pulse"></span>
              <span>Fully Interactive</span>
            </div>

            <button
              onClick={() => setIsFullscreen(false)}
              className="px-3 py-2 rounded-lg bg-slate-800 hover:bg-slate-700 text-slate-300 transition-all flex items-center gap-2"
              title="Exit Fullscreen"
            >
              <span className="text-lg">‚§ì</span>
              <span className="text-sm font-medium">Exit</span>
            </button>
          </div>
        </div>
      )}

      {/* Floating buttons when in fullscreen preview mode */}
      {activeTab === 'preview' && (
        <div className="fixed top-4 right-4 z-[110] flex items-center gap-2">
          {/* Capture for AI button */}
          <button
            onClick={handleCapture}
            disabled={isCapturing}
            className="px-4 py-2 rounded-lg bg-black/80 hover:bg-black text-white backdrop-blur-sm transition-all flex items-center gap-2 shadow-xl border border-white/20 disabled:opacity-50"
            title="Capture for AI"
          >
            {isCapturing ? (
              <span className="text-lg animate-spin">‚ü≥</span>
            ) : captureSuccess ? (
              <span className="text-lg text-green-400">‚úì</span>
            ) : (
              <span className="text-lg">üì∑</span>
            )}
            <span className="text-sm font-medium">
              {isCapturing ? 'Capturing...' : captureSuccess ? 'Captured!' : 'Capture'}
            </span>
          </button>
          {/* Exit Fullscreen button */}
          <button
            onClick={() => setIsFullscreen(false)}
            className="px-4 py-2 rounded-lg bg-black/80 hover:bg-black text-white backdrop-blur-sm transition-all flex items-center gap-2 shadow-xl border border-white/20"
            title="Exit Fullscreen"
          >
            <span className="text-lg">‚§ì</span>
            <span className="text-sm font-medium">Exit Fullscreen</span>
          </button>
        </div>
      )}

      {/* Content area */}
      <div className="flex-1 overflow-hidden">
        {activeTab === 'preview' ? (
          <div className="h-full w-full">
            <PowerfulPreview
              appDataJson={appDataJson}
              isFullscreen={true}
              onCaptureReady={handleCaptureReady}
            />
          </div>
        ) : (
          <div className="h-full flex">
            {/* File list */}
            <div className="w-64 bg-black/20 border-r border-white/10 overflow-y-auto">
              <div className="p-3 border-b border-white/10">
                <h3 className="text-xs font-semibold text-slate-400 uppercase">Files</h3>
              </div>
              {appData.files.map((file) => (
                <button
                  key={file.path}
                  onClick={() => setSelectedFile(file.path)}
                  className={`w-full text-left px-4 py-2 text-sm transition-colors ${
                    selectedFile === file.path
                      ? 'bg-blue-600/20 text-blue-300 border-l-2 border-blue-500'
                      : 'text-slate-300 hover:bg-white/5'
                  }`}
                >
                  <div className="flex items-center gap-2">
                    <span className="text-xs">
                      {file.path.endsWith('.tsx') || file.path.endsWith('.ts')
                        ? 'üìò'
                        : file.path.endsWith('.css')
                          ? 'üé®'
                          : file.path.endsWith('.json')
                            ? '‚öôÔ∏è'
                            : 'üìÑ'}
                    </span>
                    <span className="truncate">{file.path}</span>
                  </div>
                </button>
              ))}
            </div>

            {/* Code viewer */}
            <div className="flex-1 min-h-0 overflow-auto">
              {currentFile ? (
                <div className="h-full">
                  <div className="sticky top-0 bg-black/40 backdrop-blur-sm px-4 py-2 border-b border-white/10 flex items-center justify-between">
                    <span className="text-sm text-slate-300 font-mono">{currentFile.path}</span>
                    <button
                      onClick={() => {
                        navigator.clipboard.writeText(currentFile.content);
                      }}
                      className="px-3 py-1 text-xs bg-slate-800 hover:bg-slate-700 text-slate-300 rounded transition-colors"
                    >
                      üìã Copy
                    </button>
                  </div>
                  <pre className="p-4 text-sm text-slate-300 font-mono overflow-x-auto">
                    <code>{currentFile.content}</code>
                  </pre>
                </div>
              ) : (
                <div className="h-full flex items-center justify-center text-slate-500">
                  Select a file to view its contents
                </div>
              )}
            </div>
          </div>
        )}
      </div>
    </div>
  );

  // Normal (non-fullscreen) content - shows the preview with a fullscreen button
  const normalContent = (
    <div className="h-full w-full relative">
      <div className="absolute top-4 right-4 z-[100] flex items-center gap-2">
        {/* Capture for AI button */}
        <button
          onClick={handleCapture}
          disabled={isCapturing}
          className="px-4 py-2 rounded-lg bg-black/80 hover:bg-black text-white backdrop-blur-sm transition-all flex items-center gap-2 shadow-xl border border-white/20 disabled:opacity-50"
          title="Capture for AI"
        >
          {isCapturing ? (
            <span className="text-lg animate-spin">‚ü≥</span>
          ) : captureSuccess ? (
            <span className="text-lg text-green-400">‚úì</span>
          ) : (
            <span className="text-lg">üì∑</span>
          )}
          <span className="text-sm font-medium">
            {isCapturing ? 'Capturing...' : captureSuccess ? 'Captured!' : 'Capture'}
          </span>
        </button>
        {/* Fullscreen button */}
        <button
          onClick={() => setIsFullscreen(true)}
          className="px-4 py-2 rounded-lg bg-black/80 hover:bg-black text-white backdrop-blur-sm transition-all flex items-center gap-2 shadow-xl border border-white/20"
          title="Enter Fullscreen"
        >
          <span className="text-lg">‚§¢</span>
          <span className="text-sm font-medium">Fullscreen</span>
        </button>
      </div>
      <PowerfulPreview
        appDataJson={appDataJson}
        isFullscreen={false}
        onCaptureReady={handleCaptureReady}
      />
    </div>
  );

  // Render via portal when fullscreen, otherwise render normally
  return (
    <>{isFullscreen && isClient ? createPortal(fullscreenContent, document.body) : normalContent}</>
  );
}
</file>

<file path="package.json">
{
  "name": "personal-ai-app-builder",
  "version": "0.1.0",
  "private": true,
  "scripts": {
    "dev": "next dev",
    "dev:mock": "set NEXT_PUBLIC_MOCK_AI=true && next dev",
    "dev:debug": "set NEXT_PUBLIC_DEBUG_PANEL=true && set NEXT_PUBLIC_DEBUG_STATE=true && set NEXT_PUBLIC_DEBUG_API=true && next dev",
    "build": "next build",
    "start": "next start",
    "postinstall": "npx puppeteer browsers install chrome",
    "test": "jest tests/code-validator.test.ts tests/retry-logic.test.ts",
    "test:validator": "jest tests/code-validator.test.ts",
    "test:retry": "jest tests/retry-logic.test.ts",
    "test:integration": "jest tests/integration-modify-route.test.ts",
    "test:hooks": "jest src/hooks/__tests__",
    "test:services": "jest src/services/__tests__",
    "test:unit": "jest src/**/__tests__",
    "test:all": "npm test && npm run test:unit && npm run test:integration",
    "test:watch": "jest --watch",
    "test:coverage": "jest --coverage",
    "lint": "eslint src --ext .ts,.tsx",
    "lint:fix": "eslint src --ext .ts,.tsx --fix",
    "format": "prettier --write \"src/**/*.{ts,tsx,json}\"",
    "format:check": "prettier --check \"src/**/*.{ts,tsx,json}\"",
    "typecheck": "tsc --noEmit",
    "prepare": "husky"
  },
  "dependencies": {
    "@anthropic-ai/sdk": "^0.67.0",
    "@codesandbox/sandpack-react": "^2.20.0",
    "@dnd-kit/core": "^6.3.1",
    "@dnd-kit/sortable": "^10.0.0",
    "@dnd-kit/utilities": "^3.2.2",
    "@supabase/auth-helpers-nextjs": "^0.10.0",
    "@supabase/ssr": "^0.7.0",
    "@supabase/supabase-js": "^2.81.1",
    "esbuild": "^0.27.1",
    "html2canvas": "^1.4.1",
    "immer": "^11.0.1",
    "js-tiktoken": "^1.0.21",
    "jszip": "^3.10.1",
    "next": "^15.5.7",
    "openai": "^6.5.0",
    "puppeteer": "^24.32.0",
    "react": "^19.2.1",
    "react-dom": "^19.2.1",
    "tree-sitter": "^0.25.0",
    "tree-sitter-javascript": "^0.25.0",
    "tree-sitter-typescript": "^0.23.2",
    "web-tree-sitter": "^0.25.10",
    "zod": "^4.1.13",
    "zustand": "^4.5.7"
  },
  "devDependencies": {
    "@testing-library/dom": "^10.4.1",
    "@testing-library/jest-dom": "^6.9.1",
    "@testing-library/react": "^16.0.0",
    "@types/jest": "^30.0.0",
    "@types/node": "^20.8.10",
    "@types/react": "^19.2.5",
    "@types/react-dom": "^19.2.3",
    "@typescript-eslint/eslint-plugin": "^8.0.0",
    "@typescript-eslint/parser": "^8.0.0",
    "autoprefixer": "^10.4.16",
    "eslint": "^8.57.0",
    "eslint-config-next": "^15.0.0",
    "husky": "^9.0.0",
    "jest": "^30.2.0",
    "jest-environment-jsdom": "^30.2.0",
    "lint-staged": "^15.0.0",
    "postcss": "^8.4.31",
    "prettier": "^3.7.4",
    "tailwindcss": "^3.3.5",
    "ts-jest": "^29.4.5",
    "tsx": "^4.20.6",
    "typescript": "^5.2.2"
  },
  "lint-staged": {
    "*.{ts,tsx}": [
      "prettier --write",
      "eslint --fix",
      "jest --bail --findRelatedTests --passWithNoTests"
    ],
    "*.{json,md}": [
      "prettier --write --ignore-unknown"
    ]
  }
}
</file>

<file path="src/components/LayoutPreview.tsx">
'use client';

import React, { useState, useMemo, useEffect, useCallback } from 'react';
import type { UIPreferences, AppConcept, Feature } from '../types/appConcept';
import type {
  HeaderDesign,
  CardDesign,
  SidebarDesign,
  NavigationDesign,
  EffectsSettings,
  ColorSettings,
} from '../types/layoutDesign';
import { generateMockContent } from '../utils/mockContentGenerator';
import {
  DragDropCanvas,
  SortableSection,
  useSectionOrder,
  type LayoutSection,
  type SectionType,
  DEFAULT_SECTION_ORDER,
} from './layout/DragDropCanvas';
import { imageAssets, getFallbackImage } from '../utils/imageAssets';
import { imageCache } from '../utils/imageCache';

// ============================================================================
// Image Generation Types
// ============================================================================

interface GeneratedImages {
  hero?: string;
  cards: string[];
  background?: string;
}

interface ImageGenerationState {
  isGenerating: boolean;
  progress: number;
  error?: string;
}

type ViewMode = 'mobile' | 'tablet' | 'desktop';

/** Default primary color used throughout the app */
const DEFAULT_PRIMARY_COLOR = '#3B82F6';

/** Current year for copyright - extracted to avoid creating Date on every render */
const CURRENT_YEAR = new Date().getFullYear();

/** Default status colors for semantic states */
const DEFAULT_STATUS_COLORS = {
  success: '#22c55e',
  warning: '#eab308',
  error: '#ef4444',
  info: '#3b82f6',
} as const;

/** Status type for list items and badges */
type StatusType = 'success' | 'warning' | 'error' | 'info' | 'default';

/**
 * Get status color from color settings or use defaults
 */
function getStatusColor(status: StatusType, colorSettings?: Partial<ColorSettings>): string {
  switch (status) {
    case 'success':
      return colorSettings?.success || DEFAULT_STATUS_COLORS.success;
    case 'warning':
      return colorSettings?.warning || DEFAULT_STATUS_COLORS.warning;
    case 'error':
      return colorSettings?.error || DEFAULT_STATUS_COLORS.error;
    case 'info':
      return colorSettings?.info || DEFAULT_STATUS_COLORS.info;
    default:
      return colorSettings?.primary || DEFAULT_PRIMARY_COLOR;
  }
}

/**
 * Map status string to StatusType
 */
function mapStatusToType(status: string): StatusType {
  const normalizedStatus = status.toLowerCase();
  if (
    normalizedStatus.includes('success') ||
    normalizedStatus.includes('complete') ||
    normalizedStatus.includes('active')
  ) {
    return 'success';
  }
  if (
    normalizedStatus.includes('warning') ||
    normalizedStatus.includes('pending') ||
    normalizedStatus.includes('review')
  ) {
    return 'warning';
  }
  if (
    normalizedStatus.includes('error') ||
    normalizedStatus.includes('fail') ||
    normalizedStatus.includes('rejected')
  ) {
    return 'error';
  }
  if (
    normalizedStatus.includes('info') ||
    normalizedStatus.includes('draft') ||
    normalizedStatus.includes('new')
  ) {
    return 'info';
  }
  return 'default';
}

/**
 * Component design props for customization
 */
interface ComponentDesignProps {
  headerDesign?: Partial<HeaderDesign>;
  sidebarDesign?: Partial<SidebarDesign>;
  cardDesign?: Partial<CardDesign>;
  navDesign?: Partial<NavigationDesign>;
  effectsSettings?: Partial<EffectsSettings>;
  colorSettings?: Partial<ColorSettings>;
}

/**
 * Props for LayoutPreview component
 */
interface LayoutPreviewProps {
  preferences: UIPreferences;
  concept?: Partial<AppConcept>;
  className?: string;
  onPreferenceChange?: (prefs: Partial<UIPreferences>) => void;
  onElementSelect?: (elementId: string | null) => void;
  selectedElement?: string | null;
  componentDesign?: ComponentDesignProps;
  /** Enable drag-and-drop section reordering */
  enableDragDrop?: boolean;
  /** Current section order (controlled) */
  sectionOrder?: LayoutSection[];
  /** Callback when sections are reordered */
  onSectionOrderChange?: (sections: LayoutSection[]) => void;
}

/**
 * Breakpoint configuration with detailed info
 */
interface BreakpointInfo {
  width: string;
  height: string;
  numericWidth: number;
  label: string;
  description: string;
  layoutMode: 'mobile' | 'tablet' | 'desktop';
}

const BREAKPOINTS: Record<ViewMode, BreakpointInfo> = {
  mobile: {
    width: '375px',
    height: '667px',
    numericWidth: 375,
    label: 'Mobile',
    description: 'iPhone SE / Small phones',
    layoutMode: 'mobile',
  },
  tablet: {
    width: '768px',
    height: '1024px',
    numericWidth: 768,
    label: 'Tablet',
    description: 'iPad / Tablets',
    layoutMode: 'tablet',
  },
  desktop: {
    width: '100%',
    height: '100%',
    numericWidth: 1200,
    label: 'Desktop',
    description: 'Large screens',
    layoutMode: 'desktop',
  },
};

/**
 * Animation demo configuration - sequence of elements to animate
 */
const ANIMATION_DEMO_SEQUENCE = ['header', 'hero', 'stats', 'cards', 'list', 'footer'] as const;

/** Duration for each element highlight in ms */
const ANIMATION_DEMO_DURATION = 800;

/**
 * Get device frame dimensions
 */
function getDeviceDimensions(mode: ViewMode): { width: string; height: string } {
  const breakpoint = BREAKPOINTS[mode];
  return { width: breakpoint.width, height: breakpoint.height };
}

/**
 * Style presets based on UI style preference
 */
const stylePresets = {
  modern: {
    borderRadius: '0.75rem',
    cardShadow: '0 4px 6px -1px rgba(0, 0, 0, 0.1)',
    buttonStyle: 'rounded-xl font-medium',
    fontWeight: 'font-medium',
    spacing: 'gap-4',
  },
  minimalist: {
    borderRadius: '0.25rem',
    cardShadow: 'none',
    buttonStyle: 'rounded font-normal',
    fontWeight: 'font-normal',
    spacing: 'gap-6',
  },
  playful: {
    borderRadius: '1.5rem',
    cardShadow: '0 10px 15px -3px rgba(0, 0, 0, 0.1)',
    buttonStyle: 'rounded-full font-bold',
    fontWeight: 'font-bold',
    spacing: 'gap-3',
  },
  professional: {
    borderRadius: '0.375rem',
    cardShadow: '0 1px 3px 0 rgba(0, 0, 0, 0.1)',
    buttonStyle: 'rounded-md font-semibold',
    fontWeight: 'font-semibold',
    spacing: 'gap-5',
  },
  custom: {
    borderRadius: '0.5rem',
    cardShadow: '0 4px 6px -1px rgba(0, 0, 0, 0.1)',
    buttonStyle: 'rounded-lg font-medium',
    fontWeight: 'font-medium',
    spacing: 'gap-4',
  },
} as const;

/** Type for style preset values */
type StylePreset = (typeof stylePresets)[keyof typeof stylePresets];

/**
 * Color scheme presets
 */
const colorSchemes = {
  light: {
    bg: 'bg-gray-50',
    text: 'text-gray-900',
    textMuted: 'text-gray-600',
    card: 'bg-white',
    border: 'border-gray-200',
    sidebar: 'bg-white',
    header: 'bg-white',
  },
  dark: {
    bg: 'bg-slate-900',
    text: 'text-white',
    textMuted: 'text-slate-400',
    card: 'bg-slate-800',
    border: 'border-slate-700',
    sidebar: 'bg-slate-800',
    header: 'bg-slate-800',
  },
  auto: {
    // Auto mode: uses a balanced theme that works in both light/dark contexts
    bg: 'bg-zinc-900',
    text: 'text-zinc-100',
    textMuted: 'text-zinc-400',
    card: 'bg-zinc-800',
    border: 'border-zinc-700',
    sidebar: 'bg-zinc-850',
    header: 'bg-zinc-800',
  },
  custom: {
    // Custom mode: neutral base that works well with custom primary colors
    bg: 'bg-neutral-900',
    text: 'text-neutral-100',
    textMuted: 'text-neutral-400',
    card: 'bg-neutral-800',
    border: 'border-neutral-700',
    sidebar: 'bg-neutral-800',
    header: 'bg-neutral-800',
  },
} as const;

/** Type for color scheme values */
type ColorScheme = (typeof colorSchemes)[keyof typeof colorSchemes];

/**
 * Header style classes based on HeaderDesign.style
 */
const headerStyles = {
  solid: (colors: ColorScheme) => colors.header,
  gradient: (colors: ColorScheme, primary: string) =>
    `bg-gradient-to-r from-[${primary}] to-[${primary}80]`,
  blur: (colors: ColorScheme) => `backdrop-blur-md bg-opacity-80 ${colors.header}`,
  transparent: () => 'bg-transparent',
} as const;

/**
 * Card hover effect classes based on CardDesign.hoverEffect
 */
const cardHoverEffects = {
  none: '',
  lift: 'hover:-translate-y-1 hover:shadow-lg transition-all duration-200',
  glow: 'hover:shadow-[0_0_20px_rgba(59,130,246,0.3)] transition-all duration-200',
  scale: 'hover:scale-[1.02] transition-transform duration-200',
  border: 'hover:border-blue-500 transition-colors duration-200',
} as const;

/**
 * Navigation item style classes based on NavigationDesign.itemStyle
 */
const navItemStyles = {
  text: (colors: ColorScheme) => `${colors.textMuted} hover:opacity-80`,
  pills: (colors: ColorScheme, primary: string) =>
    `px-3 py-1 rounded-full ${colors.textMuted} hover:bg-[${primary}]/10`,
  underline: (colors: ColorScheme) =>
    `${colors.textMuted} border-b-2 border-transparent hover:border-current pb-1`,
  boxed: (colors: ColorScheme) =>
    `px-3 py-1 border rounded ${colors.border} ${colors.textMuted} hover:border-current`,
} as const;

/**
 * Animation classes based on EffectsSettings.animations
 */
const animationClasses = {
  none: {
    base: '',
    hover: '',
    transition: '',
  },
  subtle: {
    base: 'transition-all duration-150 ease-out',
    hover: 'hover:scale-[1.01]',
    transition: 'transition-opacity duration-150',
  },
  smooth: {
    base: 'transition-all duration-300 ease-in-out',
    hover: 'hover:scale-[1.02]',
    transition: 'transition-all duration-300',
  },
  playful: {
    base: 'transition-all duration-500 ease-[cubic-bezier(0.68,-0.55,0.265,1.55)]',
    hover: 'hover:scale-[1.05] hover:-rotate-1',
    transition: 'transition-all duration-500',
  },
} as const;

/**
 * Get animation class based on animation level
 */
function getAnimationClass(
  animation?: EffectsSettings['animations'],
  type: 'base' | 'hover' | 'transition' = 'base'
): string {
  const level = animation || 'none';
  return animationClasses[level]?.[type] || '';
}

/**
 * Blur intensity classes based on EffectsSettings.blur
 */
const blurClasses = {
  none: '',
  subtle: 'backdrop-blur-sm',
  medium: 'backdrop-blur-md',
  strong: 'backdrop-blur-xl',
} as const;

/**
 * Get blur class based on blur level
 */
function getBlurClass(blur?: EffectsSettings['blur']): string {
  return blurClasses[blur || 'none'] || '';
}

/**
 * Border radius classes based on EffectsSettings.borderRadius
 */
const borderRadiusClasses = {
  none: 'rounded-none',
  sm: 'rounded-sm',
  md: 'rounded-md',
  lg: 'rounded-lg',
  xl: 'rounded-xl',
  full: 'rounded-full',
} as const;

/**
 * Get border radius class
 */
function getBorderRadiusClass(radius?: EffectsSettings['borderRadius']): string {
  return borderRadiusClasses[radius || 'md'] || 'rounded-md';
}

/**
 * Shadow classes based on EffectsSettings.shadows
 */
const shadowClasses = {
  none: 'shadow-none',
  subtle: 'shadow-sm',
  medium: 'shadow-md',
  strong: 'shadow-xl',
} as const;

/**
 * Get shadow class
 */
function getShadowClass(shadow?: EffectsSettings['shadows']): string {
  return shadowClasses[shadow || 'medium'] || 'shadow-md';
}

/**
 * Selectable wrapper component for element selection
 */
interface SelectableProps {
  id: string;
  children: React.ReactNode;
  isSelected: boolean;
  onClick: (id: string) => void;
  className?: string;
  style?: React.CSSProperties;
}

function Selectable({ id, children, isSelected, onClick, className = '', style }: SelectableProps) {
  const handleKeyDown = (e: React.KeyboardEvent) => {
    if (e.key === 'Enter' || e.key === ' ') {
      e.preventDefault();
      e.stopPropagation();
      onClick(id);
    }
  };

  return (
    <div
      role="button"
      tabIndex={0}
      onClick={(e) => {
        e.stopPropagation();
        onClick(id);
      }}
      onKeyDown={handleKeyDown}
      aria-pressed={isSelected}
      aria-label={`Select ${id} element`}
      className={`cursor-pointer transition-all ${
        isSelected
          ? 'ring-2 ring-blue-500 ring-offset-2 ring-offset-transparent'
          : 'hover:ring-1 hover:ring-blue-400/50'
      } ${className}`}
      style={style}
    >
      {children}
    </div>
  );
}

/**
 * Header component for preview with style variants
 */
interface HeaderProps {
  appName: string;
  navItems: string[];
  colors: ColorScheme;
  style: StylePreset;
  primaryColor?: string;
  onElementSelect?: (id: string | null) => void;
  selectedElement?: string | null;
  headerDesign?: Partial<HeaderDesign>;
  navDesign?: Partial<NavigationDesign>;
  effectsSettings?: Partial<EffectsSettings>;
  isMobile?: boolean;
}

function Header({
  appName,
  navItems,
  colors,
  style,
  primaryColor,
  onElementSelect,
  selectedElement,
  headerDesign,
  navDesign,
  effectsSettings,
  isMobile = false,
}: HeaderProps) {
  // Animation classes based on effects settings
  const animBase = getAnimationClass(effectsSettings?.animations, 'base');
  const animHover = getAnimationClass(effectsSettings?.animations, 'hover');
  const handleSelect = (id: string) => {
    onElementSelect?.(selectedElement === id ? null : id);
  };

  // Get header background style with blur and gradient support
  const getHeaderBgStyle = () => {
    const headerStyle = headerDesign?.style || 'solid';
    const blurLevel = effectsSettings?.blur || 'none';
    const useGradients = effectsSettings?.gradients ?? false;

    switch (headerStyle) {
      case 'gradient':
        return useGradients
          ? `bg-gradient-to-r from-slate-800 via-slate-700 to-slate-800`
          : `bg-gradient-to-r from-slate-800 to-slate-700`;
      case 'blur':
        const blurClass = getBlurClass(blurLevel !== 'none' ? blurLevel : 'medium');
        return `${blurClass} bg-slate-800/70`;
      case 'transparent':
        return blurLevel !== 'none'
          ? `${getBlurClass(blurLevel)} bg-transparent`
          : 'bg-transparent';
      case 'solid':
      default:
        return colors.header;
    }
  };

  // Get navigation item style
  const getNavItemStyle = (isActive: boolean) => {
    const itemStyle = navDesign?.itemStyle || 'text';
    const baseStyle = 'text-sm cursor-pointer transition-all';

    if (isActive) {
      return `${baseStyle} text-white`;
    }

    switch (itemStyle) {
      case 'pills':
        return `${baseStyle} px-3 py-1 rounded-full ${colors.textMuted} hover:bg-white/10`;
      case 'underline':
        return `${baseStyle} ${colors.textMuted} border-b-2 border-transparent hover:border-current pb-1`;
      case 'boxed':
        return `${baseStyle} px-3 py-1 border rounded ${colors.border} ${colors.textMuted} hover:border-current`;
      case 'text':
      default:
        return `${baseStyle} ${colors.textMuted} hover:opacity-80`;
    }
  };

  // Get height classes
  const getHeightClass = () => {
    switch (headerDesign?.height) {
      case 'compact':
        return 'py-2';
      case 'tall':
        return 'py-5';
      case 'standard':
      default:
        return 'py-3';
    }
  };

  return (
    <Selectable
      id="header"
      isSelected={selectedElement === 'header'}
      onClick={handleSelect}
      className={`${getHeaderBgStyle()} border-b ${colors.border} px-4 ${getHeightClass()}`}
    >
      <div className="flex items-center justify-between">
        <div className={`${style.fontWeight} ${colors.text} ${isMobile ? 'text-sm' : ''}`}>
          {appName || 'App Name'}
        </div>
        {/* Navigation - hidden on mobile */}
        {!isMobile && (
          <nav className="flex items-center gap-4">
            {navItems.slice(0, 4).map((item, index) => (
              <span key={`nav-${item}`} className={getNavItemStyle(index === 0)}>
                {item}
              </span>
            ))}
          </nav>
        )}
        <div className="flex items-center gap-2">
          {/* Mobile menu button */}
          {isMobile && (
            <button
              type="button"
              className={`p-2 rounded-lg ${colors.textMuted} hover:opacity-80`}
              aria-label="Open menu"
            >
              <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path
                  strokeLinecap="round"
                  strokeLinejoin="round"
                  strokeWidth={2}
                  d="M4 6h16M4 12h16M4 18h16"
                />
              </svg>
            </button>
          )}
          {headerDesign?.hasCTA !== false && !isMobile && (
            <button
              type="button"
              className={`px-3 py-1.5 text-sm text-white ${style.buttonStyle} ${animBase} ${animHover}`}
              style={{ backgroundColor: primaryColor || DEFAULT_PRIMARY_COLOR }}
            >
              {headerDesign?.ctaText || 'Sign In'}
            </button>
          )}
        </div>
      </div>
    </Selectable>
  );
}

/**
 * Sidebar component for dashboard layout with collapsibility
 */
interface SidebarProps {
  navItems: string[];
  colors: ColorScheme;
  style: StylePreset;
  primaryColor?: string;
  onElementSelect?: (id: string | null) => void;
  selectedElement?: string | null;
  sidebarDesign?: Partial<SidebarDesign>;
}

function Sidebar({
  navItems,
  colors,
  style,
  primaryColor,
  onElementSelect,
  selectedElement,
  sidebarDesign,
}: SidebarProps) {
  const [isCollapsed, setIsCollapsed] = useState(sidebarDesign?.defaultCollapsed || false);

  const handleSelect = (id: string) => {
    onElementSelect?.(selectedElement === id ? null : id);
  };

  // Get width based on design settings
  const getWidthClass = () => {
    if (isCollapsed && sidebarDesign?.collapsible) {
      return 'w-16';
    }
    switch (sidebarDesign?.width) {
      case 'narrow':
        return 'w-36';
      case 'wide':
        return 'w-64';
      case 'standard':
      default:
        return 'w-48';
    }
  };

  // Icon placeholder component
  const IconPlaceholder = () => (
    <svg className="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
      <path
        strokeLinecap="round"
        strokeLinejoin="round"
        strokeWidth={2}
        d="M4 6h16M4 12h16M4 18h16"
      />
    </svg>
  );

  return (
    <Selectable
      id="sidebar"
      isSelected={selectedElement === 'sidebar'}
      onClick={handleSelect}
      className={`${colors.sidebar} border-r ${colors.border} ${getWidthClass()} p-4 flex-shrink-0 transition-all duration-200`}
    >
      <div className={`${style.spacing} flex flex-col`}>
        {/* Collapse toggle button */}
        {sidebarDesign?.collapsible && (
          <button
            type="button"
            onClick={(e) => {
              e.stopPropagation();
              setIsCollapsed(!isCollapsed);
            }}
            className={`mb-4 p-2 rounded-lg ${colors.textMuted} hover:bg-white/10 transition-colors self-end`}
            aria-label={isCollapsed ? 'Expand sidebar' : 'Collapse sidebar'}
          >
            <svg
              className={`w-4 h-4 transition-transform ${isCollapsed ? 'rotate-180' : ''}`}
              fill="none"
              viewBox="0 0 24 24"
              stroke="currentColor"
            >
              <path
                strokeLinecap="round"
                strokeLinejoin="round"
                strokeWidth={2}
                d="M11 19l-7-7 7-7m8 14l-7-7 7-7"
              />
            </svg>
          </button>
        )}

        {/* Menu title */}
        {!isCollapsed && <div className={`${style.fontWeight} ${colors.text} mb-4`}>Menu</div>}

        {/* Navigation items */}
        {navItems.map((item, index) => (
          <div
            key={`sidebar-${item}`}
            className={`px-3 py-2 rounded-lg text-sm cursor-pointer transition-all flex items-center gap-3 ${
              index === 0 ? 'text-white' : `${colors.textMuted} hover:opacity-80`
            }`}
            style={index === 0 ? { backgroundColor: primaryColor || DEFAULT_PRIMARY_COLOR } : {}}
            title={isCollapsed ? item : undefined}
          >
            {(sidebarDesign?.iconOnly || isCollapsed) && <IconPlaceholder />}
            {!isCollapsed && !sidebarDesign?.iconOnly && item}
          </div>
        ))}
      </div>
    </Selectable>
  );
}

/**
 * Hero section component
 */
interface HeroProps {
  title: string;
  subtitle: string;
  cta: string;
  colors: ColorScheme;
  style: StylePreset;
  primaryColor?: string;
  onElementSelect?: (id: string | null) => void;
  selectedElement?: string | null;
  effectsSettings?: Partial<EffectsSettings>;
  backgroundImage?: string;
}

function Hero({
  title,
  subtitle,
  cta,
  colors,
  style,
  primaryColor,
  onElementSelect,
  selectedElement,
  effectsSettings,
  backgroundImage,
}: HeroProps) {
  const handleSelect = (id: string) => {
    onElementSelect?.(selectedElement === id ? null : id);
  };

  const animationBase = getAnimationClass(effectsSettings?.animations, 'base');
  const animationHover = getAnimationClass(effectsSettings?.animations, 'hover');
  const radiusClass = getBorderRadiusClass(effectsSettings?.borderRadius);

  // Generate background style with image or gradient fallback
  const getHeroBackgroundStyle = (): React.CSSProperties => {
    const color = primaryColor || DEFAULT_PRIMARY_COLOR;

    if (backgroundImage) {
      return {
        backgroundImage: `linear-gradient(rgba(0,0,0,0.5), rgba(0,0,0,0.7)), url('${backgroundImage}')`,
        backgroundSize: 'cover',
        backgroundPosition: 'center',
      };
    }

    if (effectsSettings?.gradients) {
      return {
        background: `linear-gradient(135deg, ${color}10 0%, transparent 50%)`,
      };
    }
    return {};
  };

  const hasImage = !!backgroundImage;

  return (
    <Selectable
      id="hero"
      isSelected={selectedElement === 'hero'}
      onClick={handleSelect}
      className={`py-12 px-6 text-center relative ${hasImage ? 'min-h-[200px] flex flex-col justify-center' : ''}`}
      style={getHeroBackgroundStyle()}
    >
      <h1
        className={`text-2xl ${style.fontWeight} ${hasImage ? 'text-white' : colors.text} mb-3 ${animationBase}`}
      >
        {title}
      </h1>
      <p
        className={`${hasImage ? 'text-white/80' : colors.textMuted} mb-6 max-w-md mx-auto text-sm ${animationBase}`}
      >
        {subtitle}
      </p>
      <button
        type="button"
        className={`px-6 py-2.5 text-white ${style.buttonStyle} ${radiusClass} ${animationBase} ${animationHover}`}
        style={{ backgroundColor: primaryColor || DEFAULT_PRIMARY_COLOR }}
      >
        {cta}
      </button>
    </Selectable>
  );
}

/**
 * Stats row component
 */
interface StatsRowProps {
  stats: Array<{ label: string; value: string }>;
  colors: ColorScheme;
  style: StylePreset;
  onElementSelect?: (id: string | null) => void;
  selectedElement?: string | null;
  effectsSettings?: Partial<EffectsSettings>;
}

function StatsRow({
  stats,
  colors,
  style,
  onElementSelect,
  selectedElement,
  effectsSettings,
}: StatsRowProps) {
  const handleSelect = (id: string) => {
    onElementSelect?.(selectedElement === id ? null : id);
  };

  const radiusClass = getBorderRadiusClass(effectsSettings?.borderRadius);
  const shadowClass = getShadowClass(effectsSettings?.shadows);
  const animationBase = getAnimationClass(effectsSettings?.animations, 'base');
  const hoverAnimation = getAnimationClass(effectsSettings?.animations, 'hover');

  return (
    <Selectable
      id="stats"
      isSelected={selectedElement === 'stats'}
      onClick={handleSelect}
      className="px-4 py-6"
    >
      <div className={`grid grid-cols-2 sm:grid-cols-4 ${style.spacing}`}>
        {stats.slice(0, 4).map((stat) => (
          <div
            key={`stat-${stat.label}`}
            className={`${colors.card} border ${colors.border} p-4 text-center ${radiusClass} ${shadowClass} ${animationBase} ${hoverAnimation}`}
          >
            <div className={`text-xl ${style.fontWeight} ${colors.text}`}>{stat.value}</div>
            <div className={`text-xs ${colors.textMuted} mt-1`}>{stat.label}</div>
          </div>
        ))}
      </div>
    </Selectable>
  );
}

/**
 * Card grid component with hover effects
 */
interface CardGridProps {
  cards: Array<{ title: string; subtitle: string; tag: string }>;
  colors: ColorScheme;
  style: StylePreset;
  primaryColor?: string;
  onElementSelect?: (id: string | null) => void;
  selectedElement?: string | null;
  cardDesign?: Partial<CardDesign>;
  effectsSettings?: Partial<EffectsSettings>;
  cardImages?: string[];
}

function CardGrid({
  cards,
  colors,
  style,
  primaryColor,
  onElementSelect,
  selectedElement,
  cardDesign,
  effectsSettings,
  cardImages = [],
}: CardGridProps) {
  const handleSelect = (id: string) => {
    onElementSelect?.(selectedElement === id ? null : id);
  };

  // Get hover effect class - combine with animation level
  const getHoverEffect = () => {
    const effect = cardDesign?.hoverEffect || 'none';
    const animationHover = getAnimationClass(effectsSettings?.animations, 'hover');
    const hoverEffect = cardHoverEffects[effect] || '';
    return `${hoverEffect} ${animationHover}`.trim();
  };

  // Get card style class with shadow from effects settings
  const getCardStyleClass = () => {
    const cardStyle = cardDesign?.style || 'bordered';
    const shadowClass = getShadowClass(effectsSettings?.shadows);
    switch (cardStyle) {
      case 'minimal':
        return `${colors.card}`;
      case 'elevated':
        return `${colors.card} ${shadowClass}`;
      case 'filled':
        return 'bg-gradient-to-br from-slate-700 to-slate-800';
      case 'bordered':
      default:
        return `${colors.card} border ${colors.border}`;
    }
  };

  // Get border radius from effects settings
  const radiusClass = getBorderRadiusClass(effectsSettings?.borderRadius);
  const animationBase = getAnimationClass(effectsSettings?.animations, 'base');
  const showImages = cardImages.length > 0 || cardDesign?.imagePosition !== 'none';

  return (
    <Selectable
      id="cards"
      isSelected={selectedElement === 'cards'}
      onClick={handleSelect}
      className="px-4 py-6"
    >
      <div className={`grid grid-cols-1 sm:grid-cols-2 ${style.spacing}`}>
        {cards.slice(0, 4).map((card, index) => {
          const cardImage = cardImages[index];
          const hasImage = !!cardImage;

          return (
            <div
              key={`card-${card.title}`}
              className={`${getCardStyleClass()} overflow-hidden ${getHoverEffect()} ${radiusClass} ${animationBase}`}
            >
              {/* Card Image */}
              {hasImage && (
                <div className="relative h-32 overflow-hidden">
                  <img
                    src={cardImage}
                    alt={card.title}
                    className="w-full h-full object-cover"
                    onError={(e) => {
                      // Fallback to placeholder on error
                      e.currentTarget.src = imageAssets.getPlaceholder(400, 200, {
                        text: card.title,
                      });
                    }}
                  />
                </div>
              )}
              {/* Card Content */}
              <div className="p-4">
                <div className="flex items-start justify-between mb-2">
                  <h3 className={`${style.fontWeight} ${colors.text} text-sm`}>{card.title}</h3>
                  {cardDesign?.showBadge !== false && (
                    <span
                      className="text-xs px-2 py-0.5 rounded-full text-white"
                      style={{ backgroundColor: primaryColor || DEFAULT_PRIMARY_COLOR }}
                    >
                      {card.tag}
                    </span>
                  )}
                </div>
                <p className={`text-xs ${colors.textMuted}`}>{card.subtitle}</p>
                {cardDesign?.showFooter && (
                  <div className={`mt-3 pt-3 border-t ${colors.border} flex justify-end`}>
                    <button
                      type="button"
                      className={`text-xs ${colors.textMuted} hover:opacity-80`}
                    >
                      View Details
                    </button>
                  </div>
                )}
              </div>
            </div>
          );
        })}
      </div>
    </Selectable>
  );
}

/**
 * List items component with status colors
 */
interface ListItemsProps {
  items: Array<{ title: string; status: string; meta: string }>;
  colors: ColorScheme;
  style: StylePreset;
  onElementSelect?: (id: string | null) => void;
  selectedElement?: string | null;
  effectsSettings?: Partial<EffectsSettings>;
  colorSettings?: Partial<ColorSettings>;
}

function ListItems({
  items,
  colors,
  style,
  onElementSelect,
  selectedElement,
  effectsSettings,
  colorSettings,
}: ListItemsProps) {
  const handleSelect = (id: string) => {
    onElementSelect?.(selectedElement === id ? null : id);
  };

  const radiusClass = getBorderRadiusClass(effectsSettings?.borderRadius);
  const animationBase = getAnimationClass(effectsSettings?.animations, 'base');
  const hoverAnimation = getAnimationClass(effectsSettings?.animations, 'hover');

  // Get status badge styling based on status text
  const getStatusBadgeStyle = (status: string): { backgroundColor: string; color: string } => {
    const statusType = mapStatusToType(status);
    const bgColor = getStatusColor(statusType, colorSettings);
    return {
      backgroundColor: `${bgColor}20`, // 20% opacity background
      color: bgColor,
    };
  };

  return (
    <Selectable
      id="list"
      isSelected={selectedElement === 'list'}
      onClick={handleSelect}
      className="px-4 py-6"
    >
      <div className={`${colors.card} border ${colors.border} overflow-hidden ${radiusClass}`}>
        {items.slice(0, 5).map((item, index, slicedArr) => (
          <div
            key={`list-${item.title}`}
            className={`px-4 py-3 flex items-center justify-between ${animationBase} ${hoverAnimation} hover:${colors.card} ${
              index !== slicedArr.length - 1 ? `border-b ${colors.border}` : ''
            }`}
          >
            <div>
              <div className={`text-sm ${colors.text}`}>{item.title}</div>
              <div className={`text-xs ${colors.textMuted}`}>{item.meta}</div>
            </div>
            <span
              className="text-xs px-2 py-1 rounded-full font-medium"
              style={getStatusBadgeStyle(item.status)}
            >
              {item.status}
            </span>
          </div>
        ))}
      </div>
    </Selectable>
  );
}

/**
 * Footer component for preview
 */
interface FooterProps {
  appName: string;
  colors: ColorScheme;
  onElementSelect?: (id: string | null) => void;
  selectedElement?: string | null;
}

function Footer({ appName, colors, onElementSelect, selectedElement }: FooterProps) {
  const handleSelect = (id: string) => {
    onElementSelect?.(selectedElement === id ? null : id);
  };

  return (
    <Selectable
      id="footer"
      isSelected={selectedElement === 'footer'}
      onClick={handleSelect}
      className={`${colors.header} border-t ${colors.border} px-4 py-4`}
    >
      <div className="flex items-center justify-between">
        <div className={`text-xs ${colors.textMuted}`}>
          ¬© {CURRENT_YEAR} {appName || 'My App'}. All rights reserved.
        </div>
        <div className="flex items-center gap-4">
          <button
            type="button"
            className={`text-xs ${colors.textMuted} hover:opacity-80`}
            aria-label="View privacy policy"
          >
            Privacy
          </button>
          <button
            type="button"
            className={`text-xs ${colors.textMuted} hover:opacity-80`}
            aria-label="View terms of service"
          >
            Terms
          </button>
        </div>
      </div>
    </Selectable>
  );
}

/**
 * Shared props for layout components
 */
interface LayoutComponentProps {
  content: ReturnType<typeof generateMockContent>;
  colors: ColorScheme;
  style: StylePreset;
  primaryColor?: string;
  appName: string;
  onElementSelect?: (id: string | null) => void;
  selectedElement?: string | null;
  // Component design props
  headerDesign?: Partial<HeaderDesign>;
  sidebarDesign?: Partial<SidebarDesign>;
  cardDesign?: Partial<CardDesign>;
  navDesign?: Partial<NavigationDesign>;
  effectsSettings?: Partial<EffectsSettings>;
  colorSettings?: Partial<ColorSettings>;
  // Responsive
  viewMode?: ViewMode;
  // Generated images
  generatedImages?: GeneratedImages;
}

/**
 * Dashboard layout renderer
 */
function DashboardLayout({
  content,
  colors,
  style,
  primaryColor,
  appName,
  onElementSelect,
  selectedElement,
  headerDesign,
  sidebarDesign,
  cardDesign,
  navDesign,
  effectsSettings,
  colorSettings,
  viewMode = 'desktop',
  generatedImages,
}: LayoutComponentProps) {
  const isMobile = viewMode === 'mobile';
  const isTablet = viewMode === 'tablet';

  return (
    <div className={`flex flex-col h-full ${colors.bg}`}>
      <Header
        appName={appName}
        navItems={content.navItems}
        colors={colors}
        style={style}
        primaryColor={primaryColor}
        onElementSelect={onElementSelect}
        selectedElement={selectedElement}
        headerDesign={headerDesign}
        navDesign={navDesign}
        effectsSettings={effectsSettings}
        isMobile={isMobile}
      />
      <div className="flex flex-1 overflow-hidden">
        {/* Hide sidebar on mobile, show collapsed on tablet */}
        {!isMobile && (
          <Sidebar
            navItems={content.navItems}
            colors={colors}
            style={style}
            primaryColor={primaryColor}
            onElementSelect={onElementSelect}
            selectedElement={selectedElement}
            sidebarDesign={{
              ...sidebarDesign,
              // Force collapsed on tablet
              defaultCollapsed: isTablet ? true : sidebarDesign?.defaultCollapsed,
            }}
          />
        )}
        <main className={`flex-1 min-h-0 overflow-y-auto ${isMobile ? 'p-2' : 'p-4'}`}>
          <StatsRow
            stats={content.stats}
            colors={colors}
            style={style}
            onElementSelect={onElementSelect}
            selectedElement={selectedElement}
            effectsSettings={effectsSettings}
          />
          <CardGrid
            cards={content.cards}
            colors={colors}
            style={style}
            primaryColor={primaryColor}
            onElementSelect={onElementSelect}
            selectedElement={selectedElement}
            cardDesign={cardDesign}
            effectsSettings={effectsSettings}
            cardImages={generatedImages?.cards}
          />
          <ListItems
            items={content.listItems}
            colors={colors}
            style={style}
            onElementSelect={onElementSelect}
            selectedElement={selectedElement}
            effectsSettings={effectsSettings}
            colorSettings={colorSettings}
          />
        </main>
      </div>
      <Footer
        appName={appName}
        colors={colors}
        onElementSelect={onElementSelect}
        selectedElement={selectedElement}
      />
    </div>
  );
}

/**
 * Multi-page layout renderer
 */
function MultiPageLayout({
  content,
  colors,
  style,
  primaryColor,
  appName,
  onElementSelect,
  selectedElement,
  headerDesign,
  cardDesign,
  navDesign,
  effectsSettings,
  colorSettings: _colorSettings, // Not used in this layout but part of shared props
  viewMode = 'desktop',
  generatedImages,
}: LayoutComponentProps) {
  const isMobile = viewMode === 'mobile';

  return (
    <div className={`flex flex-col h-full ${colors.bg}`}>
      <Header
        appName={appName}
        navItems={content.navItems}
        colors={colors}
        style={style}
        primaryColor={primaryColor}
        onElementSelect={onElementSelect}
        selectedElement={selectedElement}
        headerDesign={headerDesign}
        navDesign={navDesign}
        effectsSettings={effectsSettings}
        isMobile={isMobile}
      />
      <main className={`flex-1 min-h-0 overflow-y-auto ${isMobile ? 'px-2' : ''}`}>
        <Hero
          title={content.hero.title}
          subtitle={content.hero.subtitle}
          cta={content.hero.cta}
          colors={colors}
          style={style}
          primaryColor={primaryColor}
          onElementSelect={onElementSelect}
          selectedElement={selectedElement}
          effectsSettings={effectsSettings}
          backgroundImage={generatedImages?.hero}
        />
        <StatsRow
          stats={content.stats}
          colors={colors}
          style={style}
          onElementSelect={onElementSelect}
          selectedElement={selectedElement}
          effectsSettings={effectsSettings}
        />
        <CardGrid
          cards={content.cards}
          colors={colors}
          style={style}
          primaryColor={primaryColor}
          onElementSelect={onElementSelect}
          selectedElement={selectedElement}
          cardDesign={cardDesign}
          effectsSettings={effectsSettings}
          cardImages={generatedImages?.cards}
        />
      </main>
      <Footer
        appName={appName}
        colors={colors}
        onElementSelect={onElementSelect}
        selectedElement={selectedElement}
      />
    </div>
  );
}

/**
 * Single-page layout renderer
 */
function SinglePageLayout({
  content,
  colors,
  style,
  primaryColor,
  appName,
  onElementSelect,
  selectedElement,
  headerDesign,
  cardDesign,
  navDesign,
  effectsSettings,
  colorSettings,
  viewMode = 'desktop',
  generatedImages,
}: LayoutComponentProps) {
  const isMobile = viewMode === 'mobile';

  return (
    <div className={`flex flex-col h-full ${colors.bg}`}>
      <Header
        appName={appName}
        navItems={content.navItems}
        colors={colors}
        style={style}
        primaryColor={primaryColor}
        onElementSelect={onElementSelect}
        selectedElement={selectedElement}
        headerDesign={headerDesign}
        navDesign={navDesign}
        effectsSettings={effectsSettings}
        isMobile={isMobile}
      />
      <main className={`flex-1 min-h-0 overflow-y-auto ${isMobile ? 'px-2' : ''}`}>
        <Hero
          title={content.hero.title}
          subtitle={content.hero.subtitle}
          cta={content.hero.cta}
          colors={colors}
          style={style}
          primaryColor={primaryColor}
          onElementSelect={onElementSelect}
          selectedElement={selectedElement}
          effectsSettings={effectsSettings}
          backgroundImage={generatedImages?.hero}
        />
        <CardGrid
          cards={content.cards}
          colors={colors}
          style={style}
          primaryColor={primaryColor}
          onElementSelect={onElementSelect}
          selectedElement={selectedElement}
          cardDesign={cardDesign}
          effectsSettings={effectsSettings}
          cardImages={generatedImages?.cards}
        />
        <ListItems
          items={content.listItems}
          colors={colors}
          style={style}
          onElementSelect={onElementSelect}
          selectedElement={selectedElement}
          effectsSettings={effectsSettings}
          colorSettings={colorSettings}
        />
      </main>
      <Footer
        appName={appName}
        colors={colors}
        onElementSelect={onElementSelect}
        selectedElement={selectedElement}
      />
    </div>
  );
}

/**
 * LayoutPreview component - Real-time visual preview
 */
export function LayoutPreview({
  preferences,
  concept,
  className = '',
  onPreferenceChange,
  onElementSelect,
  selectedElement,
  componentDesign,
  enableDragDrop = false,
  sectionOrder: externalSectionOrder,
  onSectionOrderChange,
}: LayoutPreviewProps) {
  const [viewMode, setViewMode] = useState<ViewMode>('desktop');
  const [isAnimationDemo, setIsAnimationDemo] = useState(false);
  const [animationDemoIndex, setAnimationDemoIndex] = useState(0);
  const [showSectionPanel, setShowSectionPanel] = useState(false);

  // Image generation state
  const [generatedImages, setGeneratedImages] = useState<GeneratedImages>({ cards: [] });
  const [imageGenState, setImageGenState] = useState<ImageGenerationState>({
    isGenerating: false,
    progress: 0,
  });

  // Initialize image cache on mount
  useEffect(() => {
    imageCache.initialize();
  }, []);

  // Internal section order state (used when not controlled externally)
  const layoutType = preferences.layout || 'single-page';
  const {
    sections: internalSections,
    reorderSections: internalReorder,
    toggleSectionVisibility,
    resetToDefault,
  } = useSectionOrder(layoutType);

  // Use external section order if provided, otherwise use internal
  const sections = externalSectionOrder || internalSections;
  const handleSectionReorder = useCallback(
    (newSections: LayoutSection[]) => {
      if (onSectionOrderChange) {
        onSectionOrderChange(newSections);
      } else {
        internalReorder(newSections);
      }
    },
    [onSectionOrderChange, internalReorder]
  );

  // Animation demo element (overrides selectedElement during demo)
  const demoElement = isAnimationDemo ? ANIMATION_DEMO_SEQUENCE[animationDemoIndex] : null;
  const effectiveSelectedElement = isAnimationDemo ? demoElement : selectedElement;

  // Start animation demo
  const startAnimationDemo = useCallback(() => {
    setIsAnimationDemo(true);
    setAnimationDemoIndex(0);
  }, []);

  // Stop animation demo
  const stopAnimationDemo = useCallback(() => {
    setIsAnimationDemo(false);
    setAnimationDemoIndex(0);
  }, []);

  // Animation demo cycle effect
  useEffect(() => {
    if (!isAnimationDemo) return;

    const timer = setInterval(() => {
      setAnimationDemoIndex((prev) => {
        const nextIndex = prev + 1;
        if (nextIndex >= ANIMATION_DEMO_SEQUENCE.length) {
          // End demo after cycling through all elements
          setIsAnimationDemo(false);
          return 0;
        }
        return nextIndex;
      });
    }, ANIMATION_DEMO_DURATION);

    return () => clearInterval(timer);
  }, [isAnimationDemo]);

  // Stable stringified key for coreFeatures to avoid unnecessary re-computation
  const coreFeaturesKey = useMemo(
    () => JSON.stringify(concept?.coreFeatures ?? []),
    [concept?.coreFeatures]
  );

  // Generate mock content based on concept
  const mockContent = useMemo(() => {
    // Safely handle coreFeatures - parse from key or use empty array
    const features: Feature[] =
      concept?.coreFeatures && Array.isArray(concept.coreFeatures) ? concept.coreFeatures : [];

    return generateMockContent(
      concept?.name || 'My App',
      concept?.description || '',
      features,
      concept?.purpose || ''
    );
  }, [concept?.name, concept?.description, coreFeaturesKey, concept?.purpose]);

  // Get style and color presets
  const style = stylePresets[preferences.style] || stylePresets.modern;
  const colors = colorSchemes[preferences.colorScheme] || colorSchemes.dark;
  const primaryColor = preferences.primaryColor || DEFAULT_PRIMARY_COLOR;

  // Get device dimensions
  const dimensions = getDeviceDimensions(viewMode);

  // Generate images handler - tries DALL-E first, falls back to free services
  const handleGenerateImages = useCallback(async () => {
    setImageGenState({ isGenerating: true, progress: 0, error: undefined });

    const designContext = {
      colorScheme: preferences.colorScheme || 'dark',
      style: preferences.style || 'modern',
      primaryColor: primaryColor,
    };

    try {
      // Check if DALL-E is enabled
      const isDalleEnabled = process.env.NEXT_PUBLIC_ENABLE_DALLE === 'true';

      if (isDalleEnabled) {
        // Try DALL-E API for hero image
        setImageGenState((prev) => ({ ...prev, progress: 10 }));

        try {
          const heroResponse = await fetch('/api/images/generate', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              type: 'hero',
              designContext: {
                ...designContext,
                appDescription: concept?.description || mockContent.hero.subtitle,
              },
            }),
          });

          if (heroResponse.ok) {
            const heroData = await heroResponse.json();
            if (heroData.success && heroData.image?.url) {
              setGeneratedImages((prev) => ({ ...prev, hero: heroData.image.url }));
            }
          }
        } catch {
          // Fall through to fallback
        }

        setImageGenState((prev) => ({ ...prev, progress: 40 }));

        // Try DALL-E API for card images
        try {
          const cardResponse = await fetch('/api/images/generate', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              type: 'batch-cards',
              designContext,
              cards: mockContent.cards.slice(0, 4).map((card) => ({
                title: card.title,
                context: card.subtitle,
              })),
            }),
          });

          if (cardResponse.ok) {
            const cardData = await cardResponse.json();
            if (cardData.success && cardData.images) {
              setGeneratedImages((prev) => ({
                ...prev,
                cards: cardData.images.map((img: { url: string }) => img.url),
              }));
              setImageGenState({ isGenerating: false, progress: 100 });
              return;
            }
          }
        } catch {
          // Fall through to fallback
        }
      }

      // Fallback to free image services
      setImageGenState((prev) => ({ ...prev, progress: 60 }));

      const heroFallback = getFallbackImage('hero', {
        width: 1200,
        height: 600,
        seed: concept?.name || 'app',
      });

      const cardFallbacks = mockContent.cards.slice(0, 4).map((card, index) =>
        getFallbackImage('card', {
          width: 400,
          height: 300,
          seed: `${card.title}-${index}`,
        })
      );

      setGeneratedImages({
        hero: heroFallback,
        cards: cardFallbacks,
      });

      setImageGenState({ isGenerating: false, progress: 100 });
    } catch (error) {
      console.error('Image generation failed:', error);
      setImageGenState({
        isGenerating: false,
        progress: 0,
        error: 'Failed to generate images. Please try again.',
      });
    }
  }, [
    preferences.colorScheme,
    preferences.style,
    primaryColor,
    concept?.description,
    concept?.name,
    mockContent,
  ]);

  // Clear generated images
  const handleClearImages = useCallback(() => {
    setGeneratedImages({ cards: [] });
  }, []);

  // Render the appropriate layout
  const renderLayout = () => {
    const layoutProps: LayoutComponentProps = {
      content: mockContent,
      colors,
      style,
      primaryColor,
      appName: concept?.name || 'My App',
      onElementSelect: isAnimationDemo ? undefined : onElementSelect, // Disable selection during demo
      selectedElement: effectiveSelectedElement,
      // Pass component design props
      headerDesign: componentDesign?.headerDesign,
      sidebarDesign: componentDesign?.sidebarDesign,
      cardDesign: componentDesign?.cardDesign,
      navDesign: componentDesign?.navDesign,
      effectsSettings: componentDesign?.effectsSettings,
      colorSettings: componentDesign?.colorSettings,
      // Responsive
      viewMode,
      // Generated images
      generatedImages,
    };

    switch (preferences.layout) {
      case 'dashboard':
        return <DashboardLayout {...layoutProps} />;
      case 'multi-page':
        return <MultiPageLayout {...layoutProps} />;
      case 'single-page':
      case 'custom':
      default:
        return <SinglePageLayout {...layoutProps} />;
    }
  };

  return (
    <div className={`flex flex-col ${className}`}>
      {/* Toolbar */}
      <div className="flex items-center justify-between mb-4 px-2">
        {/* View Mode Toggle */}
        <div className="flex gap-1 bg-slate-800 p-1 rounded-lg">
          <button
            type="button"
            onClick={() => setViewMode('mobile')}
            className={`px-3 py-1.5 rounded-md text-xs font-medium transition-all ${
              viewMode === 'mobile' ? 'bg-blue-600 text-white' : 'text-slate-400 hover:text-white'
            }`}
            title="Mobile view (375x667)"
          >
            üì± Mobile
          </button>
          <button
            type="button"
            onClick={() => setViewMode('tablet')}
            className={`px-3 py-1.5 rounded-md text-xs font-medium transition-all ${
              viewMode === 'tablet' ? 'bg-blue-600 text-white' : 'text-slate-400 hover:text-white'
            }`}
            title="Tablet view (768x1024)"
          >
            üì≤ Tablet
          </button>
          <button
            type="button"
            onClick={() => setViewMode('desktop')}
            className={`px-3 py-1.5 rounded-md text-xs font-medium transition-all ${
              viewMode === 'desktop' ? 'bg-blue-600 text-white' : 'text-slate-400 hover:text-white'
            }`}
            title="Desktop view (full width)"
          >
            üñ•Ô∏è Desktop
          </button>
        </div>

        {/* Quick Preference Controls */}
        {onPreferenceChange && (
          <div className="flex items-center gap-2">
            {/* Color Scheme Toggle */}
            <button
              type="button"
              onClick={() =>
                onPreferenceChange({
                  colorScheme: preferences.colorScheme === 'dark' ? 'light' : 'dark',
                })
              }
              className="px-3 py-1.5 rounded-lg bg-slate-800 text-slate-400 hover:text-white text-xs font-medium transition-all"
              title="Toggle color scheme"
              aria-label={`Switch to ${preferences.colorScheme === 'dark' ? 'light' : 'dark'} mode`}
            >
              {preferences.colorScheme === 'dark' ? 'üåô' : '‚òÄÔ∏è'}
            </button>

            {/* Primary Color Picker */}
            <label className="relative cursor-pointer" title="Change primary color">
              <span className="sr-only">Choose primary color</span>
              <input
                type="color"
                value={primaryColor}
                onChange={(e) => onPreferenceChange({ primaryColor: e.target.value })}
                className="absolute inset-0 w-full h-full opacity-0 cursor-pointer"
                aria-label="Choose primary color"
              />
              <div
                className="w-8 h-8 rounded-lg border-2 border-white/20"
                style={{ backgroundColor: primaryColor }}
                aria-hidden="true"
              />
            </label>

            {/* Animation Preview Button */}
            <button
              type="button"
              onClick={isAnimationDemo ? stopAnimationDemo : startAnimationDemo}
              className={`px-3 py-1.5 rounded-lg text-xs font-medium transition-all flex items-center gap-1.5 ${
                isAnimationDemo
                  ? 'bg-purple-600 text-white'
                  : 'bg-slate-800 text-slate-400 hover:text-white'
              }`}
              title={isAnimationDemo ? 'Stop animation preview' : 'Preview element animations'}
            >
              {isAnimationDemo ? (
                <>
                  <span className="relative flex h-2 w-2">
                    <span className="animate-ping absolute inline-flex h-full w-full rounded-full bg-purple-300 opacity-75"></span>
                    <span className="relative inline-flex rounded-full h-2 w-2 bg-purple-200"></span>
                  </span>
                  Stop
                </>
              ) : (
                <>
                  <svg
                    className="w-3.5 h-3.5"
                    fill="none"
                    viewBox="0 0 24 24"
                    stroke="currentColor"
                  >
                    <path
                      strokeLinecap="round"
                      strokeLinejoin="round"
                      strokeWidth={2}
                      d="M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z"
                    />
                    <path
                      strokeLinecap="round"
                      strokeLinejoin="round"
                      strokeWidth={2}
                      d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z"
                    />
                  </svg>
                  Demo
                </>
              )}
            </button>

            {/* Generate Images Button */}
            <button
              type="button"
              onClick={generatedImages.hero ? handleClearImages : handleGenerateImages}
              disabled={imageGenState.isGenerating}
              className={`px-3 py-1.5 rounded-lg text-xs font-medium transition-all flex items-center gap-1.5 ${
                imageGenState.isGenerating
                  ? 'bg-amber-600 text-white cursor-wait'
                  : generatedImages.hero
                    ? 'bg-green-600 text-white hover:bg-red-600'
                    : 'bg-slate-800 text-slate-400 hover:text-white hover:bg-purple-600'
              }`}
              title={
                imageGenState.isGenerating
                  ? 'Generating images...'
                  : generatedImages.hero
                    ? 'Clear generated images'
                    : 'Generate AI images for preview'
              }
            >
              {imageGenState.isGenerating ? (
                <>
                  <svg className="w-3.5 h-3.5 animate-spin" fill="none" viewBox="0 0 24 24">
                    <circle
                      className="opacity-25"
                      cx="12"
                      cy="12"
                      r="10"
                      stroke="currentColor"
                      strokeWidth="4"
                    />
                    <path
                      className="opacity-75"
                      fill="currentColor"
                      d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"
                    />
                  </svg>
                  {imageGenState.progress}%
                </>
              ) : generatedImages.hero ? (
                <>
                  <svg
                    className="w-3.5 h-3.5"
                    fill="none"
                    viewBox="0 0 24 24"
                    stroke="currentColor"
                  >
                    <path
                      strokeLinecap="round"
                      strokeLinejoin="round"
                      strokeWidth={2}
                      d="M6 18L18 6M6 6l12 12"
                    />
                  </svg>
                  Clear
                </>
              ) : (
                <>
                  <svg
                    className="w-3.5 h-3.5"
                    fill="none"
                    viewBox="0 0 24 24"
                    stroke="currentColor"
                  >
                    <path
                      strokeLinecap="round"
                      strokeLinejoin="round"
                      strokeWidth={2}
                      d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"
                    />
                  </svg>
                  Images
                </>
              )}
            </button>

            {/* Section Order Panel Toggle */}
            {enableDragDrop && (
              <button
                type="button"
                onClick={() => setShowSectionPanel(!showSectionPanel)}
                className={`px-3 py-1.5 rounded-lg text-xs font-medium transition-all flex items-center gap-1.5 ${
                  showSectionPanel
                    ? 'bg-green-600 text-white'
                    : 'bg-slate-800 text-slate-400 hover:text-white'
                }`}
                title={showSectionPanel ? 'Hide section panel' : 'Reorder sections'}
              >
                <svg className="w-3.5 h-3.5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path
                    strokeLinecap="round"
                    strokeLinejoin="round"
                    strokeWidth={2}
                    d="M4 6h16M4 12h16M4 18h16"
                  />
                </svg>
                Sections
              </button>
            )}
          </div>
        )}
      </div>

      {/* Breakpoint Indicator */}
      <div className="mb-2 px-2 flex items-center justify-between">
        <div className="flex items-center gap-2">
          <div className="flex items-center gap-1">
            <span className="text-xs text-slate-500">Breakpoint:</span>
            <span className="text-xs font-medium text-slate-300">
              {BREAKPOINTS[viewMode].label}
            </span>
          </div>
          <span className="text-xs text-slate-600">‚Ä¢</span>
          <span className="text-xs text-slate-500">
            {viewMode === 'desktop' ? 'Full width' : `${BREAKPOINTS[viewMode].numericWidth}px`}
          </span>
        </div>
        <span className="text-xs text-slate-600 italic">{BREAKPOINTS[viewMode].description}</span>
      </div>

      {/* Section Ordering Panel */}
      {enableDragDrop && showSectionPanel && (
        <div className="mb-4 px-2">
          <div className="bg-slate-800 rounded-lg border border-slate-700 p-3">
            <div className="flex items-center justify-between mb-3">
              <h3 className="text-sm font-medium text-white">Section Order</h3>
              <button
                type="button"
                onClick={resetToDefault}
                className="text-xs text-slate-400 hover:text-white transition-colors"
              >
                Reset
              </button>
            </div>
            <p className="text-xs text-slate-400 mb-3">
              Drag sections to reorder. Locked sections (header/footer) stay in place.
            </p>
            <DragDropCanvas
              sections={sections}
              onSectionsChange={handleSectionReorder}
              className="space-y-2"
            >
              {(section) => (
                <div
                  className={`flex items-center justify-between p-2 rounded-lg border transition-colors ${
                    section.visible
                      ? 'bg-slate-700/50 border-slate-600'
                      : 'bg-slate-800/50 border-slate-700 opacity-50'
                  } ${section.locked ? 'cursor-not-allowed' : 'cursor-grab'}`}
                >
                  <div className="flex items-center gap-2">
                    {section.locked ? (
                      <svg
                        className="w-4 h-4 text-slate-500"
                        fill="none"
                        viewBox="0 0 24 24"
                        stroke="currentColor"
                      >
                        <path
                          strokeLinecap="round"
                          strokeLinejoin="round"
                          strokeWidth={2}
                          d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"
                        />
                      </svg>
                    ) : (
                      <svg
                        className="w-4 h-4 text-slate-400"
                        fill="none"
                        viewBox="0 0 24 24"
                        stroke="currentColor"
                      >
                        <path
                          strokeLinecap="round"
                          strokeLinejoin="round"
                          strokeWidth={2}
                          d="M4 8h16M4 16h16"
                        />
                      </svg>
                    )}
                    <span className="text-sm text-white">{section.label}</span>
                  </div>
                  {!section.locked && (
                    <button
                      type="button"
                      onClick={() => toggleSectionVisibility(section.id)}
                      className={`p-1 rounded transition-colors ${
                        section.visible
                          ? 'text-green-400 hover:text-green-300'
                          : 'text-slate-500 hover:text-slate-400'
                      }`}
                      title={section.visible ? 'Hide section' : 'Show section'}
                    >
                      {section.visible ? (
                        <svg
                          className="w-4 h-4"
                          fill="none"
                          viewBox="0 0 24 24"
                          stroke="currentColor"
                        >
                          <path
                            strokeLinecap="round"
                            strokeLinejoin="round"
                            strokeWidth={2}
                            d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"
                          />
                          <path
                            strokeLinecap="round"
                            strokeLinejoin="round"
                            strokeWidth={2}
                            d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"
                          />
                        </svg>
                      ) : (
                        <svg
                          className="w-4 h-4"
                          fill="none"
                          viewBox="0 0 24 24"
                          stroke="currentColor"
                        >
                          <path
                            strokeLinecap="round"
                            strokeLinejoin="round"
                            strokeWidth={2}
                            d="M13.875 18.825A10.05 10.05 0 0112 19c-4.478 0-8.268-2.943-9.543-7a9.97 9.97 0 011.563-3.029m5.858.908a3 3 0 114.243 4.243M9.878 9.878l4.242 4.242M9.88 9.88l-3.29-3.29m7.532 7.532l3.29 3.29M3 3l3.59 3.59m0 0A9.953 9.953 0 0112 5c4.478 0 8.268 2.943 9.543 7a10.025 10.025 0 01-4.132 5.411m0 0L21 21"
                          />
                        </svg>
                      )}
                    </button>
                  )}
                </div>
              )}
            </DragDropCanvas>
          </div>
        </div>
      )}

      {/* Preview Frame */}
      <div className="flex-1 flex items-center justify-center bg-slate-950 rounded-xl p-4 overflow-hidden relative">
        {/* Width ruler indicator */}
        {viewMode !== 'desktop' && (
          <div className="absolute top-2 left-1/2 transform -translate-x-1/2 flex items-center gap-1 bg-slate-800/80 px-2 py-1 rounded text-xs text-slate-400">
            <svg className="w-3 h-3" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path
                strokeLinecap="round"
                strokeLinejoin="round"
                strokeWidth={2}
                d="M4 8V4m0 0h4M4 4l5 5m11-1V4m0 0h-4m4 0l-5 5M4 16v4m0 0h4m-4 0l5-5m11 5l-5-5m5 5v-4m0 4h-4"
              />
            </svg>
            <span>
              {BREAKPOINTS[viewMode].numericWidth} √ó {parseInt(BREAKPOINTS[viewMode].height)}px
            </span>
          </div>
        )}
        <div
          className="bg-white rounded-lg overflow-hidden shadow-2xl transition-all duration-300"
          style={{
            width: dimensions.width,
            height: dimensions.height,
            maxWidth: '100%',
            maxHeight: '100%',
          }}
        >
          {renderLayout()}
        </div>
      </div>

      {/* Animation Demo Progress */}
      {isAnimationDemo && (
        <div className="mt-4 px-4 py-3 bg-purple-500/20 border border-purple-500/30 rounded-lg">
          <div className="flex items-center gap-3">
            <span className="relative flex h-3 w-3">
              <span className="animate-ping absolute inline-flex h-full w-full rounded-full bg-purple-400 opacity-75"></span>
              <span className="relative inline-flex rounded-full h-3 w-3 bg-purple-500"></span>
            </span>
            <div className="flex-1">
              <div className="flex items-center justify-between mb-1">
                <span className="text-sm text-purple-200">
                  Previewing: <strong className="font-medium capitalize">{demoElement}</strong>
                </span>
                <span className="text-xs text-purple-400">
                  {animationDemoIndex + 1} / {ANIMATION_DEMO_SEQUENCE.length}
                </span>
              </div>
              {/* Progress bar */}
              <div className="h-1 bg-purple-900/50 rounded-full overflow-hidden">
                <div
                  className="h-full bg-purple-500 transition-all duration-200"
                  style={{
                    width: `${((animationDemoIndex + 1) / ANIMATION_DEMO_SEQUENCE.length) * 100}%`,
                  }}
                />
              </div>
            </div>
            <button
              type="button"
              onClick={stopAnimationDemo}
              className="text-xs text-purple-400 hover:text-purple-300 px-2 py-1 rounded hover:bg-purple-500/20"
              aria-label="Stop animation demo"
            >
              Stop
            </button>
          </div>
        </div>
      )}

      {/* Selected Element Info */}
      {!isAnimationDemo && selectedElement && (
        <div className="mt-4 px-4 py-3 bg-blue-500/20 border border-blue-500/30 rounded-lg">
          <div className="flex items-center gap-2">
            <span className="text-blue-400">üéØ</span>
            <span className="text-sm text-blue-200">
              Selected: <strong className="font-medium">{selectedElement}</strong>
            </span>
            <button
              type="button"
              onClick={() => onElementSelect?.(null)}
              className="ml-auto text-xs text-blue-400 hover:text-blue-300"
              aria-label="Clear element selection"
            >
              Clear selection
            </button>
          </div>
        </div>
      )}
    </div>
  );
}

export default LayoutPreview;
</file>

<file path="src/components/PowerfulPreview.tsx">
'use client';

import React, { useMemo, useEffect, useCallback } from 'react';
import { SandpackProvider, SandpackPreview, SandpackLayout } from '@codesandbox/sandpack-react';

interface AppFile {
  path: string;
  content: string;
  description: string;
}

interface FullAppData {
  name: string;
  description: string;
  appType?: 'FRONTEND_ONLY' | 'FULL_STACK';
  files: AppFile[];
  dependencies: Record<string, string>;
  setupInstructions: string;
}

interface PowerfulPreviewProps {
  appDataJson: string;
  isFullscreen?: boolean;
  onCaptureReady?: (captureFunc: () => Promise<string | null>) => void;
}

export default function PowerfulPreview({
  appDataJson,
  isFullscreen = false,
  onCaptureReady,
}: PowerfulPreviewProps) {
  // Parse JSON with error handling to prevent crashes
  const appData = useMemo((): FullAppData | null => {
    try {
      return JSON.parse(appDataJson) as FullAppData;
    } catch (error) {
      console.error('PowerfulPreview: Failed to parse appDataJson:', error);
      return null;
    }
  }, [appDataJson]);

  // Capture function that sends files to the API for server-side screenshot
  const capturePreview = useCallback(async (): Promise<string | null> => {
    try {
      if (!appData) return null;

      const response = await fetch('/api/screenshot', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          files: appData.files,
          name: appData.name,
          dependencies: appData.dependencies,
          width: 1280,
          height: 720,
        }),
      });

      if (!response.ok) {
        const err = await response.json();
        throw new Error(err.error || 'Screenshot failed');
      }

      const { image } = await response.json();
      return image;
    } catch (error) {
      console.error('Capture failed:', error);
      return null;
    }
  }, [appData]);

  // Pass capture function to parent via callback
  useEffect(() => {
    onCaptureReady?.(capturePreview);
  }, [capturePreview, onCaptureReady]);

  // Handle parse error or missing files
  if (!appData || !appData.files || !Array.isArray(appData.files) || appData.files.length === 0) {
    return (
      <div className="w-full h-full flex items-center justify-center bg-slate-900">
        <div className="text-center p-6">
          <p className="text-red-400 mb-2">Failed to load preview</p>
          <p className="text-slate-500 text-sm">
            {!appData ? 'Invalid app data format' : 'No files found in app data'}
          </p>
        </div>
      </div>
    );
  }

  // Convert files to Sandpack format - React template needs / prefix
  const sandpackFiles: Record<string, { code: string }> = {};

  appData.files.forEach((file) => {
    // Map file paths to Sandpack structure
    let sandpackPath = file.path;

    // Handle different file structures - remove src/ prefix
    if (sandpackPath.startsWith('src/')) {
      sandpackPath = sandpackPath.substring(4); // Remove 'src/' (4 characters)
    }

    // Keep as App.tsx for TypeScript support
    if (
      sandpackPath === 'App.tsx' ||
      sandpackPath === 'app/page.tsx' ||
      sandpackPath === 'page.tsx'
    ) {
      sandpackPath = 'App.tsx';
    }

    // Add leading / for Sandpack react template
    if (!sandpackPath.startsWith('/') && !sandpackPath.startsWith('public/')) {
      sandpackPath = '/' + sandpackPath;
    }

    // Sandpack file format uses objects with 'code' property
    sandpackFiles[sandpackPath] = { code: file.content };
  });

  // Ensure we have /App.tsx
  if (!sandpackFiles['/App.tsx']) {
    console.error('No /App.tsx found in files:', Object.keys(sandpackFiles));
    console.log(
      'Original file paths:',
      appData.files.map((f) => f.path)
    );
  }

  // Add index.tsx for TypeScript support
  if (!sandpackFiles['/index.tsx'] && !sandpackFiles['/index.js']) {
    sandpackFiles['/index.tsx'] = {
      code: `import React from "react";
import { createRoot } from "react-dom/client";
import "./styles.css";
import App from "./App";

const root = createRoot(document.getElementById("root")!);
root.render(<App />);`,
    };
  }

  // Add styles.css - Sandpack format
  if (!sandpackFiles['/styles.css']) {
    sandpackFiles['/styles.css'] = {
      code: `* {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
}

body {
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
  -webkit-font-smoothing: antialiased;
  -moz-osx-font-smoothing: grayscale;
}

h1, h2, h3, h4, h5, h6 {
  margin: 0;
}`,
    };
  }

  // Add public/index.html with Tailwind CDN
  sandpackFiles['/public/index.html'] = {
    code: `<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>${appData.name || 'App'}</title>
    <script src="https://cdn.tailwindcss.com"></script>
  </head>
  <body>
    <div id="root"></div>
  </body>
</html>`,
  };

  // Merge user dependencies with required ones
  const dependencies = {
    react: '^18.0.0',
    'react-dom': '^18.0.0',
    'react-scripts': '^5.0.0',
    ...appData.dependencies,
  };

  return (
    <div
      className="w-full h-full flex flex-col"
      style={{
        minHeight: isFullscreen ? '100vh' : '600px',
        height: isFullscreen ? '100vh' : '100%',
      }}
    >
      <SandpackProvider
        template="react-ts"
        theme="dark"
        files={sandpackFiles}
        customSetup={{
          dependencies,
        }}
        options={{
          autorun: true,
          autoReload: true,
          recompileMode: 'immediate',
          externalResources: ['https://cdn.tailwindcss.com'],
        }}
      >
        <SandpackLayout
          style={{
            height: '100%',
            width: '100%',
            minHeight: isFullscreen ? '100vh' : '600px',
            flex: 1,
          }}
        >
          <SandpackPreview
            showOpenInCodeSandbox={false}
            showRefreshButton={true}
            style={{
              height: '100%',
              width: '100%',
              minHeight: isFullscreen ? '100vh' : '600px',
            }}
          />
        </SandpackLayout>

        {appData.appType === 'FULL_STACK' && (
          <div className="absolute top-4 left-4 bg-yellow-500/90 text-yellow-900 px-4 py-2 rounded-lg text-sm font-medium shadow-lg z-50">
            ‚ö†Ô∏è Preview mode: Backend features disabled
          </div>
        )}
      </SandpackProvider>
    </div>
  );
}
</file>

<file path="src/components/LayoutBuilderWizard.tsx">
'use client';

/**
 * LayoutBuilderWizard Component
 *
 * A modal-based layout builder with conversational AI that can "see" the layout
 * through screenshots and provide visual design feedback.
 */

import React, { useState, useRef, useEffect, useCallback, useMemo } from 'react';
import { useLayoutBuilder } from '@/hooks/useLayoutBuilder';
import { useToast } from '@/hooks/useToast';
import { LayoutPreview } from '@/components/LayoutPreview';
import { DesignControlPanel } from '@/components/DesignControlPanel';
import { ToastContainer } from '@/components/ui/Toast';
import type {
  LayoutMessage,
  SuggestedAction,
  DesignChange,
  EffectsSettings,
  ColorSettings,
  LayoutDesign,
} from '@/types/layoutDesign';
import type { UIPreferences } from '@/types/appConcept';
import { DESIGN_TEMPLATES, type DesignTemplate } from '@/data/designTemplates';
import { VersionHistoryPanel } from '@/components/VersionHistoryPanel';
import {
  exportToCSSVariables,
  exportToTailwindConfig,
  exportToFigmaTokens,
  exportToReactComponent,
  downloadExport,
  copyToClipboard,
} from '@/utils/layoutExport';

// ============================================================================
// CONSTANTS
// ============================================================================

/** Number of messages to show initially and load incrementally */
const MESSAGES_PAGE_SIZE = 20;

/** Maximum messages to render at once for performance */
const MAX_RENDERED_MESSAGES = 100;

/** Maximum dimensions for compressed reference images */
const MAX_IMAGE_DIMENSION = 800;

/** JPEG quality for compressed images (0-1) */
const IMAGE_COMPRESSION_QUALITY = 0.7;

// ============================================================================
// UTILITY FUNCTIONS
// ============================================================================

/**
 * Compress an image file to a smaller size
 * @param file - The image file to compress
 * @param maxDimension - Maximum width/height
 * @param quality - JPEG quality (0-1)
 * @returns Promise with compressed base64 data URL and size info
 */
async function compressImage(
  file: File,
  maxDimension: number = MAX_IMAGE_DIMENSION,
  quality: number = IMAGE_COMPRESSION_QUALITY
): Promise<{ dataUrl: string; originalSize: number; compressedSize: number }> {
  return new Promise((resolve, reject) => {
    const img = new Image();
    const canvas = document.createElement('canvas');
    const ctx = canvas.getContext('2d');

    if (!ctx) {
      reject(new Error('Could not get canvas context'));
      return;
    }

    img.onload = () => {
      // Calculate new dimensions while maintaining aspect ratio
      let { width, height } = img;
      if (width > maxDimension || height > maxDimension) {
        if (width > height) {
          height = (height / width) * maxDimension;
          width = maxDimension;
        } else {
          width = (width / height) * maxDimension;
          height = maxDimension;
        }
      }

      // Set canvas size and draw image
      canvas.width = width;
      canvas.height = height;
      ctx.fillStyle = '#ffffff';
      ctx.fillRect(0, 0, width, height);
      ctx.drawImage(img, 0, 0, width, height);

      // Convert to JPEG with compression
      const dataUrl = canvas.toDataURL('image/jpeg', quality);

      // Calculate approximate compressed size (base64 is ~33% larger than binary)
      const compressedSize = Math.round((dataUrl.length * 3) / 4);

      resolve({
        dataUrl,
        originalSize: file.size,
        compressedSize,
      });
    };

    img.onerror = () => {
      reject(new Error('Failed to load image'));
    };

    // Create object URL from file
    img.src = URL.createObjectURL(file);
  });
}

/**
 * Format bytes to human readable string
 */
function formatBytes(bytes: number): string {
  if (bytes < 1024) return `${bytes} B`;
  if (bytes < 1024 * 1024) return `${(bytes / 1024).toFixed(1)} KB`;
  return `${(bytes / (1024 * 1024)).toFixed(2)} MB`;
}

/**
 * Calculate design completion progress
 * Returns percentages for different categories
 */
function calculateDesignProgress(design: Partial<LayoutDesign>): {
  overall: number;
  colors: number;
  typography: number;
  layout: number;
  components: number;
} {
  // Colors category (12 properties)
  const colorProps = [
    design.globalStyles?.colors?.primary,
    design.globalStyles?.colors?.secondary,
    design.globalStyles?.colors?.accent,
    design.globalStyles?.colors?.background,
    design.globalStyles?.colors?.surface,
    design.globalStyles?.colors?.text,
    design.globalStyles?.colors?.textMuted,
    design.globalStyles?.colors?.border,
    design.globalStyles?.colors?.success,
    design.globalStyles?.colors?.warning,
    design.globalStyles?.colors?.error,
    design.globalStyles?.colors?.info,
  ];
  const colorsSet = colorProps.filter(Boolean).length;
  const colors = Math.round((colorsSet / colorProps.length) * 100);

  // Typography category (7 properties)
  const typoProps = [
    design.globalStyles?.typography?.fontFamily,
    design.globalStyles?.typography?.headingWeight,
    design.globalStyles?.typography?.bodyWeight,
    design.globalStyles?.typography?.headingSize,
    design.globalStyles?.typography?.bodySize,
    design.globalStyles?.typography?.lineHeight,
    design.globalStyles?.typography?.letterSpacing,
  ];
  const typoSet = typoProps.filter(Boolean).length;
  const typography = Math.round((typoSet / typoProps.length) * 100);

  // Layout category (10 properties)
  const layoutProps = [
    design.basePreferences?.style,
    design.basePreferences?.colorScheme,
    design.basePreferences?.layout,
    design.structure?.type,
    design.structure?.hasHeader,
    design.structure?.hasSidebar,
    design.structure?.hasFooter,
    design.structure?.headerType,
    design.structure?.contentLayout,
    design.structure?.mainContentWidth,
  ];
  const layoutSet = layoutProps.filter((v) => v !== undefined).length;
  const layout = Math.round((layoutSet / layoutProps.length) * 100);

  // Components category (5 main component defined)
  const componentProps = [
    design.components?.header?.visible !== undefined,
    design.components?.sidebar?.visible !== undefined,
    design.components?.hero?.visible !== undefined,
    design.components?.cards?.style !== undefined,
    design.components?.footer?.visible !== undefined,
  ];
  const componentsSet = componentProps.filter(Boolean).length;
  const components = Math.round((componentsSet / componentProps.length) * 100);

  // Overall is weighted average
  const overall = Math.round(colors * 0.25 + typography * 0.2 + layout * 0.3 + components * 0.25);

  return { overall, colors, typography, layout, components };
}

// ============================================================================
// TYPES
// ============================================================================

interface LayoutBuilderWizardProps {
  isOpen: boolean;
  onClose: () => void;
  onApplyToAppConcept?: () => void;
  isFullPage?: boolean;
}

// ============================================================================
// SUB-COMPONENTS
// ============================================================================

/**
 * Confirmation dialog component
 */
function ConfirmDialog({
  isOpen,
  title,
  message,
  confirmLabel = 'Confirm',
  cancelLabel = 'Cancel',
  onConfirm,
  onCancel,
  variant = 'warning',
}: {
  isOpen: boolean;
  title: string;
  message: string;
  confirmLabel?: string;
  cancelLabel?: string;
  onConfirm: () => void;
  onCancel: () => void;
  variant?: 'warning' | 'danger' | 'info';
}) {
  if (!isOpen) return null;

  const variantStyles = {
    warning: 'bg-yellow-600 hover:bg-yellow-500',
    danger: 'bg-red-600 hover:bg-red-500',
    info: 'bg-blue-600 hover:bg-blue-500',
  };

  return (
    <div className="fixed inset-0 z-[60] flex items-center justify-center bg-black/60 backdrop-blur-sm">
      <div className="bg-slate-800 rounded-xl shadow-2xl max-w-md w-full mx-4 border border-slate-700">
        <div className="p-6">
          <h3 className="text-lg font-semibold text-white mb-2">{title}</h3>
          <p className="text-slate-300 text-sm">{message}</p>
        </div>
        <div className="flex justify-end gap-3 px-6 py-4 border-t border-slate-700">
          <button
            onClick={onCancel}
            className="px-4 py-2 bg-slate-700 hover:bg-slate-600 text-white rounded-lg font-medium transition-colors"
          >
            {cancelLabel}
          </button>
          <button
            onClick={onConfirm}
            className={`px-4 py-2 text-white rounded-lg font-medium transition-colors ${variantStyles[variant]}`}
          >
            {confirmLabel}
          </button>
        </div>
      </div>
    </div>
  );
}

/**
 * Draft recovery banner
 */
function DraftRecoveryBanner({
  onRecover,
  onDiscard,
}: {
  onRecover: () => void;
  onDiscard: () => void;
}) {
  return (
    <div className="bg-blue-500/20 border-b border-blue-500/30 px-6 py-3 flex items-center justify-between">
      <div className="flex items-center gap-2">
        <svg
          className="w-5 h-5 text-blue-400"
          fill="none"
          viewBox="0 0 24 24"
          stroke="currentColor"
        >
          <path
            strokeLinecap="round"
            strokeLinejoin="round"
            strokeWidth={2}
            d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"
          />
        </svg>
        <span className="text-sm text-blue-200">
          You have an unsaved draft from a previous session
        </span>
      </div>
      <div className="flex items-center gap-2">
        <button
          onClick={onDiscard}
          className="px-3 py-1.5 text-sm text-slate-300 hover:text-white transition-colors"
        >
          Discard
        </button>
        <button
          onClick={onRecover}
          className="px-3 py-1.5 bg-blue-600 hover:bg-blue-500 text-white rounded-lg text-sm font-medium transition-colors"
        >
          Recover Draft
        </button>
      </div>
    </div>
  );
}

/**
 * Design progress indicator component
 */
function DesignProgressIndicator({
  design,
  isExpanded = false,
  onToggle,
}: {
  design: Partial<LayoutDesign>;
  isExpanded?: boolean;
  onToggle?: () => void;
}) {
  const progress = useMemo(() => calculateDesignProgress(design), [design]);

  const getProgressColor = (value: number) => {
    if (value >= 80) return 'bg-green-500';
    if (value >= 50) return 'bg-yellow-500';
    if (value >= 25) return 'bg-orange-500';
    return 'bg-red-500';
  };

  const getProgressLabel = (value: number) => {
    if (value >= 80) return 'Complete';
    if (value >= 50) return 'Good';
    if (value >= 25) return 'Basic';
    return 'Starting';
  };

  return (
    <div className="bg-slate-800/50 rounded-lg border border-slate-700 overflow-hidden">
      {/* Collapsed view - just overall progress */}
      <button
        type="button"
        onClick={onToggle}
        className="w-full px-3 py-2 flex items-center justify-between hover:bg-slate-700/30 transition-colors"
      >
        <div className="flex items-center gap-2">
          <svg
            className="w-4 h-4 text-slate-400"
            fill="none"
            viewBox="0 0 24 24"
            stroke="currentColor"
          >
            <path
              strokeLinecap="round"
              strokeLinejoin="round"
              strokeWidth={2}
              d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"
            />
          </svg>
          <span className="text-xs font-medium text-slate-300">Design Progress</span>
        </div>
        <div className="flex items-center gap-2">
          <span
            className={`text-xs font-semibold ${progress.overall >= 50 ? 'text-green-400' : 'text-slate-400'}`}
          >
            {progress.overall}%
          </span>
          <div className="w-16 h-1.5 bg-slate-700 rounded-full overflow-hidden">
            <div
              className={`h-full ${getProgressColor(progress.overall)} transition-all duration-300`}
              style={{ width: `${progress.overall}%` }}
            />
          </div>
          <svg
            className={`w-4 h-4 text-slate-500 transition-transform ${isExpanded ? 'rotate-180' : ''}`}
            fill="none"
            viewBox="0 0 24 24"
            stroke="currentColor"
          >
            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 9l-7 7-7-7" />
          </svg>
        </div>
      </button>

      {/* Expanded view - category breakdown */}
      {isExpanded && (
        <div className="px-3 pb-3 pt-1 border-t border-slate-700/50">
          <div className="grid grid-cols-2 gap-2">
            {/* Colors */}
            <div className="space-y-1">
              <div className="flex items-center justify-between">
                <span className="text-[10px] text-slate-500 uppercase">Colors</span>
                <span className="text-xs font-medium text-slate-400">{progress.colors}%</span>
              </div>
              <div className="w-full h-1 bg-slate-700 rounded-full overflow-hidden">
                <div
                  className={`h-full ${getProgressColor(progress.colors)} transition-all duration-300`}
                  style={{ width: `${progress.colors}%` }}
                />
              </div>
            </div>

            {/* Typography */}
            <div className="space-y-1">
              <div className="flex items-center justify-between">
                <span className="text-[10px] text-slate-500 uppercase">Typography</span>
                <span className="text-xs font-medium text-slate-400">{progress.typography}%</span>
              </div>
              <div className="w-full h-1 bg-slate-700 rounded-full overflow-hidden">
                <div
                  className={`h-full ${getProgressColor(progress.typography)} transition-all duration-300`}
                  style={{ width: `${progress.typography}%` }}
                />
              </div>
            </div>

            {/* Layout */}
            <div className="space-y-1">
              <div className="flex items-center justify-between">
                <span className="text-[10px] text-slate-500 uppercase">Layout</span>
                <span className="text-xs font-medium text-slate-400">{progress.layout}%</span>
              </div>
              <div className="w-full h-1 bg-slate-700 rounded-full overflow-hidden">
                <div
                  className={`h-full ${getProgressColor(progress.layout)} transition-all duration-300`}
                  style={{ width: `${progress.layout}%` }}
                />
              </div>
            </div>

            {/* Components */}
            <div className="space-y-1">
              <div className="flex items-center justify-between">
                <span className="text-[10px] text-slate-500 uppercase">Components</span>
                <span className="text-xs font-medium text-slate-400">{progress.components}%</span>
              </div>
              <div className="w-full h-1 bg-slate-700 rounded-full overflow-hidden">
                <div
                  className={`h-full ${getProgressColor(progress.components)} transition-all duration-300`}
                  style={{ width: `${progress.components}%` }}
                />
              </div>
            </div>
          </div>

          {/* Status label */}
          <div className="mt-2 text-center">
            <span
              className={`text-xs font-medium ${progress.overall >= 50 ? 'text-green-400' : 'text-slate-500'}`}
            >
              {getProgressLabel(progress.overall)} -{' '}
              {progress.overall >= 80 ? 'Ready to apply!' : 'Keep customizing'}
            </span>
          </div>
        </div>
      )}
    </div>
  );
}

/**
 * Message bubble component with error retry support
 */
function MessageBubble({
  message,
  onRetry,
}: {
  message: LayoutMessage;
  onRetry?: (messageId: string) => void;
}) {
  const isUser = message.role === 'user';
  const isSystem = message.role === 'system';
  const hasError = message.error && !isUser;
  const canRetry = hasError && message.error?.canRetry;

  if (isSystem) return null;

  // Get error icon based on error type
  const getErrorIcon = () => {
    switch (message.error?.type) {
      case 'network':
        return (
          <svg className="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path
              strokeLinecap="round"
              strokeLinejoin="round"
              strokeWidth={2}
              d="M18.364 5.636a9 9 0 010 12.728m0 0l-2.829-2.829m2.829 2.829L21 21M15.536 8.464a5 5 0 010 7.072m0 0l-2.829-2.829m-4.243 2.829a4.978 4.978 0 01-1.414-2.83m-1.414 5.658a9 9 0 01-2.167-9.238m7.824 2.167a1 1 0 111.414 1.414m-1.414-1.414L3 3m8.293 8.293l1.414 1.414"
            />
          </svg>
        );
      case 'rate_limit':
        return (
          <svg className="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path
              strokeLinecap="round"
              strokeLinejoin="round"
              strokeWidth={2}
              d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"
            />
          </svg>
        );
      case 'server':
        return (
          <svg className="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path
              strokeLinecap="round"
              strokeLinejoin="round"
              strokeWidth={2}
              d="M5 12h14M5 12a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v4a2 2 0 01-2 2M5 12a2 2 0 00-2 2v4a2 2 0 002 2h14a2 2 0 002-2v-4a2 2 0 00-2-2m-2-4h.01M17 16h.01"
            />
          </svg>
        );
      default:
        return (
          <svg className="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path
              strokeLinecap="round"
              strokeLinejoin="round"
              strokeWidth={2}
              d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"
            />
          </svg>
        );
    }
  };

  return (
    <div className={`flex ${isUser ? 'justify-end' : 'justify-start'} mb-4`}>
      <div
        className={`max-w-[85%] rounded-2xl px-4 py-3 ${
          isUser
            ? 'bg-blue-600 text-white'
            : hasError
              ? 'bg-red-500/20 border border-red-500/30 text-slate-100'
              : 'bg-slate-700 text-slate-100'
        }`}
      >
        {/* Show error header if present */}
        {hasError && (
          <div className="flex items-center gap-2 text-red-400 text-xs font-medium mb-2">
            {getErrorIcon()}
            <span>Error</span>
          </div>
        )}

        {/* Show selected element indicator if present */}
        {message.selectedElement && (
          <div className="text-xs opacity-70 mb-2 flex items-center gap-1">
            <span>Selected:</span>
            <span className="font-medium">{message.selectedElement}</span>
          </div>
        )}

        {/* Show attached snapshot indicator */}
        {message.previewSnapshot && (
          <div className="text-xs opacity-70 mb-2 flex items-center gap-1">
            <span>Attached preview snapshot</span>
          </div>
        )}

        {/* Message content */}
        <div
          className={`text-sm whitespace-pre-wrap leading-relaxed ${hasError ? 'text-red-200' : ''}`}
        >
          {message.isRetrying ? (
            <span className="flex items-center gap-2">
              <svg className="w-4 h-4 animate-spin" fill="none" viewBox="0 0 24 24">
                <circle
                  className="opacity-25"
                  cx="12"
                  cy="12"
                  r="10"
                  stroke="currentColor"
                  strokeWidth="4"
                />
                <path
                  className="opacity-75"
                  fill="currentColor"
                  d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"
                />
              </svg>
              Retrying...
            </span>
          ) : (
            message.content
          )}
        </div>

        {/* Retry button for errors */}
        {canRetry && !message.isRetrying && onRetry && (
          <button
            onClick={() => onRetry(message.id)}
            className="mt-3 px-3 py-1.5 bg-red-500/30 hover:bg-red-500/50 text-red-200 rounded-lg text-xs font-medium transition-colors flex items-center gap-1.5"
          >
            <svg className="w-3.5 h-3.5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path
                strokeLinecap="round"
                strokeLinejoin="round"
                strokeWidth={2}
                d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"
              />
            </svg>
            Retry
          </button>
        )}

        {/* Timestamp */}
        <div
          className={`text-xs mt-2 ${isUser ? 'text-blue-200' : hasError ? 'text-red-300/70' : 'text-slate-400'}`}
        >
          {message.timestamp.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}
        </div>
      </div>
    </div>
  );
}

/**
 * Suggested actions bar
 */
function SuggestedActionsBar({
  actions,
  onAction,
}: {
  actions: SuggestedAction[];
  onAction: (action: string) => void;
}) {
  if (actions.length === 0) return null;

  return (
    <div className="flex flex-wrap gap-2 px-4 py-3 border-t border-slate-700">
      {actions.map((action, i) => (
        <button
          key={i}
          onClick={() => onAction(action.action)}
          className="px-3 py-1.5 rounded-lg bg-slate-700 hover:bg-slate-600 text-slate-200 text-sm font-medium transition-colors flex items-center gap-1.5"
        >
          {action.icon && <span>{action.icon}</span>}
          {action.label}
        </button>
      ))}
    </div>
  );
}

/**
 * Recent changes indicator
 */
function RecentChangesIndicator({ changes }: { changes: DesignChange[] }) {
  if (changes.length === 0) return null;

  return (
    <div className="px-4 py-2 bg-green-500/10 border-t border-green-500/20">
      <div className="text-xs text-green-400 font-medium mb-1">Recent Changes:</div>
      <div className="space-y-1">
        {changes.slice(0, 3).map((change, i) => (
          <div key={i} className="text-xs text-green-300/80">
            {change.property}: {String(change.oldValue)} ‚Üí {String(change.newValue)}
          </div>
        ))}
      </div>
    </div>
  );
}

/**
 * Reference images panel
 * Note: Uses parent's file input via onAdd callback for consistent compression handling
 */
function ReferenceImagesPanel({
  images,
  onRemove,
  onAdd,
}: {
  images: string[];
  onRemove: (index: number) => void;
  onAdd: () => void;
}) {
  if (images.length === 0) {
    return (
      <button
        type="button"
        onClick={onAdd}
        className="w-full px-4 py-3 border-2 border-dashed border-slate-600 rounded-lg text-slate-400 hover:border-slate-500 hover:text-slate-300 transition-colors text-sm"
      >
        + Add design inspiration
      </button>
    );
  }

  return (
    <div className="space-y-2">
      <div className="text-xs text-slate-400 font-medium">Reference Images</div>
      <div className="flex flex-wrap gap-2">
        {images.map((img, i) => (
          <div key={i} className="relative group">
            <img
              src={img}
              alt={`Reference ${i + 1}`}
              className="w-16 h-16 object-cover rounded-lg border border-slate-600"
            />
            <button
              type="button"
              onClick={() => onRemove(i)}
              className="absolute -top-1 -right-1 w-5 h-5 bg-red-500 rounded-full text-white text-xs opacity-0 group-hover:opacity-100 transition-opacity"
            >
              x
            </button>
          </div>
        ))}
        <button
          type="button"
          onClick={onAdd}
          className="w-16 h-16 border-2 border-dashed border-slate-600 rounded-lg text-slate-500 hover:border-slate-500 hover:text-slate-400 transition-colors text-2xl flex items-center justify-center"
        >
          +
        </button>
      </div>
    </div>
  );
}

/**
 * Template picker component for quick start
 */
function TemplatePicker({
  isOpen,
  onSelect,
  onClose,
}: {
  isOpen: boolean;
  onSelect: (template: DesignTemplate) => void;
  onClose: () => void;
}) {
  if (!isOpen) return null;

  const getCategoryIcon = (category: DesignTemplate['category']) => {
    switch (category) {
      case 'business':
        return (
          <svg className="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path
              strokeLinecap="round"
              strokeLinejoin="round"
              strokeWidth={2}
              d="M21 13.255A23.931 23.931 0 0112 15c-3.183 0-6.22-.62-9-1.745M16 6V4a2 2 0 00-2-2h-4a2 2 0 00-2 2v2m4 6h.01M5 20h14a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"
            />
          </svg>
        );
      case 'creative':
        return (
          <svg className="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path
              strokeLinecap="round"
              strokeLinejoin="round"
              strokeWidth={2}
              d="M7 21a4 4 0 01-4-4V5a2 2 0 012-2h4a2 2 0 012 2v12a4 4 0 01-4 4zm0 0h12a2 2 0 002-2v-4a2 2 0 00-2-2h-2.343M11 7.343l1.657-1.657a2 2 0 012.828 0l2.829 2.829a2 2 0 010 2.828l-8.486 8.485M7 17h.01"
            />
          </svg>
        );
      case 'commerce':
        return (
          <svg className="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path
              strokeLinecap="round"
              strokeLinejoin="round"
              strokeWidth={2}
              d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2.293 2.293c-.63.63-.184 1.707.707 1.707H17m0 0a2 2 0 100 4 2 2 0 000-4zm-8 2a2 2 0 11-4 0 2 2 0 014 0z"
            />
          </svg>
        );
      case 'utility':
        return (
          <svg className="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path
              strokeLinecap="round"
              strokeLinejoin="round"
              strokeWidth={2}
              d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"
            />
            <path
              strokeLinecap="round"
              strokeLinejoin="round"
              strokeWidth={2}
              d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"
            />
          </svg>
        );
    }
  };

  return (
    <div className="absolute inset-0 bg-slate-900/95 z-20 flex flex-col">
      <div className="p-4 border-b border-slate-700 flex items-center justify-between">
        <div>
          <h3 className="text-lg font-semibold text-white">Choose a Template</h3>
          <p className="text-sm text-slate-400">Start with a pre-designed layout</p>
        </div>
        <button
          onClick={onClose}
          className="p-2 text-slate-400 hover:text-white transition-colors"
          aria-label="Close template picker"
        >
          <svg className="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path
              strokeLinecap="round"
              strokeLinejoin="round"
              strokeWidth={2}
              d="M6 18L18 6M6 6l12 12"
            />
          </svg>
        </button>
      </div>
      <div className="flex-1 min-h-0 overflow-y-auto p-4">
        <div className="grid grid-cols-2 gap-4">
          {DESIGN_TEMPLATES.map((template) => (
            <button
              key={template.id}
              onClick={() => onSelect(template)}
              className="text-left p-4 bg-slate-800 border border-slate-700 rounded-xl hover:border-blue-500 hover:bg-slate-750 transition-all group"
            >
              <div className="flex items-center gap-2 mb-2">
                <span className="text-slate-400 group-hover:text-blue-400 transition-colors">
                  {getCategoryIcon(template.category)}
                </span>
                <span className="text-sm font-medium text-white">{template.name}</span>
              </div>
              <p className="text-xs text-slate-400 line-clamp-2">{template.description}</p>
              <div className="mt-3 flex items-center gap-2">
                <span
                  className={`text-xs px-2 py-0.5 rounded-full ${
                    template.design.basePreferences?.colorScheme === 'dark'
                      ? 'bg-slate-700 text-slate-300'
                      : 'bg-gray-200 text-gray-700'
                  }`}
                >
                  {template.design.basePreferences?.colorScheme}
                </span>
                <span className="text-xs px-2 py-0.5 rounded-full bg-blue-500/20 text-blue-300">
                  {template.design.basePreferences?.layout}
                </span>
              </div>
            </button>
          ))}
        </div>
      </div>
      <div className="p-4 border-t border-slate-700">
        <button
          onClick={onClose}
          className="w-full py-2 text-sm text-slate-400 hover:text-white transition-colors"
        >
          Skip and start from scratch
        </button>
      </div>
    </div>
  );
}

/**
 * Chat input component
 */
function ChatInput({
  onSend,
  onCapture,
  isLoading,
  isCapturing,
  hasSelection,
}: {
  onSend: (text: string, includeCapture: boolean) => void;
  onCapture: () => void;
  isLoading: boolean;
  isCapturing: boolean;
  hasSelection: boolean;
}) {
  const [input, setInput] = useState('');
  const [includeCapture, setIncludeCapture] = useState(false);
  const inputRef = useRef<HTMLTextAreaElement>(null);

  const handleSubmit = (e: React.FormEvent) => {
    e.preventDefault();
    if (input.trim() || includeCapture) {
      onSend(input, includeCapture);
      setInput('');
      setIncludeCapture(false);
    }
  };

  const handleKeyDown = (e: React.KeyboardEvent) => {
    if (e.key === 'Enter' && !e.shiftKey) {
      e.preventDefault();
      handleSubmit(e);
    }
  };

  return (
    <form onSubmit={handleSubmit} className="border-t border-slate-700 p-4">
      {/* Capture toggle */}
      <div className="flex items-center gap-2 mb-3">
        <button
          type="button"
          onClick={() => setIncludeCapture(!includeCapture)}
          className={`px-3 py-1.5 rounded-lg text-sm font-medium transition-colors ${
            includeCapture
              ? 'bg-blue-600 text-white'
              : 'bg-slate-700 text-slate-300 hover:bg-slate-600'
          }`}
        >
          {includeCapture ? 'Attached' : 'Attach Preview'}
        </button>

        <button
          type="button"
          onClick={onCapture}
          disabled={isCapturing}
          className="px-3 py-1.5 rounded-lg bg-slate-700 text-slate-300 hover:bg-slate-600 disabled:bg-slate-600 disabled:cursor-not-allowed text-sm font-medium transition-colors flex items-center gap-1.5"
        >
          {isCapturing ? (
            <>
              <svg className="w-3.5 h-3.5 animate-spin" fill="none" viewBox="0 0 24 24">
                <circle
                  className="opacity-25"
                  cx="12"
                  cy="12"
                  r="10"
                  stroke="currentColor"
                  strokeWidth="4"
                />
                <path
                  className="opacity-75"
                  fill="currentColor"
                  d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"
                />
              </svg>
              Capturing...
            </>
          ) : (
            'Capture Now'
          )}
        </button>

        {hasSelection && (
          <span className="text-xs text-blue-400 ml-auto">
            Element selected - AI will see it highlighted
          </span>
        )}
      </div>

      {/* Input area */}
      <div className="flex gap-2">
        <textarea
          ref={inputRef}
          value={input}
          onChange={(e) => setInput(e.target.value)}
          onKeyDown={handleKeyDown}
          placeholder="Describe what you'd like to change..."
          className="flex-1 bg-slate-800 border border-slate-600 rounded-xl px-4 py-3 text-white placeholder-slate-400 resize-none focus:outline-none focus:border-blue-500 transition-colors"
          rows={2}
          disabled={isLoading}
        />
        <button
          type="submit"
          disabled={isLoading || (!input.trim() && !includeCapture)}
          className="px-6 py-3 bg-blue-600 hover:bg-blue-500 disabled:bg-slate-600 disabled:cursor-not-allowed text-white font-medium rounded-xl transition-colors"
        >
          {isLoading ? '...' : 'Send'}
        </button>
      </div>
    </form>
  );
}

// ============================================================================
// MAIN COMPONENT
// ============================================================================

export function LayoutBuilderWizard({
  isOpen,
  onClose,
  onApplyToAppConcept,
  isFullPage = false,
}: LayoutBuilderWizardProps) {
  const {
    messages,
    design,
    isLoading,
    selectedElement,
    referenceImages,
    suggestedActions,
    recentChanges,
    hasDraftToRecover,
    canUndo,
    canRedo,
    versionHistory,
    currentVersionId,
    sendMessage,
    setSelectedElement,
    addReferenceImage,
    removeReferenceImage,
    capturePreview,
    updateDesign,
    saveDesign,
    applyToAppConcept,
    recoverDraft,
    discardDraft,
    undo,
    redo,
    retryMessage,
    exportDesign,
    importDesign,
    restoreVersion,
    deleteVersion,
    hasUnsavedChanges,
  } = useLayoutBuilder();

  const messagesEndRef = useRef<HTMLDivElement>(null);
  const fileInputRef = useRef<HTMLInputElement>(null);
  const importInputRef = useRef<HTMLInputElement>(null);

  // Toast notifications
  const { toasts, success, error, info, dismiss } = useToast();

  // Confirmation dialog state
  const [showCloseConfirm, setShowCloseConfirm] = useState(false);
  const [showApplyConfirm, setShowApplyConfirm] = useState(false);

  // Loading states for async operations
  const [isSaving, setIsSaving] = useState(false);
  const [isApplying, setIsApplying] = useState(false);
  const [isCapturing, setIsCapturing] = useState(false);

  // Template picker state - show on first open when only greeting message
  const [showTemplatePicker, setShowTemplatePicker] = useState(messages.length <= 1);

  // Version history panel state
  const [showVersionHistory, setShowVersionHistory] = useState(false);

  // Export menu state
  const [showExportMenu, setShowExportMenu] = useState(false);

  // Progress indicator state
  const [progressExpanded, setProgressExpanded] = useState(false);

  // Message windowing state for virtualization
  const [visibleMessageCount, setVisibleMessageCount] = useState(MESSAGES_PAGE_SIZE);

  // Calculate visible messages with windowing
  const { visibleMessages, hasMoreMessages, totalMessages } = useMemo(() => {
    const total = messages.length;
    const startIndex = Math.max(0, total - Math.min(visibleMessageCount, MAX_RENDERED_MESSAGES));
    const visible = messages.slice(startIndex);
    return {
      visibleMessages: visible,
      hasMoreMessages: startIndex > 0,
      totalMessages: total,
    };
  }, [messages, visibleMessageCount]);

  // Load more messages handler
  const loadMoreMessages = useCallback(() => {
    setVisibleMessageCount((prev) => Math.min(prev + MESSAGES_PAGE_SIZE, MAX_RENDERED_MESSAGES));
  }, []);

  // Reset visible count when messages significantly change (e.g., clear)
  useEffect(() => {
    if (messages.length <= MESSAGES_PAGE_SIZE) {
      setVisibleMessageCount(MESSAGES_PAGE_SIZE);
    }
  }, [messages.length]);

  // Handle close with confirmation
  const handleClose = useCallback(() => {
    if (hasUnsavedChanges) {
      setShowCloseConfirm(true);
    } else {
      onClose();
    }
  }, [hasUnsavedChanges, onClose]);

  // Handle save
  const handleSave = useCallback(async () => {
    setIsSaving(true);
    try {
      // Small delay to show loading state
      await new Promise((resolve) => setTimeout(resolve, 300));
      saveDesign();
      success('Design saved!');
    } catch (err) {
      error('Failed to save design');
    } finally {
      setIsSaving(false);
    }
  }, [saveDesign, success, error]);

  // Handle save and close
  const handleSaveAndClose = useCallback(async () => {
    setIsSaving(true);
    try {
      await new Promise((resolve) => setTimeout(resolve, 300));
      saveDesign();
      success('Design saved successfully!');
      setShowCloseConfirm(false);
      onClose();
    } catch (err) {
      error('Failed to save design');
    } finally {
      setIsSaving(false);
    }
  }, [saveDesign, onClose, success, error]);

  // Handle discard and close
  const handleDiscardAndClose = useCallback(() => {
    setShowCloseConfirm(false);
    onClose();
  }, [onClose]);

  // Handle apply with confirmation
  const handleApplyClick = useCallback(() => {
    setShowApplyConfirm(true);
  }, []);

  // Confirm apply to app concept
  const handleConfirmApply = useCallback(async () => {
    setIsApplying(true);
    try {
      await new Promise((resolve) => setTimeout(resolve, 300));
      applyToAppConcept();
      setShowApplyConfirm(false);
      success('Design applied to app concept!');
      onApplyToAppConcept?.();
    } catch (err) {
      error('Failed to apply design');
    } finally {
      setIsApplying(false);
    }
  }, [applyToAppConcept, onApplyToAppConcept, success, error]);

  // Handle capture preview
  const handleCapture = useCallback(async () => {
    setIsCapturing(true);
    try {
      const result = await capturePreview();
      if (result) {
        success('Preview captured!');
      } else {
        error('Failed to capture preview');
      }
    } catch (err) {
      error('Failed to capture preview');
    } finally {
      setIsCapturing(false);
    }
  }, [capturePreview, success, error]);

  // Keyboard shortcuts for undo/redo
  useEffect(() => {
    const handleKeyDown = (e: KeyboardEvent) => {
      if ((e.ctrlKey || e.metaKey) && e.key === 'z') {
        if (e.shiftKey) {
          e.preventDefault();
          redo();
        } else {
          e.preventDefault();
          undo();
        }
      }
    };

    if (isOpen) {
      window.addEventListener('keydown', handleKeyDown);
      return () => window.removeEventListener('keydown', handleKeyDown);
    }
  }, [isOpen, undo, redo]);

  // Auto-scroll to bottom on new messages
  useEffect(() => {
    messagesEndRef.current?.scrollIntoView({ behavior: 'smooth' });
  }, [messages]);

  // Build UIPreferences from design for LayoutPreview
  const previewPreferences: UIPreferences = {
    style: design.basePreferences?.style || 'modern',
    colorScheme: design.basePreferences?.colorScheme || 'dark',
    layout: design.basePreferences?.layout || 'single-page',
    primaryColor: design.globalStyles?.colors?.primary || '#3B82F6',
  };

  // Handle suggested action clicks
  const handleAction = useCallback(
    (action: string) => {
      switch (action) {
        case 'capture_preview':
          capturePreview();
          break;
        case 'upload_reference':
          fileInputRef.current?.click();
          break;
        case 'toggle_theme':
          updateDesign({
            basePreferences: {
              ...design.basePreferences,
              colorScheme: design.basePreferences?.colorScheme === 'dark' ? 'light' : 'dark',
            } as typeof design.basePreferences,
          });
          break;
        case 'save_design':
          saveDesign();
          break;
        case 'apply_to_concept':
          applyToAppConcept();
          onApplyToAppConcept?.();
          break;
      }
    },
    [
      capturePreview,
      updateDesign,
      design.basePreferences,
      saveDesign,
      applyToAppConcept,
      onApplyToAppConcept,
    ]
  );

  // Handle effects settings change from DesignControlPanel
  const handleEffectsChange = useCallback(
    (effects: Partial<EffectsSettings>) => {
      updateDesign({
        globalStyles: {
          ...design.globalStyles,
          effects: {
            ...design.globalStyles?.effects,
            ...effects,
          } as EffectsSettings,
        },
      });
    },
    [updateDesign, design.globalStyles]
  );

  // Handle color settings change from DesignControlPanel
  const handleColorSettingsChange = useCallback(
    (colors: Partial<ColorSettings>) => {
      updateDesign({
        globalStyles: {
          ...design.globalStyles,
          colors: {
            ...design.globalStyles?.colors,
            ...colors,
          } as ColorSettings,
        },
      });
    },
    [updateDesign, design.globalStyles]
  );

  // Handle primary color change from DesignControlPanel
  const handlePrimaryColorChange = useCallback(
    (color: string) => {
      updateDesign({
        globalStyles: {
          ...design.globalStyles,
          colors: {
            ...design.globalStyles?.colors,
            primary: color,
          } as ColorSettings,
        },
      });
    },
    [updateDesign, design.globalStyles]
  );

  // Handle reference image upload with compression
  const handleFileUpload = useCallback(
    async (e: React.ChangeEvent<HTMLInputElement>) => {
      const file = e.target.files?.[0];
      if (!file) return;

      if (!file.type.startsWith('image/')) {
        error('Please select an image file');
        e.target.value = '';
        return;
      }

      if (file.size > 10 * 1024 * 1024) {
        error('Image must be less than 10MB');
        e.target.value = '';
        return;
      }

      try {
        // Compress the image
        const { dataUrl, originalSize, compressedSize } = await compressImage(file);

        addReferenceImage(dataUrl);

        // Show compression info if significant size reduction
        const reduction = ((originalSize - compressedSize) / originalSize) * 100;
        if (reduction > 10) {
          success(
            `Image added (${formatBytes(originalSize)} ‚Üí ${formatBytes(compressedSize)}, ${Math.round(reduction)}% smaller)`
          );
        } else {
          success('Reference image added');
        }
      } catch (err) {
        error('Failed to process image. Please try another file.');
      }

      // Reset input
      e.target.value = '';
    },
    [addReferenceImage, error, success]
  );

  // Handle template selection
  const handleTemplateSelect = useCallback(
    (template: DesignTemplate) => {
      updateDesign(template.design as Partial<LayoutDesign>);
      setShowTemplatePicker(false);
      success(`Applied "${template.name}" template`);
    },
    [updateDesign, success]
  );

  // Handle export - JSON (original)
  const handleExportJSON = useCallback(() => {
    exportDesign(false);
    success('Design exported as JSON');
    setShowExportMenu(false);
  }, [exportDesign, success]);

  // Handle export - CSS Variables
  const handleExportCSS = useCallback(() => {
    const css = exportToCSSVariables(design as LayoutDesign);
    downloadExport(css, `${design.name || 'design'}-variables.css`, 'text/css');
    success('CSS variables exported');
    setShowExportMenu(false);
  }, [design, success]);

  // Handle export - Tailwind Config
  const handleExportTailwind = useCallback(() => {
    const config = exportToTailwindConfig(design as LayoutDesign);
    downloadExport(config, 'tailwind.config.js', 'application/javascript');
    success('Tailwind config exported');
    setShowExportMenu(false);
  }, [design, success]);

  // Handle export - React Component
  const handleExportReact = useCallback(() => {
    const component = exportToReactComponent(design as LayoutDesign);
    const filename = `${(design.name || 'Layout').replace(/[^a-zA-Z0-9]/g, '')}.tsx`;
    downloadExport(component, filename, 'text/typescript');
    success('React component exported');
    setShowExportMenu(false);
  }, [design, success]);

  // Handle export - Design Tokens
  const handleExportTokens = useCallback(() => {
    const tokens = exportToFigmaTokens(design as LayoutDesign);
    downloadExport(JSON.stringify(tokens, null, 2), 'design-tokens.json', 'application/json');
    success('Design tokens exported');
    setShowExportMenu(false);
  }, [design, success]);

  // Handle copy CSS to clipboard
  const handleCopyCSS = useCallback(async () => {
    const css = exportToCSSVariables(design as LayoutDesign);
    const copied = await copyToClipboard(css);
    if (copied) {
      success('CSS variables copied to clipboard');
    } else {
      error('Failed to copy to clipboard');
    }
    setShowExportMenu(false);
  }, [design, success, error]);

  // Handle import file selection
  const handleImportFile = useCallback(
    async (e: React.ChangeEvent<HTMLInputElement>) => {
      const file = e.target.files?.[0];
      if (!file) return;

      if (!file.name.endsWith('.json')) {
        error('Please select a JSON file');
        e.target.value = '';
        return;
      }

      const result = await importDesign(file);
      if (result) {
        success('Design imported successfully');
      } else {
        error('Failed to import design. Please check the file format.');
      }

      e.target.value = '';
    },
    [importDesign, success, error]
  );

  // Handle version restore
  const handleRestoreVersion = useCallback(
    (versionId: string) => {
      restoreVersion(versionId);
      success('Version restored successfully');
      setShowVersionHistory(false);
    },
    [restoreVersion, success]
  );

  // Handle version delete
  const handleDeleteVersion = useCallback(
    (versionId: string) => {
      deleteVersion(versionId);
      info('Version deleted');
    },
    [deleteVersion, info]
  );

  // Handle preference changes from preview
  const handlePreferenceChange = useCallback(
    (prefs: Partial<UIPreferences>) => {
      updateDesign({
        basePreferences: {
          ...design.basePreferences,
          style: prefs.style || design.basePreferences?.style,
          colorScheme: prefs.colorScheme || design.basePreferences?.colorScheme,
          layout: prefs.layout || design.basePreferences?.layout,
        } as typeof design.basePreferences,
        globalStyles: {
          ...design.globalStyles,
          colors: {
            ...design.globalStyles?.colors,
            primary: prefs.primaryColor || design.globalStyles?.colors?.primary,
          },
        } as typeof design.globalStyles,
      });
    },
    [design, updateDesign]
  );

  if (!isOpen) return null;

  const content = (
    <div
      className={`${isFullPage ? 'w-full h-full' : 'w-[95vw] h-[90vh] max-w-[1600px]'} bg-slate-900 rounded-2xl shadow-2xl flex flex-col overflow-hidden border border-slate-700`}
    >
      {/* Draft recovery banner */}
      {hasDraftToRecover && (
        <DraftRecoveryBanner onRecover={recoverDraft} onDiscard={discardDraft} />
      )}

      {/* Header */}
      <div className="flex items-center justify-between px-6 py-4 border-b border-slate-700">
        <div className="flex items-center gap-3">
          <h2 className="text-xl font-semibold text-white">Layout Builder</h2>
          {hasUnsavedChanges && (
            <span className="text-xs px-2 py-0.5 bg-yellow-500/20 text-yellow-400 rounded-full">
              Unsaved changes
            </span>
          )}
        </div>
        <div className="flex items-center gap-3">
          {/* Templates button */}
          <button
            onClick={() => setShowTemplatePicker(true)}
            className="px-3 py-1.5 text-sm text-slate-400 hover:text-white bg-slate-800 hover:bg-slate-700 rounded-lg transition-colors flex items-center gap-2"
            title="Choose a design template"
          >
            <svg className="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path
                strokeLinecap="round"
                strokeLinejoin="round"
                strokeWidth={2}
                d="M4 5a1 1 0 011-1h14a1 1 0 011 1v2a1 1 0 01-1 1H5a1 1 0 01-1-1V5zM4 13a1 1 0 011-1h6a1 1 0 011 1v6a1 1 0 01-1 1H5a1 1 0 01-1-1v-6zM16 13a1 1 0 011-1h2a1 1 0 011 1v6a1 1 0 01-1 1h-2a1 1 0 01-1-1v-6z"
              />
            </svg>
            Templates
          </button>

          {/* Export/Import/History buttons */}
          <div className="flex items-center gap-1">
            {/* Export dropdown */}
            <div className="relative">
              <button
                onClick={() => setShowExportMenu(!showExportMenu)}
                className={`p-2 text-slate-400 hover:text-white bg-slate-800 hover:bg-slate-700 rounded-lg transition-colors ${showExportMenu ? 'bg-slate-700 text-white' : ''}`}
                title="Export design"
              >
                <svg className="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path
                    strokeLinecap="round"
                    strokeLinejoin="round"
                    strokeWidth={2}
                    d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"
                  />
                </svg>
              </button>
              {showExportMenu && (
                <>
                  {/* Backdrop to close menu */}
                  <div className="fixed inset-0 z-40" onClick={() => setShowExportMenu(false)} />
                  {/* Dropdown menu */}
                  <div className="absolute right-0 top-full mt-1 w-56 bg-slate-800 border border-slate-700 rounded-lg shadow-xl z-50 py-1 overflow-hidden">
                    <div className="px-3 py-2 border-b border-slate-700">
                      <span className="text-xs font-medium text-slate-400 uppercase tracking-wider">
                        Export Format
                      </span>
                    </div>
                    <button
                      onClick={handleExportJSON}
                      className="w-full px-3 py-2 text-left text-sm text-slate-300 hover:bg-slate-700 hover:text-white flex items-center gap-2"
                    >
                      <svg
                        className="w-4 h-4 text-blue-400"
                        fill="none"
                        viewBox="0 0 24 24"
                        stroke="currentColor"
                      >
                        <path
                          strokeLinecap="round"
                          strokeLinejoin="round"
                          strokeWidth={2}
                          d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"
                        />
                      </svg>
                      JSON (Full Design)
                    </button>
                    <button
                      onClick={handleExportCSS}
                      className="w-full px-3 py-2 text-left text-sm text-slate-300 hover:bg-slate-700 hover:text-white flex items-center gap-2"
                    >
                      <svg
                        className="w-4 h-4 text-purple-400"
                        fill="none"
                        viewBox="0 0 24 24"
                        stroke="currentColor"
                      >
                        <path
                          strokeLinecap="round"
                          strokeLinejoin="round"
                          strokeWidth={2}
                          d="M7 21h10a2 2 0 002-2V9.414a1 1 0 00-.293-.707l-5.414-5.414A1 1 0 0012.586 3H7a2 2 0 00-2 2v14a2 2 0 002 2z"
                        />
                      </svg>
                      CSS Variables
                    </button>
                    <button
                      onClick={handleExportTailwind}
                      className="w-full px-3 py-2 text-left text-sm text-slate-300 hover:bg-slate-700 hover:text-white flex items-center gap-2"
                    >
                      <svg
                        className="w-4 h-4 text-cyan-400"
                        fill="none"
                        viewBox="0 0 24 24"
                        stroke="currentColor"
                      >
                        <path
                          strokeLinecap="round"
                          strokeLinejoin="round"
                          strokeWidth={2}
                          d="M10 20l4-16m4 4l4 4-4 4M6 16l-4-4 4-4"
                        />
                      </svg>
                      Tailwind Config
                    </button>
                    <button
                      onClick={handleExportReact}
                      className="w-full px-3 py-2 text-left text-sm text-slate-300 hover:bg-slate-700 hover:text-white flex items-center gap-2"
                    >
                      <svg
                        className="w-4 h-4 text-green-400"
                        fill="none"
                        viewBox="0 0 24 24"
                        stroke="currentColor"
                      >
                        <path
                          strokeLinecap="round"
                          strokeLinejoin="round"
                          strokeWidth={2}
                          d="M8 9l3 3-3 3m5 0h3M5 20h14a2 2 0 002-2V6a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"
                        />
                      </svg>
                      React Component
                    </button>
                    <button
                      onClick={handleExportTokens}
                      className="w-full px-3 py-2 text-left text-sm text-slate-300 hover:bg-slate-700 hover:text-white flex items-center gap-2"
                    >
                      <svg
                        className="w-4 h-4 text-yellow-400"
                        fill="none"
                        viewBox="0 0 24 24"
                        stroke="currentColor"
                      >
                        <path
                          strokeLinecap="round"
                          strokeLinejoin="round"
                          strokeWidth={2}
                          d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"
                        />
                      </svg>
                      Design Tokens (Figma)
                    </button>
                    <div className="border-t border-slate-700 mt-1 pt-1">
                      <button
                        onClick={handleCopyCSS}
                        className="w-full px-3 py-2 text-left text-sm text-slate-300 hover:bg-slate-700 hover:text-white flex items-center gap-2"
                      >
                        <svg
                          className="w-4 h-4 text-slate-400"
                          fill="none"
                          viewBox="0 0 24 24"
                          stroke="currentColor"
                        >
                          <path
                            strokeLinecap="round"
                            strokeLinejoin="round"
                            strokeWidth={2}
                            d="M8 5H6a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2v-1M8 5a2 2 0 002 2h2a2 2 0 002-2M8 5a2 2 0 012-2h2a2 2 0 012 2m0 0h2a2 2 0 012 2v3m2 4H10m0 0l3-3m-3 3l3 3"
                          />
                        </svg>
                        Copy CSS to Clipboard
                      </button>
                    </div>
                  </div>
                </>
              )}
            </div>
            <button
              onClick={() => importInputRef.current?.click()}
              className="p-2 text-slate-400 hover:text-white bg-slate-800 hover:bg-slate-700 rounded-lg transition-colors"
              title="Import design from JSON file"
            >
              <svg className="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path
                  strokeLinecap="round"
                  strokeLinejoin="round"
                  strokeWidth={2}
                  d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"
                />
              </svg>
            </button>
            <button
              onClick={() => setShowVersionHistory(true)}
              className="p-2 text-slate-400 hover:text-white bg-slate-800 hover:bg-slate-700 rounded-lg transition-colors relative"
              title="View version history"
            >
              <svg className="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path
                  strokeLinecap="round"
                  strokeLinejoin="round"
                  strokeWidth={2}
                  d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"
                />
              </svg>
              {versionHistory.length > 0 && (
                <span className="absolute -top-1 -right-1 w-4 h-4 text-[10px] bg-blue-600 text-white rounded-full flex items-center justify-center">
                  {versionHistory.length > 9 ? '9+' : versionHistory.length}
                </span>
              )}
            </button>
            <input
              ref={importInputRef}
              type="file"
              accept=".json"
              onChange={handleImportFile}
              className="hidden"
            />
          </div>

          {/* Undo/Redo buttons */}
          <div className="flex items-center gap-1 mr-2">
            <button
              onClick={undo}
              disabled={!canUndo}
              className="p-2 text-slate-400 hover:text-white disabled:text-slate-600 disabled:cursor-not-allowed transition-colors"
              title="Undo (Ctrl+Z)"
            >
              <svg className="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path
                  strokeLinecap="round"
                  strokeLinejoin="round"
                  strokeWidth={2}
                  d="M3 10h10a8 8 0 018 8v2M3 10l6 6m-6-6l6-6"
                />
              </svg>
            </button>
            <button
              onClick={redo}
              disabled={!canRedo}
              className="p-2 text-slate-400 hover:text-white disabled:text-slate-600 disabled:cursor-not-allowed transition-colors"
              title="Redo (Ctrl+Shift+Z)"
            >
              <svg className="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path
                  strokeLinecap="round"
                  strokeLinejoin="round"
                  strokeWidth={2}
                  d="M21 10h-10a8 8 0 00-8 8v2M21 10l-6 6m6-6l-6-6"
                />
              </svg>
            </button>
          </div>

          <button
            onClick={handleSave}
            disabled={isSaving}
            className="px-4 py-2 bg-slate-700 hover:bg-slate-600 disabled:bg-slate-600 disabled:cursor-not-allowed text-white rounded-lg font-medium transition-colors flex items-center gap-2"
          >
            {isSaving ? (
              <>
                <svg className="w-4 h-4 animate-spin" fill="none" viewBox="0 0 24 24">
                  <circle
                    className="opacity-25"
                    cx="12"
                    cy="12"
                    r="10"
                    stroke="currentColor"
                    strokeWidth="4"
                  />
                  <path
                    className="opacity-75"
                    fill="currentColor"
                    d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"
                  />
                </svg>
                Saving...
              </>
            ) : (
              'Save Design'
            )}
          </button>
          <button
            onClick={handleApplyClick}
            disabled={isApplying}
            className="px-4 py-2 bg-green-600 hover:bg-green-500 disabled:bg-green-700 disabled:cursor-not-allowed text-white rounded-lg font-medium transition-colors flex items-center gap-2"
          >
            {isApplying ? (
              <>
                <svg className="w-4 h-4 animate-spin" fill="none" viewBox="0 0 24 24">
                  <circle
                    className="opacity-25"
                    cx="12"
                    cy="12"
                    r="10"
                    stroke="currentColor"
                    strokeWidth="4"
                  />
                  <path
                    className="opacity-75"
                    fill="currentColor"
                    d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"
                  />
                </svg>
                Applying...
              </>
            ) : (
              'Apply to App Concept'
            )}
          </button>
          <button
            onClick={handleClose}
            className="p-2 text-slate-400 hover:text-white transition-colors"
          >
            <svg className="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path
                strokeLinecap="round"
                strokeLinejoin="round"
                strokeWidth={2}
                d="M6 18L18 6M6 6l12 12"
              />
            </svg>
          </button>
        </div>
      </div>

      {/* Main content */}
      <div className="flex-1 min-h-0 flex overflow-hidden">
        {/* Chat panel (left) */}
        <div className="w-1/2 min-h-0 flex flex-col border-r border-slate-700 relative">
          {/* Template Picker Overlay */}
          <TemplatePicker
            isOpen={showTemplatePicker}
            onSelect={handleTemplateSelect}
            onClose={() => setShowTemplatePicker(false)}
          />

          {/* Messages */}
          <div className="flex-1 min-h-0 overflow-y-auto p-4 space-y-4">
            {/* Load more button for older messages */}
            {hasMoreMessages && (
              <div className="flex justify-center mb-2">
                <button
                  type="button"
                  onClick={loadMoreMessages}
                  className="flex items-center gap-2 px-4 py-2 text-xs font-medium text-slate-400 hover:text-white bg-slate-800 hover:bg-slate-700 rounded-lg transition-colors"
                >
                  <svg className="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path
                      strokeLinecap="round"
                      strokeLinejoin="round"
                      strokeWidth={2}
                      d="M5 15l7-7 7 7"
                    />
                  </svg>
                  Load {Math.min(MESSAGES_PAGE_SIZE, totalMessages - visibleMessages.length)} older
                  messages
                  <span className="text-slate-500">
                    ({visibleMessages.length} of {totalMessages})
                  </span>
                </button>
              </div>
            )}
            {visibleMessages.map((msg) => (
              <MessageBubble key={msg.id} message={msg} onRetry={retryMessage} />
            ))}
            {isLoading && (
              <div className="flex justify-start mb-4">
                <div className="bg-slate-700 rounded-2xl px-4 py-3 text-slate-300">
                  <div className="flex items-center gap-2">
                    <div className="w-2 h-2 bg-blue-400 rounded-full animate-bounce" />
                    <div
                      className="w-2 h-2 bg-blue-400 rounded-full animate-bounce"
                      style={{ animationDelay: '0.1s' }}
                    />
                    <div
                      className="w-2 h-2 bg-blue-400 rounded-full animate-bounce"
                      style={{ animationDelay: '0.2s' }}
                    />
                  </div>
                </div>
              </div>
            )}
            <div ref={messagesEndRef} />
          </div>

          {/* Recent changes */}
          <RecentChangesIndicator changes={recentChanges} />

          {/* Design progress indicator */}
          <div className="px-4 py-2 border-t border-slate-700">
            <DesignProgressIndicator
              design={design}
              isExpanded={progressExpanded}
              onToggle={() => setProgressExpanded(!progressExpanded)}
            />
          </div>

          {/* Suggested actions */}
          <SuggestedActionsBar actions={suggestedActions} onAction={handleAction} />

          {/* Reference images */}
          <div className="px-4 py-3 border-t border-slate-700">
            <ReferenceImagesPanel
              images={referenceImages}
              onRemove={removeReferenceImage}
              onAdd={() => fileInputRef.current?.click()}
            />
            <input
              ref={fileInputRef}
              type="file"
              accept="image/*"
              onChange={handleFileUpload}
              className="hidden"
            />
          </div>

          {/* Input */}
          <ChatInput
            onSend={sendMessage}
            onCapture={handleCapture}
            isLoading={isLoading}
            isCapturing={isCapturing}
            hasSelection={!!selectedElement}
          />
        </div>

        {/* Preview panel (right) */}
        <div className="w-1/2 min-h-0 flex flex-col bg-slate-950">
          {/* Selected element indicator */}
          {selectedElement && (
            <div className="px-4 py-2 bg-blue-500/20 border-b border-blue-500/30 flex items-center justify-between">
              <span className="text-sm text-blue-300">
                Selected: <strong>{selectedElement}</strong>
              </span>
              <button
                onClick={() => setSelectedElement(null)}
                className="text-xs text-blue-400 hover:text-blue-300"
              >
                Clear selection
              </button>
            </div>
          )}

          {/* Design Control Panel */}
          <div className="px-4 pt-4">
            <DesignControlPanel
              effectsSettings={design.globalStyles?.effects}
              colorSettings={design.globalStyles?.colors}
              onEffectsChange={handleEffectsChange}
              onColorChange={handleColorSettingsChange}
              primaryColor={design.globalStyles?.colors?.primary}
              onPrimaryColorChange={handlePrimaryColorChange}
            />
          </div>

          {/* Layout Preview */}
          <div className="flex-1 min-h-0 overflow-y-auto p-4" id="layout-preview-container">
            <div id="layout-preview-frame" className="h-full">
              <LayoutPreview
                preferences={previewPreferences}
                className="h-full"
                onPreferenceChange={handlePreferenceChange}
                onElementSelect={setSelectedElement}
                selectedElement={selectedElement}
                componentDesign={{
                  effectsSettings: design.globalStyles?.effects,
                  colorSettings: design.globalStyles?.colors,
                  headerDesign: design.components?.header,
                  sidebarDesign: design.components?.sidebar,
                  cardDesign: design.components?.cards,
                  navDesign: design.components?.navigation,
                }}
              />
            </div>
          </div>
        </div>
      </div>
    </div>
  );

  const dialogs = (
    <>
      {/* Close confirmation dialog */}
      <ConfirmDialog
        isOpen={showCloseConfirm}
        title="Unsaved Changes"
        message="You have unsaved changes. Would you like to save before closing?"
        confirmLabel="Save & Close"
        cancelLabel="Discard"
        onConfirm={handleSaveAndClose}
        onCancel={handleDiscardAndClose}
        variant="warning"
      />

      {/* Apply confirmation dialog */}
      <ConfirmDialog
        isOpen={showApplyConfirm}
        title="Apply to App Concept"
        message="This will update your app concept with the current layout design. Any existing layout preferences will be overwritten."
        confirmLabel="Apply"
        cancelLabel="Cancel"
        onConfirm={handleConfirmApply}
        onCancel={() => setShowApplyConfirm(false)}
        variant="info"
      />

      {/* Version History Panel */}
      {showVersionHistory && (
        <VersionHistoryPanel
          versions={versionHistory}
          currentVersionId={currentVersionId}
          currentDesign={design}
          onRestore={handleRestoreVersion}
          onDelete={handleDeleteVersion}
          onClose={() => setShowVersionHistory(false)}
        />
      )}

      {/* Toast notifications */}
      <ToastContainer toasts={toasts} onDismiss={dismiss} position="top-right" />
    </>
  );

  if (isFullPage) {
    return (
      <>
        {content}
        {dialogs}
      </>
    );
  }

  return (
    <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/80 backdrop-blur-sm">
      {content}
      {dialogs}
    </div>
  );
}

export default LayoutBuilderWizard;
</file>

<file path="src/components/NaturalConversationWizard.tsx">
/**
 * Natural Conversation Wizard
 *
 * A complete rewrite of the ConversationalAppWizard that uses actual
 * Claude API calls for natural conversation instead of hardcoded responses.
 *
 * Key differences from old wizard:
 * - Real AI responses (not simulated)
 * - No rigid state machine
 * - Natural conversation flow
 * - Progressive concept building
 * - Dynamic phase generation
 */

'use client';

import { useState, useRef, useEffect, useCallback } from 'react';
import type {
  AppConcept,
  Feature,
  TechnicalRequirements,
  UIPreferences,
  UserRole,
} from '@/types/appConcept';
import type { DynamicPhasePlan } from '@/types/dynamicPhases';
import { useToast } from '@/components/Toast';
import {
  WIZARD_DRAFT_KEYS,
  saveWizardDraft,
  loadWizardDraft,
  deleteDraft,
  getDraftMetadata,
  formatDraftAge,
} from '@/utils/wizardAutoSave';
import {
  compressConversation,
  buildCompressedContext,
  needsCompression,
} from '@/utils/contextCompression';
import { buildStructuredContext, structuredContextToSummary } from '@/utils/structuredExtraction';
import {
  segmentConversation,
  getHighImportanceSegments,
  buildContextFromSegments,
  getSegmentationSummary,
} from '@/utils/conversationSegmentation';

// ============================================================================
// TYPES
// ============================================================================

interface Message {
  id: string;
  role: 'user' | 'assistant' | 'system';
  content: string;
  timestamp: Date;
  attachments?: string[]; // Base64 images
}

interface WizardState {
  name?: string;
  description?: string;
  purpose?: string;
  targetUsers?: string;
  features: Feature[];
  technical: Partial<TechnicalRequirements>;
  uiPreferences: Partial<UIPreferences>;
  roles?: Array<{ name: string; capabilities: string[] }>;
  workflows?: Array<{
    name: string;
    description?: string;
    steps: string[];
    involvedRoles: string[];
  }>;
  isComplete: boolean;
  readyForPhases: boolean;
}

interface SuggestedAction {
  label: string;
  action: string;
}

interface NaturalConversationWizardProps {
  onComplete: (concept: AppConcept, phasePlan?: DynamicPhasePlan) => void;
  onCancel: () => void;
  initialConcept?: Partial<AppConcept>;
  isFullPage?: boolean;
}

// ============================================================================
// COMPONENT
// ============================================================================

export default function NaturalConversationWizard({
  onComplete,
  onCancel,
  initialConcept,
  isFullPage = false,
}: NaturalConversationWizardProps) {
  // State
  const [messages, setMessages] = useState<Message[]>([]);
  const [userInput, setUserInput] = useState('');
  const [isLoading, setIsLoading] = useState(false);
  const [wizardState, setWizardState] = useState<WizardState>({
    name: initialConcept?.name,
    description: initialConcept?.description,
    features: initialConcept?.coreFeatures || [],
    technical: initialConcept?.technical || {},
    uiPreferences: initialConcept?.uiPreferences || {},
    isComplete: false,
    readyForPhases: false,
  });
  const [suggestedActions, setSuggestedActions] = useState<SuggestedAction[]>([]);
  const [phasePlan, setPhasePlan] = useState<DynamicPhasePlan | null>(null);
  const [isGeneratingPhases, setIsGeneratingPhases] = useState(false);
  const [pendingImages, setPendingImages] = useState<string[]>([]);
  const [error, setError] = useState<string | null>(null);
  const [showRecoveryPrompt, setShowRecoveryPrompt] = useState(false);
  const [draftAge, setDraftAge] = useState<string>('');
  const [isInitialized, setIsInitialized] = useState(false);
  const [showAllMessages, setShowAllMessages] = useState(false);

  // Message windowing - limit rendered messages for performance
  const MAX_VISIBLE_MESSAGES = 100;

  // Refs
  const chatEndRef = useRef<HTMLDivElement>(null);
  const inputRef = useRef<HTMLTextAreaElement>(null);
  const fileInputRef = useRef<HTMLInputElement>(null);

  const { showToast } = useToast();

  // ============================================================================
  // INITIALIZATION & PERSISTENCE
  // ============================================================================

  // Check for existing draft on mount
  useEffect(() => {
    const checkForDraft = () => {
      const messagesMetadata = getDraftMetadata(WIZARD_DRAFT_KEYS.CONVERSATION_MESSAGES);
      const stateMetadata = getDraftMetadata(WIZARD_DRAFT_KEYS.CONVERSATION_STATE);

      console.log('[Wizard] Checking for drafts:', { messagesMetadata, stateMetadata });

      // If we have a saved conversation with more than just the greeting
      if (messagesMetadata || stateMetadata) {
        const savedMessages = loadWizardDraft<Message[]>(WIZARD_DRAFT_KEYS.CONVERSATION_MESSAGES);
        console.log('[Wizard] Loaded messages:', savedMessages?.length, 'messages');

        // Check if there's actual conversation content (more than just greeting)
        if (savedMessages && savedMessages.length > 1) {
          const timestamp = messagesMetadata?.savedAt || stateMetadata?.savedAt;
          if (timestamp) {
            setDraftAge(formatDraftAge(timestamp));
          }
          console.log('[Wizard] Showing recovery prompt');
          setShowRecoveryPrompt(true);
          return;
        }
      }

      // No valid draft found, start fresh
      console.log('[Wizard] Starting fresh conversation');
      startFreshConversation();
    };

    checkForDraft();
  }, []);

  /**
   * Start a fresh conversation with greeting
   */
  const startFreshConversation = useCallback(() => {
    // Clear any existing drafts
    deleteDraft(WIZARD_DRAFT_KEYS.CONVERSATION_MESSAGES);
    deleteDraft(WIZARD_DRAFT_KEYS.CONVERSATION_STATE);
    deleteDraft(WIZARD_DRAFT_KEYS.CONVERSATION_PHASE_PLAN);

    const greeting: Message = {
      id: 'greeting',
      role: 'assistant',
      content: `Hi! I'm here to help you plan your application. Tell me about what you want to build.

You can describe your idea in as much or as little detail as you'd like. I'll ask clarifying questions to make sure I understand your vision completely.

**Examples to get started:**
- "I want to build a task management app for remote teams"
- "A mobile app for tracking fitness goals"
- "An e-commerce platform for handmade crafts"

What would you like to build?`,
      timestamp: new Date(),
    };
    setMessages([greeting]);
    setWizardState({
      name: initialConcept?.name,
      description: initialConcept?.description,
      features: initialConcept?.coreFeatures || [],
      technical: initialConcept?.technical || {},
      uiPreferences: initialConcept?.uiPreferences || {},
      isComplete: false,
      readyForPhases: false,
    });
    setPhasePlan(null);
    setSuggestedActions([]);
    setShowRecoveryPrompt(false);
    setIsInitialized(true);

    // Focus input
    setTimeout(() => inputRef.current?.focus(), 100);
  }, [initialConcept]);

  /**
   * Recover saved conversation from localStorage
   */
  const recoverConversation = useCallback(() => {
    const savedMessages = loadWizardDraft<Message[]>(WIZARD_DRAFT_KEYS.CONVERSATION_MESSAGES);
    const savedState = loadWizardDraft<WizardState>(WIZARD_DRAFT_KEYS.CONVERSATION_STATE);
    const savedPhasePlan = loadWizardDraft<DynamicPhasePlan>(
      WIZARD_DRAFT_KEYS.CONVERSATION_PHASE_PLAN
    );

    if (savedMessages && savedMessages.length > 0) {
      // Restore timestamps as Date objects
      const messagesWithDates = savedMessages.map((m) => ({
        ...m,
        timestamp: new Date(m.timestamp),
      }));
      setMessages(messagesWithDates);
    }

    if (savedState) {
      setWizardState(savedState);
    }

    if (savedPhasePlan) {
      setPhasePlan(savedPhasePlan);
      setSuggestedActions([
        { label: 'Start Building', action: 'start_building' },
        { label: 'Adjust Plan', action: 'adjust_plan' },
      ]);
    }

    setShowRecoveryPrompt(false);
    setIsInitialized(true);

    showToast({
      type: 'success',
      message: 'Previous conversation restored!',
    });

    // Focus input
    setTimeout(() => inputRef.current?.focus(), 100);
  }, [showToast]);

  // Auto-save messages when they change
  useEffect(() => {
    if (!isInitialized || messages.length === 0) return;

    // Debounce save
    const saveTimeout = setTimeout(() => {
      console.log('[Wizard] Auto-saving messages:', messages.length, 'messages');
      saveWizardDraft(WIZARD_DRAFT_KEYS.CONVERSATION_MESSAGES, messages);
    }, 500);

    return () => clearTimeout(saveTimeout);
  }, [messages, isInitialized]);

  // Auto-save wizard state when it changes
  useEffect(() => {
    if (!isInitialized) return;

    const saveTimeout = setTimeout(() => {
      saveWizardDraft(WIZARD_DRAFT_KEYS.CONVERSATION_STATE, wizardState);
    }, 500);

    return () => clearTimeout(saveTimeout);
  }, [wizardState, isInitialized]);

  // Auto-save phase plan when it changes
  useEffect(() => {
    if (!isInitialized || !phasePlan) return;

    saveWizardDraft(WIZARD_DRAFT_KEYS.CONVERSATION_PHASE_PLAN, phasePlan);
  }, [phasePlan, isInitialized]);

  /**
   * Clear all drafts (called on complete or explicit cancel)
   */
  const clearDrafts = useCallback(() => {
    deleteDraft(WIZARD_DRAFT_KEYS.CONVERSATION_MESSAGES);
    deleteDraft(WIZARD_DRAFT_KEYS.CONVERSATION_STATE);
    deleteDraft(WIZARD_DRAFT_KEYS.CONVERSATION_PHASE_PLAN);
  }, []);

  // Escape key handler
  useEffect(() => {
    const handleEscape = (e: KeyboardEvent) => {
      if (e.key === 'Escape') {
        onCancel();
      }
    };

    document.addEventListener('keydown', handleEscape);
    return () => document.removeEventListener('keydown', handleEscape);
  }, [onCancel]);

  // Auto-scroll to bottom
  useEffect(() => {
    chatEndRef.current?.scrollIntoView({ behavior: 'smooth' });
  }, [messages]);

  // ============================================================================
  // MESSAGE HANDLING
  // ============================================================================

  const sendMessage = useCallback(
    async (messageText: string, images?: string[]) => {
      if (!messageText.trim() && !images?.length) return;

      setError(null);
      setIsLoading(true);

      // Add user message
      const userMessage: Message = {
        id: `user-${Date.now()}`,
        role: 'user',
        content: messageText,
        timestamp: new Date(),
        attachments: images,
      };
      setMessages((prev) => [...prev, userMessage]);
      setUserInput('');
      setPendingImages([]);

      try {
        // Prepare conversation history for API with compression for large conversations
        const MAX_CONTEXT_TOKENS = 100000;
        let conversationHistory: Array<{ role: 'user' | 'assistant'; content: string }>;
        let contextSummary: string | undefined;

        // Filter out system messages and convert to ChatMessage format for compression
        const filteredMessages = messages
          .filter((m) => m.role !== 'system')
          .map((m) => ({
            id: m.id,
            role: m.role as 'user' | 'assistant',
            content: m.content,
            timestamp: m.timestamp.toISOString(),
          }));

        if (needsCompression(filteredMessages, MAX_CONTEXT_TOKENS)) {
          // Compress older messages while preserving recent context
          const compressed = compressConversation(filteredMessages, {
            maxTokens: MAX_CONTEXT_TOKENS,
            preserveLastN: 8,
          });

          conversationHistory = compressed.recentMessages.map((m) => ({
            role: m.role as 'user' | 'assistant',
            content: m.content,
          }));

          // Build summary context if messages were compressed
          if (compressed.summary.messageCount > 0) {
            contextSummary = buildCompressedContext(compressed);
            console.log(
              `[Wizard] Compressed ${compressed.summary.messageCount} messages, ` +
                `ratio: ${compressed.compressionRatio.toFixed(2)}x`
            );
          }
        } else {
          conversationHistory = filteredMessages.map((m) => ({
            role: m.role as 'user' | 'assistant',
            content: m.content,
          }));
        }

        // Call the wizard chat API
        const response = await fetch('/api/wizard/chat', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            message: messageText,
            conversationHistory,
            currentState: wizardState,
            referenceImages: images,
            contextSummary, // Include compressed summary if conversation was large
          }),
        });

        if (!response.ok) {
          const errorData = await response.json();
          throw new Error(errorData.error || 'Failed to get response');
        }

        const data = await response.json();

        // Add assistant response
        const assistantMessage: Message = {
          id: `assistant-${Date.now()}`,
          role: 'assistant',
          content: data.message,
          timestamp: new Date(),
        };
        setMessages((prev) => [...prev, assistantMessage]);

        // Update state
        if (data.updatedState) {
          setWizardState(data.updatedState);
        }

        // Update suggested actions
        if (data.suggestedActions) {
          setSuggestedActions(data.suggestedActions);
        } else {
          setSuggestedActions([]);
        }
      } catch (err) {
        console.error('Chat error:', err);
        setError(err instanceof Error ? err.message : 'Something went wrong');
        showToast({
          type: 'error',
          message: 'Failed to get response. Please try again.',
        });
      } finally {
        setIsLoading(false);
      }
    },
    [messages, wizardState, showToast]
  );

  // ============================================================================
  // PHASE GENERATION
  // ============================================================================

  /**
   * Build conversation context summary for phase generation
   * Uses structured extraction and segmentation for rich detail preservation
   */
  const buildConversationContext = useCallback((): string => {
    const relevantMessages = messages.filter((m) => m.role !== 'system');
    if (relevantMessages.length === 0) return '';

    // Convert to ChatMessage format for extraction
    const chatMessages = relevantMessages.map((m) => ({
      id: m.id,
      role: m.role as 'user' | 'assistant',
      content: m.content,
      timestamp: m.timestamp.toISOString(),
    }));

    const contextParts: string[] = [];

    // For large conversations, use segmentation to preserve important context
    if (chatMessages.length > 20) {
      const segmentationResult = segmentConversation(chatMessages);
      const highImportanceSegments = getHighImportanceSegments(segmentationResult);

      if (highImportanceSegments.length > 0) {
        const segmentContext = buildContextFromSegments(highImportanceSegments, 2000);
        contextParts.push('=== KEY CONVERSATION SEGMENTS ===');
        contextParts.push(segmentContext);
        contextParts.push('');

        console.log(`[Wizard] Segmentation: ${getSegmentationSummary(segmentationResult)}`);
      }
    }

    // Build structured context with rich feature/role/workflow extraction
    const structuredContext = buildStructuredContext(chatMessages);
    const structuredSummary = structuredContextToSummary(structuredContext);

    // Add structured extraction
    if (structuredSummary) {
      contextParts.push('=== STRUCTURED REQUIREMENTS ===');
      contextParts.push(structuredSummary);
      contextParts.push('');
    }

    // Also include condensed recent conversation for immediate context
    const conversationSummary = relevantMessages
      .slice(-10) // Focus on most recent messages
      .map(
        (m) =>
          `${m.role.toUpperCase()}: ${m.content.slice(0, 250)}${m.content.length > 250 ? '...' : ''}`
      )
      .join('\n\n');

    contextParts.push('=== RECENT CONVERSATION ===');
    contextParts.push(conversationSummary);

    console.log(
      `[Wizard] Built context: ${structuredContext.features.length} features, ` +
        `${structuredContext.roles.length} roles, ${structuredContext.technicalSpecs.length} tech specs, ` +
        `${relevantMessages.length} messages`
    );

    return contextParts.join('\n');
  }, [messages]);

  /**
   * Convert wizard roles to AppConcept UserRole format
   */
  const convertRolesToUserRoles = useCallback((): UserRole[] | undefined => {
    if (!wizardState.roles || wizardState.roles.length === 0) return undefined;

    return wizardState.roles.map((role) => ({
      name: role.name,
      capabilities: role.capabilities,
    }));
  }, [wizardState.roles]);

  /**
   * Extract workflows from conversation messages for AppConcept
   */
  const extractWorkflowsFromConversation = useCallback(() => {
    const relevantMessages = messages.filter((m) => m.role !== 'system');
    if (relevantMessages.length === 0) return undefined;

    const chatMessages = relevantMessages.map((m) => ({
      id: m.id,
      role: m.role as 'user' | 'assistant',
      content: m.content,
      timestamp: m.timestamp.toISOString(),
    }));

    const structuredContext = buildStructuredContext(chatMessages);

    if (structuredContext.workflows.length === 0) return undefined;

    return structuredContext.workflows.map((w) => ({
      name: w.name,
      description: w.description || w.triggerCondition,
      steps: w.steps.map((s) => s.action),
      involvedRoles: w.involvedRoles,
    }));
  }, [messages]);

  const generatePhases = useCallback(async () => {
    if (!wizardState.name || wizardState.features.length === 0) {
      showToast({
        type: 'error',
        message: 'Please complete the app concept before generating phases.',
      });
      return;
    }

    setIsGeneratingPhases(true);

    try {
      // Build complete concept with ALL details from the conversation
      const concept: AppConcept = {
        name: wizardState.name!,
        description: wizardState.description || `A ${wizardState.name} application`,
        purpose: wizardState.purpose || wizardState.description || '',
        targetUsers: wizardState.targetUsers || 'General users',
        coreFeatures: wizardState.features,
        uiPreferences: {
          style: 'modern',
          colorScheme: 'auto',
          layout: 'single-page',
          ...wizardState.uiPreferences,
        } as UIPreferences,
        technical: {
          needsAuth: false,
          needsDatabase: false,
          needsAPI: false,
          needsFileUpload: false,
          needsRealtime: false,
          ...wizardState.technical,
        } as TechnicalRequirements,
        // NEW: Preserve roles from wizard conversation
        roles: convertRolesToUserRoles(),
        // NEW: Preserve workflows extracted from conversation
        workflows: extractWorkflowsFromConversation(),
        // NEW: Preserve full conversation context for detail retention
        conversationContext: buildConversationContext(),
        createdAt: new Date().toISOString(),
        updatedAt: new Date().toISOString(),
      };

      // Call phase generation API
      const response = await fetch('/api/wizard/generate-phases', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ concept }),
      });

      if (!response.ok) {
        const errorData = await response.json();
        throw new Error(errorData.error || 'Failed to generate phases');
      }

      const data = await response.json();

      if (data.success && data.plan) {
        setPhasePlan(data.plan);

        // Add message showing the plan
        const planMessage: Message = {
          id: `plan-${Date.now()}`,
          role: 'assistant',
          content: formatPhasePlanMessage(data.plan),
          timestamp: new Date(),
        };
        setMessages((prev) => [...prev, planMessage]);

        // Update suggested actions
        setSuggestedActions([
          { label: 'Start Building', action: 'start_building' },
          { label: 'Adjust Plan', action: 'adjust_plan' },
        ]);
      }
    } catch (err) {
      console.error('Phase generation error:', err);
      showToast({
        type: 'error',
        message: err instanceof Error ? err.message : 'Failed to generate phases',
      });
    } finally {
      setIsGeneratingPhases(false);
    }
  }, [wizardState, showToast]);

  // Auto-trigger phase generation when ready
  useEffect(() => {
    if (wizardState.readyForPhases && !phasePlan && !isGeneratingPhases) {
      generatePhases();
    }
  }, [wizardState.readyForPhases, phasePlan, isGeneratingPhases, generatePhases]);

  /**
   * Format the phase plan as a readable message
   */
  const formatPhasePlanMessage = (plan: DynamicPhasePlan): string => {
    let message = `## Implementation Plan: ${plan.appName}

**Complexity:** ${plan.complexity}
**Total Phases:** ${plan.totalPhases}
**Estimated Time:** ${plan.estimatedTotalTime}

---

### Phases:

`;

    for (const phase of plan.phases) {
      message += `**Phase ${phase.number}: ${phase.name}** (${phase.estimatedTime})
${phase.description}
`;
      if (phase.features.length > 0 && phase.features.length <= 5) {
        message += `- ${phase.features.join('\n- ')}\n`;
      }
      message += '\n';
    }

    message += `---

Does this look good? You can:
- **Start building** to begin with Phase 1
- Ask me to **adjust** any phases
- Add or remove features before starting`;

    return message;
  };

  // ============================================================================
  // ACTION HANDLING
  // ============================================================================

  const handleAction = useCallback(
    (action: string) => {
      switch (action) {
        case 'generate_phases':
          generatePhases();
          break;

        case 'start_building':
          if (phasePlan) {
            const concept: AppConcept = {
              name: wizardState.name!,
              description: wizardState.description || '',
              purpose: wizardState.purpose || '',
              targetUsers: wizardState.targetUsers || '',
              coreFeatures: wizardState.features,
              uiPreferences: wizardState.uiPreferences as UIPreferences,
              technical: wizardState.technical as TechnicalRequirements,
              // Preserve roles from wizard conversation
              roles: convertRolesToUserRoles(),
              // Preserve workflows extracted from conversation
              workflows: extractWorkflowsFromConversation(),
              // Preserve full conversation context for detail retention
              conversationContext: buildConversationContext(),
              createdAt: new Date().toISOString(),
              updatedAt: new Date().toISOString(),
            };
            // Clear drafts since we're completing the wizard
            clearDrafts();
            onComplete(concept, phasePlan);
          }
          break;

        case 'adjust_plan':
          sendMessage("I'd like to adjust the implementation plan");
          break;

        case 'browse_templates':
          sendMessage('Show me some app templates to get inspired');
          break;

        case 'upload_reference':
          fileInputRef.current?.click();
          break;

        default:
          console.warn('Unknown action:', action);
      }
    },
    [generatePhases, phasePlan, wizardState, onComplete, sendMessage, clearDrafts]
  );

  // ============================================================================
  // FILE HANDLING
  // ============================================================================

  const handleFileUpload = (event: React.ChangeEvent<HTMLInputElement>) => {
    const files = event.target.files;
    if (!files) return;

    const newImages: string[] = [];
    let processed = 0;

    Array.from(files).forEach((file) => {
      if (!file.type.startsWith('image/')) {
        showToast({ type: 'error', message: 'Only images are supported' });
        return;
      }

      if (file.size > 5 * 1024 * 1024) {
        showToast({ type: 'error', message: 'Image must be under 5MB' });
        return;
      }

      const reader = new FileReader();
      reader.onloadend = () => {
        newImages.push(reader.result as string);
        processed++;

        if (processed === files.length) {
          setPendingImages((prev) => [...prev, ...newImages]);
        }
      };
      reader.readAsDataURL(file);
    });

    // Reset input
    event.target.value = '';
  };

  const removePendingImage = (index: number) => {
    setPendingImages((prev) => prev.filter((_, i) => i !== index));
  };

  // ============================================================================
  // KEYBOARD HANDLING
  // ============================================================================

  const handleKeyDown = (e: React.KeyboardEvent<HTMLTextAreaElement>) => {
    if (e.key === 'Enter' && !e.shiftKey) {
      e.preventDefault();
      if (!isLoading && (userInput.trim() || pendingImages.length > 0)) {
        sendMessage(userInput, pendingImages.length > 0 ? pendingImages : undefined);
      }
    }
  };

  // ============================================================================
  // RENDER
  // ============================================================================

  // Show recovery prompt if there's a saved conversation
  if (showRecoveryPrompt) {
    return (
      <div
        className="fixed inset-0 bg-black/80 backdrop-blur-sm z-50 flex items-center justify-center p-4"
        onClick={onCancel}
      >
        <div
          className="bg-slate-900 text-white rounded-2xl border border-white/10 shadow-2xl p-8 max-w-md w-full"
          onClick={(e) => e.stopPropagation()}
        >
          <div className="text-center">
            <div className="w-16 h-16 mx-auto rounded-full bg-gradient-to-br from-blue-500 to-purple-500 flex items-center justify-center text-3xl mb-4">
              <span role="img" aria-label="restore">
                &#128190;
              </span>
            </div>
            <h2 className="text-xl font-bold mb-2">Resume Previous Session?</h2>
            <p className="text-slate-400 mb-6">
              You have an unsaved conversation from{' '}
              <span className="text-white font-medium">{draftAge}</span>. Would you like to continue
              where you left off?
            </p>
            <div className="flex gap-3">
              <button
                onClick={startFreshConversation}
                className="flex-1 px-4 py-3 bg-slate-700 hover:bg-slate-600 rounded-xl font-medium transition-colors"
              >
                Start Fresh
              </button>
              <button
                onClick={recoverConversation}
                className="flex-1 px-4 py-3 bg-gradient-to-r from-blue-600 to-purple-600 hover:from-blue-500 hover:to-purple-500 rounded-xl font-medium transition-colors"
              >
                Resume
              </button>
            </div>
            <button
              onClick={onCancel}
              className="mt-4 text-sm text-slate-500 hover:text-slate-300 transition-colors"
            >
              Cancel
            </button>
          </div>
        </div>
      </div>
    );
  }

  const content = (
    <div
      className={`flex w-full ${isFullPage ? 'h-full' : 'max-w-7xl h-[90vh]'} bg-slate-900 text-white ${isFullPage ? '' : 'rounded-2xl border border-white/10 shadow-2xl'} overflow-hidden`}
      onClick={(e) => e.stopPropagation()}
    >
      {/* Main Chat Area */}
      <div className="flex-1 min-h-0 flex flex-col">
        {/* Header */}
        <div className="flex items-center justify-between px-6 py-4 border-b border-slate-700/50">
          <div className="flex items-center gap-3">
            <div className="w-10 h-10 rounded-xl bg-gradient-to-br from-purple-500 to-blue-500 flex items-center justify-center text-xl">
              <span role="img" aria-label="wizard">
                &#129497;
              </span>
            </div>
            <div>
              <h1 className="font-semibold">App Planning Assistant</h1>
              <p className="text-sm text-slate-400">
                {wizardState.name ? `Planning: ${wizardState.name}` : 'Describe your app idea'}
              </p>
            </div>
          </div>
          <button
            onClick={onCancel}
            className="px-4 py-2 text-sm text-slate-400 hover:text-white transition-colors"
          >
            Cancel
          </button>
        </div>

        {/* Messages */}
        <div className="flex-1 min-h-0 overflow-y-auto px-6 py-4 space-y-4">
          {/* Load older messages button - shown when windowing is active */}
          {!showAllMessages && messages.length > MAX_VISIBLE_MESSAGES && (
            <div className="flex justify-center">
              <button
                onClick={() => setShowAllMessages(true)}
                className="px-4 py-2 text-sm text-slate-400 hover:text-white bg-slate-800 hover:bg-slate-700 rounded-lg border border-slate-600 transition-colors"
              >
                Load {messages.length - MAX_VISIBLE_MESSAGES} older messages
              </button>
            </div>
          )}

          {/* Render messages with optional windowing */}
          {(showAllMessages ? messages : messages.slice(-MAX_VISIBLE_MESSAGES)).map((message) => (
            <div
              key={message.id}
              className={`flex ${message.role === 'user' ? 'justify-end' : 'justify-start'}`}
            >
              <div
                className={`max-w-[80%] rounded-2xl px-4 py-3 ${
                  message.role === 'user'
                    ? 'bg-blue-600 text-white'
                    : message.role === 'system'
                      ? 'bg-purple-600/20 text-purple-200 border border-purple-500/30'
                      : 'bg-slate-800 text-slate-100 border border-slate-700/50'
                }`}
              >
                {/* Attachments */}
                {message.attachments && message.attachments.length > 0 && (
                  <div className="flex gap-2 mb-2">
                    {message.attachments.map((img, i) => (
                      <img
                        key={i}
                        src={img}
                        alt={`Attachment ${i + 1}`}
                        className="w-20 h-20 object-cover rounded-lg"
                      />
                    ))}
                  </div>
                )}

                {/* Content with markdown-like rendering */}
                <div className="prose prose-invert prose-sm max-w-none">
                  {message.content.split('\n').map((line, i) => {
                    // Headers
                    if (line.startsWith('## ')) {
                      return (
                        <h2 key={i} className="text-lg font-bold mt-4 mb-2">
                          {line.slice(3)}
                        </h2>
                      );
                    }
                    if (line.startsWith('### ')) {
                      return (
                        <h3 key={i} className="text-base font-semibold mt-3 mb-1">
                          {line.slice(4)}
                        </h3>
                      );
                    }
                    // Bold
                    if (line.includes('**')) {
                      const parts = line.split(/\*\*(.+?)\*\*/g);
                      return (
                        <p key={i} className="mb-1">
                          {parts.map((part, j) =>
                            j % 2 === 1 ? <strong key={j}>{part}</strong> : part
                          )}
                        </p>
                      );
                    }
                    // List items
                    if (line.startsWith('- ')) {
                      return (
                        <li key={i} className="ml-4">
                          {line.slice(2)}
                        </li>
                      );
                    }
                    // Horizontal rule
                    if (line === '---') {
                      return <hr key={i} className="my-3 border-slate-600" />;
                    }
                    // Tables (simple rendering)
                    if (line.startsWith('|')) {
                      return (
                        <p key={i} className="font-mono text-sm">
                          {line}
                        </p>
                      );
                    }
                    // Regular text
                    if (line.trim()) {
                      return (
                        <p key={i} className="mb-1">
                          {line}
                        </p>
                      );
                    }
                    return null;
                  })}
                </div>
              </div>
            </div>
          ))}

          {/* Loading indicator */}
          {isLoading && (
            <div className="flex justify-start">
              <div className="bg-slate-800 rounded-2xl px-4 py-3 border border-slate-700/50">
                <div className="flex items-center gap-2">
                  <div className="flex gap-1">
                    <span
                      className="w-2 h-2 bg-blue-400 rounded-full animate-bounce"
                      style={{ animationDelay: '0ms' }}
                    />
                    <span
                      className="w-2 h-2 bg-blue-400 rounded-full animate-bounce"
                      style={{ animationDelay: '150ms' }}
                    />
                    <span
                      className="w-2 h-2 bg-blue-400 rounded-full animate-bounce"
                      style={{ animationDelay: '300ms' }}
                    />
                  </div>
                  <span className="text-slate-400 text-sm">Thinking...</span>
                </div>
              </div>
            </div>
          )}

          {/* Phase generation indicator */}
          {isGeneratingPhases && (
            <div className="flex justify-start">
              <div className="bg-purple-600/20 rounded-2xl px-4 py-3 border border-purple-500/30">
                <div className="flex items-center gap-2">
                  <div className="w-4 h-4 border-2 border-purple-400 border-t-transparent rounded-full animate-spin" />
                  <span className="text-purple-200">Generating implementation plan...</span>
                </div>
              </div>
            </div>
          )}

          {/* Error message */}
          {error && (
            <div className="flex justify-center">
              <div className="bg-red-500/20 text-red-200 rounded-lg px-4 py-2 text-sm">{error}</div>
            </div>
          )}

          <div ref={chatEndRef} />
        </div>

        {/* Suggested Actions */}
        {suggestedActions.length > 0 && !isLoading && (
          <div className="px-6 py-2 flex flex-wrap gap-2">
            {suggestedActions.map((action, i) => (
              <button
                key={i}
                onClick={() => handleAction(action.action)}
                className="px-4 py-2 bg-slate-800 hover:bg-slate-700 border border-slate-600 rounded-full text-sm transition-colors"
              >
                {action.label}
              </button>
            ))}
          </div>
        )}

        {/* Pending Images Preview */}
        {pendingImages.length > 0 && (
          <div className="px-6 py-2 flex gap-2">
            {pendingImages.map((img, i) => (
              <div key={i} className="relative">
                <img
                  src={img}
                  alt={`Upload ${i + 1}`}
                  className="w-16 h-16 object-cover rounded-lg"
                />
                <button
                  onClick={() => removePendingImage(i)}
                  className="absolute -top-1 -right-1 w-5 h-5 bg-red-500 rounded-full flex items-center justify-center text-xs"
                >
                  x
                </button>
              </div>
            ))}
          </div>
        )}

        {/* Input Area */}
        <div className="px-6 py-4 border-t border-slate-700/50">
          <div className="flex items-end gap-3">
            {/* File upload button */}
            <button
              onClick={() => fileInputRef.current?.click()}
              className="p-3 text-slate-400 hover:text-white hover:bg-slate-800 rounded-xl transition-colors"
              title="Upload design reference"
            >
              <span role="img" aria-label="image">
                &#128444;
              </span>
            </button>
            <input
              ref={fileInputRef}
              type="file"
              accept="image/*"
              multiple
              onChange={handleFileUpload}
              className="hidden"
            />

            {/* Text input */}
            <div className="flex-1 relative">
              <textarea
                ref={inputRef}
                value={userInput}
                onChange={(e) => setUserInput(e.target.value)}
                onKeyDown={handleKeyDown}
                placeholder="Describe your app idea..."
                rows={1}
                className="w-full bg-slate-800 border border-slate-600 rounded-xl px-4 py-3 pr-12 resize-none focus:outline-none focus:border-blue-500 transition-colors"
                style={{ minHeight: '48px', maxHeight: '120px' }}
              />
            </div>

            {/* Send button */}
            <button
              onClick={() =>
                sendMessage(userInput, pendingImages.length > 0 ? pendingImages : undefined)
              }
              disabled={isLoading || (!userInput.trim() && pendingImages.length === 0)}
              className={`p-3 rounded-xl transition-all ${
                isLoading || (!userInput.trim() && pendingImages.length === 0)
                  ? 'bg-slate-700 text-slate-500 cursor-not-allowed'
                  : 'bg-blue-600 hover:bg-blue-500 text-white'
              }`}
            >
              {isLoading ? (
                <div className="w-5 h-5 border-2 border-white border-t-transparent rounded-full animate-spin" />
              ) : (
                <span role="img" aria-label="send">
                  &#128640;
                </span>
              )}
            </button>
          </div>

          <p className="text-xs text-slate-500 mt-2 text-center">
            Press Enter to send, Shift+Enter for new line
          </p>
        </div>
      </div>

      {/* Side Panel - Concept Summary */}
      <div className="w-80 border-l border-slate-700/50 flex flex-col">
        <div className="p-4 border-b border-slate-700/50">
          <h2 className="font-semibold">Concept Summary</h2>
          <p className="text-sm text-slate-400">
            {wizardState.isComplete ? 'Ready to build' : 'In progress...'}
          </p>
        </div>

        <div className="flex-1 min-h-0 overflow-y-auto p-4 space-y-4">
          {/* App Name */}
          <div>
            <label className="text-xs text-slate-400 uppercase tracking-wide">App Name</label>
            <p className="mt-1">{wizardState.name || '‚Äî'}</p>
          </div>

          {/* Description */}
          {wizardState.description && (
            <div>
              <label className="text-xs text-slate-400 uppercase tracking-wide">Description</label>
              <p className="mt-1 text-sm">{wizardState.description}</p>
            </div>
          )}

          {/* Target Users */}
          {wizardState.targetUsers && (
            <div>
              <label className="text-xs text-slate-400 uppercase tracking-wide">Target Users</label>
              <p className="mt-1 text-sm">{wizardState.targetUsers}</p>
            </div>
          )}

          {/* Roles */}
          {wizardState.roles && wizardState.roles.length > 0 && (
            <div>
              <label className="text-xs text-slate-400 uppercase tracking-wide">User Roles</label>
              <ul className="mt-1 space-y-1">
                {wizardState.roles.map((role, i) => (
                  <li key={i} className="text-sm">
                    <strong>{role.name}:</strong> {role.capabilities.slice(0, 2).join(', ')}
                    {role.capabilities.length > 2 && ` +${role.capabilities.length - 2} more`}
                  </li>
                ))}
              </ul>
            </div>
          )}

          {/* Features */}
          {wizardState.features.length > 0 && (
            <div>
              <label className="text-xs text-slate-400 uppercase tracking-wide">
                Features ({wizardState.features.length})
              </label>
              <ul className="mt-1 space-y-1">
                {wizardState.features.slice(0, 6).map((feature, i) => (
                  <li key={i} className="text-sm flex items-center gap-2">
                    <span
                      className={`w-2 h-2 rounded-full ${
                        feature.priority === 'high'
                          ? 'bg-red-400'
                          : feature.priority === 'medium'
                            ? 'bg-yellow-400'
                            : 'bg-green-400'
                      }`}
                    />
                    {feature.name}
                  </li>
                ))}
                {wizardState.features.length > 6 && (
                  <li className="text-sm text-slate-400">
                    +{wizardState.features.length - 6} more features
                  </li>
                )}
              </ul>
            </div>
          )}

          {/* Technical */}
          {Object.values(wizardState.technical).some((v) => v !== undefined) && (
            <div>
              <label className="text-xs text-slate-400 uppercase tracking-wide">Technical</label>
              <div className="mt-1 flex flex-wrap gap-1">
                {wizardState.technical.needsAuth && (
                  <span className="px-2 py-0.5 bg-blue-500/20 text-blue-300 rounded text-xs">
                    Auth
                  </span>
                )}
                {wizardState.technical.needsDatabase && (
                  <span className="px-2 py-0.5 bg-green-500/20 text-green-300 rounded text-xs">
                    Database
                  </span>
                )}
                {wizardState.technical.needsRealtime && (
                  <span className="px-2 py-0.5 bg-purple-500/20 text-purple-300 rounded text-xs">
                    Real-time
                  </span>
                )}
                {wizardState.technical.needsFileUpload && (
                  <span className="px-2 py-0.5 bg-orange-500/20 text-orange-300 rounded text-xs">
                    Files
                  </span>
                )}
                {wizardState.technical.needsAPI && (
                  <span className="px-2 py-0.5 bg-pink-500/20 text-pink-300 rounded text-xs">
                    API
                  </span>
                )}
              </div>
            </div>
          )}

          {/* Phase Plan */}
          {phasePlan && (
            <div>
              <label className="text-xs text-slate-400 uppercase tracking-wide">
                Implementation Plan ({phasePlan.totalPhases} phases)
              </label>
              <div className="mt-2 space-y-1">
                {phasePlan.phases.slice(0, 5).map((phase) => (
                  <div key={phase.number} className="flex items-center gap-2 text-sm">
                    <span className="w-5 h-5 rounded-full bg-slate-700 flex items-center justify-center text-xs">
                      {phase.number}
                    </span>
                    <span className="truncate">{phase.name}</span>
                  </div>
                ))}
                {phasePlan.phases.length > 5 && (
                  <p className="text-sm text-slate-400 pl-7">
                    +{phasePlan.phases.length - 5} more phases
                  </p>
                )}
              </div>
            </div>
          )}
        </div>

        {/* Action Buttons */}
        {phasePlan && (
          <div className="p-4 border-t border-slate-700/50">
            <button
              onClick={() => handleAction('start_building')}
              className="w-full py-3 bg-gradient-to-r from-blue-600 to-purple-600 hover:from-blue-500 hover:to-purple-500 rounded-xl font-medium transition-all"
            >
              Start Building
            </button>
          </div>
        )}
      </div>
    </div>
  );

  // Return with or without modal wrapper based on isFullPage
  if (isFullPage) {
    return content;
  }

  return (
    <div
      className="fixed inset-0 bg-black/80 backdrop-blur-sm z-50 flex items-center justify-center p-4"
      onClick={onCancel}
    >
      {content}
    </div>
  );
}
</file>

<file path="src/components/AIBuilder.tsx">
'use client';

/**
 * AIBuilder - Refactored Orchestrator Component
 *
 * This component has been refactored from 3182 lines to ~1570 lines (50% reduction).
 * It now uses:
 * - Zustand store for state management
 * - Extracted ChatPanel and PreviewPanel components
 * - Custom hooks (useVersionControl, useDatabaseSync, useKeyboardShortcuts, useFileStorage, useMessageSender, useDynamicBuildPhases)
 * - Modal components from ./modals
 *
 * All functionality is preserved from the original implementation.
 */

import React, { useState, useEffect, useRef, useCallback, useMemo } from 'react';
import { useAuth } from '@/contexts/AuthContext';
import { useAppStore } from '@/store/useAppStore';

// Extracted components
import { ChatPanel } from './ChatPanel';
import { PreviewPanel } from './PreviewPanel';
import { ToastProvider } from './Toast';
import AppConceptWizard from './AppConceptWizard';
import NaturalConversationWizard from './NaturalConversationWizard';
import LayoutBuilderWizard from './LayoutBuilderWizard';
import SettingsPage from './SettingsPage';
import BuilderHeader from './BuilderHeader';
import TabNavigation from './TabNavigation';

// UI components
import { ResizablePanelGroup, ResizablePanel, ResizableHandle } from './ui';

// Modal components
import {
  LibraryModal,
  ApprovalModal,
  VersionHistoryModal,
  DeploymentModal,
  DiffPreviewModal,
  StagingConsentModal,
  CompareVersionsModal,
  PhasedBuildPanel,
} from './modals';

// Build system components
import { PhaseDetailView } from './build';

// Custom hooks
import {
  useDatabaseSync,
  useFileStorage,
  useVersionControl,
  useKeyboardShortcuts,
  useMessageSender,
} from '@/hooks';
import { useDynamicBuildPhases } from '@/hooks/useDynamicBuildPhases';
import { useStreamingGeneration } from '@/hooks/useStreamingGeneration';

// Context Compression
import {
  compressConversation,
  buildCompressedContext,
  needsCompression,
} from '@/utils/contextCompression';

// Types
import type { AppConcept, ImplementationPlan, BuildPhase } from '../types/appConcept';
import type {
  GeneratedComponent,
  ChatMessage,
  AppVersion,
  StagePlan,
  Phase,
  PendingChange,
  PendingDiff,
  CurrentStagePlan,
} from '../types/aiBuilderTypes';
import type { PhasedAppConcept, PhaseId } from '../types/buildPhases';
import type { DynamicPhasePlan } from '../types/dynamicPhases';
import { buildPhaseExecutionPrompt } from '../services/PhaseExecutionManager';

// Utils
import {
  exportAppAsZip,
  downloadBlob,
  parseAppFiles,
  getDeploymentInstructions,
  type DeploymentInstructions,
} from '../utils/exportApp';

// Services
import { createClient } from '@/utils/supabase/client';
import { StorageService } from '@/services/StorageService';
import { StorageAnalyticsService } from '@/services/StorageAnalytics';

// ============================================================================
// HELPER FUNCTIONS
// ============================================================================

/**
 * Generate a unique ID for messages and components
 * Uses crypto.randomUUID() with fallback for older environments
 */
function generateId(): string {
  if (typeof crypto !== 'undefined' && crypto.randomUUID) {
    return crypto.randomUUID();
  }
  // Fallback for environments without crypto.randomUUID
  return `${Date.now()}-${Math.random().toString(36).substring(2, 11)}`;
}

/**
 * Get welcome message for new conversations
 */
function getWelcomeMessage(): ChatMessage {
  return {
    id: 'welcome',
    role: 'system',
    content:
      "üëã Hi! I'm your AI App Builder.\n\nüéØ **How It Works:**\n\n**üí≠ PLAN Mode** (Current):\n‚Ä¢ Discuss what you want to build\n‚Ä¢ Design requirements and architecture\n‚Ä¢ No code - just planning and roadmapping\n\n**‚ö° ACT Mode:**\n‚Ä¢ Generates working code from our plan\n‚Ä¢ Modifies apps with surgical precision\n‚Ä¢ Real-time streaming progress\n\n**üîí Smart Protection:**\n‚Ä¢ Every change saved to version history\n‚Ä¢ One-click undo/redo anytime\n‚Ä¢ Review changes before applying\n\n**‚ú® Pro Features:**\nüßô‚Äç‚ôÇÔ∏è Use Wizards for guided planning ‚Ä¢ üèóÔ∏è Build in phases ‚Ä¢ üñºÔ∏è Upload design inspiration ‚Ä¢ üì¶ Export & deploy\n\nüí° **Start by telling me what you want to build, and we'll plan it together!**",
    timestamp: new Date().toISOString(),
  };
}

/**
 * Extract component name from user prompt
 */
function extractComponentName(prompt: string): string {
  const words = prompt.split(' ').slice(0, 3).join(' ');
  return words.length > 30 ? words.slice(0, 27) + '...' : words;
}

/**
 * Phase data structure from API response
 * Properties are optional since API responses may be incomplete
 */
interface PhaseApiData {
  number?: number;
  name?: string;
  description?: string;
  features?: string[];
}

/**
 * Format phase data from API response into displayable content
 * Safely handles potentially missing properties with defaults
 */
function formatPhaseContent(phases: PhaseApiData[]): string {
  if (!Array.isArray(phases) || phases.length === 0) {
    return 'No phases defined';
  }

  return phases
    .map((phase, index) => {
      const phaseNumber = phase.number ?? index + 1;
      const phaseName = phase.name ?? 'Unnamed Phase';
      const phaseDescription = phase.description ?? '';
      const features = Array.isArray(phase.features)
        ? phase.features.map((f) => `  ‚Ä¢ ${f}`).join('\n')
        : '';

      return `**Phase ${phaseNumber}: ${phaseName}**\n${phaseDescription}${features ? '\n' + features : ''}`;
    })
    .join('\n\n');
}

// ============================================================================
// MAIN COMPONENT
// ============================================================================

export default function AIBuilder() {
  // Authentication
  const { user, loading: authLoading, sessionReady } = useAuth();

  // ============================================================================
  // ZUSTAND STORE STATE
  // ============================================================================
  const {
    // Chat
    chatMessages,
    setChatMessages,
    userInput,
    setUserInput,
    isGenerating,
    setIsGenerating,
    generationProgress,
    setGenerationProgress,

    // Mode
    currentMode,
    setCurrentMode,
    lastUserRequest,
    setLastUserRequest,

    // Components
    components,
    setComponents,
    currentComponent,
    setCurrentComponent,
    loadingApps,
    setLoadingApps,
    dbSyncError,
    setDbSyncError,

    // UI
    isClient,
    setIsClient,
    activeTab,
    setActiveTab,
    showLibrary,
    setShowLibrary,
    showVersionHistory,
    setShowVersionHistory,
    showSettings,
    setShowSettings,
    showDiffPreview,
    setShowDiffPreview,
    showApprovalModal,
    setShowApprovalModal,
    showDeploymentModal,
    setShowDeploymentModal,
    showCompareModal,
    setShowCompareModal,
    showNewAppStagingModal,
    setShowNewAppStagingModal,
    showConceptWizard,
    setShowConceptWizard,
    showConversationalWizard,
    setShowConversationalWizard,
    showLayoutBuilder,
    setShowLayoutBuilder,
    showAdvancedPhasedBuild,
    setShowAdvancedPhasedBuild,
    activeView,
    setActiveView,
    searchQuery,
    setSearchQuery,

    // Data
    pendingChange,
    setPendingChange,
    pendingDiff,
    setPendingDiff,
    pendingNewAppRequest,
    setPendingNewAppRequest,
    deploymentInstructions,
    setDeploymentInstructions,
    exportingApp,
    setExportingApp,
    compareVersions,
    setCompareVersions,
    currentStagePlan,
    setCurrentStagePlan,
    newAppStagePlan,
    setNewAppStagePlan,
    appConcept,
    setAppConcept,
    implementationPlan,
    setImplementationPlan,
    selectedPhaseId,
    setSelectedPhaseId,
    isValidating,
    setIsValidating,
    uploadedImage,
    setUploadedImage,

    // File storage
    contentTab,
    setContentTab,
  } = useAppStore();

  // ============================================================================
  // LOCAL STATE (refs, computed values, etc)
  // ============================================================================
  const previousModeRef = useRef<'PLAN' | 'ACT'>('PLAN');
  const fileInputRef = useRef<HTMLInputElement>(null);
  const [imageFile, setImageFile] = useState<File | null>(null);

  // Smart Conversations: Wizard state for PLAN mode
  const [wizardState, setWizardState] = useState<{
    name?: string;
    description?: string;
    features: Array<{ name: string; description: string; priority: string }>;
    technical: Record<string, boolean | string | undefined>;
    isComplete: boolean;
    readyForPhases: boolean;
  }>({
    features: [],
    technical: {},
    isComplete: false,
    readyForPhases: false,
  });

  // Dynamic Phase Generation state
  const [dynamicPhasePlan, setDynamicPhasePlan] = useState<DynamicPhasePlan | null>(null);

  // Initialize StorageService
  const [storageService] = useState(() => {
    const supabase = createClient();
    const analytics = new StorageAnalyticsService(supabase);
    return new StorageService(supabase, analytics);
  });

  // ============================================================================
  // CUSTOM HOOKS
  // ============================================================================

  // Memoized error handler for database sync to prevent infinite loops
  const handleDbError = useCallback(
    (error: string) => {
      setDbSyncError(error);
    },
    [setDbSyncError]
  );

  // Database sync hook
  const {
    saveComponent: saveComponentToDb,
    deleteComponent: deleteComponentFromDb,
    loadComponents: loadComponentsFromDb,
    isLoading: isDbLoading,
    error: dbError,
  } = useDatabaseSync({
    userId: user?.id || null,
    onError: handleDbError,
  });

  // Version control hook
  const versionControl = useVersionControl({
    currentComponent,
    onComponentUpdate: (updated) => {
      setCurrentComponent(updated);
      setComponents((prev) =>
        prev.map((comp) => (comp.id === currentComponent?.id ? updated : comp))
      );
    },
  });

  // File storage hook
  const fileStorage = useFileStorage({
    userId: user?.id || null,
    storageService,
  });

  // Message sender utilities
  const messageSender = useMessageSender({
    chatMessages,
    setChatMessages,
    currentComponent,
    setCurrentComponent,
    currentMode,
    newAppStagePlan,
    setNewAppStagePlan,
    onComponentCreated: (component) => {
      setComponents((prev) => [component, ...prev].slice(0, 50));
    },
    onShowDiffPreview: (diff) => {
      setPendingDiff(diff);
      setShowDiffPreview(true);
    },
    onShowStagingModal: (request) => {
      setPendingNewAppRequest(request);
      setShowNewAppStagingModal(true);
    },
    onSaveComponent: async (component) => {
      await saveComponentToDb(component);
    },
    uploadedImage,
    onClearImage: () => {
      setUploadedImage(null);
      setImageFile(null);
      if (fileInputRef.current) {
        fileInputRef.current.value = '';
      }
    },
  });

  // Streaming generation hook for real-time progress
  const streaming = useStreamingGeneration({
    onStart: () => {
      setGenerationProgress('Starting generation...');
    },
    onFileStart: (filePath) => {
      setGenerationProgress(`Generating ${filePath.split('/').pop()}...`);
    },
    onComplete: (data, stats) => {
      console.log(
        `Generation complete: ${stats.filesGenerated} files in ${(stats.totalTime / 1000).toFixed(1)}s`
      );
    },
    onError: (message) => {
      console.error('Streaming error:', message);
    },
  });

  // Dynamic build phases hook (replaces useBuildPhases)
  const dynamicBuildPhases = useDynamicBuildPhases({
    onPhaseStart: (phase) => {
      const notification: ChatMessage = {
        id: generateId(),
        role: 'system',
        content: `üöÄ **Starting Phase ${phase.number}: ${phase.name}**\n\n${phase.description}`,
        timestamp: new Date().toISOString(),
      };
      setChatMessages((prev) => [...prev, notification]);
    },
    onPhaseComplete: (phase, result) => {
      const notification: ChatMessage = {
        id: generateId(),
        role: 'system',
        content: result.success
          ? `‚úÖ **Phase ${phase.number} Complete!**\n\nImplemented ${result.implementedFeatures.length} features in ${(result.duration / 1000).toFixed(1)}s`
          : `‚ö†Ô∏è **Phase ${phase.number} had issues**\n\n${result.errors?.join('\n') || 'Unknown error'}`,
        timestamp: new Date().toISOString(),
      };
      setChatMessages((prev) => [...prev, notification]);
    },
    onBuildComplete: (plan) => {
      const notification: ChatMessage = {
        id: generateId(),
        role: 'system',
        content: `üéâ **Build Complete!**\n\nAll ${plan.totalPhases} phases finished. Your app is ready!`,
        timestamp: new Date().toISOString(),
      };
      setChatMessages((prev) => [...prev, notification]);
    },
    onError: (error, phase) => {
      const notification: ChatMessage = {
        id: generateId(),
        role: 'system',
        content: `‚ùå **Build Error${phase ? ` in Phase ${phase.number}` : ''}**\n\n${error.message}`,
        timestamp: new Date().toISOString(),
      };
      setChatMessages((prev) => [...prev, notification]);
    },
  });

  // Keyboard shortcuts
  useKeyboardShortcuts({
    onUndo: versionControl.undo,
    onRedo: versionControl.redo,
    onSave: () => {
      if (currentComponent) {
        saveComponentToDb(currentComponent);
      }
    },
    enabled: !!currentComponent,
  });

  // ============================================================================
  // EFFECTS
  // ============================================================================

  // Initialize client-side only
  useEffect(() => {
    setIsClient(true);
    setChatMessages([getWelcomeMessage()]);
    // eslint-disable-next-line react-hooks/exhaustive-deps
  }, []); // Run only once on mount - setters are stable

  // Detect mode transitions
  useEffect(() => {
    const previousMode = previousModeRef.current;
    previousModeRef.current = currentMode;

    if (previousMode === 'PLAN' && currentMode === 'ACT') {
      const transitionMessage: ChatMessage = {
        id: generateId(),
        role: 'system',
        content: `‚ö° **Switched to ACT Mode**\n\nReady to build! I'll read the plan we discussed and implement it.\n\n**To build:** Type "build it" or "implement the plan" and I'll create your app based on our conversation.`,
        timestamp: new Date().toISOString(),
      };
      setChatMessages((prev) => [...prev, transitionMessage]);
    }

    if (previousMode === 'ACT' && currentMode === 'PLAN') {
      const transitionMessage: ChatMessage = {
        id: generateId(),
        role: 'system',
        content: `üí≠ **Switched to PLAN Mode**\n\nLet's plan your next feature or discuss improvements. I won't generate code in this mode - we'll design the requirements first.`,
        timestamp: new Date().toISOString(),
      };
      setChatMessages((prev) => [...prev, transitionMessage]);
    }
    // eslint-disable-next-line react-hooks/exhaustive-deps
  }, [currentMode]); // Only react to mode changes - setChatMessages is stable

  // Load components from database
  useEffect(() => {
    let mounted = true;

    const loadApps = async () => {
      if (!sessionReady) return;
      if (!mounted) return;

      setLoadingApps(true);
      setDbSyncError(null);

      try {
        if (user) {
          // Load from database
          const dbComponents = await loadComponentsFromDb();

          // Load from localStorage
          let localComponents: GeneratedComponent[] = [];
          if (typeof window !== 'undefined') {
            const stored = localStorage.getItem('ai_components');
            if (stored) {
              try {
                localComponents = JSON.parse(stored);
              } catch (e) {
                console.error('Error parsing localStorage:', e);
              }
            }
          }

          // Merge components
          const mergedMap = new Map<string, GeneratedComponent>();
          localComponents.forEach((comp) => mergedMap.set(comp.id, comp));
          dbComponents.forEach((comp) => mergedMap.set(comp.id, comp));

          const mergedComponents = Array.from(mergedMap.values()).sort(
            (a, b) => new Date(b.timestamp).getTime() - new Date(a.timestamp).getTime()
          );

          setComponents(mergedComponents);

          // Cache in localStorage
          if (typeof window !== 'undefined') {
            try {
              localStorage.setItem('ai_components', JSON.stringify(mergedComponents));

              // Restore last active app
              const lastAppId = localStorage.getItem('current_app_id');
              if (lastAppId && mergedComponents.length > 0) {
                const lastApp = mergedComponents.find((c) => c.id === lastAppId);
                if (lastApp) {
                  setCurrentComponent(lastApp);
                  if (lastApp.conversationHistory && lastApp.conversationHistory.length > 0) {
                    setChatMessages(lastApp.conversationHistory);
                  }
                  setActiveTab('preview');
                }
              }
            } catch (e) {
              console.warn('Failed to save to localStorage:', e);
            }
          }
        } else {
          // Load from localStorage only
          if (typeof window !== 'undefined') {
            const stored = localStorage.getItem('ai_components');
            if (stored) {
              try {
                const parsedComponents = JSON.parse(stored);
                setComponents(parsedComponents);

                const lastAppId = localStorage.getItem('current_app_id');
                if (lastAppId && parsedComponents.length > 0) {
                  const lastApp = parsedComponents.find(
                    (c: GeneratedComponent) => c.id === lastAppId
                  );
                  if (lastApp) {
                    setCurrentComponent(lastApp);
                    if (lastApp.conversationHistory && lastApp.conversationHistory.length > 0) {
                      setChatMessages(lastApp.conversationHistory);
                    }
                    setActiveTab('preview');
                  }
                }
              } catch (e) {
                console.error('Error loading components from localStorage:', e);
              }
            }
          }
        }
      } catch (error) {
        console.error('Error in loadApps:', error);
        setDbSyncError('Failed to load apps');
      } finally {
        setLoadingApps(false);
      }
    };

    loadApps();

    return () => {
      mounted = false;
    };
    // Note: This effect should only run when sessionReady or user changes.
    // loadComponentsFromDb is stable after we memoized handleDbError.
    // eslint-disable-next-line react-hooks/exhaustive-deps
  }, [sessionReady, user?.id]);

  // Save components to localStorage
  useEffect(() => {
    if (typeof window !== 'undefined' && components.length > 0) {
      try {
        localStorage.setItem('ai_components', JSON.stringify(components));
      } catch (e) {
        console.warn('Failed to save components to localStorage:', e);
      }
    }
  }, [components]);

  // Save current app ID to localStorage
  useEffect(() => {
    if (typeof window !== 'undefined' && currentComponent) {
      try {
        localStorage.setItem('current_app_id', currentComponent.id);
      } catch (e) {
        console.warn('Failed to save current app ID to localStorage:', e);
      }
    }
  }, [currentComponent?.id]);

  // Load files when storage tab is active
  useEffect(() => {
    if (user && showLibrary && contentTab === 'files') {
      fileStorage.loadFiles();
    }
    // eslint-disable-next-line react-hooks/exhaustive-deps
  }, [user, showLibrary, contentTab]); // fileStorage.loadFiles is stable

  // ============================================================================
  // HANDLERS
  // ============================================================================

  // Image upload handler
  const handleImageUpload = useCallback(
    (e: React.ChangeEvent<HTMLInputElement>) => {
      const file = e.target.files?.[0];
      if (!file) return;

      if (!file.type.startsWith('image/')) {
        alert('Please upload an image file');
        return;
      }

      if (file.size > 5 * 1024 * 1024) {
        alert('Image size must be less than 5MB');
        return;
      }

      setImageFile(file);

      const reader = new FileReader();
      reader.onloadend = () => {
        setUploadedImage(reader.result as string);
      };
      reader.readAsDataURL(file);
    },
    [setUploadedImage]
  );

  // Remove uploaded image
  const removeImage = useCallback(() => {
    setUploadedImage(null);
    setImageFile(null);
    if (fileInputRef.current) {
      fileInputRef.current.value = '';
    }
  }, [setUploadedImage]);

  // Generate implementation plan from app concept
  const generateImplementationPlan = useCallback(
    (concept: AppConcept) => {
      const phases: BuildPhase[] = [];
      let phaseNumber = 1;

      // Phase 1: Foundation & Layout
      phases.push({
        id: `phase-${phaseNumber}`,
        phaseNumber,
        name: 'Foundation & Layout',
        description: `Set up the base structure with ${concept.uiPreferences.layout} layout, ${concept.uiPreferences.style} style, and ${concept.uiPreferences.colorScheme} color scheme`,
        objectives: [
          'Create main layout structure',
          'Set up navigation',
          'Implement responsive design',
          'Apply theme and styling',
        ],
        prompt: `Create a ${concept.uiPreferences.layout} layout for "${concept.name}" with ${concept.uiPreferences.style} styling and ${concept.uiPreferences.colorScheme} color scheme.`,
        dependencies: [],
        features: [],
        estimatedComplexity: 'moderate',
        status: 'pending',
      });
      phaseNumber++;

      // Phase 2: Core Features (High Priority)
      const highPriorityFeatures = concept.coreFeatures.filter((f) => f.priority === 'high');
      if (highPriorityFeatures.length > 0) {
        phases.push({
          id: `phase-${phaseNumber}`,
          phaseNumber,
          name: 'Core Features',
          description: 'Implement high-priority features',
          objectives: highPriorityFeatures.map((f) => f.name),
          prompt: `Add these core features to "${concept.name}": ${highPriorityFeatures.map((f) => `${f.name} - ${f.description}`).join('; ')}`,
          dependencies: [`phase-${phaseNumber - 1}`],
          features: highPriorityFeatures.map((f) => f.id),
          estimatedComplexity: 'complex',
          status: 'pending',
        });
        phaseNumber++;
      }

      // More phases can be added here...

      const plan: ImplementationPlan = {
        concept,
        phases,
        estimatedSteps: phases.length,
        createdAt: new Date().toISOString(),
      };

      setImplementationPlan(plan);

      // Add system message about the plan
      const planMessage: ChatMessage = {
        id: generateId(),
        role: 'assistant',
        content:
          `üéØ **Implementation Plan Created for "${concept.name}"**\n\n` +
          `I've analyzed your app concept and created a ${phases.length}-phase build plan:\n\n` +
          phases
            .map((p) => `**Phase ${p.phaseNumber}: ${p.name}**\n${p.description}`)
            .join('\n\n') +
          `\n\nüí° **Ready to start building?** Switch to **‚ö° ACT Mode** and type "build phase 1" or "start building" to begin!`,
        timestamp: new Date().toISOString(),
      };
      setChatMessages((prev) => [...prev, planMessage]);

      // Convert to StagePlan format
      const stagePlan: StagePlan = {
        totalPhases: phases.length,
        currentPhase: 0,
        phases: phases.map((p) => ({
          number: p.phaseNumber,
          name: p.name,
          description: p.description,
          features: p.objectives,
          status: 'pending' as const,
        })),
      };
      setNewAppStagePlan(stagePlan);
    },
    [setChatMessages, setImplementationPlan, setNewAppStagePlan]
  );

  // Handle concept wizard completion
  const handleConceptComplete = useCallback(
    (concept: AppConcept) => {
      setAppConcept(concept);
      setShowConceptWizard(false);

      const welcomeMessage: ChatMessage = {
        id: generateId(),
        role: 'assistant',
        content:
          `‚ú® **App Concept Created: "${concept.name}"**\n\n` +
          `**Description:** ${concept.description}\n\n` +
          `**Target Users:** ${concept.targetUsers}\n\n` +
          `**Features:** ${concept.coreFeatures.length} defined\n\n` +
          `I'm now generating your implementation plan...`,
        timestamp: new Date().toISOString(),
      };
      setChatMessages((prev) => [...prev, welcomeMessage]);

      generateImplementationPlan(concept);
    },
    [setAppConcept, setShowConceptWizard, setChatMessages, generateImplementationPlan]
  );

  // Handle natural wizard completion with dynamic phase plan
  const handleNaturalWizardComplete = useCallback(
    (concept: AppConcept, phasePlan?: DynamicPhasePlan) => {
      setAppConcept(concept);
      setShowConversationalWizard(false);

      if (phasePlan) {
        setDynamicPhasePlan(phasePlan);
        // Initialize the dynamic build phases hook with the plan
        dynamicBuildPhases.initializePlan(phasePlan);

        // Convert to existing StagePlan format for compatibility
        const stagePlan: StagePlan = {
          totalPhases: phasePlan.totalPhases,
          currentPhase: 0,
          phases: phasePlan.phases.map((p) => ({
            number: p.number,
            name: p.name,
            description: p.description,
            features: p.features,
            status: 'pending' as const,
          })),
        };
        setNewAppStagePlan(stagePlan);

        // Show phase plan message
        const planMessage: ChatMessage = {
          id: generateId(),
          role: 'assistant',
          content:
            `üéØ **${phasePlan.totalPhases}-Phase Build Plan Created for "${concept.name}"**\n\n` +
            `**Complexity:** ${phasePlan.complexity}\n` +
            `**Estimated Time:** ${phasePlan.estimatedTotalTime}\n\n` +
            phasePlan.phases
              .map((p) => `**Phase ${p.number}: ${p.name}** (${p.estimatedTime})\n${p.description}`)
              .join('\n\n') +
            `\n\nüí° **Ready to start?** Switch to ACT mode and type "build phase 1"!`,
          timestamp: new Date().toISOString(),
        };
        setChatMessages((prev) => [...prev, planMessage]);
      } else {
        // No phase plan, just show concept created message
        const welcomeMessage: ChatMessage = {
          id: generateId(),
          role: 'assistant',
          content:
            `‚ú® **App Concept Created: "${concept.name}"**\n\n` +
            `**Description:** ${concept.description}\n\n` +
            `**Target Users:** ${concept.targetUsers}\n\n` +
            `**Features:** ${concept.coreFeatures.length} defined\n\n` +
            `I'm now generating your implementation plan...`,
          timestamp: new Date().toISOString(),
        };
        setChatMessages((prev) => [...prev, welcomeMessage]);
        generateImplementationPlan(concept);
      }
    },
    [
      setAppConcept,
      setShowConversationalWizard,
      setChatMessages,
      setNewAppStagePlan,
      generateImplementationPlan,
      dynamicBuildPhases,
    ]
  );

  // Start building with dynamic phase plan (context-chained execution)
  const startDynamicPhasedBuild = useCallback(
    async (phaseNumber: number = 1) => {
      if (!dynamicPhasePlan) {
        console.error('No dynamic phase plan available');
        const errorMessage: ChatMessage = {
          id: generateId(),
          role: 'system',
          content: '‚ùå No phase plan available. Please use the Wizard to create a plan first.',
          timestamp: new Date().toISOString(),
        };
        setChatMessages((prev) => [...prev, errorMessage]);
        return;
      }

      // Use the hook's execution context and prompt builder (avoids creating duplicate managers)
      const context = dynamicBuildPhases.getExecutionContext(phaseNumber);
      if (!context) {
        // Fallback: If hook's manager not ready, create temporary context from plan
        const phase = dynamicPhasePlan.phases.find((p) => p.number === phaseNumber);
        if (!phase) {
          console.error(`Phase ${phaseNumber} not found in plan`);
          return;
        }

        // Build a basic prompt for the fallback case
        const fallbackPrompt = `Build Phase ${phaseNumber}: ${phase.name}\n\nDescription: ${phase.description}\n\nFeatures to implement:\n${phase.features.map((f) => `- ${f}`).join('\n')}`;

        const startMessage: ChatMessage = {
          id: generateId(),
          role: 'system',
          content: `üöÄ **Starting Phase ${phaseNumber}: ${phase.name}**\n\n${phase.description}\n\n**Features to implement:**\n${phase.features.map((f) => `- ${f}`).join('\n')}`,
          timestamp: new Date().toISOString(),
        };
        setChatMessages((prev) => [...prev, startMessage]);
        setUserInput(fallbackPrompt);
      } else {
        const prompt =
          dynamicBuildPhases.getExecutionPrompt(phaseNumber) || buildPhaseExecutionPrompt(context);

        // Add a message showing we're starting this phase
        const startMessage: ChatMessage = {
          id: generateId(),
          role: 'system',
          content: `üöÄ **Starting Phase ${phaseNumber}: ${context.phaseName}**\n\n${context.phaseDescription}\n\n**Features to implement:**\n${context.features.map((f) => `- ${f}`).join('\n')}`,
          timestamp: new Date().toISOString(),
        };
        setChatMessages((prev) => [...prev, startMessage]);

        // Set the prompt in the input for the user to send or modify
        setUserInput(prompt);
      }

      // Auto-open the phased build panel when building starts
      setShowAdvancedPhasedBuild(true);

      // Mark phase as in-progress in the hook's state
      dynamicBuildPhases.startPhase(phaseNumber);
      setCurrentMode('ACT');

      // Update the stage plan to show this phase as in-progress
      setNewAppStagePlan((prev) =>
        prev
          ? {
              ...prev,
              currentPhase: phaseNumber,
              phases: prev.phases.map((p) =>
                p.number === phaseNumber ? { ...p, status: 'building' as const } : p
              ),
            }
          : null
      );
    },
    [
      dynamicPhasePlan,
      dynamicBuildPhases,
      setChatMessages,
      setUserInput,
      setCurrentMode,
      setNewAppStagePlan,
      setShowAdvancedPhasedBuild,
    ]
  );

  // Handle advanced phased build start - generates dynamic phases from app concept
  const handleStartAdvancedPhasedBuild = useCallback(async () => {
    if (!appConcept) return;

    // Show generating message
    const generatingMessage: ChatMessage = {
      id: generateId(),
      role: 'system',
      content: `üîÑ **Generating Phase Plan...**\n\nAnalyzing "${appConcept.name}" to create an optimal build plan.`,
      timestamp: new Date().toISOString(),
    };
    setChatMessages((prev) => [...prev, generatingMessage]);

    try {
      // Call API to generate dynamic phases
      const response = await fetch('/api/wizard/generate-phases', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ concept: appConcept }),
      });

      const data = await response.json();

      if (data.success && data.plan) {
        const phasePlan: DynamicPhasePlan = data.plan;
        setDynamicPhasePlan(phasePlan);
        dynamicBuildPhases.initializePlan(phasePlan);
        setShowAdvancedPhasedBuild(true);

        // Sync with StagePlan for ChatPanel display
        const stagePlan: StagePlan = {
          totalPhases: phasePlan.totalPhases,
          currentPhase: 0,
          phases: phasePlan.phases.map((p) => ({
            number: p.number,
            name: p.name,
            description: p.description,
            features: p.features,
            status: 'pending' as const,
          })),
        };
        setNewAppStagePlan(stagePlan);

        const notification: ChatMessage = {
          id: generateId(),
          role: 'system',
          content: `üèóÔ∏è **${phasePlan.totalPhases}-Phase Build Plan Created**\n\nBuilding "${appConcept.name}" with ${phasePlan.complexity} complexity.\n\n**Estimated time:** ${phasePlan.estimatedTotalTime}`,
          timestamp: new Date().toISOString(),
        };
        setChatMessages((prev) => [...prev, notification]);
      } else {
        throw new Error(data.error || 'Failed to generate phase plan');
      }
    } catch (error) {
      const errorMessage: ChatMessage = {
        id: generateId(),
        role: 'system',
        content: `‚ùå **Failed to generate phase plan**\n\n${(error as Error).message}`,
        timestamp: new Date().toISOString(),
      };
      setChatMessages((prev) => [...prev, errorMessage]);
    }
  }, [
    appConcept,
    dynamicBuildPhases,
    setShowAdvancedPhasedBuild,
    setChatMessages,
    setNewAppStagePlan,
  ]);

  // Handle phase detail view
  const handleViewPhaseDetails = useCallback(
    (phaseId: PhaseId) => {
      setSelectedPhaseId(phaseId);
    },
    [setSelectedPhaseId]
  );

  // Handle phase validation
  const handleRunValidation = useCallback(async () => {
    setIsValidating(true);
    try {
      // For now, validation is handled by the streaming generation API
      // Future: Add specific validation logic for dynamic phases
      const currentPhase = dynamicBuildPhases.currentPhase;
      if (currentPhase) {
        const notification: ChatMessage = {
          id: generateId(),
          role: 'system',
          content: `üîç **Validating Phase ${currentPhase.number}...**\n\nChecking: ${currentPhase.testCriteria.join(', ')}`,
          timestamp: new Date().toISOString(),
        };
        setChatMessages((prev) => [...prev, notification]);
      }
    } finally {
      setIsValidating(false);
    }
  }, [dynamicBuildPhases, setIsValidating, setChatMessages]);

  // Handle new app creation
  const handleNewApp = useCallback(() => {
    setCurrentComponent(null);
    setChatMessages([getWelcomeMessage()]);
    setActiveTab('chat');
    if (typeof window !== 'undefined') {
      try {
        localStorage.removeItem('current_app_id');
      } catch (e) {
        console.warn('Failed to clear current app ID from localStorage:', e);
      }
    }
  }, [setCurrentComponent, setChatMessages, setActiveTab]);

  // Save version helper
  const saveVersion = useCallback(
    (
      component: GeneratedComponent,
      changeType: 'NEW_APP' | 'MAJOR_CHANGE' | 'MINOR_CHANGE',
      description: string
    ): GeneratedComponent => {
      const versions = component.versions || [];
      const newVersion: AppVersion = {
        id: generateId(),
        versionNumber: versions.length + 1,
        code: component.code,
        description: description,
        timestamp: new Date().toISOString(),
        changeType,
      };

      return {
        ...component,
        versions: [...versions, newVersion],
      };
    },
    []
  );

  // Approve pending change
  const approveChange = useCallback(() => {
    if (!pendingChange || !currentComponent) return;

    try {
      versionControl.pushToUndoStack({
        id: generateId(),
        versionNumber: (currentComponent.versions?.length || 0) + 1,
        code: currentComponent.code,
        description: currentComponent.description,
        timestamp: currentComponent.timestamp,
        changeType: 'MINOR_CHANGE',
      });
      versionControl.clearRedoStack();

      let updatedComponent: GeneratedComponent = {
        ...currentComponent,
        code: pendingChange.newCode,
        description: pendingChange.changeDescription,
        timestamp: new Date().toISOString(),
      };

      updatedComponent = saveVersion(
        updatedComponent,
        'MAJOR_CHANGE',
        pendingChange.changeDescription
      );

      setCurrentComponent(updatedComponent);
      setComponents((prev) =>
        prev.map((comp) => (comp.id === currentComponent.id ? updatedComponent : comp))
      );

      saveComponentToDb(updatedComponent);

      const approvalMessage: ChatMessage = {
        id: generateId(),
        role: 'assistant',
        content: `‚úÖ Changes approved and applied! (Version ${updatedComponent.versions?.length || 1} saved)`,
        timestamp: new Date().toISOString(),
        componentCode: pendingChange.newCode,
        componentPreview: true,
      };

      setChatMessages((prev) => [...prev, approvalMessage]);
      setActiveTab('preview');
    } catch (error) {
      console.error('Error applying changes:', error);
    } finally {
      setPendingChange(null);
      setShowApprovalModal(false);
    }
  }, [
    pendingChange,
    currentComponent,
    versionControl,
    saveVersion,
    setCurrentComponent,
    setComponents,
    saveComponentToDb,
    setChatMessages,
    setActiveTab,
    setPendingChange,
    setShowApprovalModal,
  ]);

  // Reject pending change
  const rejectChange = useCallback(() => {
    const rejectionMessage: ChatMessage = {
      id: generateId(),
      role: 'assistant',
      content: `‚ùå Changes rejected. Your app remains unchanged.`,
      timestamp: new Date().toISOString(),
    };

    setChatMessages((prev) => [...prev, rejectionMessage]);
    setPendingChange(null);
    setShowApprovalModal(false);
    setActiveTab('chat');
  }, [setChatMessages, setPendingChange, setShowApprovalModal, setActiveTab]);

  // Approve diff
  const approveDiff = useCallback(async () => {
    if (!pendingDiff || !currentComponent) return;

    try {
      const currentAppData = JSON.parse(currentComponent.code);
      const currentFiles = currentAppData.files.map((f: { path: string; content: string }) => ({
        path: f.path,
        content: f.content,
      }));

      const response = await fetch('/api/ai-builder/apply-diff', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          currentFiles,
          diffs: pendingDiff.files,
        }),
      });

      const result = await response.json();

      if (!result.success) {
        throw new Error(result.errors?.join(', ') || 'Failed to apply diff');
      }

      const updatedAppData = {
        ...currentAppData,
        files: result.modifiedFiles.map((f: { path: string; content: string }) => ({
          path: f.path,
          content: f.content,
        })),
      };

      versionControl.pushToUndoStack({
        id: generateId(),
        versionNumber: (currentComponent.versions?.length || 0) + 1,
        code: currentComponent.code,
        description: currentComponent.description,
        timestamp: currentComponent.timestamp,
        changeType: 'MINOR_CHANGE',
      });
      versionControl.clearRedoStack();

      let updatedComponent: GeneratedComponent = {
        ...currentComponent,
        code: JSON.stringify(updatedAppData, null, 2),
        description: pendingDiff.summary,
        timestamp: new Date().toISOString(),
      };

      updatedComponent = saveVersion(updatedComponent, 'MINOR_CHANGE', pendingDiff.summary);

      setCurrentComponent(updatedComponent);
      setComponents((prev) =>
        prev.map((comp) => (comp.id === currentComponent.id ? updatedComponent : comp))
      );

      saveComponentToDb(updatedComponent);

      const successMessage: ChatMessage = {
        id: generateId(),
        role: 'assistant',
        content: `‚úÖ Changes applied successfully!\n\n${pendingDiff.summary}`,
        timestamp: new Date().toISOString(),
        componentCode: JSON.stringify(updatedAppData, null, 2),
        componentPreview: true,
      };

      setChatMessages((prev) => [...prev, successMessage]);
      setActiveTab('preview');
    } catch (error) {
      const errorMsg = error instanceof Error ? error.message : 'Unknown error';
      const errorMessage: ChatMessage = {
        id: generateId(),
        role: 'assistant',
        content: `‚ùå **Error Applying Changes**\n\n${errorMsg}`,
        timestamp: new Date().toISOString(),
      };
      setChatMessages((prev) => [...prev, errorMessage]);
    } finally {
      setPendingDiff(null);
      setShowDiffPreview(false);
    }
  }, [
    pendingDiff,
    currentComponent,
    versionControl,
    saveVersion,
    setCurrentComponent,
    setComponents,
    saveComponentToDb,
    setChatMessages,
    setActiveTab,
    setPendingDiff,
    setShowDiffPreview,
  ]);

  // Reject diff
  const rejectDiff = useCallback(() => {
    const rejectionMessage: ChatMessage = {
      id: generateId(),
      role: 'assistant',
      content: `‚ùå Changes rejected. Your app remains unchanged.`,
      timestamp: new Date().toISOString(),
    };

    setChatMessages((prev) => [...prev, rejectionMessage]);
    setPendingDiff(null);
    setShowDiffPreview(false);
    setActiveTab('chat');
  }, [setChatMessages, setPendingDiff, setShowDiffPreview, setActiveTab]);

  // Revert to version
  const revertToVersion = useCallback(
    (version: AppVersion) => {
      if (!currentComponent) return;

      versionControl.revertToVersion(version);

      const revertMessage: ChatMessage = {
        id: generateId(),
        role: 'assistant',
        content: `üîÑ Successfully reverted to Version ${version.versionNumber}\n\n**Reverted to:** ${version.description}`,
        timestamp: new Date().toISOString(),
        componentCode: version.code,
        componentPreview: true,
      };

      setChatMessages((prev) => [...prev, revertMessage]);
      setShowVersionHistory(false);
      setActiveTab('preview');
    },
    [currentComponent, versionControl, setChatMessages, setShowVersionHistory, setActiveTab]
  );

  // Compare versions
  const handleCompareVersions = useCallback(
    (v1: AppVersion, v2: AppVersion) => {
      setCompareVersions({ v1, v2 });
      setShowCompareModal(true);
    },
    [setCompareVersions, setShowCompareModal]
  );

  // Fork app
  const handleForkApp = useCallback(
    (sourceApp: GeneratedComponent, versionToFork?: AppVersion) => {
      const forkedApp = versionControl.forkFromVersion(sourceApp, versionToFork);

      setComponents((prev) => [forkedApp, ...prev]);
      setCurrentComponent(forkedApp);
      setChatMessages([
        {
          id: generateId(),
          role: 'assistant',
          content: `üç¥ Successfully forked "${sourceApp.name}"!\n\nYou can now make changes to this forked version without affecting the original.`,
          timestamp: new Date().toISOString(),
          componentCode: forkedApp.code,
          componentPreview: true,
        },
      ]);
      setShowVersionHistory(false);
      setActiveTab('preview');
    },
    [
      versionControl,
      setComponents,
      setCurrentComponent,
      setChatMessages,
      setShowVersionHistory,
      setActiveTab,
    ]
  );

  // Toggle favorite
  const toggleFavorite = useCallback(
    (id: string) => {
      const component = components.find((c) => c.id === id);
      if (!component) return;

      const updatedComponent = { ...component, isFavorite: !component.isFavorite };

      setComponents((prev) => prev.map((comp) => (comp.id === id ? updatedComponent : comp)));

      saveComponentToDb(updatedComponent);
    },
    [components, setComponents, saveComponentToDb]
  );

  // Delete component
  const deleteComponent = useCallback(
    (id: string) => {
      // Delete from database first
      deleteComponentFromDb(id);

      // Update components state (this will trigger localStorage sync via useEffect)
      const updatedComponents = components.filter((comp) => comp.id !== id);
      setComponents(updatedComponents);

      // Immediately update localStorage to ensure sync before any page refresh
      if (typeof window !== 'undefined') {
        try {
          localStorage.setItem('ai_components', JSON.stringify(updatedComponents));

          // If deleting the currently loaded component, clear its ID from localStorage
          if (currentComponent?.id === id) {
            localStorage.removeItem('current_app_id');
          }
        } catch (e) {
          console.warn('Failed to update localStorage after delete:', e);
        }
      }

      if (currentComponent?.id === id) {
        setCurrentComponent(null);
        setChatMessages([getWelcomeMessage()]);
        setActiveTab('chat');
      }
    },
    [
      deleteComponentFromDb,
      components,
      setComponents,
      currentComponent,
      setCurrentComponent,
      setChatMessages,
      setActiveTab,
    ]
  );

  // Export app
  const handleExportApp = useCallback(
    async (comp: GeneratedComponent) => {
      setExportingApp(comp);

      try {
        const appData = JSON.parse(comp.code);
        const files = parseAppFiles(appData);

        const zipBlob = await exportAppAsZip({
          appName: comp.name,
          files: files,
        });

        const filename = `${comp.name.toLowerCase().replace(/\s+/g, '-')}.zip`;
        downloadBlob(zipBlob, filename);

        setDeploymentInstructions(getDeploymentInstructions('vercel', comp.name));
        setShowDeploymentModal(true);
      } catch (error) {
        console.error('Error exporting app:', error);
        alert('Failed to export app. Please try again.');
      } finally {
        setExportingApp(null);
      }
    },
    [setExportingApp, setDeploymentInstructions, setShowDeploymentModal]
  );

  // Load component
  const loadComponent = useCallback(
    (comp: GeneratedComponent) => {
      setCurrentComponent(comp);
      setChatMessages(comp.conversationHistory);
      setShowLibrary(false);
      setActiveTab('preview');
      const hasPendingPhases = comp.stagePlan?.phases?.some((p) => p.status === 'pending') ?? false;
      setNewAppStagePlan(hasPendingPhases ? comp.stagePlan! : null);
    },
    [setCurrentComponent, setChatMessages, setShowLibrary, setActiveTab, setNewAppStagePlan]
  );

  // Download code
  const downloadCode = useCallback(() => {
    if (!currentComponent) return;

    const blob = new Blob([currentComponent.code], { type: 'text/plain' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `${currentComponent.name.replace(/\s+/g, '-')}.tsx`;
    a.click();
    URL.revokeObjectURL(url);
  }, [currentComponent]);

  // Filtered components - memoized to avoid recalculating on every render
  const filteredComponents = useMemo(
    () =>
      components.filter(
        (comp) =>
          searchQuery === '' ||
          comp.name.toLowerCase().includes(searchQuery.toLowerCase()) ||
          comp.description.toLowerCase().includes(searchQuery.toLowerCase())
      ),
    [components, searchQuery]
  );

  // Handle build phase in chat panel
  const handleBuildPhase = useCallback(
    (phase: Phase) => {
      // If we have a dynamic phase plan, use context-aware execution
      if (dynamicPhasePlan) {
        startDynamicPhasedBuild(phase.number);
        return;
      }

      // Fallback to simple prompt for non-dynamic plans
      const buildPrompt = `Build ${phase.name}: ${phase.description}. Features to implement: ${phase.features.join(', ')}`;
      setUserInput(buildPrompt);
      setNewAppStagePlan((prev) =>
        prev
          ? {
              ...prev,
              currentPhase: phase.number,
              phases: prev.phases.map((p) =>
                p.number === phase.number ? { ...p, status: 'building' as const } : p
              ),
            }
          : null
      );
    },
    [dynamicPhasePlan, startDynamicPhasedBuild, setUserInput, setNewAppStagePlan]
  );

  // ============================================================================
  // SEND MESSAGE (Core message sending logic - kept in orchestrator)
  // ============================================================================
  const sendMessage = useCallback(async () => {
    if (!userInput.trim() || isGenerating) return;

    // Create user message
    const userMessage: ChatMessage = {
      id: generateId(),
      role: 'user',
      content: userInput,
      timestamp: new Date().toISOString(),
    };

    setLastUserRequest(userInput);
    setChatMessages((prev) => [...prev, userMessage]);
    setUserInput('');
    setIsGenerating(true);

    // Determine if this is a modification (has existing app loaded)
    const isModification = currentComponent !== null;

    // Legacy isQuestion check - kept for PLAN mode and response handling compatibility
    const isQuestion = messageSender.isQuestion(userInput);

    // Get progress messages for requests
    const progressMessages = messageSender.getProgressMessages(isQuestion, isModification);

    let progressIndex = 0;
    const progressInterval = setInterval(() => {
      if (progressIndex < progressMessages.length) {
        setGenerationProgress(progressMessages[progressIndex]);
        progressIndex++;
      }
    }, 3000);

    try {
      // Build request body
      const parsedCurrentAppState = currentComponent ? JSON.parse(currentComponent.code) : null;

      const requestBody: Record<string, unknown> = {
        prompt: userInput,
        conversationHistory: chatMessages.slice(-30),
        mode: currentMode,
        currentAppState: parsedCurrentAppState,
      };

      if (uploadedImage) {
        requestBody.image = uploadedImage;
        requestBody.hasImage = true;
      }

      let data: Record<string, unknown> | null = null;

      // Determine endpoint based on mode
      let endpoint: string;
      let fetchBody: string;

      if (currentMode === 'PLAN') {
        // Smart Conversations: Use wizard API for intelligent planning
        endpoint = '/api/wizard/chat';

        // Prepare conversation history with compression for large conversations
        // Increased limit to 100k tokens for deep context memory
        const MAX_CONTEXT_TOKENS = 100000;
        let conversationHistory: Array<{ role: 'user' | 'assistant'; content: string }>;
        let contextSummary: string | undefined;

        // Filter out system messages for the API context
        const filteredMessages = chatMessages
          .filter((m) => m.role !== 'system')
          .map((m) => ({
            id: m.id,
            role: m.role as 'user' | 'assistant',
            content: m.content,
            timestamp: m.timestamp,
          }));

        // Check if compression is needed
        if (needsCompression(filteredMessages, MAX_CONTEXT_TOKENS)) {
          const compressed = compressConversation(filteredMessages, {
            maxTokens: MAX_CONTEXT_TOKENS,
            preserveLastN: 8,
          });

          conversationHistory = compressed.recentMessages.map((m) => ({
            role: m.role as 'user' | 'assistant',
            content: m.content,
          }));

          if (compressed.summary.messageCount > 0) {
            contextSummary = buildCompressedContext(compressed);
          }
        } else {
          conversationHistory = filteredMessages.map((m) => ({
            role: m.role as 'user' | 'assistant',
            content: m.content,
          }));
        }

        fetchBody = JSON.stringify({
          message: userInput,
          conversationHistory,
          contextSummary,
          currentState: wizardState,
          // Include images for vision capabilities
          referenceImages: uploadedImage ? [uploadedImage] : undefined,
        });
      } else {
        // ACT mode: Use builder expert for intelligent intent detection
        // The builder expert handles questions, builds, and modifications
        endpoint = '/api/builder/chat';
        fetchBody = JSON.stringify({
          message: userInput,
          conversationHistory: chatMessages.slice(-30).map((m) => ({
            role: m.role === 'user' ? 'user' : 'assistant',
            content: m.content,
          })),
          currentAppState: currentComponent
            ? {
                name: currentComponent.name,
                files: [{ path: 'App.tsx', content: currentComponent.code }],
              }
            : undefined,
          image: uploadedImage || undefined,
          hasImage: !!uploadedImage,
        });
      }

      const response = await fetch(endpoint, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: fetchBody,
      });

      if (progressInterval) {
        clearInterval(progressInterval);
      }
      setGenerationProgress('');

      data = await response.json();

      if (data?.error) {
        throw new Error(data.error as string);
      }

      // Smart Conversations: Update wizard state from response (PLAN mode)
      if (currentMode === 'PLAN' && data?.updatedState) {
        setWizardState(data.updatedState as typeof wizardState);
      }

      // Builder Expert: Check if we should trigger build/modify (ACT mode)
      if (currentMode === 'ACT' && data?.shouldTriggerBuild) {
        // The builder expert decided this needs a full build - call streaming generation
        const buildRequestBody: Record<string, unknown> = {
          prompt: userInput,
          conversationHistory: chatMessages.slice(-30),
          isModification: false,
          image: uploadedImage || undefined,
          hasImage: !!uploadedImage,
        };

        const buildingMessage: ChatMessage = {
          id: generateId(),
          role: 'assistant',
          content: "üî® **Building your app...**\n\nI'm generating the code for your application.",
          timestamp: new Date().toISOString(),
        };
        setChatMessages((prev) => [...prev, buildingMessage]);

        const streamResult = await streaming.generate(buildRequestBody);

        if (streamResult) {
          const aiAppMessage: ChatMessage = {
            id: generateId(),
            role: 'assistant',
            content: `üöÄ App created!\n\n${streamResult.description || `I've created your ${streamResult.name} app!`}`,
            timestamp: new Date().toISOString(),
            componentCode: JSON.stringify(streamResult),
            componentPreview: !!(streamResult.files as unknown[])?.length,
          };
          setChatMessages((prev) => [...prev, aiAppMessage]);

          const files = streamResult.files as Array<{ path: string; content: string }>;
          if (files && files.length > 0) {
            let newComponent: GeneratedComponent = {
              id: generateId(),
              name: (streamResult.name as string) || extractComponentName(userInput),
              code: JSON.stringify(streamResult, null, 2),
              description: userInput,
              timestamp: new Date().toISOString(),
              isFavorite: false,
              conversationHistory: [...chatMessages, userMessage, aiAppMessage],
              versions: [],
            };

            newComponent = saveVersion(newComponent, 'NEW_APP', userInput);
            setCurrentComponent(newComponent);
            setComponents((prev) => [newComponent, ...prev].slice(0, 50));
            saveComponentToDb(newComponent);
            setActiveTab('preview');
          }
        }
        return;
      }

      // Builder Expert: Check if we should trigger modify (ACT mode)
      if (currentMode === 'ACT' && data?.shouldTriggerModify && currentComponent) {
        const modifyRequestBody: Record<string, unknown> = {
          prompt: userInput,
          conversationHistory: chatMessages.slice(-30),
          isModification: true,
          currentAppName: currentComponent.name,
          currentAppState: JSON.parse(currentComponent.code),
          image: uploadedImage || undefined,
          hasImage: !!uploadedImage,
        };

        const modifyingMessage: ChatMessage = {
          id: generateId(),
          role: 'assistant',
          content: 'üîß **Updating your app...**',
          timestamp: new Date().toISOString(),
        };
        setChatMessages((prev) => [...prev, modifyingMessage]);

        const streamResult = await streaming.generate(modifyRequestBody);

        if (streamResult) {
          const aiAppMessage: ChatMessage = {
            id: generateId(),
            role: 'assistant',
            content: `‚úÖ App updated!\n\n${streamResult.description || 'Changes applied.'}`,
            timestamp: new Date().toISOString(),
            componentCode: JSON.stringify(streamResult),
            componentPreview: !!(streamResult.files as unknown[])?.length,
          };
          setChatMessages((prev) => [...prev, aiAppMessage]);

          const files = streamResult.files as Array<{ path: string; content: string }>;
          if (files && files.length > 0) {
            let updatedComponent: GeneratedComponent = {
              ...currentComponent,
              code: JSON.stringify(streamResult, null, 2),
              description: userInput,
              timestamp: new Date().toISOString(),
              conversationHistory: [...chatMessages, userMessage, aiAppMessage],
            };

            updatedComponent = saveVersion(updatedComponent, 'MAJOR_CHANGE', userInput);
            setCurrentComponent(updatedComponent);
            setComponents((prev) =>
              prev.map((c) => (c.id === currentComponent.id ? updatedComponent : c))
            );
            saveComponentToDb(updatedComponent);
            setActiveTab('preview');
          }
        }
        return;
      }

      // Handle diff response
      if (data?.changeType === 'MODIFICATION' && data?.files) {
        setPendingDiff({
          id: generateId(),
          summary: data.summary as string,
          files: data.files as PendingDiff['files'],
          timestamp: new Date().toISOString(),
        });
        setShowDiffPreview(true);

        const diffMessage: ChatMessage = {
          id: (Date.now() + 1).toString(),
          role: 'assistant',
          content: `üîç **Changes Ready for Review**\n\n${data.summary}`,
          timestamp: new Date().toISOString(),
        };
        setChatMessages((prev) => [...prev, diffMessage]);
        return;
      }

      // Handle chat response (wizard in PLAN mode, builder expert in ACT mode)
      const isBuilderResponse = currentMode === 'ACT' && data?.message && data?.responseType;
      const isWizardResponse = currentMode === 'PLAN' && data?.message;
      const isChatResponse =
        isQuestion || data?.type === 'chat' || isWizardResponse || isBuilderResponse;

      if (isChatResponse) {
        const chatResponse: ChatMessage = {
          id: generateId(),
          role: 'assistant',
          content: (data?.message || data?.answer || data?.description) as string,
          timestamp: new Date().toISOString(),
        };
        setChatMessages((prev) => [...prev, chatResponse]);
      } else if (data) {
        // Handle full-app response (both streaming and non-streaming)
        const aiAppMessage: ChatMessage = {
          id: generateId(),
          role: 'assistant',
          content: `üöÄ App created\n\n${data.description || `I've created your ${data.name} app!`}`,
          timestamp: new Date().toISOString(),
          componentCode: JSON.stringify(data),
          componentPreview: !!(data.files as unknown[])?.length,
        };
        setChatMessages((prev) => [...prev, aiAppMessage]);

        const files = data.files as Array<{ path: string; content: string }>;
        if (files && files.length > 0) {
          let newComponent: GeneratedComponent = {
            id: isModification && currentComponent ? currentComponent.id : generateId(),
            name: (data.name as string) || extractComponentName(userInput),
            code: JSON.stringify(data, null, 2),
            description: userInput,
            timestamp: new Date().toISOString(),
            isFavorite: isModification && currentComponent ? currentComponent.isFavorite : false,
            conversationHistory: [...chatMessages, userMessage, aiAppMessage],
            versions: isModification && currentComponent ? currentComponent.versions : [],
          };

          newComponent = saveVersion(
            newComponent,
            'NEW_APP',
            (data.description as string) || userInput
          );

          setCurrentComponent(newComponent);

          if (isModification && currentComponent) {
            setComponents((prev) =>
              prev.map((comp) => (comp.id === currentComponent.id ? newComponent : comp))
            );
          } else {
            setComponents((prev) => [newComponent, ...prev].slice(0, 50));
          }

          saveComponentToDb(newComponent);
          setActiveTab('preview');
        }
      }
    } catch (error) {
      if (progressInterval) {
        clearInterval(progressInterval);
      }
      setGenerationProgress('');

      const errorMessage: ChatMessage = {
        id: generateId(),
        role: 'assistant',
        content: `‚ùå Sorry, I encountered an error: ${error instanceof Error ? error.message : 'Unknown error'}. Please try again.`,
        timestamp: new Date().toISOString(),
      };
      setChatMessages((prev) => [...prev, errorMessage]);
    } finally {
      setIsGenerating(false);
      setUploadedImage(null);
      setImageFile(null);
      if (fileInputRef.current) {
        fileInputRef.current.value = '';
      }
    }
    // Note: This callback depends on the listed values that may change. The Zustand setters
    // used internally (setChatMessages, setIsGenerating, etc.) are stable and omitted from deps.
    // eslint-disable-next-line react-hooks/exhaustive-deps
  }, [
    userInput,
    isGenerating,
    currentMode,
    currentComponent,
    chatMessages,
    uploadedImage,
    messageSender,
    streaming,
    saveVersion,
    saveComponentToDb,
  ]);

  // ============================================================================
  // RENDER
  // ============================================================================

  // Prevent hydration errors
  if (!isClient) {
    return (
      <div className="h-full bg-gradient-to-br from-slate-900 via-slate-800 to-slate-900 flex items-center justify-center">
        <div className="text-slate-400">Loading...</div>
      </div>
    );
  }

  return (
    <ToastProvider>
      <div className="h-full bg-gradient-to-br from-slate-900 via-slate-800 to-slate-900">
        {/* Header */}
        <BuilderHeader
          projectName={currentComponent?.name || 'Untitled App'}
          onProjectNameChange={(name) => {
            if (currentComponent) {
              // Update component name in store
              const updated = { ...currentComponent, name };
              setCurrentComponent(updated);
            }
          }}
          projectStatus={isGenerating ? 'generating' : currentComponent ? 'saved' : 'draft'}
          hasUnsavedChanges={false}
          currentView={activeTab as 'chat' | 'code' | 'preview' | 'split'}
          onViewChange={(view) => {
            // Map 'split' to 'preview' for the store since ActiveTab doesn't support 'split'
            const mappedView = view === 'split' ? 'preview' : view;
            setActiveTab(mappedView as 'chat' | 'preview' | 'code');
          }}
          onNewProject={handleNewApp}
          onSave={() => {
            if (currentComponent) {
              saveComponentToDb(currentComponent);
            }
          }}
          onExport={(format) => {
            if (currentComponent) {
              switch (format) {
                case 'zip':
                  handleExportApp(currentComponent);
                  break;
                case 'clipboard':
                  navigator.clipboard.writeText(currentComponent.code);
                  break;
                case 'html':
                case 'react':
                  // For HTML/React, use the ZIP export which packages everything
                  handleExportApp(currentComponent);
                  break;
              }
            }
          }}
          onOpenSettings={() => setShowSettings(true)}
          onHelp={() => {
            /* Could open help modal */
          }}
          onPlanApp={() => setShowConceptWizard(true)}
          onWizard={() => setActiveView('wizard')}
          onLayoutBuilder={() => setActiveView('layout')}
          onPhasedBuild={() => setActiveView('build')}
          hasAppConcept={!!appConcept}
          isPhasedMode={activeView === 'build'}
          showPhasedBuildPanel={activeView === 'build'}
          onTogglePhasedPanel={() => setActiveView(activeView === 'build' ? 'main' : 'build')}
          versionCount={currentComponent?.versions?.length || 0}
          onShowHistory={() => setShowVersionHistory(!showVersionHistory)}
          appCount={components.length}
          onShowLibrary={() => setShowLibrary(!showLibrary)}
          currentMode={currentMode}
          onModeChange={setCurrentMode}
          onNewApp={handleNewApp}
        />

        {/* Tab Navigation */}
        <TabNavigation />

        {/* Main Content - Builder View */}
        {activeView === 'main' && (
          <div className="max-w-[1800px] mx-auto px-4 py-4 h-[calc(100vh-120px)]">
            <ResizablePanelGroup
              direction="horizontal"
              persistenceKey="ai-builder-layout"
              className="h-full"
            >
              {/* Chat Panel */}
              <ResizablePanel defaultSize={35} minSize={20} maxSize={60}>
                <div className="h-full flex flex-col relative">
                  <ChatPanel
                    messages={chatMessages}
                    isGenerating={isGenerating}
                    generationProgress={generationProgress}
                    userInput={userInput}
                    onUserInputChange={setUserInput}
                    onSendMessage={sendMessage}
                    uploadedImage={uploadedImage}
                    onImageUpload={handleImageUpload}
                    onRemoveImage={removeImage}
                    currentMode={currentMode}
                    onModeChange={setCurrentMode}
                    stagePlan={newAppStagePlan}
                    onBuildPhase={handleBuildPhase}
                    onViewComponent={() => setActiveTab('preview')}
                    streamingProgress={streaming.progress}
                    isStreamingActive={streaming.isStreaming}
                  />
                </div>
              </ResizablePanel>

              <ResizableHandle />

              {/* Preview Panel */}
              <ResizablePanel defaultSize={65} minSize={30} maxSize={80}>
                <PreviewPanel
                  currentComponent={currentComponent}
                  activeTab={activeTab}
                  onTabChange={setActiveTab}
                  canUndo={versionControl.canUndo}
                  canRedo={versionControl.canRedo}
                  onUndo={versionControl.undo}
                  onRedo={versionControl.redo}
                  undoCount={versionControl.undoStack.length}
                  redoCount={versionControl.redoStack.length}
                  onFork={handleForkApp}
                  onExport={handleExportApp}
                  onDownload={downloadCode}
                  isExporting={!!exportingApp}
                  onScreenshot={(image) => {
                    setUploadedImage(image);
                    // Show a subtle indicator that capture is ready
                    console.log('Preview captured - will be sent with next message');
                  }}
                />
              </ResizablePanel>
            </ResizablePanelGroup>
          </div>
        )}

        {/* Wizard View */}
        {activeView === 'wizard' && (
          <div className="h-[calc(100vh-120px)]">
            <NaturalConversationWizard
              onComplete={handleNaturalWizardComplete}
              onCancel={() => setActiveView('main')}
              isFullPage
            />
          </div>
        )}

        {/* Layout View */}
        {activeView === 'layout' && (
          <div className="h-[calc(100vh-120px)]">
            <LayoutBuilderWizard
              isOpen={true}
              onClose={() => setActiveView('main')}
              onApplyToAppConcept={() => {
                // Optionally close the wizard or show a success message
              }}
              isFullPage
            />
          </div>
        )}

        {/* Build View */}
        {activeView === 'build' && dynamicPhasePlan && (
          <div className="h-[calc(100vh-120px)]">
            <PhasedBuildPanel
              isOpen={true}
              onClose={() => setActiveView('main')}
              phases={dynamicBuildPhases.uiPhases}
              progress={dynamicBuildPhases.progress}
              currentPhase={
                dynamicBuildPhases.currentPhase
                  ? dynamicBuildPhases.uiPhases.find(
                      (p) => p.order === dynamicBuildPhases.currentPhase?.number
                    ) || null
                  : null
              }
              isBuilding={dynamicBuildPhases.isBuilding}
              isPaused={dynamicBuildPhases.isPaused}
              isValidating={isValidating}
              onStartBuild={handleStartAdvancedPhasedBuild}
              onPauseBuild={dynamicBuildPhases.pauseBuild}
              onResumeBuild={dynamicBuildPhases.resumeBuild}
              onSkipPhase={(phaseId) => {
                const phase = dynamicBuildPhases.uiPhases.find((p) => p.id === phaseId);
                if (phase) {
                  dynamicBuildPhases.skipPhase(phase.order);
                }
              }}
              onRetryPhase={(phaseId) => {
                const phase = dynamicBuildPhases.uiPhases.find((p) => p.id === phaseId);
                if (phase) {
                  dynamicBuildPhases.retryPhase(phase.order);
                }
              }}
              onViewPhaseDetails={handleViewPhaseDetails}
              onRunValidation={handleRunValidation}
              onResetBuild={dynamicBuildPhases.resetBuild}
              onExecuteCurrentPhase={async () => {
                const nextPhase = dynamicBuildPhases.getNextPhase();
                if (nextPhase) {
                  startDynamicPhasedBuild(nextPhase.number);
                }
              }}
              onProceedToNextPhase={() => {
                const nextPhase = dynamicBuildPhases.getNextPhase();
                if (nextPhase) {
                  startDynamicPhasedBuild(nextPhase.number);
                }
              }}
              dynamicPlan={dynamicPhasePlan}
              isFullPage
            />
          </div>
        )}

        {/* Build View - No Plan Yet */}
        {activeView === 'build' && !dynamicPhasePlan && (
          <div className="h-[calc(100vh-120px)] flex items-center justify-center">
            <div className="text-center max-w-md">
              <div className="text-6xl mb-4">üèóÔ∏è</div>
              <h2 className="text-2xl font-bold text-white mb-2">No Build Plan Yet</h2>
              <p className="text-slate-400 mb-6">
                Use the Wizard to create an app concept and generate a phased build plan first.
              </p>
              <button
                onClick={() => setActiveView('wizard')}
                className="px-6 py-3 bg-blue-600 hover:bg-blue-700 text-white rounded-lg font-medium transition-colors"
              >
                Start with Wizard
              </button>
            </div>
          </div>
        )}

        {/* Modals */}
        <LibraryModal
          isOpen={showLibrary}
          onClose={() => setShowLibrary(false)}
          components={components}
          filteredComponents={filteredComponents}
          searchQuery={searchQuery}
          onSearchChange={setSearchQuery}
          onLoadComponent={loadComponent}
          onToggleFavorite={toggleFavorite}
          onDeleteComponent={deleteComponent}
          onExportComponent={handleExportApp}
          exportingAppId={exportingApp?.id}
          contentTab={contentTab}
          onContentTabChange={setContentTab}
          storageFiles={fileStorage.files}
          filteredFiles={fileStorage.filteredFiles}
          fileSearchQuery={fileStorage.searchQuery}
          onFileSearchChange={fileStorage.setSearchQuery}
          fileTypeFilter={fileStorage.typeFilter}
          onFileTypeFilterChange={fileStorage.setTypeFilter}
          fileSortBy={fileStorage.sortBy}
          fileSortOrder={fileStorage.sortOrder}
          onSortChange={(newSortBy, newSortOrder) => {
            fileStorage.setSortBy(newSortBy);
            fileStorage.setSortOrder(newSortOrder);
          }}
          selectedFiles={fileStorage.selectedFiles}
          onFileSelect={fileStorage.selectFile}
          onFileUpload={fileStorage.uploadFiles}
          onFileDownload={fileStorage.downloadFile}
          onFileDelete={fileStorage.deleteFile}
          onBulkDelete={fileStorage.bulkDelete}
          onClearSelection={fileStorage.clearSelection}
          loadingFiles={fileStorage.isLoading}
          deletingFiles={fileStorage.deletingFiles}
          storageStats={fileStorage.storageStats}
          user={user}
        />

        <ApprovalModal
          isOpen={showApprovalModal}
          pendingChange={pendingChange}
          onApprove={approveChange}
          onReject={rejectChange}
        />

        <VersionHistoryModal
          isOpen={showVersionHistory}
          onClose={() => setShowVersionHistory(false)}
          currentComponent={currentComponent}
          onRevertToVersion={revertToVersion}
          onForkVersion={handleForkApp}
          onCompareVersions={handleCompareVersions}
        />

        <DeploymentModal
          isOpen={showDeploymentModal}
          onClose={() => {
            setShowDeploymentModal(false);
            setDeploymentInstructions(null);
          }}
          deploymentInstructions={deploymentInstructions}
          onPlatformChange={(platform) =>
            setDeploymentInstructions(
              getDeploymentInstructions(platform, exportingApp?.name || 'app')
            )
          }
          appName={exportingApp?.name}
        />

        <DiffPreviewModal
          isOpen={showDiffPreview}
          onClose={() => {
            setPendingDiff(null);
            setShowDiffPreview(false);
          }}
          pendingDiff={pendingDiff}
          onApprove={approveDiff}
          onReject={rejectDiff}
        />

        <StagingConsentModal
          isOpen={showNewAppStagingModal}
          pendingRequest={pendingNewAppRequest}
          onBuildAllAtOnce={() => {
            setShowNewAppStagingModal(false);
            setPendingNewAppRequest('');
            setUserInput(pendingNewAppRequest);
          }}
          onBuildInPhases={async () => {
            setShowNewAppStagingModal(false);
            setIsGenerating(true);

            try {
              const response = await fetch('/api/ai-builder/plan-phases', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                  prompt: pendingNewAppRequest,
                  conversationHistory: chatMessages.slice(-20),
                }),
              });

              const data = await response.json();

              if (data.error) {
                throw new Error(data.error);
              }

              setNewAppStagePlan(data);

              // Use helper function to format phase content safely
              const phaseContent = formatPhaseContent(data.phases);

              const phasePlanMessage: ChatMessage = {
                id: generateId(),
                role: 'assistant',
                content: `üèóÔ∏è **${data.totalPhases ?? 0}-Phase Build Plan Created**\n\n${phaseContent}\n\n**Ready to start?** Type **'start'** or **'begin'** to build Phase 1!`,
                timestamp: new Date().toISOString(),
              };

              setChatMessages((prev) => [...prev, phasePlanMessage]);
            } catch (error) {
              const errorMessage: ChatMessage = {
                id: generateId(),
                role: 'assistant',
                content: `‚ùå Failed to create phase plan: ${error instanceof Error ? error.message : 'Unknown error'}`,
                timestamp: new Date().toISOString(),
              };
              setChatMessages((prev) => [...prev, errorMessage]);
            } finally {
              setIsGenerating(false);
              setPendingNewAppRequest('');
            }
          }}
        />

        <CompareVersionsModal
          isOpen={showCompareModal}
          onClose={() => {
            setShowCompareModal(false);
            setCompareVersions({ v1: null, v2: null });
          }}
          version1={compareVersions.v1}
          version2={compareVersions.v2}
          onRevertToVersion={revertToVersion}
          onForkVersion={(version) => {
            if (currentComponent) {
              handleForkApp(currentComponent, version);
            }
          }}
          currentComponent={currentComponent}
        />

        {showConceptWizard && (
          <AppConceptWizard
            onComplete={handleConceptComplete}
            onCancel={() => setShowConceptWizard(false)}
          />
        )}

        {showConversationalWizard && (
          <NaturalConversationWizard
            onComplete={handleNaturalWizardComplete}
            onCancel={() => setShowConversationalWizard(false)}
          />
        )}

        <LayoutBuilderWizard
          isOpen={showLayoutBuilder}
          onClose={() => setShowLayoutBuilder(false)}
          onApplyToAppConcept={() => {
            // Optionally close the wizard or show a success message
          }}
        />

        <SettingsPage isOpen={showSettings} onClose={() => setShowSettings(false)} />

        {dynamicPhasePlan && (
          <PhasedBuildPanel
            isOpen={showAdvancedPhasedBuild}
            onClose={() => setShowAdvancedPhasedBuild(false)}
            phases={dynamicBuildPhases.uiPhases}
            progress={dynamicBuildPhases.progress}
            currentPhase={
              dynamicBuildPhases.currentPhase
                ? dynamicBuildPhases.uiPhases.find(
                    (p) => p.order === dynamicBuildPhases.currentPhase?.number
                  ) || null
                : null
            }
            isBuilding={dynamicBuildPhases.isBuilding}
            isPaused={dynamicBuildPhases.isPaused}
            isValidating={isValidating}
            onStartBuild={handleStartAdvancedPhasedBuild}
            onPauseBuild={dynamicBuildPhases.pauseBuild}
            onResumeBuild={dynamicBuildPhases.resumeBuild}
            onSkipPhase={(phaseId) => {
              const phase = dynamicBuildPhases.uiPhases.find((p) => p.id === phaseId);
              if (phase) {
                dynamicBuildPhases.skipPhase(phase.order);
              }
            }}
            onRetryPhase={(phaseId) => {
              const phase = dynamicBuildPhases.uiPhases.find((p) => p.id === phaseId);
              if (phase) {
                dynamicBuildPhases.retryPhase(phase.order);
              }
            }}
            onViewPhaseDetails={handleViewPhaseDetails}
            onRunValidation={handleRunValidation}
            onResetBuild={dynamicBuildPhases.resetBuild}
            onExecuteCurrentPhase={async () => {
              const nextPhase = dynamicBuildPhases.getNextPhase();
              if (nextPhase) {
                startDynamicPhasedBuild(nextPhase.number);
              }
            }}
            onProceedToNextPhase={() => {
              const nextPhase = dynamicBuildPhases.getNextPhase();
              if (nextPhase) {
                startDynamicPhasedBuild(nextPhase.number);
              }
            }}
            dynamicPlan={dynamicPhasePlan}
          />
        )}

        {selectedPhaseId && dynamicBuildPhases.uiPhases.length > 0 && (
          <PhaseDetailView
            phase={
              dynamicBuildPhases.uiPhases.find((p) => p.id === selectedPhaseId) ||
              dynamicBuildPhases.uiPhases[0]
            }
            isOpen={!!selectedPhaseId}
            onClose={() => setSelectedPhaseId(null)}
            onBuildPhase={async () => {
              const phase = dynamicBuildPhases.uiPhases.find((p) => p.id === selectedPhaseId);
              if (phase) {
                startDynamicPhasedBuild(phase.order);
              }
              setSelectedPhaseId(null);
            }}
            onSkipPhase={async () => {
              const phase = dynamicBuildPhases.uiPhases.find((p) => p.id === selectedPhaseId);
              if (phase) {
                dynamicBuildPhases.skipPhase(phase.order);
              }
              setSelectedPhaseId(null);
            }}
            onRetryPhase={async () => {
              const phase = dynamicBuildPhases.uiPhases.find((p) => p.id === selectedPhaseId);
              if (phase) {
                dynamicBuildPhases.retryPhase(phase.order);
              }
              setSelectedPhaseId(null);
            }}
            generatedCode={dynamicBuildPhases.accumulatedCode}
          />
        )}
      </div>
    </ToastProvider>
  );
}
</file>

</files>
